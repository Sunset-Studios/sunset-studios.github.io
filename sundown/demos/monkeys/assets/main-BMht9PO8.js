var cm=Object.defineProperty;var hm=(r,s,n)=>s in r?cm(r,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[s]=n;var O=(r,s,n)=>hm(r,typeof s!="symbol"?s+"":s,n);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))o(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerPolicy&&(c.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?c.credentials="include":l.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(l){if(l.ep)return;l.ep=!0;const c=n(l);fetch(l.href,c)}})();const _m=2;class Ba{constructor(){O(this,"canvas",null);O(this,"adapter",null);O(this,"device",null);O(this,"context",null);O(this,"canvas_format",null);O(this,"frame_number",0);O(this,"aspect_ratio",1)}async init(s,n={}){if(!navigator.gpu)throw Error("WebGPU is not supported");if(this.canvas=s,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw Error("Unable to request WebGPU adapter");try{this.device=await this.adapter.requestDevice({requiredLimits:{maxColorAttachmentBytesPerSample:64}})}catch(o){console.log(o),console.log("Falling back to default limits"),this.device=await this.adapter.requestDevice()}this.context=this.canvas.getContext("webgpu"),this.canvas_format=navigator.gpu.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.canvas_format,alphaMode:"premultiplied"}),this.aspect_ratio=this.canvas.width/this.canvas.height,n.pointer_lock&&this.canvas.addEventListener("click",async()=>{await this.canvas.requestPointerLock()})}advance_frame(){this.frame_number++}get_frame_number(){return this.frame_number}get_buffered_frame_number(){return this.frame_number%_m}get_canvas_resolution(){return{width:this.canvas.width,height:this.canvas.height}}draw_pass(s,n,o=1){s.pass.draw(n,o)}max_bind_groups(){return this.adapter.limits.maxBindGroups}static async create(s,n={}){let o=new Ba;return await o.init(s,n),o}}class fm{constructor(){this.executions=[],this.execution_delays=[]}push_execution(s,n=0){this.executions.push(s),this.execution_delays.push(n)}remove_execution(s){const n=this.executions.indexOf(s);n!==-1&&(this.executions.splice(n,1),this.execution_delays.splice(n,1))}update(){for(let s=this.executions.length-1;s>=0;--s)--this.execution_delays[s]<0&&(this.executions[s](),this.executions.splice(s,1),this.execution_delays.splice(s,1))}flush(){for(let s=this.executions.length-1;s>=0;--s)this.executions[s]();this.executions=[],this.execution_delays=[]}}class ti{constructor(s,n){this.max_objects=s,this.buffer=new Array(s).fill(null).map(()=>({...n})),this.offset=0}allocate(){if(this.offset>=this.max_objects)throw new Error("Out of memory on frame allocator");const s=this.offset;return this.offset++,this.buffer[s]}get(s){if(s<0||s>=this.offset)throw new Error("Invalid allocator index");return this.buffer[s]}reset(){this.offset=0}[Symbol.iterator](){let s=0;return{next:()=>s<this.offset?{value:this.buffer[s++],done:!1}:{done:!0}}}}const K=Object.freeze({SHADER:0,PIPELINE_STATE:1,RENDER_PASS:2,BIND_GROUP:3,BIND_GROUP_LAYOUT:4,BUFFER:5,IMAGE:6,SAMPLER:7,MESH:8,MATERIAL:9});class V{constructor(){if(V.instance)return V.instance;V.instance=this,this.cache=new Map,this.cache.set(K.SHADER,new Map),this.cache.set(K.PIPELINE_STATE,new Map),this.cache.set(K.PASS,new Map),this.cache.set(K.BIND_GROUP,new Map),this.cache.set(K.BIND_GROUP_LAYOUT,new Map),this.cache.set(K.BUFFER,new Map),this.cache.set(K.IMAGE,new Map),this.cache.set(K.SAMPLER,new Map),this.cache.set(K.MESH,new Map),this.cache.set(K.MATERIAL,new Map)}static get(){return V.instance||(V.instance=new V),V.instance}fetch(s,n){return this.cache.get(s).get(n)}store(s,n,o){this.cache.get(s).set(n,o)}remove(s,n){this.cache.get(s).delete(n)}size(s){return this.cache.get(s).size}}const yt=class yt{constructor(s){yt.string_to_hash.has(s)?this.hash=yt.string_to_hash.get(s):(this.hash=yt.fnv1a_hash(s),yt.string_to_hash.set(s,this.hash),yt.hash_to_string.set(this.hash,s))}static fnv1a_hash(s){let n=2166136261;for(let o=0;o<s.length;o++)n^=s.charCodeAt(o),n*=16777619;return n}static string(s){return yt.hash_to_string.get(s)}static hash(s){return yt.string_to_hash.get(s)}static from(s){return new yt(s),yt.hash(s)}};O(yt,"string_to_hash",new Map),O(yt,"hash_to_string",new Map);let oe=yt;const ge={Global:0,Pass:1,Material:2,Num:3};class dm{constructor(s){this.total_bindings_count=s,this.free_indices=Array.from({length:s},(n,o)=>o),this.bound_indices=[]}}class cl{constructor(){this.binding_table=new Map}has_binding_slot(s){return this.binding_table.has(s)}add_binding_slot(s,n){this.has_binding_slot(s)||this.binding_table.set(s,new dm(n))}get_new(s){if(!this.has_binding_slot(s))throw new Error(`Binding slot ${s} does not exist`);const n=this.binding_table.get(s);if(n.free_indices.length===0)throw new Error(`No free indices available for binding slot ${s}`);const o=n.free_indices.pop();return n.bound_indices.push(o),{slot:s,index:o}}free(s){const{slot:n,index:o}=s;if(!this.has_binding_slot(n))throw new Error(`Binding slot ${n} does not exist`);const l=this.binding_table.get(n),c=l.bound_indices.indexOf(o);if(c===-1)throw new Error(`Index ${o} is not bound for slot ${n}`);l.bound_indices.splice(c,1),l.free_indices.push(o)}reset(s){if(!this.has_binding_slot(s))throw new Error(`Binding slot ${s} does not exist`);const n=this.binding_table.get(s);n.free_indices=Array.from({length:n.total_bindings_count},(o,l)=>l),n.bound_indices=[]}}class Un{constructor(){O(this,"index",0);O(this,"name","");O(this,"bind_group",null);O(this,"layout",null);O(this,"binding_table",null)}init(s,n,o,l,c){this.name=n,this.index=l,this.layout=o.pipeline.getBindGroupLayout(l),this.bind_group=s.device.createBindGroup({label:n,layout:this.layout,entries:c}),this.binding_table=new cl}init_with_layout(s,n,o,l,c){this.name=n,this.index=l,this.layout=Un.create_layout(s,n,o),this.bind_group=s.device.createBindGroup({label:n,layout:this.layout,entries:c}),this.binding_table=new cl}destroy(){this.bind_group&&(V.get().remove(K.BIND_GROUP,oe.from(this.name)),this.bind_group=null,this.layout=null,this.binding_table=null)}bind(s){s.pass.setBindGroup(this.index,this.bind_group)}static create(s,n,o,l,c,d=!1){let y=V.get().fetch(K.BIND_GROUP,oe.from(n));return y&&d&&(y.destroy(),y=null),y||(y=new Un,y.init(s,n,o,l,c),V.get().store(K.BIND_GROUP,oe.from(n),y)),y}static create_with_layout(s,n,o,l,c,d=!1){let y=V.get().fetch(K.BIND_GROUP,oe.from(n));return y&&d&&(y.destroy(),y=null),y||(y=new Un,y.init_with_layout(s,n,o,l,c),V.get().store(K.BIND_GROUP,oe.from(n),y)),y}static create_layout(s,n,o,l=!1){let c=V.get().fetch(K.BIND_GROUP_LAYOUT,oe.from(n));return c&&l&&(c.destroy(),c=null),c||(c=s.device.createBindGroupLayout({label:n,entries:o}),V.get().store(K.BIND_GROUP_LAYOUT,oe.from(n),c)),c}}const Le=Object.freeze({None:0,Graphics:1,Present:2,Compute:4,GraphLocal:8});class Fa{constructor(){O(this,"pass",null);O(this,"config",null)}init(s){this.config=s}begin(s,n){if(this.config.flags&Le.Graphics){const o=this.config.attachments.map(c=>{const d=V.get().fetch(K.IMAGE,c.image);return{view:d.view,clearValue:d.config.clear_value??{r:0,g:0,b:0,a:1},loadOp:d.config.load_op??"clear",storeOp:d.config.store_op??"store"}}),l={label:this.config.name,colorAttachments:o};if(this.config.depth_stencil_attachment){const c=V.get().fetch(K.IMAGE,this.config.depth_stencil_attachment.image);l.depthStencilAttachment={view:c.view,depthClearValue:c.config.clear_value??0,depthLoadOp:c.config.load_op??"load",depthStoreOp:c.config.store_op??"store"}}this.pass=s.beginRenderPass(l)}else this.config.flags&Le.Compute&&(this.pass=s.beginComputePass({label:this.config.name}));this.config.viewport&&this.pass.setViewport(this.config.viewport),this.config.scissor_rect&&this.pass.setScissorRect(this.config.scissor_rect),this.config.vertex_buffer&&this.pass.setVertexBuffer(this.config.vertex_buffer),this.config.index_buffer&&this.pass.setIndexBuffer(this.config.index_buffer),n&&this.set_pipeline(n)}set_pipeline(s){this.pass.setPipeline(s.pipeline)}set_attachments(s){this.config.attachments=s}set_depth_stencil_attachment(s){this.config.depth_stencil_attachment=s}dispatch(s,n,o){this.config.flags&Le.Compute&&this.pass.dispatchWorkgroups(s,n,o)}end(){this.pass&&this.pass.end()}static create(s){let n=V.get().fetch(K.PASS,oe.from(s.name));return n||(n=new Fa,n.init(s),V.get().store(K.PASS,oe.from(s.name),n)),n}}class Ir{constructor(){O(this,"pipeline",null);O(this,"layout",null)}init_render_pipeline(s,n,o){o.bind_layouts&&o.bind_layouts.length&&(this.layout=s.device.createPipelineLayout({label:oe.string(n),bindGroupLayouts:o.bind_layouts})),this.pipeline=s.device.createRenderPipeline({label:oe.string(n),layout:this.layout??"auto",...o})}init_compute_pipeline(s,n,o){o.bind_layouts&&o.bind_layouts.length&&(this.layout=s.device.createPipelineLayout({label:oe.string(n),bindGroupLayouts:o.bind_layouts})),this.pipeline=s.device.createComputePipeline({label:oe.string(n),layout:this.layout??"auto",...o})}static create_render(s,n,o){let l=oe.from(n),c=V.get().fetch(K.PIPELINE_STATE,l);return c||(c=new Ir,c.init_render_pipeline(s,l,o),V.get().store(K.PIPELINE_STATE,l,c)),c}static create_compute(s,n,o){let l=oe.from(n),c=V.get().fetch(K.PIPELINE_STATE,l);return c||(c=new Ir,c.init_compute_pipeline(s,l,o),V.get().store(K.PIPELINE_STATE,l,c)),c}}class hl{constructor(){O(this,"queue",null)}static create_encoder(s,n){return s.device.createCommandEncoder({label:n})}static submit(s,n){const o=n.finish();s.device.queue.submit([o])}}const kl=Object.freeze({None:0,Transient:1});class Lt{constructor(){O(this,"config",null);O(this,"buffer",null)}init(s,n){this.config=n;let o=null;if(n.raw_data)o=n.raw_data;else{const l=n.data.flat();o=new Float32Array(l.length),o.set(l)}this.config.size=o.byteLength,this.buffer=s.device.createBuffer({label:this.config.name,size:this.config.size,usage:this.config.usage}),this.write(s,o)}destroy(s){this.buffer&&(this.buffer=null,V.get().remove(K.BUFFER,oe.from(this.config.name)))}write(s,n,o=0){const l=ArrayBuffer.isView(n),c=l?n:n.flat(),d=l?c:new Float32Array(c.length);d.set(c),s.device.queue.writeBuffer(this.buffer,o,d)}write_raw(s,n,o=0){s.device.queue.writeBuffer(this.buffer,o,n)}read(s,n,o,l=0,c=0){const d=new Float32Array(this.buffer.getMappedRange());n.set(d.subarray(l,l+o),c),this.buffer.unmap()}bind_vertex(s,n=0){s.setVertexBuffer(n,this.buffer)}get physical_id(){return oe.from(this.config.name)}static create(s,n){let o=V.get().fetch(K.BUFFER,oe.from(n.name));return o||(o=new Lt,o.init(s,n),V.get().store(K.BUFFER,oe.from(n.name),o)),o}}const et=Object.freeze({None:0,Transient:1,LocalLoad:2});class gm{constructor(){O(this,"name",null);O(this,"width",0);O(this,"height",0);O(this,"depth",0);O(this,"mip_levels",1);O(this,"format","rgba8unorm");O(this,"usage",GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.SAMPLED);O(this,"sample_count",1);O(this,"dimension","2d");O(this,"b_is_bindless",!1);O(this,"flags",et.None);O(this,"clear_value",{r:0,g:0,b:0,a:1});O(this,"load_op","clear");O(this,"store_op","store")}}let es=class ni{constructor(){O(this,"config",new gm);O(this,"image",null);O(this,"view",null)}init(s,n){this.config={...this.config,...n},this.config.type=n.format.includes("depth")?"depth":"color",this.config.type==="depth"&&(this.config.clear_value=1,this.config.load_op="clear"),this.image=s.device.createTexture({label:n.name,size:{width:n.width,height:n.height,depthOrArrayLayers:n.depth},mipLevelCount:n.mip_levels,sampleCount:n.sample_count,dimension:n.dimension,format:n.format,usage:n.usage}),this.view=this.create_view()}async load(s,n,o){this.config={...this.config,...o},this.config.type=o.format.includes("depth")?"depth":"color",this.config.type==="depth"&&(this.config.clear_value=1,this.config.load_op="clear");async function l(d){const y=await new Promise((w,S)=>{const I=new Image;I.onload=()=>w(I),I.onerror=S,I.src=d});return await createImageBitmap(y,{colorSpaceConversion:"none"})}const c=await Promise.all(n.map(l));this.config.width=c[0].width,this.config.height=c[0].height,this.config.depth=c.length,this.image=s.device.createTexture({label:this.config.name,size:{width:this.config.width,height:this.config.height,depthOrArrayLayers:this.config.depth},mipLevelCount:o.mip_levels,sampleCount:o.sample_count,format:o.format,usage:o.usage}),c.forEach((d,y)=>{s.device.queue.copyExternalImageToTexture({source:d,flipY:!0},{texture:this.image,origin:{x:0,y:0,z:y}},[d.width,d.height])}),this.view=this.create_view()}set_image(s){this.image=s,this.config.width=s.width,this.config.height=s.height,this.config.depth=s.depthOrArrayLayers,this.config.mip_levels=s.mipLevelCount,this.config.sample_count=s.sampleCount,this.config.usage=s.usage,this.config.format=s.format,this.config.dimension=s.dimension,this.config.type=this.config.format.includes("depth")?"depth":"color",this.config.type==="depth"?(this.config.clear_value=1,this.config.load_op="clear"):(this.config.clear_value={r:0,g:0,b:0,a:1},this.config.load_op="clear"),this.view=this.create_view()}create_view(s={}){return this.image.createView({label:this.config.name,dimension:this.config.dimension,format:this.config.format,aspect:s.aspect??"all",baseMipLevel:s.baseMipLevel??0,mipLevelCount:s.mipLevelCount??this.config.mip_levels,baseArrayLayer:s.baseArrayLayer??0,arrayLayerCount:s.arrayLayerCount??this.config.depth})}copy_buffer(s,n){s.copyBufferToImage({buffer:n.buffer},{texture:this.image},{width:this.config.width,height:this.config.height,depthOrArrayLayers:1})}copy_texture(s,n){s.copyTextureToTexture({texture:n.image},{texture:this.image},{width:this.config.width,height:this.config.height,depthOrArrayLayers:1})}get physical_id(){return oe.from(this.config.name)}static get_default_sampler(s){let n=V.get().fetch(K.SAMPLER,oe.from("default_sampler"));return n||(n=s.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),V.get().store(K.SAMPLER,oe.from("default_sampler"),n),n)}static create(s,n){let o=V.get().fetch(K.IMAGE,oe.from(n.name));return o||(o=new ni,o.init(s,n),V.get().store(K.IMAGE,oe.from(n.name),o),o)}static create_from_texture(s,n){let o=V.get().fetch(K.IMAGE,oe.from(n));return o?(o.set_image(s),o):(o=new ni,o.config={name:n},V.get().store(K.IMAGE,oe.from(n),o),o.set_image(s),o)}static async load(s,n,o){let l=V.get().fetch(K.IMAGE,oe.from(o.name));return l||(l=new ni,await l.load(s,n,o),V.get().store(K.IMAGE,oe.from(o.name),l),l)}static dimension_from_type_name(s){switch(s){case"texture_2d":case"texture_2d_depth":return"2d";case"texture_cube":return"cube";case"texture_3d":return"3d";case"texture_array":return"2d_array";case"texture_cube_array":return"cube_array";default:return"2d"}}};var Zr=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function pm(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Jn={};(function(r){Object.defineProperty(r,"__esModule",{value:!0});class s{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class n{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(a){throw new Error("Cannot evaluate node")}evaluateString(a){return this.evaluate(a).toString()}search(a){}searchBlock(a,h){if(a){h(o.instance);for(const m of a)m instanceof Array?this.searchBlock(m,h):m.search(h);h(l.instance)}}}class o extends n{}o.instance=new o;class l extends n{}l.instance=new l;class c extends n{constructor(){super()}}class d extends c{constructor(a,h,m,b,C,L){super(),this.calls=new Set,this.name=a,this.args=h,this.returnType=m,this.body=b,this.startLine=C,this.endLine=L}get astNodeType(){return"function"}search(a){this.searchBlock(this.body,a)}}class y extends c{constructor(a){super(),this.expression=a}get astNodeType(){return"staticAssert"}search(a){this.expression.search(a)}}class w extends c{constructor(a,h){super(),this.condition=a,this.body=h}get astNodeType(){return"while"}search(a){this.condition.search(a),this.searchBlock(this.body,a)}}class S extends c{constructor(a){super(),this.body=a}get astNodeType(){return"continuing"}search(a){this.searchBlock(this.body,a)}}class I extends c{constructor(a,h,m,b){super(),this.init=a,this.condition=h,this.increment=m,this.body=b}get astNodeType(){return"for"}search(a){var h,m,b;(h=this.init)===null||h===void 0||h.search(a),(m=this.condition)===null||m===void 0||m.search(a),(b=this.increment)===null||b===void 0||b.search(a),this.searchBlock(this.body,a)}}class M extends c{constructor(a,h,m,b,C){super(),this.name=a,this.type=h,this.storage=m,this.access=b,this.value=C}get astNodeType(){return"var"}search(a){var h;a(this),(h=this.value)===null||h===void 0||h.search(a)}}class z extends c{constructor(a,h,m){super(),this.name=a,this.type=h,this.value=m}get astNodeType(){return"override"}search(a){var h;(h=this.value)===null||h===void 0||h.search(a)}}class N extends c{constructor(a,h,m,b,C){super(),this.name=a,this.type=h,this.storage=m,this.access=b,this.value=C}get astNodeType(){return"let"}search(a){var h;a(this),(h=this.value)===null||h===void 0||h.search(a)}}class q extends c{constructor(a,h,m,b,C){super(),this.name=a,this.type=h,this.storage=m,this.access=b,this.value=C}get astNodeType(){return"const"}evaluate(a){return this.value.evaluate(a)}search(a){var h;a(this),(h=this.value)===null||h===void 0||h.search(a)}}r.IncrementOperator=void 0,function(F){F.increment="++",F.decrement="--"}(r.IncrementOperator||(r.IncrementOperator={})),function(F){function a(h){const m=h;if(m=="parse")throw new Error("Invalid value for IncrementOperator");return F[m]}F.parse=a}(r.IncrementOperator||(r.IncrementOperator={}));class X extends c{constructor(a,h){super(),this.operator=a,this.variable=h}get astNodeType(){return"increment"}search(a){this.variable.search(a)}}r.AssignOperator=void 0,function(F){F.assign="=",F.addAssign="+=",F.subtractAssin="-=",F.multiplyAssign="*=",F.divideAssign="/=",F.moduloAssign="%=",F.andAssign="&=",F.orAssign="|=",F.xorAssign="^=",F.shiftLeftAssign="<<=",F.shiftRightAssign=">>="}(r.AssignOperator||(r.AssignOperator={})),function(F){function a(h){const m=h;if(m=="parse")throw new Error("Invalid value for AssignOperator");return m}F.parse=a}(r.AssignOperator||(r.AssignOperator={}));class D extends c{constructor(a,h,m){super(),this.operator=a,this.variable=h,this.value=m}get astNodeType(){return"assign"}search(a){this.variable.search(a),this.value.search(a)}}class H extends c{constructor(a,h){super(),this.name=a,this.args=h}get astNodeType(){return"call"}search(a){for(const h of this.args)h.search(a);a(this)}}class ce extends c{constructor(a,h){super(),this.body=a,this.continuing=h}get astNodeType(){return"loop"}}class Q extends c{constructor(a,h){super(),this.condition=a,this.body=h}get astNodeType(){return"body"}}class ne extends c{constructor(a,h,m,b){super(),this.condition=a,this.body=h,this.elseif=m,this.else=b}get astNodeType(){return"if"}search(a){this.condition.search(a),this.searchBlock(this.body,a),this.searchBlock(this.elseif,a),this.searchBlock(this.else,a)}}class ee extends c{constructor(a){super(),this.value=a}get astNodeType(){return"return"}search(a){var h;(h=this.value)===null||h===void 0||h.search(a)}}class j extends c{constructor(a){super(),this.name=a}get astNodeType(){return"enable"}}class Me extends c{constructor(a){super(),this.extensions=a}get astNodeType(){return"requires"}}class Fe extends c{constructor(a,h){super(),this.severity=a,this.rule=h}get astNodeType(){return"diagnostic"}}class ht extends c{constructor(a,h){super(),this.name=a,this.type=h}get astNodeType(){return"alias"}}class Wt extends c{constructor(){super()}get astNodeType(){return"discard"}}class $t extends c{constructor(){super()}get astNodeType(){return"break"}}class Ht extends c{constructor(){super()}get astNodeType(){return"continue"}}class We extends c{constructor(a){super(),this.name=a}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class ye extends We{constructor(a,h,m,b){super(a),this.members=h,this.startLine=m,this.endLine=b}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(a){for(let h=0;h<this.members.length;h++)if(this.members[h].name==a)return h;return-1}}class Mr extends We{constructor(a,h,m){super(a),this.format=h,this.access=m}get astNodeType(){return"template"}}class rs extends We{constructor(a,h,m,b){super(a),this.storage=h,this.type=m,this.access=b}get astNodeType(){return"pointer"}}class Ut extends We{constructor(a,h,m,b){super(a),this.attributes=h,this.format=m,this.count=b}get astNodeType(){return"array"}get isArray(){return!0}}class Ze extends We{constructor(a,h,m){super(a),this.format=h,this.access=m}get astNodeType(){return"sampler"}}class tt extends n{constructor(){super()}}class mn extends tt{constructor(a){super(),this.value=a}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class Ne extends tt{constructor(a,h){super(),this.type=a,this.args=h}get astNodeType(){return"createExpr"}search(a){a(this);for(const h of this.args)h.search(a)}}class Rr extends tt{constructor(a,h){super(),this.name=a,this.args=h}get astNodeType(){return"callExpr"}evaluate(a){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(a));case"acos":return Math.acos(this.args[0].evaluate(a));case"acosh":return Math.acosh(this.args[0].evaluate(a));case"asin":return Math.asin(this.args[0].evaluate(a));case"asinh":return Math.asinh(this.args[0].evaluate(a));case"atan":return Math.atan(this.args[0].evaluate(a));case"atan2":return Math.atan2(this.args[0].evaluate(a),this.args[1].evaluate(a));case"atanh":return Math.atanh(this.args[0].evaluate(a));case"ceil":return Math.ceil(this.args[0].evaluate(a));case"clamp":return Math.min(Math.max(this.args[0].evaluate(a),this.args[1].evaluate(a)),this.args[2].evaluate(a));case"cos":return Math.cos(this.args[0].evaluate(a));case"degrees":return this.args[0].evaluate(a)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(a)-this.args[1].evaluate(a),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(a));case"exp2":return Math.pow(2,this.args[0].evaluate(a));case"floor":return Math.floor(this.args[0].evaluate(a));case"fma":return this.args[0].evaluate(a)*this.args[1].evaluate(a)+this.args[2].evaluate(a);case"fract":return this.args[0].evaluate(a)-Math.floor(this.args[0].evaluate(a));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(a));case"log":return Math.log(this.args[0].evaluate(a));case"log2":return Math.log2(this.args[0].evaluate(a));case"max":return Math.max(this.args[0].evaluate(a),this.args[1].evaluate(a));case"min":return Math.min(this.args[0].evaluate(a),this.args[1].evaluate(a));case"mix":return this.args[0].evaluate(a)*(1-this.args[2].evaluate(a))+this.args[1].evaluate(a)*this.args[2].evaluate(a);case"modf":return this.args[0].evaluate(a)-Math.floor(this.args[0].evaluate(a));case"pow":return Math.pow(this.args[0].evaluate(a),this.args[1].evaluate(a));case"radians":return this.args[0].evaluate(a)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(a));case"sign":return Math.sign(this.args[0].evaluate(a));case"sin":return Math.sin(this.args[0].evaluate(a));case"sinh":return Math.sinh(this.args[0].evaluate(a));case"saturate":return Math.min(Math.max(this.args[0].evaluate(a),0),1);case"smoothstep":return this.args[0].evaluate(a)*this.args[0].evaluate(a)*(3-2*this.args[0].evaluate(a));case"sqrt":return Math.sqrt(this.args[0].evaluate(a));case"step":return this.args[0].evaluate(a)<this.args[1].evaluate(a)?0:1;case"tan":return Math.tan(this.args[0].evaluate(a));case"tanh":return Math.tanh(this.args[0].evaluate(a));case"trunc":return Math.trunc(this.args[0].evaluate(a));default:throw new Error("Non const function: "+this.name)}}search(a){for(const h of this.args)h.search(a);a(this)}}class er extends tt{constructor(a){super(),this.name=a}get astNodeType(){return"varExpr"}search(a){a(this),this.postfix&&this.postfix.search(a)}evaluate(a){const h=a.constants.get(this.name);if(!h)throw new Error("Cannot evaluate node");return h.evaluate(a)}}class Br extends tt{constructor(a,h){super(),this.name=a,this.initializer=h}get astNodeType(){return"constExpr"}evaluate(a){var h,m;if(this.initializer instanceof Ne){const b=(h=this.postfix)===null||h===void 0?void 0:h.evaluateString(a),C=(m=this.initializer.type)===null||m===void 0?void 0:m.name,L=a.structs.get(C),W=L==null?void 0:L.getMemberIndex(b);if(W!=-1)return this.initializer.args[W].evaluate(a);console.log(W)}return this.initializer.evaluate(a)}search(a){this.initializer.search(a)}}class Vt extends tt{constructor(a){super(),this.value=a}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class Nn extends tt{constructor(a,h){super(),this.type=a,this.value=h}get astNodeType(){return"bitcastExpr"}search(a){this.value.search(a)}}class ss extends tt{constructor(a,h){super(),this.type=a,this.args=h}get astNodeType(){return"typecastExpr"}evaluate(a){return this.args[0].evaluate(a)}search(a){this.searchBlock(this.args,a)}}class tn extends tt{constructor(a){super(),this.contents=a}get astNodeType(){return"groupExpr"}evaluate(a){return this.contents[0].evaluate(a)}search(a){this.searchBlock(this.contents,a)}}class yn extends tt{constructor(a){super(),this.index=a}search(a){this.index.search(a)}}class Fr extends tt{constructor(){super()}}class zn extends Fr{constructor(a,h){super(),this.operator=a,this.right=h}get astNodeType(){return"unaryOp"}evaluate(a){switch(this.operator){case"+":return this.right.evaluate(a);case"-":return-this.right.evaluate(a);case"!":return this.right.evaluate(a)?0:1;case"~":return~this.right.evaluate(a);default:throw new Error("Unknown unary operator: "+this.operator)}}search(a){this.right.search(a)}}class $e extends Fr{constructor(a,h,m){super(),this.operator=a,this.left=h,this.right=m}get astNodeType(){return"binaryOp"}evaluate(a){switch(this.operator){case"+":return this.left.evaluate(a)+this.right.evaluate(a);case"-":return this.left.evaluate(a)-this.right.evaluate(a);case"*":return this.left.evaluate(a)*this.right.evaluate(a);case"/":return this.left.evaluate(a)/this.right.evaluate(a);case"%":return this.left.evaluate(a)%this.right.evaluate(a);case"==":return this.left.evaluate(a)==this.right.evaluate(a)?1:0;case"!=":return this.left.evaluate(a)!=this.right.evaluate(a)?1:0;case"<":return this.left.evaluate(a)<this.right.evaluate(a)?1:0;case">":return this.left.evaluate(a)>this.right.evaluate(a)?1:0;case"<=":return this.left.evaluate(a)<=this.right.evaluate(a)?1:0;case">=":return this.left.evaluate(a)>=this.right.evaluate(a)?1:0;case"&&":return this.left.evaluate(a)&&this.right.evaluate(a)?1:0;case"||":return this.left.evaluate(a)||this.right.evaluate(a)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(a){this.left.search(a),this.right.search(a)}}class tr extends n{constructor(){super()}}class nt extends tr{constructor(a,h){super(),this.selector=a,this.body=h}get astNodeType(){return"case"}search(a){this.searchBlock(this.body,a)}}class vn extends tr{constructor(a){super(),this.body=a}get astNodeType(){return"default"}search(a){this.searchBlock(this.body,a)}}class is extends n{constructor(a,h,m){super(),this.name=a,this.type=h,this.attributes=m}get astNodeType(){return"argument"}}class bt extends n{constructor(a,h){super(),this.condition=a,this.body=h}get astNodeType(){return"elseif"}search(a){this.condition.search(a),this.searchBlock(this.body,a)}}class Lr extends n{constructor(a,h,m){super(),this.name=a,this.type=h,this.attributes=m}get astNodeType(){return"member"}}class as extends n{constructor(a,h){super(),this.name=a,this.value=h}get astNodeType(){return"attribute"}}var E;r.TokenClass=void 0,function(F){F[F.token=0]="token",F[F.keyword=1]="keyword",F[F.reserved=2]="reserved"}(r.TokenClass||(r.TokenClass={}));class k{constructor(a,h,m){this.name=a,this.type=h,this.rule=m}toString(){return this.name}}class p{}E=p,p.none=new k("",r.TokenClass.reserved,""),p.eof=new k("EOF",r.TokenClass.token,""),p.reserved={asm:new k("asm",r.TokenClass.reserved,"asm"),bf16:new k("bf16",r.TokenClass.reserved,"bf16"),do:new k("do",r.TokenClass.reserved,"do"),enum:new k("enum",r.TokenClass.reserved,"enum"),f16:new k("f16",r.TokenClass.reserved,"f16"),f64:new k("f64",r.TokenClass.reserved,"f64"),handle:new k("handle",r.TokenClass.reserved,"handle"),i8:new k("i8",r.TokenClass.reserved,"i8"),i16:new k("i16",r.TokenClass.reserved,"i16"),i64:new k("i64",r.TokenClass.reserved,"i64"),mat:new k("mat",r.TokenClass.reserved,"mat"),premerge:new k("premerge",r.TokenClass.reserved,"premerge"),regardless:new k("regardless",r.TokenClass.reserved,"regardless"),typedef:new k("typedef",r.TokenClass.reserved,"typedef"),u8:new k("u8",r.TokenClass.reserved,"u8"),u16:new k("u16",r.TokenClass.reserved,"u16"),u64:new k("u64",r.TokenClass.reserved,"u64"),unless:new k("unless",r.TokenClass.reserved,"unless"),using:new k("using",r.TokenClass.reserved,"using"),vec:new k("vec",r.TokenClass.reserved,"vec"),void:new k("void",r.TokenClass.reserved,"void")},p.keywords={array:new k("array",r.TokenClass.keyword,"array"),atomic:new k("atomic",r.TokenClass.keyword,"atomic"),bool:new k("bool",r.TokenClass.keyword,"bool"),f32:new k("f32",r.TokenClass.keyword,"f32"),i32:new k("i32",r.TokenClass.keyword,"i32"),mat2x2:new k("mat2x2",r.TokenClass.keyword,"mat2x2"),mat2x3:new k("mat2x3",r.TokenClass.keyword,"mat2x3"),mat2x4:new k("mat2x4",r.TokenClass.keyword,"mat2x4"),mat3x2:new k("mat3x2",r.TokenClass.keyword,"mat3x2"),mat3x3:new k("mat3x3",r.TokenClass.keyword,"mat3x3"),mat3x4:new k("mat3x4",r.TokenClass.keyword,"mat3x4"),mat4x2:new k("mat4x2",r.TokenClass.keyword,"mat4x2"),mat4x3:new k("mat4x3",r.TokenClass.keyword,"mat4x3"),mat4x4:new k("mat4x4",r.TokenClass.keyword,"mat4x4"),ptr:new k("ptr",r.TokenClass.keyword,"ptr"),sampler:new k("sampler",r.TokenClass.keyword,"sampler"),sampler_comparison:new k("sampler_comparison",r.TokenClass.keyword,"sampler_comparison"),struct:new k("struct",r.TokenClass.keyword,"struct"),texture_1d:new k("texture_1d",r.TokenClass.keyword,"texture_1d"),texture_2d:new k("texture_2d",r.TokenClass.keyword,"texture_2d"),texture_2d_array:new k("texture_2d_array",r.TokenClass.keyword,"texture_2d_array"),texture_3d:new k("texture_3d",r.TokenClass.keyword,"texture_3d"),texture_cube:new k("texture_cube",r.TokenClass.keyword,"texture_cube"),texture_cube_array:new k("texture_cube_array",r.TokenClass.keyword,"texture_cube_array"),texture_multisampled_2d:new k("texture_multisampled_2d",r.TokenClass.keyword,"texture_multisampled_2d"),texture_storage_1d:new k("texture_storage_1d",r.TokenClass.keyword,"texture_storage_1d"),texture_storage_2d:new k("texture_storage_2d",r.TokenClass.keyword,"texture_storage_2d"),texture_storage_2d_array:new k("texture_storage_2d_array",r.TokenClass.keyword,"texture_storage_2d_array"),texture_storage_3d:new k("texture_storage_3d",r.TokenClass.keyword,"texture_storage_3d"),texture_depth_2d:new k("texture_depth_2d",r.TokenClass.keyword,"texture_depth_2d"),texture_depth_2d_array:new k("texture_depth_2d_array",r.TokenClass.keyword,"texture_depth_2d_array"),texture_depth_cube:new k("texture_depth_cube",r.TokenClass.keyword,"texture_depth_cube"),texture_depth_cube_array:new k("texture_depth_cube_array",r.TokenClass.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new k("texture_depth_multisampled_2d",r.TokenClass.keyword,"texture_depth_multisampled_2d"),texture_external:new k("texture_external",r.TokenClass.keyword,"texture_external"),u32:new k("u32",r.TokenClass.keyword,"u32"),vec2:new k("vec2",r.TokenClass.keyword,"vec2"),vec3:new k("vec3",r.TokenClass.keyword,"vec3"),vec4:new k("vec4",r.TokenClass.keyword,"vec4"),bitcast:new k("bitcast",r.TokenClass.keyword,"bitcast"),block:new k("block",r.TokenClass.keyword,"block"),break:new k("break",r.TokenClass.keyword,"break"),case:new k("case",r.TokenClass.keyword,"case"),continue:new k("continue",r.TokenClass.keyword,"continue"),continuing:new k("continuing",r.TokenClass.keyword,"continuing"),default:new k("default",r.TokenClass.keyword,"default"),diagnostic:new k("diagnostic",r.TokenClass.keyword,"diagnostic"),discard:new k("discard",r.TokenClass.keyword,"discard"),else:new k("else",r.TokenClass.keyword,"else"),enable:new k("enable",r.TokenClass.keyword,"enable"),fallthrough:new k("fallthrough",r.TokenClass.keyword,"fallthrough"),false:new k("false",r.TokenClass.keyword,"false"),fn:new k("fn",r.TokenClass.keyword,"fn"),for:new k("for",r.TokenClass.keyword,"for"),function:new k("function",r.TokenClass.keyword,"function"),if:new k("if",r.TokenClass.keyword,"if"),let:new k("let",r.TokenClass.keyword,"let"),const:new k("const",r.TokenClass.keyword,"const"),loop:new k("loop",r.TokenClass.keyword,"loop"),while:new k("while",r.TokenClass.keyword,"while"),private:new k("private",r.TokenClass.keyword,"private"),read:new k("read",r.TokenClass.keyword,"read"),read_write:new k("read_write",r.TokenClass.keyword,"read_write"),return:new k("return",r.TokenClass.keyword,"return"),requires:new k("requires",r.TokenClass.keyword,"requires"),storage:new k("storage",r.TokenClass.keyword,"storage"),switch:new k("switch",r.TokenClass.keyword,"switch"),true:new k("true",r.TokenClass.keyword,"true"),alias:new k("alias",r.TokenClass.keyword,"alias"),type:new k("type",r.TokenClass.keyword,"type"),uniform:new k("uniform",r.TokenClass.keyword,"uniform"),var:new k("var",r.TokenClass.keyword,"var"),override:new k("override",r.TokenClass.keyword,"override"),workgroup:new k("workgroup",r.TokenClass.keyword,"workgroup"),write:new k("write",r.TokenClass.keyword,"write"),r8unorm:new k("r8unorm",r.TokenClass.keyword,"r8unorm"),r8snorm:new k("r8snorm",r.TokenClass.keyword,"r8snorm"),r8uint:new k("r8uint",r.TokenClass.keyword,"r8uint"),r8sint:new k("r8sint",r.TokenClass.keyword,"r8sint"),r16uint:new k("r16uint",r.TokenClass.keyword,"r16uint"),r16sint:new k("r16sint",r.TokenClass.keyword,"r16sint"),r16float:new k("r16float",r.TokenClass.keyword,"r16float"),rg8unorm:new k("rg8unorm",r.TokenClass.keyword,"rg8unorm"),rg8snorm:new k("rg8snorm",r.TokenClass.keyword,"rg8snorm"),rg8uint:new k("rg8uint",r.TokenClass.keyword,"rg8uint"),rg8sint:new k("rg8sint",r.TokenClass.keyword,"rg8sint"),r32uint:new k("r32uint",r.TokenClass.keyword,"r32uint"),r32sint:new k("r32sint",r.TokenClass.keyword,"r32sint"),r32float:new k("r32float",r.TokenClass.keyword,"r32float"),rg16uint:new k("rg16uint",r.TokenClass.keyword,"rg16uint"),rg16sint:new k("rg16sint",r.TokenClass.keyword,"rg16sint"),rg16float:new k("rg16float",r.TokenClass.keyword,"rg16float"),rgba8unorm:new k("rgba8unorm",r.TokenClass.keyword,"rgba8unorm"),rgba8unorm_srgb:new k("rgba8unorm_srgb",r.TokenClass.keyword,"rgba8unorm_srgb"),rgba8snorm:new k("rgba8snorm",r.TokenClass.keyword,"rgba8snorm"),rgba8uint:new k("rgba8uint",r.TokenClass.keyword,"rgba8uint"),rgba8sint:new k("rgba8sint",r.TokenClass.keyword,"rgba8sint"),bgra8unorm:new k("bgra8unorm",r.TokenClass.keyword,"bgra8unorm"),bgra8unorm_srgb:new k("bgra8unorm_srgb",r.TokenClass.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new k("rgb10a2unorm",r.TokenClass.keyword,"rgb10a2unorm"),rg11b10float:new k("rg11b10float",r.TokenClass.keyword,"rg11b10float"),rg32uint:new k("rg32uint",r.TokenClass.keyword,"rg32uint"),rg32sint:new k("rg32sint",r.TokenClass.keyword,"rg32sint"),rg32float:new k("rg32float",r.TokenClass.keyword,"rg32float"),rgba16uint:new k("rgba16uint",r.TokenClass.keyword,"rgba16uint"),rgba16sint:new k("rgba16sint",r.TokenClass.keyword,"rgba16sint"),rgba16float:new k("rgba16float",r.TokenClass.keyword,"rgba16float"),rgba32uint:new k("rgba32uint",r.TokenClass.keyword,"rgba32uint"),rgba32sint:new k("rgba32sint",r.TokenClass.keyword,"rgba32sint"),rgba32float:new k("rgba32float",r.TokenClass.keyword,"rgba32float"),static_assert:new k("static_assert",r.TokenClass.keyword,"static_assert")},p.tokens={decimal_float_literal:new k("decimal_float_literal",r.TokenClass.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new k("hex_float_literal",r.TokenClass.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new k("int_literal",r.TokenClass.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new k("uint_literal",r.TokenClass.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new k("ident",r.TokenClass.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new k("and",r.TokenClass.token,"&"),and_and:new k("and_and",r.TokenClass.token,"&&"),arrow:new k("arrow ",r.TokenClass.token,"->"),attr:new k("attr",r.TokenClass.token,"@"),forward_slash:new k("forward_slash",r.TokenClass.token,"/"),bang:new k("bang",r.TokenClass.token,"!"),bracket_left:new k("bracket_left",r.TokenClass.token,"["),bracket_right:new k("bracket_right",r.TokenClass.token,"]"),brace_left:new k("brace_left",r.TokenClass.token,"{"),brace_right:new k("brace_right",r.TokenClass.token,"}"),colon:new k("colon",r.TokenClass.token,":"),comma:new k("comma",r.TokenClass.token,","),equal:new k("equal",r.TokenClass.token,"="),equal_equal:new k("equal_equal",r.TokenClass.token,"=="),not_equal:new k("not_equal",r.TokenClass.token,"!="),greater_than:new k("greater_than",r.TokenClass.token,">"),greater_than_equal:new k("greater_than_equal",r.TokenClass.token,">="),shift_right:new k("shift_right",r.TokenClass.token,">>"),less_than:new k("less_than",r.TokenClass.token,"<"),less_than_equal:new k("less_than_equal",r.TokenClass.token,"<="),shift_left:new k("shift_left",r.TokenClass.token,"<<"),modulo:new k("modulo",r.TokenClass.token,"%"),minus:new k("minus",r.TokenClass.token,"-"),minus_minus:new k("minus_minus",r.TokenClass.token,"--"),period:new k("period",r.TokenClass.token,"."),plus:new k("plus",r.TokenClass.token,"+"),plus_plus:new k("plus_plus",r.TokenClass.token,"++"),or:new k("or",r.TokenClass.token,"|"),or_or:new k("or_or",r.TokenClass.token,"||"),paren_left:new k("paren_left",r.TokenClass.token,"("),paren_right:new k("paren_right",r.TokenClass.token,")"),semicolon:new k("semicolon",r.TokenClass.token,";"),star:new k("star",r.TokenClass.token,"*"),tilde:new k("tilde",r.TokenClass.token,"~"),underscore:new k("underscore",r.TokenClass.token,"_"),xor:new k("xor",r.TokenClass.token,"^"),plus_equal:new k("plus_equal",r.TokenClass.token,"+="),minus_equal:new k("minus_equal",r.TokenClass.token,"-="),times_equal:new k("times_equal",r.TokenClass.token,"*="),division_equal:new k("division_equal",r.TokenClass.token,"/="),modulo_equal:new k("modulo_equal",r.TokenClass.token,"%="),and_equal:new k("and_equal",r.TokenClass.token,"&="),or_equal:new k("or_equal",r.TokenClass.token,"|="),xor_equal:new k("xor_equal",r.TokenClass.token,"^="),shift_right_equal:new k("shift_right_equal",r.TokenClass.token,">>="),shift_left_equal:new k("shift_left_equal",r.TokenClass.token,"<<=")},p.simpleTokens={"@":E.tokens.attr,"{":E.tokens.brace_left,"}":E.tokens.brace_right,":":E.tokens.colon,",":E.tokens.comma,"(":E.tokens.paren_left,")":E.tokens.paren_right,";":E.tokens.semicolon},p.literalTokens={"&":E.tokens.and,"&&":E.tokens.and_and,"->":E.tokens.arrow,"/":E.tokens.forward_slash,"!":E.tokens.bang,"[":E.tokens.bracket_left,"]":E.tokens.bracket_right,"=":E.tokens.equal,"==":E.tokens.equal_equal,"!=":E.tokens.not_equal,">":E.tokens.greater_than,">=":E.tokens.greater_than_equal,">>":E.tokens.shift_right,"<":E.tokens.less_than,"<=":E.tokens.less_than_equal,"<<":E.tokens.shift_left,"%":E.tokens.modulo,"-":E.tokens.minus,"--":E.tokens.minus_minus,".":E.tokens.period,"+":E.tokens.plus,"++":E.tokens.plus_plus,"|":E.tokens.or,"||":E.tokens.or_or,"*":E.tokens.star,"~":E.tokens.tilde,_:E.tokens.underscore,"^":E.tokens.xor,"+=":E.tokens.plus_equal,"-=":E.tokens.minus_equal,"*=":E.tokens.times_equal,"/=":E.tokens.division_equal,"%=":E.tokens.modulo_equal,"&=":E.tokens.and_equal,"|=":E.tokens.or_equal,"^=":E.tokens.xor_equal,">>=":E.tokens.shift_right_equal,"<<=":E.tokens.shift_left_equal},p.regexTokens={decimal_float_literal:E.tokens.decimal_float_literal,hex_float_literal:E.tokens.hex_float_literal,int_literal:E.tokens.int_literal,uint_literal:E.tokens.uint_literal,ident:E.tokens.ident},p.storage_class=[E.keywords.function,E.keywords.private,E.keywords.workgroup,E.keywords.uniform,E.keywords.storage],p.access_mode=[E.keywords.read,E.keywords.write,E.keywords.read_write],p.sampler_type=[E.keywords.sampler,E.keywords.sampler_comparison],p.sampled_texture_type=[E.keywords.texture_1d,E.keywords.texture_2d,E.keywords.texture_2d_array,E.keywords.texture_3d,E.keywords.texture_cube,E.keywords.texture_cube_array],p.multisampled_texture_type=[E.keywords.texture_multisampled_2d],p.storage_texture_type=[E.keywords.texture_storage_1d,E.keywords.texture_storage_2d,E.keywords.texture_storage_2d_array,E.keywords.texture_storage_3d],p.depth_texture_type=[E.keywords.texture_depth_2d,E.keywords.texture_depth_2d_array,E.keywords.texture_depth_cube,E.keywords.texture_depth_cube_array,E.keywords.texture_depth_multisampled_2d],p.texture_external_type=[E.keywords.texture_external],p.any_texture_type=[...E.sampled_texture_type,...E.multisampled_texture_type,...E.storage_texture_type,...E.depth_texture_type,...E.texture_external_type],p.texel_format=[E.keywords.r8unorm,E.keywords.r8snorm,E.keywords.r8uint,E.keywords.r8sint,E.keywords.r16uint,E.keywords.r16sint,E.keywords.r16float,E.keywords.rg8unorm,E.keywords.rg8snorm,E.keywords.rg8uint,E.keywords.rg8sint,E.keywords.r32uint,E.keywords.r32sint,E.keywords.r32float,E.keywords.rg16uint,E.keywords.rg16sint,E.keywords.rg16float,E.keywords.rgba8unorm,E.keywords.rgba8unorm_srgb,E.keywords.rgba8snorm,E.keywords.rgba8uint,E.keywords.rgba8sint,E.keywords.bgra8unorm,E.keywords.bgra8unorm_srgb,E.keywords.rgb10a2unorm,E.keywords.rg11b10float,E.keywords.rg32uint,E.keywords.rg32sint,E.keywords.rg32float,E.keywords.rgba16uint,E.keywords.rgba16sint,E.keywords.rgba16float,E.keywords.rgba32uint,E.keywords.rgba32sint,E.keywords.rgba32float],p.const_literal=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal,E.keywords.true,E.keywords.false],p.literal_or_ident=[E.tokens.ident,E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal],p.element_count_expression=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.ident],p.template_types=[E.keywords.vec2,E.keywords.vec3,E.keywords.vec4,E.keywords.mat2x2,E.keywords.mat2x3,E.keywords.mat2x4,E.keywords.mat3x2,E.keywords.mat3x3,E.keywords.mat3x4,E.keywords.mat4x2,E.keywords.mat4x3,E.keywords.mat4x4,E.keywords.atomic,E.keywords.bitcast,...E.any_texture_type],p.attribute_name=[E.tokens.ident,E.keywords.block,E.keywords.diagnostic],p.assignment_operators=[E.tokens.equal,E.tokens.plus_equal,E.tokens.minus_equal,E.tokens.times_equal,E.tokens.division_equal,E.tokens.modulo_equal,E.tokens.and_equal,E.tokens.or_equal,E.tokens.xor_equal,E.tokens.shift_right_equal,E.tokens.shift_left_equal],p.increment_operators=[E.tokens.plus_plus,E.tokens.minus_minus];class wn{constructor(a,h,m){this.type=a,this.lexeme=h,this.line=m}toString(){return this.lexeme}isTemplateType(){return p.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==p.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class os{constructor(a){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=a??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new wn(p.eof,"",this._line)),this._tokens}scanToken(){let a=this._advance();if(a==`
`)return this._line++,!0;if(this._isWhitespace(a))return!0;if(a=="/"){if(this._peekAhead()=="/"){for(;a!=`
`;){if(this._isAtEnd())return!0;a=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let L=1;for(;L>0;){if(this._isAtEnd())return!0;if(a=this._advance(),a==`
`)this._line++;else if(a=="*"){if(this._peekAhead()=="/"&&(this._advance(),L--,L==0))return!0}else a=="/"&&this._peekAhead()=="*"&&(this._advance(),L++)}return!0}}const h=p.simpleTokens[a];if(h)return this._addToken(h),!0;let m=p.none;const b=this._isAlpha(a),C=a==="_";if(this._isAlphaNumeric(a)){let L=this._peekAhead();for(;this._isAlphaNumeric(L);)a+=this._advance(),L=this._peekAhead()}if(b){const L=p.keywords[a];if(L)return this._addToken(L),!0}if(b||C)return this._addToken(p.tokens.ident),!0;for(;;){let L=this._findType(a);const W=this._peekAhead();if(a==">"&&(W==">"||W=="=")){let Y=!1,re=this._tokens.length-1;for(let Te=0;Te<5&&re>=0;++Te,--re)if(this._tokens[re].type===p.tokens.less_than){re>0&&this._tokens[re-1].isArrayOrTemplateType()&&(Y=!0);break}if(Y)return this._addToken(L),!0}if(L===p.none){let Y=a,re=0;const Te=2;for(let rt=0;rt<Te;++rt)if(Y+=this._peekAhead(rt),L=this._findType(Y),L!==p.none){re=rt;break}if(L===p.none)return m===p.none?!1:(this._current--,this._addToken(m),!0);a=Y,this._current+=re+1}if(m=L,this._isAtEnd())break;a+=this._advance()}return m===p.none?!1:(this._addToken(m),!0)}_findType(a){for(const m in p.regexTokens){const b=p.regexTokens[m];if(this._match(a,b.rule))return b}const h=p.literalTokens[a];return h||p.none}_match(a,h){const m=h.exec(a);return m&&m.index==0&&m[0]==a}_isAtEnd(){return this._current>=this._source.length}_isAlpha(a){return a>="a"&&a<="z"||a>="A"&&a<="Z"}_isAlphaNumeric(a){return a>="a"&&a<="z"||a>="A"&&a<="Z"||a=="_"||a>="0"&&a<="9"}_isWhitespace(a){return a==" "||a=="	"||a=="\r"}_advance(a=0){let h=this._source[this._current];return a=a||0,a++,this._current+=a,h}_peekAhead(a=0){return a=a||0,this._current+a>=this._source.length?"\0":this._source[this._current+a]}_addToken(a){const h=this._source.substring(this._start,this._current);this._tokens.push(new wn(a,h,this._line))}}class bn{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new s,this._deferArrayCountEval=[]}parse(a){this._initialize(a),this._deferArrayCountEval.length=0;const h=[];for(;!this._isAtEnd();){const m=this._global_decl_or_directive();if(!m)break;h.push(m)}if(this._deferArrayCountEval.length>0){for(const m of this._deferArrayCountEval){const b=m.arrayType,C=m.countNode;if(C instanceof er){const W=C.name,Y=this._context.constants.get(W);if(Y)try{const re=Y.evaluate(this._context);b.count=re}catch{}}}this._deferArrayCountEval.length=0}return h}_initialize(a){if(a)if(typeof a=="string"){const h=new os(a);this._tokens=h.scanTokens()}else this._tokens=a;else this._tokens=[];this._current=0}_error(a,h){return{token:a,message:h,toString:function(){return`${h}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==p.eof}_match(a){if(a instanceof k)return this._check(a)?(this._advance(),!0):!1;for(let h=0,m=a.length;h<m;++h){const b=a[h];if(this._check(b))return this._advance(),!0}return!1}_consume(a,h){if(this._check(a))return this._advance();throw this._error(this._peek(),h)}_check(a){if(this._isAtEnd())return!1;const h=this._peek();if(a instanceof Array){const m=h.type;return a.indexOf(m)!=-1}return h.type==a}_advance(){var a,h;return this._currentLine=(h=(a=this._peek())===null||a===void 0?void 0:a.line)!==null&&h!==void 0?h:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(p.tokens.semicolon)&&!this._isAtEnd(););if(this._match(p.keywords.alias)){const h=this._type_alias();return this._consume(p.tokens.semicolon,"Expected ';'"),h}if(this._match(p.keywords.diagnostic)){const h=this._diagnostic();return this._consume(p.tokens.semicolon,"Expected ';'"),h}if(this._match(p.keywords.requires)){const h=this._requires_directive();return this._consume(p.tokens.semicolon,"Expected ';'"),h}if(this._match(p.keywords.enable)){const h=this._enable_directive();return this._consume(p.tokens.semicolon,"Expected ';'"),h}const a=this._attribute();if(this._check(p.keywords.var)){const h=this._global_variable_decl();return h!=null&&(h.attributes=a),this._consume(p.tokens.semicolon,"Expected ';'."),h}if(this._check(p.keywords.override)){const h=this._override_variable_decl();return h!=null&&(h.attributes=a),this._consume(p.tokens.semicolon,"Expected ';'."),h}if(this._check(p.keywords.let)){const h=this._global_let_decl();return h!=null&&(h.attributes=a),this._consume(p.tokens.semicolon,"Expected ';'."),h}if(this._check(p.keywords.const)){const h=this._global_const_decl();return h!=null&&(h.attributes=a),this._consume(p.tokens.semicolon,"Expected ';'."),h}if(this._check(p.keywords.struct)){const h=this._struct_decl();return h!=null&&(h.attributes=a),h}if(this._check(p.keywords.fn)){const h=this._function_decl();return h!=null&&(h.attributes=a),h}return null}_function_decl(){if(!this._match(p.keywords.fn))return null;const a=this._currentLine,h=this._consume(p.tokens.ident,"Expected function name.").toString();this._consume(p.tokens.paren_left,"Expected '(' for function arguments.");const m=[];if(!this._check(p.tokens.paren_right))do{if(this._check(p.tokens.paren_right))break;const W=this._attribute(),Y=this._consume(p.tokens.ident,"Expected argument name.").toString();this._consume(p.tokens.colon,"Expected ':' for argument type.");const re=this._attribute(),Te=this._type_decl();Te!=null&&(Te.attributes=re,m.push(new is(Y,Te,W)))}while(this._match(p.tokens.comma));this._consume(p.tokens.paren_right,"Expected ')' after function arguments.");let b=null;if(this._match(p.tokens.arrow)){const W=this._attribute();b=this._type_decl(),b!=null&&(b.attributes=W)}const C=this._compound_statement(),L=this._currentLine;return new d(h,m,b,C,a,L)}_compound_statement(){const a=[];for(this._consume(p.tokens.brace_left,"Expected '{' for block.");!this._check(p.tokens.brace_right);){const h=this._statement();h!==null&&a.push(h)}return this._consume(p.tokens.brace_right,"Expected '}' for block."),a}_statement(){for(;this._match(p.tokens.semicolon)&&!this._isAtEnd(););if(this._check(p.tokens.attr)&&this._attribute(),this._check(p.keywords.if))return this._if_statement();if(this._check(p.keywords.switch))return this._switch_statement();if(this._check(p.keywords.loop))return this._loop_statement();if(this._check(p.keywords.for))return this._for_statement();if(this._check(p.keywords.while))return this._while_statement();if(this._check(p.keywords.continuing))return this._continuing_statement();if(this._check(p.keywords.static_assert))return this._static_assert_statement();if(this._check(p.tokens.brace_left))return this._compound_statement();let a=null;return this._check(p.keywords.return)?a=this._return_statement():this._check([p.keywords.var,p.keywords.let,p.keywords.const])?a=this._variable_statement():this._match(p.keywords.discard)?a=new Wt:this._match(p.keywords.break)?a=new $t:this._match(p.keywords.continue)?a=new Ht:a=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),a!=null&&this._consume(p.tokens.semicolon,"Expected ';' after statement."),a}_static_assert_statement(){if(!this._match(p.keywords.static_assert))return null;const a=this._optional_paren_expression();return new y(a)}_while_statement(){if(!this._match(p.keywords.while))return null;const a=this._optional_paren_expression();this._check(p.tokens.attr)&&this._attribute();const h=this._compound_statement();return new w(a,h)}_continuing_statement(){if(!this._match(p.keywords.continuing))return null;const a=this._compound_statement();return new S(a)}_for_statement(){if(!this._match(p.keywords.for))return null;this._consume(p.tokens.paren_left,"Expected '('.");const a=this._check(p.tokens.semicolon)?null:this._for_init();this._consume(p.tokens.semicolon,"Expected ';'.");const h=this._check(p.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(p.tokens.semicolon,"Expected ';'.");const m=this._check(p.tokens.paren_right)?null:this._for_increment();this._consume(p.tokens.paren_right,"Expected ')'."),this._check(p.tokens.attr)&&this._attribute();const b=this._compound_statement();return new I(a,h,m,b)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(p.keywords.var)){const a=this._variable_decl();if(a===null)throw this._error(this._peek(),"Variable declaration expected.");let h=null;return this._match(p.tokens.equal)&&(h=this._short_circuit_or_expression()),new M(a.name,a.type,a.storage,a.access,h)}if(this._match(p.keywords.let)){const a=this._consume(p.tokens.ident,"Expected name for let.").toString();let h=null;if(this._match(p.tokens.colon)){const b=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=b)}this._consume(p.tokens.equal,"Expected '=' for let.");const m=this._short_circuit_or_expression();return new N(a,h,null,null,m)}if(this._match(p.keywords.const)){const a=this._consume(p.tokens.ident,"Expected name for const.").toString();let h=null;if(this._match(p.tokens.colon)){const b=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=b)}this._consume(p.tokens.equal,"Expected '=' for const.");const m=this._short_circuit_or_expression();return new q(a,h,null,null,m)}return null}_increment_decrement_statement(){const a=this._current,h=this._unary_expression();if(h==null)return null;if(!this._check(p.increment_operators))return this._current=a,null;const m=this._consume(p.increment_operators,"Expected increment operator");return new X(m.type===p.tokens.plus_plus?r.IncrementOperator.increment:r.IncrementOperator.decrement,h)}_assignment_statement(){let a=null;if(this._check(p.tokens.brace_right))return null;let h=this._match(p.tokens.underscore);if(h||(a=this._unary_expression()),!h&&a==null)return null;const m=this._consume(p.assignment_operators,"Expected assignment operator."),b=this._short_circuit_or_expression();return new D(r.AssignOperator.parse(m.lexeme),a,b)}_func_call_statement(){if(!this._check(p.tokens.ident))return null;const a=this._current,h=this._consume(p.tokens.ident,"Expected function name."),m=this._argument_expression_list();return m===null?(this._current=a,null):new H(h.lexeme,m)}_loop_statement(){if(!this._match(p.keywords.loop))return null;this._check(p.tokens.attr)&&this._attribute(),this._consume(p.tokens.brace_left,"Expected '{' for loop.");const a=[];let h=this._statement();for(;h!==null;){if(Array.isArray(h))for(let b of h)a.push(b);else a.push(h);h=this._statement()}let m=null;return this._match(p.keywords.continuing)&&(m=this._compound_statement()),this._consume(p.tokens.brace_right,"Expected '}' for loop."),new ce(a,m)}_switch_statement(){if(!this._match(p.keywords.switch))return null;const a=this._optional_paren_expression();this._check(p.tokens.attr)&&this._attribute(),this._consume(p.tokens.brace_left,"Expected '{' for switch.");const h=this._switch_body();if(h==null||h.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(p.tokens.brace_right,"Expected '}' for switch."),new Q(a,h)}_switch_body(){const a=[];if(this._match(p.keywords.case)){const h=this._case_selectors();this._match(p.tokens.colon),this._check(p.tokens.attr)&&this._attribute(),this._consume(p.tokens.brace_left,"Exected '{' for switch case.");const m=this._case_body();this._consume(p.tokens.brace_right,"Exected '}' for switch case."),a.push(new nt(h,m))}if(this._match(p.keywords.default)){this._match(p.tokens.colon),this._check(p.tokens.attr)&&this._attribute(),this._consume(p.tokens.brace_left,"Exected '{' for switch default.");const h=this._case_body();this._consume(p.tokens.brace_right,"Exected '}' for switch default."),a.push(new vn(h))}if(this._check([p.keywords.default,p.keywords.case])){const h=this._switch_body();a.push(h[0])}return a}_case_selectors(){const a=[this._shift_expression()];for(;this._match(p.tokens.comma);)a.push(this._shift_expression());return a}_case_body(){if(this._match(p.keywords.fallthrough))return this._consume(p.tokens.semicolon,"Expected ';'"),[];let a=this._statement();if(a==null)return[];a instanceof Array||(a=[a]);const h=this._case_body();return h.length==0?a:[...a,h[0]]}_if_statement(){if(!this._match(p.keywords.if))return null;const a=this._optional_paren_expression();this._check(p.tokens.attr)&&this._attribute();const h=this._compound_statement();let m=[];this._match_elseif()&&(this._check(p.tokens.attr)&&this._attribute(),m=this._elseif_statement(m));let b=null;return this._match(p.keywords.else)&&(this._check(p.tokens.attr)&&this._attribute(),b=this._compound_statement()),new ne(a,h,m,b)}_match_elseif(){return this._tokens[this._current].type===p.keywords.else&&this._tokens[this._current+1].type===p.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(a=[]){const h=this._optional_paren_expression(),m=this._compound_statement();return a.push(new bt(h,m)),this._match_elseif()&&(this._check(p.tokens.attr)&&this._attribute(),this._elseif_statement(a)),a}_return_statement(){if(!this._match(p.keywords.return))return null;const a=this._short_circuit_or_expression();return new ee(a)}_short_circuit_or_expression(){let a=this._short_circuit_and_expr();for(;this._match(p.tokens.or_or);)a=new $e(this._previous().toString(),a,this._short_circuit_and_expr());return a}_short_circuit_and_expr(){let a=this._inclusive_or_expression();for(;this._match(p.tokens.and_and);)a=new $e(this._previous().toString(),a,this._inclusive_or_expression());return a}_inclusive_or_expression(){let a=this._exclusive_or_expression();for(;this._match(p.tokens.or);)a=new $e(this._previous().toString(),a,this._exclusive_or_expression());return a}_exclusive_or_expression(){let a=this._and_expression();for(;this._match(p.tokens.xor);)a=new $e(this._previous().toString(),a,this._and_expression());return a}_and_expression(){let a=this._equality_expression();for(;this._match(p.tokens.and);)a=new $e(this._previous().toString(),a,this._equality_expression());return a}_equality_expression(){const a=this._relational_expression();return this._match([p.tokens.equal_equal,p.tokens.not_equal])?new $e(this._previous().toString(),a,this._relational_expression()):a}_relational_expression(){let a=this._shift_expression();for(;this._match([p.tokens.less_than,p.tokens.greater_than,p.tokens.less_than_equal,p.tokens.greater_than_equal]);)a=new $e(this._previous().toString(),a,this._shift_expression());return a}_shift_expression(){let a=this._additive_expression();for(;this._match([p.tokens.shift_left,p.tokens.shift_right]);)a=new $e(this._previous().toString(),a,this._additive_expression());return a}_additive_expression(){let a=this._multiplicative_expression();for(;this._match([p.tokens.plus,p.tokens.minus]);)a=new $e(this._previous().toString(),a,this._multiplicative_expression());return a}_multiplicative_expression(){let a=this._unary_expression();for(;this._match([p.tokens.star,p.tokens.forward_slash,p.tokens.modulo]);)a=new $e(this._previous().toString(),a,this._unary_expression());return a}_unary_expression(){return this._match([p.tokens.minus,p.tokens.bang,p.tokens.tilde,p.tokens.star,p.tokens.and])?new zn(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const a=this._primary_expression(),h=this._postfix_expression();return h&&(a.postfix=h),a}_postfix_expression(){if(this._match(p.tokens.bracket_left)){const a=this._short_circuit_or_expression();this._consume(p.tokens.bracket_right,"Expected ']'.");const h=new yn(a),m=this._postfix_expression();return m&&(h.postfix=m),h}if(this._match(p.tokens.period)){const a=this._consume(p.tokens.ident,"Expected member name."),h=this._postfix_expression(),m=new mn(a.lexeme);return h&&(m.postfix=h),m}return null}_getStruct(a){return this._context.aliases.has(a)?this._context.aliases.get(a).type:this._context.structs.has(a)?this._context.structs.get(a):null}_primary_expression(){if(this._match(p.tokens.ident)){const m=this._previous().toString();if(this._check(p.tokens.paren_left)){const b=this._argument_expression_list(),C=this._getStruct(m);return C!=null?new Ne(C,b):new Rr(m,b)}if(this._context.constants.has(m)){const b=this._context.constants.get(m);return new Br(m,b.value)}return new er(m)}if(this._match(p.const_literal))return new Vt(parseFloat(this._previous().toString()));if(this._check(p.tokens.paren_left))return this._paren_expression();if(this._match(p.keywords.bitcast)){this._consume(p.tokens.less_than,"Expected '<'.");const m=this._type_decl();this._consume(p.tokens.greater_than,"Expected '>'.");const b=this._paren_expression();return new Nn(m,b)}const a=this._type_decl(),h=this._argument_expression_list();return new ss(a,h)}_argument_expression_list(){if(!this._match(p.tokens.paren_left))return null;const a=[];do{if(this._check(p.tokens.paren_right))break;const h=this._short_circuit_or_expression();a.push(h)}while(this._match(p.tokens.comma));return this._consume(p.tokens.paren_right,"Expected ')' for agument list"),a}_optional_paren_expression(){this._match(p.tokens.paren_left);const a=this._short_circuit_or_expression();return this._match(p.tokens.paren_right),new tn([a])}_paren_expression(){this._consume(p.tokens.paren_left,"Expected '('.");const a=this._short_circuit_or_expression();return this._consume(p.tokens.paren_right,"Expected ')'."),new tn([a])}_struct_decl(){if(!this._match(p.keywords.struct))return null;const a=this._currentLine,h=this._consume(p.tokens.ident,"Expected name for struct.").toString();this._consume(p.tokens.brace_left,"Expected '{' for struct body.");const m=[];for(;!this._check(p.tokens.brace_right);){const L=this._attribute(),W=this._consume(p.tokens.ident,"Expected variable name.").toString();this._consume(p.tokens.colon,"Expected ':' for struct member type.");const Y=this._attribute(),re=this._type_decl();re!=null&&(re.attributes=Y),this._check(p.tokens.brace_right)?this._match(p.tokens.comma):this._consume(p.tokens.comma,"Expected ',' for struct member."),m.push(new Lr(W,re,L))}this._consume(p.tokens.brace_right,"Expected '}' after struct body.");const b=this._currentLine,C=new ye(h,m,a,b);return this._context.structs.set(h,C),C}_global_variable_decl(){const a=this._variable_decl();return a&&this._match(p.tokens.equal)&&(a.value=this._const_expression()),a}_override_variable_decl(){const a=this._override_decl();return a&&this._match(p.tokens.equal)&&(a.value=this._const_expression()),a}_global_const_decl(){if(!this._match(p.keywords.const))return null;const a=this._consume(p.tokens.ident,"Expected variable name");let h=null;if(this._match(p.tokens.colon)){const C=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=C)}let m=null;if(this._match(p.tokens.equal)){const C=this._short_circuit_or_expression();if(C instanceof Ne)m=C;else if(C instanceof Br&&C.initializer instanceof Ne)m=C.initializer;else try{const L=C.evaluate(this._context);m=new Vt(L)}catch{m=C}}const b=new q(a.toString(),h,"","",m);return this._context.constants.set(b.name,b),b}_global_let_decl(){if(!this._match(p.keywords.let))return null;const a=this._consume(p.tokens.ident,"Expected variable name");let h=null;if(this._match(p.tokens.colon)){const b=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=b)}let m=null;return this._match(p.tokens.equal)&&(m=this._const_expression()),new N(a.toString(),h,"","",m)}_const_expression(){if(this._match(p.const_literal))return new mn(this._previous().toString());const a=this._type_decl();this._consume(p.tokens.paren_left,"Expected '('.");let h=[];for(;!this._check(p.tokens.paren_right)&&(h.push(this._const_expression()),!!this._check(p.tokens.comma));)this._advance();return this._consume(p.tokens.paren_right,"Expected ')'."),new Ne(a,h)}_variable_decl(){if(!this._match(p.keywords.var))return null;let a="",h="";this._match(p.tokens.less_than)&&(a=this._consume(p.storage_class,"Expected storage_class.").toString(),this._match(p.tokens.comma)&&(h=this._consume(p.access_mode,"Expected access_mode.").toString()),this._consume(p.tokens.greater_than,"Expected '>'."));const m=this._consume(p.tokens.ident,"Expected variable name");let b=null;if(this._match(p.tokens.colon)){const C=this._attribute();b=this._type_decl(),b!=null&&(b.attributes=C)}return new M(m.toString(),b,a,h,null)}_override_decl(){if(!this._match(p.keywords.override))return null;const a=this._consume(p.tokens.ident,"Expected variable name");let h=null;if(this._match(p.tokens.colon)){const m=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=m)}return new z(a.toString(),h,null)}_diagnostic(){this._consume(p.tokens.paren_left,"Expected '('");const a=this._consume(p.tokens.ident,"Expected severity control name.");this._consume(p.tokens.comma,"Expected ','");const h=this._consume(p.tokens.ident,"Expected diagnostic rule name.");return this._consume(p.tokens.paren_right,"Expected ')'"),new Fe(a.toString(),h.toString())}_enable_directive(){const a=this._consume(p.tokens.ident,"identity expected.");return new j(a.toString())}_requires_directive(){const a=[this._consume(p.tokens.ident,"identity expected.").toString()];for(;this._match(p.tokens.comma);){const h=this._consume(p.tokens.ident,"identity expected.");a.push(h.toString())}return new Me(a)}_type_alias(){const a=this._consume(p.tokens.ident,"identity expected.");this._consume(p.tokens.equal,"Expected '=' for type alias.");let h=this._type_decl();if(h===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(h.name)&&(h=this._context.aliases.get(h.name).type);const m=new ht(a.toString(),h);return this._context.aliases.set(m.name,m),m}_type_decl(){if(this._check([p.tokens.ident,...p.texel_format,p.keywords.bool,p.keywords.f32,p.keywords.i32,p.keywords.u32])){const m=this._advance(),b=m.toString();return this._context.structs.has(b)?this._context.structs.get(b):this._context.aliases.has(b)?this._context.aliases.get(b).type:new We(m.toString())}let a=this._texture_sampler_types();if(a)return a;if(this._check(p.template_types)){let m=this._advance().toString(),b=null,C=null;return this._match(p.tokens.less_than)&&(b=this._type_decl(),C=null,this._match(p.tokens.comma)&&(C=this._consume(p.access_mode,"Expected access_mode for pointer").toString()),this._consume(p.tokens.greater_than,"Expected '>' for type.")),new Mr(m,b,C)}if(this._match(p.keywords.ptr)){let m=this._previous().toString();this._consume(p.tokens.less_than,"Expected '<' for pointer.");const b=this._consume(p.storage_class,"Expected storage_class for pointer");this._consume(p.tokens.comma,"Expected ',' for pointer.");const C=this._type_decl();let L=null;return this._match(p.tokens.comma)&&(L=this._consume(p.access_mode,"Expected access_mode for pointer").toString()),this._consume(p.tokens.greater_than,"Expected '>' for pointer."),new rs(m,b.toString(),C,L)}const h=this._attribute();if(this._match(p.keywords.array)){let m=null,b=-1;const C=this._previous();let L=null;if(this._match(p.tokens.less_than)){m=this._type_decl(),this._context.aliases.has(m.name)&&(m=this._context.aliases.get(m.name).type);let Y="";if(this._match(p.tokens.comma)){L=this._shift_expression();try{Y=L.evaluate(this._context).toString(),L=null}catch{Y="1"}}this._consume(p.tokens.greater_than,"Expected '>' for array."),b=Y?parseInt(Y):0}const W=new Ut(C.toString(),h,m,b);return L&&this._deferArrayCountEval.push({arrayType:W,countNode:L}),W}return null}_texture_sampler_types(){if(this._match(p.sampler_type))return new Ze(this._previous().toString(),null,null);if(this._match(p.depth_texture_type))return new Ze(this._previous().toString(),null,null);if(this._match(p.sampled_texture_type)||this._match(p.multisampled_texture_type)){const a=this._previous();this._consume(p.tokens.less_than,"Expected '<' for sampler type.");const h=this._type_decl();return this._consume(p.tokens.greater_than,"Expected '>' for sampler type."),new Ze(a.toString(),h,null)}if(this._match(p.storage_texture_type)){const a=this._previous();this._consume(p.tokens.less_than,"Expected '<' for sampler type.");const h=this._consume(p.texel_format,"Invalid texel format.").toString();this._consume(p.tokens.comma,"Expected ',' after texel format.");const m=this._consume(p.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(p.tokens.greater_than,"Expected '>' for sampler type."),new Ze(a.toString(),h,m)}return null}_attribute(){let a=[];for(;this._match(p.tokens.attr);){const h=this._consume(p.attribute_name,"Expected attribute name"),m=new as(h.toString(),null);if(this._match(p.tokens.paren_left)){if(m.value=this._consume(p.literal_or_ident,"Expected attribute value").toString(),this._check(p.tokens.comma)){this._advance();do{const b=this._consume(p.literal_or_ident,"Expected attribute value").toString();m.value instanceof Array||(m.value=[m.value]),m.value.push(b)}while(this._match(p.tokens.comma))}this._consume(p.tokens.paren_right,"Expected ')'")}a.push(m)}return a.length==0?null:a}}class nn{constructor(a,h){this.name=a,this.attributes=h,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class rn{constructor(a,h,m){this.name=a,this.type=h,this.attributes=m,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class xt extends nn{constructor(a,h){super(a,h),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class xn extends nn{constructor(a,h){super(a,h),this.count=0,this.stride=0}get isArray(){return!0}}class Dn extends nn{constructor(a,h,m,b){super(a,m),this.format=h,this.access=b}get isTemplate(){return!0}}r.ResourceType=void 0,function(F){F[F.Uniform=0]="Uniform",F[F.Storage=1]="Storage",F[F.Texture=2]="Texture",F[F.Sampler=3]="Sampler",F[F.StorageTexture=4]="StorageTexture"}(r.ResourceType||(r.ResourceType={}));class sn{constructor(a,h,m,b,C,L,W){this.name=a,this.type=h,this.group=m,this.binding=b,this.attributes=C,this.resourceType=L,this.access=W}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class nr{constructor(a,h){this.name=a,this.type=h}}class kn{constructor(a,h){this.align=a,this.size=h}}class rr{constructor(a,h,m,b){this.name=a,this.type=h,this.locationType=m,this.location=b,this.interpolation=null}}class Gn{constructor(a,h,m,b){this.name=a,this.type=h,this.locationType=m,this.location=b}}class sr{constructor(a,h=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=a,this.stage=h}}class ir{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class us{constructor(a,h,m,b){this.name=a,this.type=h,this.attributes=m,this.id=b}}class fi{constructor(a){this.resources=null,this.inUse=!1,this.info=null,this.node=a}}class Pt{constructor(a){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new ir,this.functions=[],this._types=new Map,this._functions=new Map,a&&this.update(a)}_isStorageTexture(a){return a.name=="texture_storage_1d"||a.name=="texture_storage_2d"||a.name=="texture_storage_2d_array"||a.name=="texture_storage_3d"}update(a){const m=new bn().parse(a);for(const b of m)b instanceof d&&this._functions.set(b.name,new fi(b));for(const b of m)if(b instanceof ye){const C=this._getTypeInfo(b,null);C instanceof xt&&this.structs.push(C)}for(const b of m){if(b instanceof ht){this.aliases.push(this._getAliasInfo(b));continue}if(b instanceof z){const C=b,L=this._getAttributeNum(C.attributes,"id",0),W=C.type!=null?this._getTypeInfo(C.type,C.attributes):null;this.overrides.push(new us(C.name,W,C.attributes,L));continue}if(this._isUniformVar(b)){const C=b,L=this._getAttributeNum(C.attributes,"group",0),W=this._getAttributeNum(C.attributes,"binding",0),Y=this._getTypeInfo(C.type,C.attributes),re=new sn(C.name,Y,L,W,C.attributes,r.ResourceType.Uniform,C.access);this.uniforms.push(re);continue}if(this._isStorageVar(b)){const C=b,L=this._getAttributeNum(C.attributes,"group",0),W=this._getAttributeNum(C.attributes,"binding",0),Y=this._getTypeInfo(C.type,C.attributes),re=this._isStorageTexture(Y),Te=new sn(C.name,Y,L,W,C.attributes,re?r.ResourceType.StorageTexture:r.ResourceType.Storage,C.access);this.storage.push(Te);continue}if(this._isTextureVar(b)){const C=b,L=this._getAttributeNum(C.attributes,"group",0),W=this._getAttributeNum(C.attributes,"binding",0),Y=this._getTypeInfo(C.type,C.attributes),re=this._isStorageTexture(Y),Te=new sn(C.name,Y,L,W,C.attributes,re?r.ResourceType.StorageTexture:r.ResourceType.Texture,C.access);re?this.storage.push(Te):this.textures.push(Te);continue}if(this._isSamplerVar(b)){const C=b,L=this._getAttributeNum(C.attributes,"group",0),W=this._getAttributeNum(C.attributes,"binding",0),Y=this._getTypeInfo(C.type,C.attributes),re=new sn(C.name,Y,L,W,C.attributes,r.ResourceType.Sampler,C.access);this.samplers.push(re);continue}if(b instanceof d){const C=this._getAttribute(b,"vertex"),L=this._getAttribute(b,"fragment"),W=this._getAttribute(b,"compute"),Y=C||L||W,re=new sr(b.name,Y==null?void 0:Y.name);re.startLine=b.startLine,re.endLine=b.endLine,this.functions.push(re),this._functions.get(b.name).info=re,Y&&(this._functions.get(b.name).inUse=!0,re.inUse=!0,re.resources=this._findResources(b,!!Y),re.inputs=this._getInputs(b.args),re.outputs=this._getOutputs(b.returnType),this.entry[Y.name].push(re));continue}}for(const b of this._functions.values())b.info&&(b.info.inUse=b.inUse,this._addCalls(b.node,b.info.calls));for(const b of this.uniforms)this._markStructsInUse(b.type);for(const b of this.storage)this._markStructsInUse(b.type)}_markStructsInUse(a){if(a.isStruct){a.inUse=!0;for(const h of a.members)this._markStructsInUse(h.type)}else if(a.isArray)this._markStructsInUse(a.format);else if(a.isTemplate)this._markStructsInUse(a.format);else{const h=this._getAlias(a.name);h&&this._markStructsInUse(h)}}_addCalls(a,h){var m;for(const b of a.calls){const C=(m=this._functions.get(b.name))===null||m===void 0?void 0:m.info;C&&h.add(C)}}findResource(a,h){for(const m of this.uniforms)if(m.group==a&&m.binding==h)return m;for(const m of this.storage)if(m.group==a&&m.binding==h)return m;for(const m of this.textures)if(m.group==a&&m.binding==h)return m;for(const m of this.samplers)if(m.group==a&&m.binding==h)return m;return null}_findResource(a){for(const h of this.uniforms)if(h.name==a)return h;for(const h of this.storage)if(h.name==a)return h;for(const h of this.textures)if(h.name==a)return h;for(const h of this.samplers)if(h.name==a)return h;return null}_markStructsFromAST(a){const h=this._getTypeInfo(a,null);this._markStructsInUse(h)}_findResources(a,h){const m=[],b=this,C=[];return a.search(L=>{if(L instanceof o)C.push({});else if(L instanceof l)C.pop();else if(L instanceof M){const W=L;h&&W.type!==null&&this._markStructsFromAST(W.type),C.length>0&&(C[C.length-1][W.name]=W)}else if(L instanceof Ne){const W=L;h&&W.type!==null&&this._markStructsFromAST(W.type)}else if(L instanceof N){const W=L;h&&W.type!==null&&this._markStructsFromAST(W.type),C.length>0&&(C[C.length-1][W.name]=W)}else if(L instanceof er){const W=L;if(C.length>0&&C[C.length-1][W.name])return;const Y=b._findResource(W.name);Y&&m.push(Y)}else if(L instanceof Rr){const W=L,Y=b._functions.get(W.name);Y&&(h&&(Y.inUse=!0),a.calls.add(Y.node),Y.resources===null&&(Y.resources=b._findResources(Y.node,h)),m.push(...Y.resources))}else if(L instanceof H){const W=L,Y=b._functions.get(W.name);Y&&(h&&(Y.inUse=!0),a.calls.add(Y.node),Y.resources===null&&(Y.resources=b._findResources(Y.node,h)),m.push(...Y.resources))}}),[...new Map(m.map(L=>[L.name,L])).values()]}getBindGroups(){const a=[];function h(m,b){m>=a.length&&(a.length=m+1),a[m]===void 0&&(a[m]=[]),b>=a[m].length&&(a[m].length=b+1)}for(const m of this.uniforms){h(m.group,m.binding);const b=a[m.group];b[m.binding]=m}for(const m of this.storage){h(m.group,m.binding);const b=a[m.group];b[m.binding]=m}for(const m of this.textures){h(m.group,m.binding);const b=a[m.group];b[m.binding]=m}for(const m of this.samplers){h(m.group,m.binding);const b=a[m.group];b[m.binding]=m}return a}_getOutputs(a,h=void 0){if(h===void 0&&(h=[]),a instanceof ye)this._getStructOutputs(a,h);else{const m=this._getOutputInfo(a);m!==null&&h.push(m)}return h}_getStructOutputs(a,h){for(const m of a.members)if(m.type instanceof ye)this._getStructOutputs(m.type,h);else{const b=this._getAttribute(m,"location")||this._getAttribute(m,"builtin");if(b!==null){const C=this._getTypeInfo(m.type,m.type.attributes),L=this._parseInt(b.value),W=new Gn(m.name,C,b.name,L);h.push(W)}}}_getOutputInfo(a){const h=this._getAttribute(a,"location")||this._getAttribute(a,"builtin");if(h!==null){const m=this._getTypeInfo(a,a.attributes),b=this._parseInt(h.value);return new Gn("",m,h.name,b)}return null}_getInputs(a,h=void 0){h===void 0&&(h=[]);for(const m of a)if(m.type instanceof ye)this._getStructInputs(m.type,h);else{const b=this._getInputInfo(m);b!==null&&h.push(b)}return h}_getStructInputs(a,h){for(const m of a.members)if(m.type instanceof ye)this._getStructInputs(m.type,h);else{const b=this._getInputInfo(m);b!==null&&h.push(b)}}_getInputInfo(a){const h=this._getAttribute(a,"location")||this._getAttribute(a,"builtin");if(h!==null){const m=this._getAttribute(a,"interpolation"),b=this._getTypeInfo(a.type,a.attributes),C=this._parseInt(h.value),L=new rr(a.name,b,h.name,C);return m!==null&&(L.interpolation=this._parseString(m.value)),L}return null}_parseString(a){return a instanceof Array&&(a=a[0]),a}_parseInt(a){a instanceof Array&&(a=a[0]);const h=parseInt(a);return isNaN(h)?a:h}_getAlias(a){for(const h of this.aliases)if(h.name==a)return h.type;return null}_getAliasInfo(a){return new nr(a.name,this._getTypeInfo(a.type,null))}_getTypeInfo(a,h){if(this._types.has(a))return this._types.get(a);if(a instanceof Ut){const b=a,C=this._getTypeInfo(b.format,b.attributes),L=new xn(b.name,h);return L.format=C,L.count=b.count,this._types.set(a,L),this._updateTypeInfo(L),L}if(a instanceof ye){const b=a,C=new xt(b.name,h);C.startLine=b.startLine,C.endLine=b.endLine;for(const L of b.members){const W=this._getTypeInfo(L.type,L.attributes);C.members.push(new rn(L.name,W,L.attributes))}return this._types.set(a,C),this._updateTypeInfo(C),C}if(a instanceof Ze){const b=a,C=b.format instanceof We,L=b.format?C?this._getTypeInfo(b.format,null):new nn(b.format,null):null,W=new Dn(b.name,L,h,b.access);return this._types.set(a,W),this._updateTypeInfo(W),W}if(a instanceof Mr){const b=a,C=b.format?this._getTypeInfo(b.format,null):null,L=new Dn(b.name,C,h,b.access);return this._types.set(a,L),this._updateTypeInfo(L),L}const m=new nn(a.name,h);return this._types.set(a,m),this._updateTypeInfo(m),m}_updateTypeInfo(a){var h,m;const b=this._getTypeSize(a);if(a.size=(h=b==null?void 0:b.size)!==null&&h!==void 0?h:0,a instanceof xn){const C=this._getTypeSize(a.format);a.stride=(m=C==null?void 0:C.size)!==null&&m!==void 0?m:0,this._updateTypeInfo(a.format)}a instanceof xt&&this._updateStructInfo(a)}_updateStructInfo(a){var h;let m=0,b=0,C=0,L=0;for(let W=0,Y=a.members.length;W<Y;++W){const re=a.members[W],Te=this._getTypeSize(re);if(!Te)continue;(h=this._getAlias(re.type.name))!==null&&h!==void 0||re.type;const rt=Te.align,ar=Te.size;m=this._roundUp(rt,m+b),b=ar,C=m,L=Math.max(L,rt),re.offset=m,re.size=ar,this._updateTypeInfo(re.type)}a.size=this._roundUp(L,C+b),a.align=L}_getTypeSize(a){var h;if(a==null)return null;const m=this._getAttributeNum(a.attributes,"size",0),b=this._getAttributeNum(a.attributes,"align",0);if(a instanceof rn&&(a=a.type),a instanceof nn){const C=this._getAlias(a.name);C!==null&&(a=C)}{const C=Pt._typeInfo[a.name];if(C!==void 0){const L=a.format==="f16"?2:1;return new kn(Math.max(b,C.align/L),Math.max(m,C.size/L))}}{const C=Pt._typeInfo[a.name.substring(0,a.name.length-1)];if(C){const L=a.name[a.name.length-1]==="h"?2:1;return new kn(Math.max(b,C.align/L),Math.max(m,C.size/L))}}if(a instanceof xn){let C=a,L=8,W=8;const Y=this._getTypeSize(C.format);Y!==null&&(W=Y.size,L=Y.align);const re=C.count,Te=this._getAttributeNum((h=a==null?void 0:a.attributes)!==null&&h!==void 0?h:null,"stride",this._roundUp(L,W));return W=re*Te,m&&(W=m),new kn(Math.max(b,L),Math.max(m,W))}if(a instanceof xt){let C=0,L=0,W=0,Y=0,re=0;for(const Te of a.members){const rt=this._getTypeSize(Te.type);rt!==null&&(C=Math.max(rt.align,C),W=this._roundUp(rt.align,W+Y),Y=rt.size,re=W)}return L=this._roundUp(C,re+Y),new kn(Math.max(b,C),Math.max(m,L))}return null}_isUniformVar(a){return a instanceof M&&a.storage=="uniform"}_isStorageVar(a){return a instanceof M&&a.storage=="storage"}_isTextureVar(a){return a instanceof M&&a.type!==null&&Pt._textureTypes.indexOf(a.type.name)!=-1}_isSamplerVar(a){return a instanceof M&&a.type!==null&&Pt._samplerTypes.indexOf(a.type.name)!=-1}_getAttribute(a,h){const m=a;if(!m||!m.attributes)return null;const b=m.attributes;for(let C of b)if(C.name==h)return C;return null}_getAttributeNum(a,h,m){if(a===null)return m;for(let b of a)if(b.name==h){let C=b!==null&&b.value!==null?b.value:m;return C instanceof Array&&(C=C[0]),typeof C=="number"?C:typeof C=="string"?parseInt(C):m}return m}_roundUp(a,h){return Math.ceil(h/a)*a}}Pt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Pt._textureTypes=p.any_texture_type.map(F=>F.name),Pt._samplerTypes=p.sampler_type.map(F=>F.name),r.Alias=ht,r.AliasInfo=nr,r.Argument=is,r.ArrayIndex=yn,r.ArrayInfo=xn,r.ArrayType=Ut,r.Assign=D,r.Attribute=as,r.BinaryOperator=$e,r.BitcastExpr=Nn,r.Break=$t,r.Call=H,r.CallExpr=Rr,r.Case=nt,r.Const=q,r.ConstExpr=Br,r.Continue=Ht,r.Continuing=S,r.CreateExpr=Ne,r.Default=vn,r.Diagnostic=Fe,r.Discard=Wt,r.ElseIf=bt,r.Enable=j,r.EntryFunctions=ir,r.Expression=tt,r.For=I,r.Function=d,r.FunctionInfo=sr,r.GroupingExpr=tn,r.If=ne,r.Increment=X,r.InputInfo=rr,r.Let=N,r.LiteralExpr=Vt,r.Loop=ce,r.Member=Lr,r.MemberInfo=rn,r.Node=n,r.Operator=Fr,r.OutputInfo=Gn,r.Override=z,r.OverrideInfo=us,r.ParseContext=s,r.PointerType=rs,r.Requires=Me,r.Return=ee,r.SamplerType=Ze,r.Statement=c,r.StaticAssert=y,r.StringExpr=mn,r.Struct=ye,r.StructInfo=xt,r.Switch=Q,r.SwitchCase=tr,r.TemplateInfo=Dn,r.TemplateType=Mr,r.Token=wn,r.TokenType=k,r.TokenTypes=p,r.Type=We,r.TypeInfo=nn,r.TypecastExpr=ss,r.UnaryOperator=zn,r.Var=M,r.VariableExpr=er,r.VariableInfo=sn,r.WgslParser=bn,r.WgslReflect=Pt,r.WgslScanner=os,r.While=w,r._BlockEnd=l,r._BlockStart=o})(Jn);const vt={Uniform:0,Storage:1,Texture:2,Sampler:3,StorageTexture:4},Tr=class Tr{constructor(){O(this,"module",null);O(this,"code",null);O(this,"file_path","");O(this,"defines",{})}static register_shader_path(s){Tr.shader_paths.push(s)}initialize(s,n){let o=this._load_shader_text(n);if(o)try{this.code=o,this.module=s.device.createShaderModule({label:n,code:o}),this.file_path=n}catch(l){console.error(`WebGPU shader error: could not create shader module at ${n}`,l)}}reflect(){return new Jn.WgslReflect(this.code)}_load_shader_text(s,n=0){let o=null;for(const l of Tr.shader_paths)try{const c=new URL(`${l}/${s}`,window.location.href),d=new XMLHttpRequest;if(d.open("GET",c.href,!1),d.send(null),d.status===200){o=d.responseText;break}}catch(c){console.warn(`Failed to load shader from ${l}/${s}:`,c)}if(!o)return console.error(`WebGPU shader error: could not find shader at ${s}`),null;if(o=this._parse_shader_includes(o,n),n===0){const{defines_map:l,stripped_code:c}=this._build_defines_map_and_strip(o);o=c,this.defines=l,o=this._parse_conditional_defines(o)}return o}_parse_shader_includes(s,n=0){let o=[],l=s.indexOf("#include",0);for(;l!==-1;)o.push(l),l=s.indexOf("#include",l+1);const c=/^#include\s+"(\S+)".*$/m;for(let d=o.length-1;d>=0;--d){const y=o[d],w=s.indexOf(`
`,y),I=s.substring(y,w).match(c);if(I){const M=this._load_shader_text(I[1],n+1);s=s.slice(0,y)+M+s.slice(w)}}return s}_build_defines_map_and_strip(s){const n={},o=/#define\s+(\S+)(?:\s+(\S*))?$/gm,l=s.replace(o,(c,d,y)=>(n[d]=y||!0,""));return{defines_map:n,stripped_code:l}}_parse_conditional_defines(s){let n="",o=0,l;const c=/#(if|ifndef)\s+(\S+)(?:\s+(\S+))?$/gm;for(;(l=c.exec(s))!==null;){const[d,y,w,S]=l,I=l.index,M=s.indexOf("#endif",I);if(M===-1){console.warn(`Unmatched #${y} at position ${I}`);continue}if(n+=s.slice(o,I),y==="if"?this.defines[w]===(S||!0):!this.defines[w]){const N=s.slice(I,M).replace(d,"").trim();n+=N}o=M+6}return n+=s.slice(o),n.trim()}static create(s,n){let o=V.get().fetch(K.SHADER,n);return o||(o=new Tr,o.initialize(s,n),V.get().store(K.SHADER,n,o)),o}static resource_type_from_reflection_type(s){switch(s){case Jn.ResourceType.Texture:return vt.Texture;case Jn.ResourceType.Sampler:return vt.Sampler;case Jn.ResourceType.Storage:return vt.Storage;case Jn.ResourceType.Uniform:return vt.Uniform;case Jn.ResourceType.StorageTexture:return vt.StorageTexture;default:throw new Error(`Unknown binding type: ${s}`)}}static get_optimal_texture_format(s){switch(s){case"f32":return"bgra8unorm";case"vec4<f32>":case"vec4f":return"bgra8unorm";case"vec4<u32>":case"vec4u":return"rgba32uint";case"vec4<i32>":case"vec4i":return"rgba32sint";case"vec2<f32>":case"vec2f":return"rg32float";case"u32":case"u":return"r32uint";case"i32":case"i":return"r32sint";case"f16":return"rgba16float";case"vec4<f16>":case"vec4f16":return"rgba16float";case"vec2<f16>":case"vec2f16":return"rg16float";case"u16":case"u16":return"r16uint";case"i16":case"i16":return"r16sint";case"vec4<unorm>":case"vec4unorm":return"rgba8unorm";case"vec4<snorm>":case"vec4snorm":return"rgba8snorm";case"vec4<u8>":case"vec4u8":return"rgba8uint";case"vec4<i8>":case"vec4i8":return"rgba8sint";default:return"rgba8unorm"}}};O(Tr,"shader_paths",["engine/shaders"]);let jt=Tr;var ai={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */ai.exports;(function(r,s){(function(){var n,o="4.17.21",l=200,c="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",d="Expected a function",y="Invalid `variable` option passed into `_.template`",w="__lodash_hash_undefined__",S=500,I="__lodash_placeholder__",M=1,z=2,N=4,q=1,X=2,D=1,H=2,ce=4,Q=8,ne=16,ee=32,j=64,Me=128,Fe=256,ht=512,Wt=30,$t="...",Ht=800,We=16,ye=1,Mr=2,rs=3,Ut=1/0,Ze=9007199254740991,tt=17976931348623157e292,mn=NaN,Ne=4294967295,Rr=Ne-1,er=Ne>>>1,Br=[["ary",Me],["bind",D],["bindKey",H],["curry",Q],["curryRight",ne],["flip",ht],["partial",ee],["partialRight",j],["rearg",Fe]],Vt="[object Arguments]",Nn="[object Array]",ss="[object AsyncFunction]",tn="[object Boolean]",yn="[object Date]",Fr="[object DOMException]",zn="[object Error]",$e="[object Function]",tr="[object GeneratorFunction]",nt="[object Map]",vn="[object Number]",is="[object Null]",bt="[object Object]",Lr="[object Promise]",as="[object Proxy]",E="[object RegExp]",k="[object Set]",p="[object String]",wn="[object Symbol]",os="[object Undefined]",bn="[object WeakMap]",nn="[object WeakSet]",rn="[object ArrayBuffer]",xt="[object DataView]",xn="[object Float32Array]",Dn="[object Float64Array]",sn="[object Int8Array]",nr="[object Int16Array]",kn="[object Int32Array]",rr="[object Uint8Array]",Gn="[object Uint8ClampedArray]",sr="[object Uint16Array]",ir="[object Uint32Array]",us=/\b__p \+= '';/g,fi=/\b(__p \+=) '' \+/g,Pt=/(__e\(.*?\)|\b__t\)) \+\n'';/g,F=/&(?:amp|lt|gt|quot|#39);/g,a=/[&<>"']/g,h=RegExp(F.source),m=RegExp(a.source),b=/<%-([\s\S]+?)%>/g,C=/<%([\s\S]+?)%>/g,L=/<%=([\s\S]+?)%>/g,W=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Y=/^\w*$/,re=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Te=/[\\^$.*+?()[\]{}|]/g,rt=RegExp(Te.source),ar=/^\s+/,Gl=/\s/,ql=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Kl=/\{\n\/\* \[wrapped with (.+)\] \*/,Wl=/,? & /,$l=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Hl=/[()=,{}\[\]\/\s]/,Vl=/\\(\\)?/g,Xl=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,Oa=/\w*$/,Yl=/^[-+]0x[0-9a-f]+$/i,Zl=/^0b[01]+$/i,Jl=/^\[object .+?Constructor\]$/,Ql=/^0o[0-7]+$/i,jl=/^(?:0|[1-9]\d*)$/,ec=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,ls=/($^)/,tc=/['\n\r\u2028\u2029\\]/g,cs="\\ud800-\\udfff",nc="\\u0300-\\u036f",rc="\\ufe20-\\ufe2f",sc="\\u20d0-\\u20ff",Na=nc+rc+sc,za="\\u2700-\\u27bf",Da="a-z\\xdf-\\xf6\\xf8-\\xff",ic="\\xac\\xb1\\xd7\\xf7",ac="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",oc="\\u2000-\\u206f",uc=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Ga="A-Z\\xc0-\\xd6\\xd8-\\xde",qa="\\ufe0e\\ufe0f",Ka=ic+ac+oc+uc,di="[']",lc="["+cs+"]",Wa="["+Ka+"]",hs="["+Na+"]",$a="\\d+",cc="["+za+"]",Ha="["+Da+"]",Va="[^"+cs+Ka+$a+za+Da+Ga+"]",gi="\\ud83c[\\udffb-\\udfff]",hc="(?:"+hs+"|"+gi+")",Xa="[^"+cs+"]",pi="(?:\\ud83c[\\udde6-\\uddff]){2}",mi="[\\ud800-\\udbff][\\udc00-\\udfff]",or="["+Ga+"]",Ya="\\u200d",Za="(?:"+Ha+"|"+Va+")",_c="(?:"+or+"|"+Va+")",Ja="(?:"+di+"(?:d|ll|m|re|s|t|ve))?",Qa="(?:"+di+"(?:D|LL|M|RE|S|T|VE))?",ja=hc+"?",eo="["+qa+"]?",fc="(?:"+Ya+"(?:"+[Xa,pi,mi].join("|")+")"+eo+ja+")*",dc="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",gc="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",to=eo+ja+fc,pc="(?:"+[cc,pi,mi].join("|")+")"+to,mc="(?:"+[Xa+hs+"?",hs,pi,mi,lc].join("|")+")",yc=RegExp(di,"g"),vc=RegExp(hs,"g"),yi=RegExp(gi+"(?="+gi+")|"+mc+to,"g"),wc=RegExp([or+"?"+Ha+"+"+Ja+"(?="+[Wa,or,"$"].join("|")+")",_c+"+"+Qa+"(?="+[Wa,or+Za,"$"].join("|")+")",or+"?"+Za+"+"+Ja,or+"+"+Qa,gc,dc,$a,pc].join("|"),"g"),bc=RegExp("["+Ya+cs+Na+qa+"]"),xc=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,kc=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],Tc=-1,Ae={};Ae[xn]=Ae[Dn]=Ae[sn]=Ae[nr]=Ae[kn]=Ae[rr]=Ae[Gn]=Ae[sr]=Ae[ir]=!0,Ae[Vt]=Ae[Nn]=Ae[rn]=Ae[tn]=Ae[xt]=Ae[yn]=Ae[zn]=Ae[$e]=Ae[nt]=Ae[vn]=Ae[bt]=Ae[E]=Ae[k]=Ae[p]=Ae[bn]=!1;var ke={};ke[Vt]=ke[Nn]=ke[rn]=ke[xt]=ke[tn]=ke[yn]=ke[xn]=ke[Dn]=ke[sn]=ke[nr]=ke[kn]=ke[nt]=ke[vn]=ke[bt]=ke[E]=ke[k]=ke[p]=ke[wn]=ke[rr]=ke[Gn]=ke[sr]=ke[ir]=!0,ke[zn]=ke[$e]=ke[bn]=!1;var Ac={:"A",:"A",:"A",:"A",:"A",:"A",:"a",:"a",:"a",:"a",:"a",:"a",:"C",:"c",:"D",:"d",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"N",:"n",:"O",:"O",:"O",:"O",:"O",:"O",:"o",:"o",:"o",:"o",:"o",:"o",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"Y",:"y",:"y",:"Ae",:"ae",:"Th",:"th",:"ss",:"A",:"A",:"A",:"a",:"a",:"a",:"C",:"C",:"C",:"C",:"c",:"c",:"c",:"c",:"D",:"D",:"d",:"d",:"E",:"E",:"E",:"E",:"E",:"e",:"e",:"e",:"e",:"e",:"G",:"G",:"G",:"G",:"g",:"g",:"g",:"g",:"H",:"H",:"h",:"h",:"I",:"I",:"I",:"I",:"I",:"i",:"i",:"i",:"i",:"i",:"J",:"j",:"K",:"k",:"k",:"L",:"L",:"L",:"L",:"L",:"l",:"l",:"l",:"l",:"l",:"N",:"N",:"N",:"N",:"n",:"n",:"n",:"n",:"O",:"O",:"O",:"o",:"o",:"o",:"R",:"R",:"R",:"r",:"r",:"r",:"S",:"S",:"S",:"S",:"s",:"s",:"s",:"s",:"T",:"T",:"T",:"t",:"t",:"t",:"U",:"U",:"U",:"U",:"U",:"U",:"u",:"u",:"u",:"u",:"u",:"u",:"W",:"w",:"Y",:"y",:"Y",:"Z",:"Z",:"Z",:"z",:"z",:"z",:"IJ",:"ij",:"Oe",:"oe",:"'n",:"s"},Ec={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Ic={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Sc={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Cc=parseFloat,Mc=parseInt,no=typeof Zr=="object"&&Zr&&Zr.Object===Object&&Zr,Rc=typeof self=="object"&&self&&self.Object===Object&&self,Ge=no||Rc||Function("return this")(),vi=s&&!s.nodeType&&s,qn=vi&&!0&&r&&!r.nodeType&&r,ro=qn&&qn.exports===vi,wi=ro&&no.process,kt=function(){try{var T=qn&&qn.require&&qn.require("util").types;return T||wi&&wi.binding&&wi.binding("util")}catch{}}(),so=kt&&kt.isArrayBuffer,io=kt&&kt.isDate,ao=kt&&kt.isMap,oo=kt&&kt.isRegExp,uo=kt&&kt.isSet,lo=kt&&kt.isTypedArray;function _t(T,B,R){switch(R.length){case 0:return T.call(B);case 1:return T.call(B,R[0]);case 2:return T.call(B,R[0],R[1]);case 3:return T.call(B,R[0],R[1],R[2])}return T.apply(B,R)}function Bc(T,B,R,Z){for(var ue=-1,ve=T==null?0:T.length;++ue<ve;){var Ue=T[ue];B(Z,Ue,R(Ue),T)}return Z}function Tt(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z&&B(T[R],R,T)!==!1;);return T}function Fc(T,B){for(var R=T==null?0:T.length;R--&&B(T[R],R,T)!==!1;);return T}function co(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z;)if(!B(T[R],R,T))return!1;return!0}function Tn(T,B){for(var R=-1,Z=T==null?0:T.length,ue=0,ve=[];++R<Z;){var Ue=T[R];B(Ue,R,T)&&(ve[ue++]=Ue)}return ve}function _s(T,B){var R=T==null?0:T.length;return!!R&&ur(T,B,0)>-1}function bi(T,B,R){for(var Z=-1,ue=T==null?0:T.length;++Z<ue;)if(R(B,T[Z]))return!0;return!1}function Ee(T,B){for(var R=-1,Z=T==null?0:T.length,ue=Array(Z);++R<Z;)ue[R]=B(T[R],R,T);return ue}function An(T,B){for(var R=-1,Z=B.length,ue=T.length;++R<Z;)T[ue+R]=B[R];return T}function xi(T,B,R,Z){var ue=-1,ve=T==null?0:T.length;for(Z&&ve&&(R=T[++ue]);++ue<ve;)R=B(R,T[ue],ue,T);return R}function Lc(T,B,R,Z){var ue=T==null?0:T.length;for(Z&&ue&&(R=T[--ue]);ue--;)R=B(R,T[ue],ue,T);return R}function ki(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z;)if(B(T[R],R,T))return!0;return!1}var Uc=Ti("length");function Pc(T){return T.split("")}function Oc(T){return T.match($l)||[]}function ho(T,B,R){var Z;return R(T,function(ue,ve,Ue){if(B(ue,ve,Ue))return Z=ve,!1}),Z}function fs(T,B,R,Z){for(var ue=T.length,ve=R+(Z?1:-1);Z?ve--:++ve<ue;)if(B(T[ve],ve,T))return ve;return-1}function ur(T,B,R){return B===B?Yc(T,B,R):fs(T,_o,R)}function Nc(T,B,R,Z){for(var ue=R-1,ve=T.length;++ue<ve;)if(Z(T[ue],B))return ue;return-1}function _o(T){return T!==T}function fo(T,B){var R=T==null?0:T.length;return R?Ei(T,B)/R:mn}function Ti(T){return function(B){return B==null?n:B[T]}}function Ai(T){return function(B){return T==null?n:T[B]}}function go(T,B,R,Z,ue){return ue(T,function(ve,Ue,xe){R=Z?(Z=!1,ve):B(R,ve,Ue,xe)}),R}function zc(T,B){var R=T.length;for(T.sort(B);R--;)T[R]=T[R].value;return T}function Ei(T,B){for(var R,Z=-1,ue=T.length;++Z<ue;){var ve=B(T[Z]);ve!==n&&(R=R===n?ve:R+ve)}return R}function Ii(T,B){for(var R=-1,Z=Array(T);++R<T;)Z[R]=B(R);return Z}function Dc(T,B){return Ee(B,function(R){return[R,T[R]]})}function po(T){return T&&T.slice(0,wo(T)+1).replace(ar,"")}function ft(T){return function(B){return T(B)}}function Si(T,B){return Ee(B,function(R){return T[R]})}function Ur(T,B){return T.has(B)}function mo(T,B){for(var R=-1,Z=T.length;++R<Z&&ur(B,T[R],0)>-1;);return R}function yo(T,B){for(var R=T.length;R--&&ur(B,T[R],0)>-1;);return R}function Gc(T,B){for(var R=T.length,Z=0;R--;)T[R]===B&&++Z;return Z}var qc=Ai(Ac),Kc=Ai(Ec);function Wc(T){return"\\"+Sc[T]}function $c(T,B){return T==null?n:T[B]}function lr(T){return bc.test(T)}function Hc(T){return xc.test(T)}function Vc(T){for(var B,R=[];!(B=T.next()).done;)R.push(B.value);return R}function Ci(T){var B=-1,R=Array(T.size);return T.forEach(function(Z,ue){R[++B]=[ue,Z]}),R}function vo(T,B){return function(R){return T(B(R))}}function En(T,B){for(var R=-1,Z=T.length,ue=0,ve=[];++R<Z;){var Ue=T[R];(Ue===B||Ue===I)&&(T[R]=I,ve[ue++]=R)}return ve}function ds(T){var B=-1,R=Array(T.size);return T.forEach(function(Z){R[++B]=Z}),R}function Xc(T){var B=-1,R=Array(T.size);return T.forEach(function(Z){R[++B]=[Z,Z]}),R}function Yc(T,B,R){for(var Z=R-1,ue=T.length;++Z<ue;)if(T[Z]===B)return Z;return-1}function Zc(T,B,R){for(var Z=R+1;Z--;)if(T[Z]===B)return Z;return Z}function cr(T){return lr(T)?Qc(T):Uc(T)}function Ot(T){return lr(T)?jc(T):Pc(T)}function wo(T){for(var B=T.length;B--&&Gl.test(T.charAt(B)););return B}var Jc=Ai(Ic);function Qc(T){for(var B=yi.lastIndex=0;yi.test(T);)++B;return B}function jc(T){return T.match(yi)||[]}function eh(T){return T.match(wc)||[]}var th=function T(B){B=B==null?Ge:hr.defaults(Ge.Object(),B,hr.pick(Ge,kc));var R=B.Array,Z=B.Date,ue=B.Error,ve=B.Function,Ue=B.Math,xe=B.Object,Mi=B.RegExp,nh=B.String,At=B.TypeError,gs=R.prototype,rh=ve.prototype,_r=xe.prototype,ps=B["__core-js_shared__"],ms=rh.toString,be=_r.hasOwnProperty,sh=0,bo=function(){var e=/[^.]+$/.exec(ps&&ps.keys&&ps.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),ys=_r.toString,ih=ms.call(xe),ah=Ge._,oh=Mi("^"+ms.call(be).replace(Te,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),vs=ro?B.Buffer:n,In=B.Symbol,ws=B.Uint8Array,xo=vs?vs.allocUnsafe:n,bs=vo(xe.getPrototypeOf,xe),ko=xe.create,To=_r.propertyIsEnumerable,xs=gs.splice,Ao=In?In.isConcatSpreadable:n,Pr=In?In.iterator:n,Kn=In?In.toStringTag:n,ks=function(){try{var e=Xn(xe,"defineProperty");return e({},"",{}),e}catch{}}(),uh=B.clearTimeout!==Ge.clearTimeout&&B.clearTimeout,lh=Z&&Z.now!==Ge.Date.now&&Z.now,ch=B.setTimeout!==Ge.setTimeout&&B.setTimeout,Ts=Ue.ceil,As=Ue.floor,Ri=xe.getOwnPropertySymbols,hh=vs?vs.isBuffer:n,Eo=B.isFinite,_h=gs.join,fh=vo(xe.keys,xe),Pe=Ue.max,He=Ue.min,dh=Z.now,gh=B.parseInt,Io=Ue.random,ph=gs.reverse,Bi=Xn(B,"DataView"),Or=Xn(B,"Map"),Fi=Xn(B,"Promise"),fr=Xn(B,"Set"),Nr=Xn(B,"WeakMap"),zr=Xn(xe,"create"),Es=Nr&&new Nr,dr={},mh=Yn(Bi),yh=Yn(Or),vh=Yn(Fi),wh=Yn(fr),bh=Yn(Nr),Is=In?In.prototype:n,Dr=Is?Is.valueOf:n,So=Is?Is.toString:n;function f(e){if(Ce(e)&&!le(e)&&!(e instanceof pe)){if(e instanceof Et)return e;if(be.call(e,"__wrapped__"))return Cu(e)}return new Et(e)}var gr=function(){function e(){}return function(t){if(!Se(t))return{};if(ko)return ko(t);e.prototype=t;var i=new e;return e.prototype=n,i}}();function Ss(){}function Et(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=n}f.templateSettings={escape:b,evaluate:C,interpolate:L,variable:"",imports:{_:f}},f.prototype=Ss.prototype,f.prototype.constructor=f,Et.prototype=gr(Ss.prototype),Et.prototype.constructor=Et;function pe(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Ne,this.__views__=[]}function xh(){var e=new pe(this.__wrapped__);return e.__actions__=st(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=st(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=st(this.__views__),e}function kh(){if(this.__filtered__){var e=new pe(this);e.__dir__=-1,e.__filtered__=!0}else e=this.clone(),e.__dir__*=-1;return e}function Th(){var e=this.__wrapped__.value(),t=this.__dir__,i=le(e),u=t<0,_=i?e.length:0,g=P_(0,_,this.__views__),v=g.start,x=g.end,A=x-v,U=u?x:v-1,P=this.__iteratees__,G=P.length,$=0,te=He(A,this.__takeCount__);if(!i||!u&&_==A&&te==A)return Qo(e,this.__actions__);var ie=[];e:for(;A--&&$<te;){U+=t;for(var _e=-1,ae=e[U];++_e<G;){var de=P[_e],me=de.iteratee,pt=de.type,je=me(ae);if(pt==Mr)ae=je;else if(!je){if(pt==ye)continue e;break e}}ie[$++]=ae}return ie}pe.prototype=gr(Ss.prototype),pe.prototype.constructor=pe;function Wn(e){var t=-1,i=e==null?0:e.length;for(this.clear();++t<i;){var u=e[t];this.set(u[0],u[1])}}function Ah(){this.__data__=zr?zr(null):{},this.size=0}function Eh(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}function Ih(e){var t=this.__data__;if(zr){var i=t[e];return i===w?n:i}return be.call(t,e)?t[e]:n}function Sh(e){var t=this.__data__;return zr?t[e]!==n:be.call(t,e)}function Ch(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=zr&&t===n?w:t,this}Wn.prototype.clear=Ah,Wn.prototype.delete=Eh,Wn.prototype.get=Ih,Wn.prototype.has=Sh,Wn.prototype.set=Ch;function an(e){var t=-1,i=e==null?0:e.length;for(this.clear();++t<i;){var u=e[t];this.set(u[0],u[1])}}function Mh(){this.__data__=[],this.size=0}function Rh(e){var t=this.__data__,i=Cs(t,e);if(i<0)return!1;var u=t.length-1;return i==u?t.pop():xs.call(t,i,1),--this.size,!0}function Bh(e){var t=this.__data__,i=Cs(t,e);return i<0?n:t[i][1]}function Fh(e){return Cs(this.__data__,e)>-1}function Lh(e,t){var i=this.__data__,u=Cs(i,e);return u<0?(++this.size,i.push([e,t])):i[u][1]=t,this}an.prototype.clear=Mh,an.prototype.delete=Rh,an.prototype.get=Bh,an.prototype.has=Fh,an.prototype.set=Lh;function on(e){var t=-1,i=e==null?0:e.length;for(this.clear();++t<i;){var u=e[t];this.set(u[0],u[1])}}function Uh(){this.size=0,this.__data__={hash:new Wn,map:new(Or||an),string:new Wn}}function Ph(e){var t=Gs(this,e).delete(e);return this.size-=t?1:0,t}function Oh(e){return Gs(this,e).get(e)}function Nh(e){return Gs(this,e).has(e)}function zh(e,t){var i=Gs(this,e),u=i.size;return i.set(e,t),this.size+=i.size==u?0:1,this}on.prototype.clear=Uh,on.prototype.delete=Ph,on.prototype.get=Oh,on.prototype.has=Nh,on.prototype.set=zh;function $n(e){var t=-1,i=e==null?0:e.length;for(this.__data__=new on;++t<i;)this.add(e[t])}function Dh(e){return this.__data__.set(e,w),this}function Gh(e){return this.__data__.has(e)}$n.prototype.add=$n.prototype.push=Dh,$n.prototype.has=Gh;function Nt(e){var t=this.__data__=new an(e);this.size=t.size}function qh(){this.__data__=new an,this.size=0}function Kh(e){var t=this.__data__,i=t.delete(e);return this.size=t.size,i}function Wh(e){return this.__data__.get(e)}function $h(e){return this.__data__.has(e)}function Hh(e,t){var i=this.__data__;if(i instanceof an){var u=i.__data__;if(!Or||u.length<l-1)return u.push([e,t]),this.size=++i.size,this;i=this.__data__=new on(u)}return i.set(e,t),this.size=i.size,this}Nt.prototype.clear=qh,Nt.prototype.delete=Kh,Nt.prototype.get=Wh,Nt.prototype.has=$h,Nt.prototype.set=Hh;function Co(e,t){var i=le(e),u=!i&&Zn(e),_=!i&&!u&&Bn(e),g=!i&&!u&&!_&&vr(e),v=i||u||_||g,x=v?Ii(e.length,nh):[],A=x.length;for(var U in e)(t||be.call(e,U))&&!(v&&(U=="length"||_&&(U=="offset"||U=="parent")||g&&(U=="buffer"||U=="byteLength"||U=="byteOffset")||hn(U,A)))&&x.push(U);return x}function Mo(e){var t=e.length;return t?e[Wi(0,t-1)]:n}function Vh(e,t){return qs(st(e),Hn(t,0,e.length))}function Xh(e){return qs(st(e))}function Li(e,t,i){(i!==n&&!zt(e[t],i)||i===n&&!(t in e))&&un(e,t,i)}function Gr(e,t,i){var u=e[t];(!(be.call(e,t)&&zt(u,i))||i===n&&!(t in e))&&un(e,t,i)}function Cs(e,t){for(var i=e.length;i--;)if(zt(e[i][0],t))return i;return-1}function Yh(e,t,i,u){return Sn(e,function(_,g,v){t(u,_,i(_),v)}),u}function Ro(e,t){return e&&Yt(t,ze(t),e)}function Zh(e,t){return e&&Yt(t,at(t),e)}function un(e,t,i){t=="__proto__"&&ks?ks(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}function Ui(e,t){for(var i=-1,u=t.length,_=R(u),g=e==null;++i<u;)_[i]=g?n:ga(e,t[i]);return _}function Hn(e,t,i){return e===e&&(i!==n&&(e=e<=i?e:i),t!==n&&(e=e>=t?e:t)),e}function It(e,t,i,u,_,g){var v,x=t&M,A=t&z,U=t&N;if(i&&(v=_?i(e,u,_,g):i(e)),v!==n)return v;if(!Se(e))return e;var P=le(e);if(P){if(v=N_(e),!x)return st(e,v)}else{var G=Ve(e),$=G==$e||G==tr;if(Bn(e))return tu(e,x);if(G==bt||G==Vt||$&&!_){if(v=A||$?{}:wu(e),!x)return A?I_(e,Zh(v,e)):E_(e,Ro(v,e))}else{if(!ke[G])return _?e:{};v=z_(e,G,x)}}g||(g=new Nt);var te=g.get(e);if(te)return te;g.set(e,v),Yu(e)?e.forEach(function(ae){v.add(It(ae,t,i,ae,e,g))}):Vu(e)&&e.forEach(function(ae,de){v.set(de,It(ae,t,i,de,e,g))});var ie=U?A?ta:ea:A?at:ze,_e=P?n:ie(e);return Tt(_e||e,function(ae,de){_e&&(de=ae,ae=e[de]),Gr(v,de,It(ae,t,i,de,e,g))}),v}function Jh(e){var t=ze(e);return function(i){return Bo(i,e,t)}}function Bo(e,t,i){var u=i.length;if(e==null)return!u;for(e=xe(e);u--;){var _=i[u],g=t[_],v=e[_];if(v===n&&!(_ in e)||!g(v))return!1}return!0}function Fo(e,t,i){if(typeof e!="function")throw new At(d);return Xr(function(){e.apply(n,i)},t)}function qr(e,t,i,u){var _=-1,g=_s,v=!0,x=e.length,A=[],U=t.length;if(!x)return A;i&&(t=Ee(t,ft(i))),u?(g=bi,v=!1):t.length>=l&&(g=Ur,v=!1,t=new $n(t));e:for(;++_<x;){var P=e[_],G=i==null?P:i(P);if(P=u||P!==0?P:0,v&&G===G){for(var $=U;$--;)if(t[$]===G)continue e;A.push(P)}else g(t,G,u)||A.push(P)}return A}var Sn=au(Xt),Lo=au(Oi,!0);function Qh(e,t){var i=!0;return Sn(e,function(u,_,g){return i=!!t(u,_,g),i}),i}function Ms(e,t,i){for(var u=-1,_=e.length;++u<_;){var g=e[u],v=t(g);if(v!=null&&(x===n?v===v&&!gt(v):i(v,x)))var x=v,A=g}return A}function jh(e,t,i,u){var _=e.length;for(i=he(i),i<0&&(i=-i>_?0:_+i),u=u===n||u>_?_:he(u),u<0&&(u+=_),u=i>u?0:Ju(u);i<u;)e[i++]=t;return e}function Uo(e,t){var i=[];return Sn(e,function(u,_,g){t(u,_,g)&&i.push(u)}),i}function qe(e,t,i,u,_){var g=-1,v=e.length;for(i||(i=G_),_||(_=[]);++g<v;){var x=e[g];t>0&&i(x)?t>1?qe(x,t-1,i,u,_):An(_,x):u||(_[_.length]=x)}return _}var Pi=ou(),Po=ou(!0);function Xt(e,t){return e&&Pi(e,t,ze)}function Oi(e,t){return e&&Po(e,t,ze)}function Rs(e,t){return Tn(t,function(i){return _n(e[i])})}function Vn(e,t){t=Mn(t,e);for(var i=0,u=t.length;e!=null&&i<u;)e=e[Zt(t[i++])];return i&&i==u?e:n}function Oo(e,t,i){var u=t(e);return le(e)?u:An(u,i(e))}function Je(e){return e==null?e===n?os:is:Kn&&Kn in xe(e)?U_(e):X_(e)}function Ni(e,t){return e>t}function e_(e,t){return e!=null&&be.call(e,t)}function t_(e,t){return e!=null&&t in xe(e)}function n_(e,t,i){return e>=He(t,i)&&e<Pe(t,i)}function zi(e,t,i){for(var u=i?bi:_s,_=e[0].length,g=e.length,v=g,x=R(g),A=1/0,U=[];v--;){var P=e[v];v&&t&&(P=Ee(P,ft(t))),A=He(P.length,A),x[v]=!i&&(t||_>=120&&P.length>=120)?new $n(v&&P):n}P=e[0];var G=-1,$=x[0];e:for(;++G<_&&U.length<A;){var te=P[G],ie=t?t(te):te;if(te=i||te!==0?te:0,!($?Ur($,ie):u(U,ie,i))){for(v=g;--v;){var _e=x[v];if(!(_e?Ur(_e,ie):u(e[v],ie,i)))continue e}$&&$.push(ie),U.push(te)}}return U}function r_(e,t,i,u){return Xt(e,function(_,g,v){t(u,i(_),g,v)}),u}function Kr(e,t,i){t=Mn(t,e),e=Tu(e,t);var u=e==null?e:e[Zt(Ct(t))];return u==null?n:_t(u,e,i)}function No(e){return Ce(e)&&Je(e)==Vt}function s_(e){return Ce(e)&&Je(e)==rn}function i_(e){return Ce(e)&&Je(e)==yn}function Wr(e,t,i,u,_){return e===t?!0:e==null||t==null||!Ce(e)&&!Ce(t)?e!==e&&t!==t:a_(e,t,i,u,Wr,_)}function a_(e,t,i,u,_,g){var v=le(e),x=le(t),A=v?Nn:Ve(e),U=x?Nn:Ve(t);A=A==Vt?bt:A,U=U==Vt?bt:U;var P=A==bt,G=U==bt,$=A==U;if($&&Bn(e)){if(!Bn(t))return!1;v=!0,P=!1}if($&&!P)return g||(g=new Nt),v||vr(e)?mu(e,t,i,u,_,g):F_(e,t,A,i,u,_,g);if(!(i&q)){var te=P&&be.call(e,"__wrapped__"),ie=G&&be.call(t,"__wrapped__");if(te||ie){var _e=te?e.value():e,ae=ie?t.value():t;return g||(g=new Nt),_(_e,ae,i,u,g)}}return $?(g||(g=new Nt),L_(e,t,i,u,_,g)):!1}function o_(e){return Ce(e)&&Ve(e)==nt}function Di(e,t,i,u){var _=i.length,g=_,v=!u;if(e==null)return!g;for(e=xe(e);_--;){var x=i[_];if(v&&x[2]?x[1]!==e[x[0]]:!(x[0]in e))return!1}for(;++_<g;){x=i[_];var A=x[0],U=e[A],P=x[1];if(v&&x[2]){if(U===n&&!(A in e))return!1}else{var G=new Nt;if(u)var $=u(U,P,A,e,t,G);if(!($===n?Wr(P,U,q|X,u,G):$))return!1}}return!0}function zo(e){if(!Se(e)||K_(e))return!1;var t=_n(e)?oh:Jl;return t.test(Yn(e))}function u_(e){return Ce(e)&&Je(e)==E}function l_(e){return Ce(e)&&Ve(e)==k}function c_(e){return Ce(e)&&Xs(e.length)&&!!Ae[Je(e)]}function Do(e){return typeof e=="function"?e:e==null?ot:typeof e=="object"?le(e)?Ko(e[0],e[1]):qo(e):ul(e)}function Gi(e){if(!Vr(e))return fh(e);var t=[];for(var i in xe(e))be.call(e,i)&&i!="constructor"&&t.push(i);return t}function h_(e){if(!Se(e))return V_(e);var t=Vr(e),i=[];for(var u in e)u=="constructor"&&(t||!be.call(e,u))||i.push(u);return i}function qi(e,t){return e<t}function Go(e,t){var i=-1,u=it(e)?R(e.length):[];return Sn(e,function(_,g,v){u[++i]=t(_,g,v)}),u}function qo(e){var t=ra(e);return t.length==1&&t[0][2]?xu(t[0][0],t[0][1]):function(i){return i===e||Di(i,e,t)}}function Ko(e,t){return ia(e)&&bu(t)?xu(Zt(e),t):function(i){var u=ga(i,e);return u===n&&u===t?pa(i,e):Wr(t,u,q|X)}}function Bs(e,t,i,u,_){e!==t&&Pi(t,function(g,v){if(_||(_=new Nt),Se(g))__(e,t,v,i,Bs,u,_);else{var x=u?u(oa(e,v),g,v+"",e,t,_):n;x===n&&(x=g),Li(e,v,x)}},at)}function __(e,t,i,u,_,g,v){var x=oa(e,i),A=oa(t,i),U=v.get(A);if(U){Li(e,i,U);return}var P=g?g(x,A,i+"",e,t,v):n,G=P===n;if(G){var $=le(A),te=!$&&Bn(A),ie=!$&&!te&&vr(A);P=A,$||te||ie?le(x)?P=x:Re(x)?P=st(x):te?(G=!1,P=tu(A,!0)):ie?(G=!1,P=nu(A,!0)):P=[]:Yr(A)||Zn(A)?(P=x,Zn(x)?P=Qu(x):(!Se(x)||_n(x))&&(P=wu(A))):G=!1}G&&(v.set(A,P),_(P,A,u,g,v),v.delete(A)),Li(e,i,P)}function Wo(e,t){var i=e.length;if(i)return t+=t<0?i:0,hn(t,i)?e[t]:n}function $o(e,t,i){t.length?t=Ee(t,function(g){return le(g)?function(v){return Vn(v,g.length===1?g[0]:g)}:g}):t=[ot];var u=-1;t=Ee(t,ft(se()));var _=Go(e,function(g,v,x){var A=Ee(t,function(U){return U(g)});return{criteria:A,index:++u,value:g}});return zc(_,function(g,v){return A_(g,v,i)})}function f_(e,t){return Ho(e,t,function(i,u){return pa(e,u)})}function Ho(e,t,i){for(var u=-1,_=t.length,g={};++u<_;){var v=t[u],x=Vn(e,v);i(x,v)&&$r(g,Mn(v,e),x)}return g}function d_(e){return function(t){return Vn(t,e)}}function Ki(e,t,i,u){var _=u?Nc:ur,g=-1,v=t.length,x=e;for(e===t&&(t=st(t)),i&&(x=Ee(e,ft(i)));++g<v;)for(var A=0,U=t[g],P=i?i(U):U;(A=_(x,P,A,u))>-1;)x!==e&&xs.call(x,A,1),xs.call(e,A,1);return e}function Vo(e,t){for(var i=e?t.length:0,u=i-1;i--;){var _=t[i];if(i==u||_!==g){var g=_;hn(_)?xs.call(e,_,1):Vi(e,_)}}return e}function Wi(e,t){return e+As(Io()*(t-e+1))}function g_(e,t,i,u){for(var _=-1,g=Pe(Ts((t-e)/(i||1)),0),v=R(g);g--;)v[u?g:++_]=e,e+=i;return v}function $i(e,t){var i="";if(!e||t<1||t>Ze)return i;do t%2&&(i+=e),t=As(t/2),t&&(e+=e);while(t);return i}function fe(e,t){return ua(ku(e,t,ot),e+"")}function p_(e){return Mo(wr(e))}function m_(e,t){var i=wr(e);return qs(i,Hn(t,0,i.length))}function $r(e,t,i,u){if(!Se(e))return e;t=Mn(t,e);for(var _=-1,g=t.length,v=g-1,x=e;x!=null&&++_<g;){var A=Zt(t[_]),U=i;if(A==="__proto__"||A==="constructor"||A==="prototype")return e;if(_!=v){var P=x[A];U=u?u(P,A,x):n,U===n&&(U=Se(P)?P:hn(t[_+1])?[]:{})}Gr(x,A,U),x=x[A]}return e}var Xo=Es?function(e,t){return Es.set(e,t),e}:ot,y_=ks?function(e,t){return ks(e,"toString",{configurable:!0,enumerable:!1,value:ya(t),writable:!0})}:ot;function v_(e){return qs(wr(e))}function St(e,t,i){var u=-1,_=e.length;t<0&&(t=-t>_?0:_+t),i=i>_?_:i,i<0&&(i+=_),_=t>i?0:i-t>>>0,t>>>=0;for(var g=R(_);++u<_;)g[u]=e[u+t];return g}function w_(e,t){var i;return Sn(e,function(u,_,g){return i=t(u,_,g),!i}),!!i}function Fs(e,t,i){var u=0,_=e==null?u:e.length;if(typeof t=="number"&&t===t&&_<=er){for(;u<_;){var g=u+_>>>1,v=e[g];v!==null&&!gt(v)&&(i?v<=t:v<t)?u=g+1:_=g}return _}return Hi(e,t,ot,i)}function Hi(e,t,i,u){var _=0,g=e==null?0:e.length;if(g===0)return 0;t=i(t);for(var v=t!==t,x=t===null,A=gt(t),U=t===n;_<g;){var P=As((_+g)/2),G=i(e[P]),$=G!==n,te=G===null,ie=G===G,_e=gt(G);if(v)var ae=u||ie;else U?ae=ie&&(u||$):x?ae=ie&&$&&(u||!te):A?ae=ie&&$&&!te&&(u||!_e):te||_e?ae=!1:ae=u?G<=t:G<t;ae?_=P+1:g=P}return He(g,Rr)}function Yo(e,t){for(var i=-1,u=e.length,_=0,g=[];++i<u;){var v=e[i],x=t?t(v):v;if(!i||!zt(x,A)){var A=x;g[_++]=v===0?0:v}}return g}function Zo(e){return typeof e=="number"?e:gt(e)?mn:+e}function dt(e){if(typeof e=="string")return e;if(le(e))return Ee(e,dt)+"";if(gt(e))return So?So.call(e):"";var t=e+"";return t=="0"&&1/e==-Ut?"-0":t}function Cn(e,t,i){var u=-1,_=_s,g=e.length,v=!0,x=[],A=x;if(i)v=!1,_=bi;else if(g>=l){var U=t?null:R_(e);if(U)return ds(U);v=!1,_=Ur,A=new $n}else A=t?[]:x;e:for(;++u<g;){var P=e[u],G=t?t(P):P;if(P=i||P!==0?P:0,v&&G===G){for(var $=A.length;$--;)if(A[$]===G)continue e;t&&A.push(G),x.push(P)}else _(A,G,i)||(A!==x&&A.push(G),x.push(P))}return x}function Vi(e,t){return t=Mn(t,e),e=Tu(e,t),e==null||delete e[Zt(Ct(t))]}function Jo(e,t,i,u){return $r(e,t,i(Vn(e,t)),u)}function Ls(e,t,i,u){for(var _=e.length,g=u?_:-1;(u?g--:++g<_)&&t(e[g],g,e););return i?St(e,u?0:g,u?g+1:_):St(e,u?g+1:0,u?_:g)}function Qo(e,t){var i=e;return i instanceof pe&&(i=i.value()),xi(t,function(u,_){return _.func.apply(_.thisArg,An([u],_.args))},i)}function Xi(e,t,i){var u=e.length;if(u<2)return u?Cn(e[0]):[];for(var _=-1,g=R(u);++_<u;)for(var v=e[_],x=-1;++x<u;)x!=_&&(g[_]=qr(g[_]||v,e[x],t,i));return Cn(qe(g,1),t,i)}function jo(e,t,i){for(var u=-1,_=e.length,g=t.length,v={};++u<_;){var x=u<g?t[u]:n;i(v,e[u],x)}return v}function Yi(e){return Re(e)?e:[]}function Zi(e){return typeof e=="function"?e:ot}function Mn(e,t){return le(e)?e:ia(e,t)?[e]:Su(we(e))}var b_=fe;function Rn(e,t,i){var u=e.length;return i=i===n?u:i,!t&&i>=u?e:St(e,t,i)}var eu=uh||function(e){return Ge.clearTimeout(e)};function tu(e,t){if(t)return e.slice();var i=e.length,u=xo?xo(i):new e.constructor(i);return e.copy(u),u}function Ji(e){var t=new e.constructor(e.byteLength);return new ws(t).set(new ws(e)),t}function x_(e,t){var i=t?Ji(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.byteLength)}function k_(e){var t=new e.constructor(e.source,Oa.exec(e));return t.lastIndex=e.lastIndex,t}function T_(e){return Dr?xe(Dr.call(e)):{}}function nu(e,t){var i=t?Ji(e.buffer):e.buffer;return new e.constructor(i,e.byteOffset,e.length)}function ru(e,t){if(e!==t){var i=e!==n,u=e===null,_=e===e,g=gt(e),v=t!==n,x=t===null,A=t===t,U=gt(t);if(!x&&!U&&!g&&e>t||g&&v&&A&&!x&&!U||u&&v&&A||!i&&A||!_)return 1;if(!u&&!g&&!U&&e<t||U&&i&&_&&!u&&!g||x&&i&&_||!v&&_||!A)return-1}return 0}function A_(e,t,i){for(var u=-1,_=e.criteria,g=t.criteria,v=_.length,x=i.length;++u<v;){var A=ru(_[u],g[u]);if(A){if(u>=x)return A;var U=i[u];return A*(U=="desc"?-1:1)}}return e.index-t.index}function su(e,t,i,u){for(var _=-1,g=e.length,v=i.length,x=-1,A=t.length,U=Pe(g-v,0),P=R(A+U),G=!u;++x<A;)P[x]=t[x];for(;++_<v;)(G||_<g)&&(P[i[_]]=e[_]);for(;U--;)P[x++]=e[_++];return P}function iu(e,t,i,u){for(var _=-1,g=e.length,v=-1,x=i.length,A=-1,U=t.length,P=Pe(g-x,0),G=R(P+U),$=!u;++_<P;)G[_]=e[_];for(var te=_;++A<U;)G[te+A]=t[A];for(;++v<x;)($||_<g)&&(G[te+i[v]]=e[_++]);return G}function st(e,t){var i=-1,u=e.length;for(t||(t=R(u));++i<u;)t[i]=e[i];return t}function Yt(e,t,i,u){var _=!i;i||(i={});for(var g=-1,v=t.length;++g<v;){var x=t[g],A=u?u(i[x],e[x],x,i,e):n;A===n&&(A=e[x]),_?un(i,x,A):Gr(i,x,A)}return i}function E_(e,t){return Yt(e,sa(e),t)}function I_(e,t){return Yt(e,yu(e),t)}function Us(e,t){return function(i,u){var _=le(i)?Bc:Yh,g=t?t():{};return _(i,e,se(u,2),g)}}function pr(e){return fe(function(t,i){var u=-1,_=i.length,g=_>1?i[_-1]:n,v=_>2?i[2]:n;for(g=e.length>3&&typeof g=="function"?(_--,g):n,v&&Qe(i[0],i[1],v)&&(g=_<3?n:g,_=1),t=xe(t);++u<_;){var x=i[u];x&&e(t,x,u,g)}return t})}function au(e,t){return function(i,u){if(i==null)return i;if(!it(i))return e(i,u);for(var _=i.length,g=t?_:-1,v=xe(i);(t?g--:++g<_)&&u(v[g],g,v)!==!1;);return i}}function ou(e){return function(t,i,u){for(var _=-1,g=xe(t),v=u(t),x=v.length;x--;){var A=v[e?x:++_];if(i(g[A],A,g)===!1)break}return t}}function S_(e,t,i){var u=t&D,_=Hr(e);function g(){var v=this&&this!==Ge&&this instanceof g?_:e;return v.apply(u?i:this,arguments)}return g}function uu(e){return function(t){t=we(t);var i=lr(t)?Ot(t):n,u=i?i[0]:t.charAt(0),_=i?Rn(i,1).join(""):t.slice(1);return u[e]()+_}}function mr(e){return function(t){return xi(al(il(t).replace(yc,"")),e,"")}}function Hr(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var i=gr(e.prototype),u=e.apply(i,t);return Se(u)?u:i}}function C_(e,t,i){var u=Hr(e);function _(){for(var g=arguments.length,v=R(g),x=g,A=yr(_);x--;)v[x]=arguments[x];var U=g<3&&v[0]!==A&&v[g-1]!==A?[]:En(v,A);if(g-=U.length,g<i)return fu(e,t,Ps,_.placeholder,n,v,U,n,n,i-g);var P=this&&this!==Ge&&this instanceof _?u:e;return _t(P,this,v)}return _}function lu(e){return function(t,i,u){var _=xe(t);if(!it(t)){var g=se(i,3);t=ze(t),i=function(x){return g(_[x],x,_)}}var v=e(t,i,u);return v>-1?_[g?t[v]:v]:n}}function cu(e){return cn(function(t){var i=t.length,u=i,_=Et.prototype.thru;for(e&&t.reverse();u--;){var g=t[u];if(typeof g!="function")throw new At(d);if(_&&!v&&Ds(g)=="wrapper")var v=new Et([],!0)}for(u=v?u:i;++u<i;){g=t[u];var x=Ds(g),A=x=="wrapper"?na(g):n;A&&aa(A[0])&&A[1]==(Me|Q|ee|Fe)&&!A[4].length&&A[9]==1?v=v[Ds(A[0])].apply(v,A[3]):v=g.length==1&&aa(g)?v[x]():v.thru(g)}return function(){var U=arguments,P=U[0];if(v&&U.length==1&&le(P))return v.plant(P).value();for(var G=0,$=i?t[G].apply(this,U):P;++G<i;)$=t[G].call(this,$);return $}})}function Ps(e,t,i,u,_,g,v,x,A,U){var P=t&Me,G=t&D,$=t&H,te=t&(Q|ne),ie=t&ht,_e=$?n:Hr(e);function ae(){for(var de=arguments.length,me=R(de),pt=de;pt--;)me[pt]=arguments[pt];if(te)var je=yr(ae),mt=Gc(me,je);if(u&&(me=su(me,u,_,te)),g&&(me=iu(me,g,v,te)),de-=mt,te&&de<U){var Be=En(me,je);return fu(e,t,Ps,ae.placeholder,i,me,Be,x,A,U-de)}var Dt=G?i:this,dn=$?Dt[e]:e;return de=me.length,x?me=Y_(me,x):ie&&de>1&&me.reverse(),P&&A<de&&(me.length=A),this&&this!==Ge&&this instanceof ae&&(dn=_e||Hr(dn)),dn.apply(Dt,me)}return ae}function hu(e,t){return function(i,u){return r_(i,e,t(u),{})}}function Os(e,t){return function(i,u){var _;if(i===n&&u===n)return t;if(i!==n&&(_=i),u!==n){if(_===n)return u;typeof i=="string"||typeof u=="string"?(i=dt(i),u=dt(u)):(i=Zo(i),u=Zo(u)),_=e(i,u)}return _}}function Qi(e){return cn(function(t){return t=Ee(t,ft(se())),fe(function(i){var u=this;return e(t,function(_){return _t(_,u,i)})})})}function Ns(e,t){t=t===n?" ":dt(t);var i=t.length;if(i<2)return i?$i(t,e):t;var u=$i(t,Ts(e/cr(t)));return lr(t)?Rn(Ot(u),0,e).join(""):u.slice(0,e)}function M_(e,t,i,u){var _=t&D,g=Hr(e);function v(){for(var x=-1,A=arguments.length,U=-1,P=u.length,G=R(P+A),$=this&&this!==Ge&&this instanceof v?g:e;++U<P;)G[U]=u[U];for(;A--;)G[U++]=arguments[++x];return _t($,_?i:this,G)}return v}function _u(e){return function(t,i,u){return u&&typeof u!="number"&&Qe(t,i,u)&&(i=u=n),t=fn(t),i===n?(i=t,t=0):i=fn(i),u=u===n?t<i?1:-1:fn(u),g_(t,i,u,e)}}function zs(e){return function(t,i){return typeof t=="string"&&typeof i=="string"||(t=Mt(t),i=Mt(i)),e(t,i)}}function fu(e,t,i,u,_,g,v,x,A,U){var P=t&Q,G=P?v:n,$=P?n:v,te=P?g:n,ie=P?n:g;t|=P?ee:j,t&=~(P?j:ee),t&ce||(t&=~(D|H));var _e=[e,t,_,te,G,ie,$,x,A,U],ae=i.apply(n,_e);return aa(e)&&Au(ae,_e),ae.placeholder=u,Eu(ae,e,t)}function ji(e){var t=Ue[e];return function(i,u){if(i=Mt(i),u=u==null?0:He(he(u),292),u&&Eo(i)){var _=(we(i)+"e").split("e"),g=t(_[0]+"e"+(+_[1]+u));return _=(we(g)+"e").split("e"),+(_[0]+"e"+(+_[1]-u))}return t(i)}}var R_=fr&&1/ds(new fr([,-0]))[1]==Ut?function(e){return new fr(e)}:ba;function du(e){return function(t){var i=Ve(t);return i==nt?Ci(t):i==k?Xc(t):Dc(t,e(t))}}function ln(e,t,i,u,_,g,v,x){var A=t&H;if(!A&&typeof e!="function")throw new At(d);var U=u?u.length:0;if(U||(t&=~(ee|j),u=_=n),v=v===n?v:Pe(he(v),0),x=x===n?x:he(x),U-=_?_.length:0,t&j){var P=u,G=_;u=_=n}var $=A?n:na(e),te=[e,t,i,u,_,P,G,g,v,x];if($&&H_(te,$),e=te[0],t=te[1],i=te[2],u=te[3],_=te[4],x=te[9]=te[9]===n?A?0:e.length:Pe(te[9]-U,0),!x&&t&(Q|ne)&&(t&=~(Q|ne)),!t||t==D)var ie=S_(e,t,i);else t==Q||t==ne?ie=C_(e,t,x):(t==ee||t==(D|ee))&&!_.length?ie=M_(e,t,i,u):ie=Ps.apply(n,te);var _e=$?Xo:Au;return Eu(_e(ie,te),e,t)}function gu(e,t,i,u){return e===n||zt(e,_r[i])&&!be.call(u,i)?t:e}function pu(e,t,i,u,_,g){return Se(e)&&Se(t)&&(g.set(t,e),Bs(e,t,n,pu,g),g.delete(t)),e}function B_(e){return Yr(e)?n:e}function mu(e,t,i,u,_,g){var v=i&q,x=e.length,A=t.length;if(x!=A&&!(v&&A>x))return!1;var U=g.get(e),P=g.get(t);if(U&&P)return U==t&&P==e;var G=-1,$=!0,te=i&X?new $n:n;for(g.set(e,t),g.set(t,e);++G<x;){var ie=e[G],_e=t[G];if(u)var ae=v?u(_e,ie,G,t,e,g):u(ie,_e,G,e,t,g);if(ae!==n){if(ae)continue;$=!1;break}if(te){if(!ki(t,function(de,me){if(!Ur(te,me)&&(ie===de||_(ie,de,i,u,g)))return te.push(me)})){$=!1;break}}else if(!(ie===_e||_(ie,_e,i,u,g))){$=!1;break}}return g.delete(e),g.delete(t),$}function F_(e,t,i,u,_,g,v){switch(i){case xt:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case rn:return!(e.byteLength!=t.byteLength||!g(new ws(e),new ws(t)));case tn:case yn:case vn:return zt(+e,+t);case zn:return e.name==t.name&&e.message==t.message;case E:case p:return e==t+"";case nt:var x=Ci;case k:var A=u&q;if(x||(x=ds),e.size!=t.size&&!A)return!1;var U=v.get(e);if(U)return U==t;u|=X,v.set(e,t);var P=mu(x(e),x(t),u,_,g,v);return v.delete(e),P;case wn:if(Dr)return Dr.call(e)==Dr.call(t)}return!1}function L_(e,t,i,u,_,g){var v=i&q,x=ea(e),A=x.length,U=ea(t),P=U.length;if(A!=P&&!v)return!1;for(var G=A;G--;){var $=x[G];if(!(v?$ in t:be.call(t,$)))return!1}var te=g.get(e),ie=g.get(t);if(te&&ie)return te==t&&ie==e;var _e=!0;g.set(e,t),g.set(t,e);for(var ae=v;++G<A;){$=x[G];var de=e[$],me=t[$];if(u)var pt=v?u(me,de,$,t,e,g):u(de,me,$,e,t,g);if(!(pt===n?de===me||_(de,me,i,u,g):pt)){_e=!1;break}ae||(ae=$=="constructor")}if(_e&&!ae){var je=e.constructor,mt=t.constructor;je!=mt&&"constructor"in e&&"constructor"in t&&!(typeof je=="function"&&je instanceof je&&typeof mt=="function"&&mt instanceof mt)&&(_e=!1)}return g.delete(e),g.delete(t),_e}function cn(e){return ua(ku(e,n,Bu),e+"")}function ea(e){return Oo(e,ze,sa)}function ta(e){return Oo(e,at,yu)}var na=Es?function(e){return Es.get(e)}:ba;function Ds(e){for(var t=e.name+"",i=dr[t],u=be.call(dr,t)?i.length:0;u--;){var _=i[u],g=_.func;if(g==null||g==e)return _.name}return t}function yr(e){var t=be.call(f,"placeholder")?f:e;return t.placeholder}function se(){var e=f.iteratee||va;return e=e===va?Do:e,arguments.length?e(arguments[0],arguments[1]):e}function Gs(e,t){var i=e.__data__;return q_(t)?i[typeof t=="string"?"string":"hash"]:i.map}function ra(e){for(var t=ze(e),i=t.length;i--;){var u=t[i],_=e[u];t[i]=[u,_,bu(_)]}return t}function Xn(e,t){var i=$c(e,t);return zo(i)?i:n}function U_(e){var t=be.call(e,Kn),i=e[Kn];try{e[Kn]=n;var u=!0}catch{}var _=ys.call(e);return u&&(t?e[Kn]=i:delete e[Kn]),_}var sa=Ri?function(e){return e==null?[]:(e=xe(e),Tn(Ri(e),function(t){return To.call(e,t)}))}:xa,yu=Ri?function(e){for(var t=[];e;)An(t,sa(e)),e=bs(e);return t}:xa,Ve=Je;(Bi&&Ve(new Bi(new ArrayBuffer(1)))!=xt||Or&&Ve(new Or)!=nt||Fi&&Ve(Fi.resolve())!=Lr||fr&&Ve(new fr)!=k||Nr&&Ve(new Nr)!=bn)&&(Ve=function(e){var t=Je(e),i=t==bt?e.constructor:n,u=i?Yn(i):"";if(u)switch(u){case mh:return xt;case yh:return nt;case vh:return Lr;case wh:return k;case bh:return bn}return t});function P_(e,t,i){for(var u=-1,_=i.length;++u<_;){var g=i[u],v=g.size;switch(g.type){case"drop":e+=v;break;case"dropRight":t-=v;break;case"take":t=He(t,e+v);break;case"takeRight":e=Pe(e,t-v);break}}return{start:e,end:t}}function O_(e){var t=e.match(Kl);return t?t[1].split(Wl):[]}function vu(e,t,i){t=Mn(t,e);for(var u=-1,_=t.length,g=!1;++u<_;){var v=Zt(t[u]);if(!(g=e!=null&&i(e,v)))break;e=e[v]}return g||++u!=_?g:(_=e==null?0:e.length,!!_&&Xs(_)&&hn(v,_)&&(le(e)||Zn(e)))}function N_(e){var t=e.length,i=new e.constructor(t);return t&&typeof e[0]=="string"&&be.call(e,"index")&&(i.index=e.index,i.input=e.input),i}function wu(e){return typeof e.constructor=="function"&&!Vr(e)?gr(bs(e)):{}}function z_(e,t,i){var u=e.constructor;switch(t){case rn:return Ji(e);case tn:case yn:return new u(+e);case xt:return x_(e,i);case xn:case Dn:case sn:case nr:case kn:case rr:case Gn:case sr:case ir:return nu(e,i);case nt:return new u;case vn:case p:return new u(e);case E:return k_(e);case k:return new u;case wn:return T_(e)}}function D_(e,t){var i=t.length;if(!i)return e;var u=i-1;return t[u]=(i>1?"& ":"")+t[u],t=t.join(i>2?", ":" "),e.replace(ql,`{
/* [wrapped with `+t+`] */
`)}function G_(e){return le(e)||Zn(e)||!!(Ao&&e&&e[Ao])}function hn(e,t){var i=typeof e;return t=t??Ze,!!t&&(i=="number"||i!="symbol"&&jl.test(e))&&e>-1&&e%1==0&&e<t}function Qe(e,t,i){if(!Se(i))return!1;var u=typeof t;return(u=="number"?it(i)&&hn(t,i.length):u=="string"&&t in i)?zt(i[t],e):!1}function ia(e,t){if(le(e))return!1;var i=typeof e;return i=="number"||i=="symbol"||i=="boolean"||e==null||gt(e)?!0:Y.test(e)||!W.test(e)||t!=null&&e in xe(t)}function q_(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}function aa(e){var t=Ds(e),i=f[t];if(typeof i!="function"||!(t in pe.prototype))return!1;if(e===i)return!0;var u=na(i);return!!u&&e===u[0]}function K_(e){return!!bo&&bo in e}var W_=ps?_n:ka;function Vr(e){var t=e&&e.constructor,i=typeof t=="function"&&t.prototype||_r;return e===i}function bu(e){return e===e&&!Se(e)}function xu(e,t){return function(i){return i==null?!1:i[e]===t&&(t!==n||e in xe(i))}}function $_(e){var t=Hs(e,function(u){return i.size===S&&i.clear(),u}),i=t.cache;return t}function H_(e,t){var i=e[1],u=t[1],_=i|u,g=_<(D|H|Me),v=u==Me&&i==Q||u==Me&&i==Fe&&e[7].length<=t[8]||u==(Me|Fe)&&t[7].length<=t[8]&&i==Q;if(!(g||v))return e;u&D&&(e[2]=t[2],_|=i&D?0:ce);var x=t[3];if(x){var A=e[3];e[3]=A?su(A,x,t[4]):x,e[4]=A?En(e[3],I):t[4]}return x=t[5],x&&(A=e[5],e[5]=A?iu(A,x,t[6]):x,e[6]=A?En(e[5],I):t[6]),x=t[7],x&&(e[7]=x),u&Me&&(e[8]=e[8]==null?t[8]:He(e[8],t[8])),e[9]==null&&(e[9]=t[9]),e[0]=t[0],e[1]=_,e}function V_(e){var t=[];if(e!=null)for(var i in xe(e))t.push(i);return t}function X_(e){return ys.call(e)}function ku(e,t,i){return t=Pe(t===n?e.length-1:t,0),function(){for(var u=arguments,_=-1,g=Pe(u.length-t,0),v=R(g);++_<g;)v[_]=u[t+_];_=-1;for(var x=R(t+1);++_<t;)x[_]=u[_];return x[t]=i(v),_t(e,this,x)}}function Tu(e,t){return t.length<2?e:Vn(e,St(t,0,-1))}function Y_(e,t){for(var i=e.length,u=He(t.length,i),_=st(e);u--;){var g=t[u];e[u]=hn(g,i)?_[g]:n}return e}function oa(e,t){if(!(t==="constructor"&&typeof e[t]=="function")&&t!="__proto__")return e[t]}var Au=Iu(Xo),Xr=ch||function(e,t){return Ge.setTimeout(e,t)},ua=Iu(y_);function Eu(e,t,i){var u=t+"";return ua(e,D_(u,Z_(O_(u),i)))}function Iu(e){var t=0,i=0;return function(){var u=dh(),_=We-(u-i);if(i=u,_>0){if(++t>=Ht)return arguments[0]}else t=0;return e.apply(n,arguments)}}function qs(e,t){var i=-1,u=e.length,_=u-1;for(t=t===n?u:t;++i<t;){var g=Wi(i,_),v=e[g];e[g]=e[i],e[i]=v}return e.length=t,e}var Su=$_(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(re,function(i,u,_,g){t.push(_?g.replace(Vl,"$1"):u||i)}),t});function Zt(e){if(typeof e=="string"||gt(e))return e;var t=e+"";return t=="0"&&1/e==-Ut?"-0":t}function Yn(e){if(e!=null){try{return ms.call(e)}catch{}try{return e+""}catch{}}return""}function Z_(e,t){return Tt(Br,function(i){var u="_."+i[0];t&i[1]&&!_s(e,u)&&e.push(u)}),e.sort()}function Cu(e){if(e instanceof pe)return e.clone();var t=new Et(e.__wrapped__,e.__chain__);return t.__actions__=st(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}function J_(e,t,i){(i?Qe(e,t,i):t===n)?t=1:t=Pe(he(t),0);var u=e==null?0:e.length;if(!u||t<1)return[];for(var _=0,g=0,v=R(Ts(u/t));_<u;)v[g++]=St(e,_,_+=t);return v}function Q_(e){for(var t=-1,i=e==null?0:e.length,u=0,_=[];++t<i;){var g=e[t];g&&(_[u++]=g)}return _}function j_(){var e=arguments.length;if(!e)return[];for(var t=R(e-1),i=arguments[0],u=e;u--;)t[u-1]=arguments[u];return An(le(i)?st(i):[i],qe(t,1))}var ef=fe(function(e,t){return Re(e)?qr(e,qe(t,1,Re,!0)):[]}),tf=fe(function(e,t){var i=Ct(t);return Re(i)&&(i=n),Re(e)?qr(e,qe(t,1,Re,!0),se(i,2)):[]}),nf=fe(function(e,t){var i=Ct(t);return Re(i)&&(i=n),Re(e)?qr(e,qe(t,1,Re,!0),n,i):[]});function rf(e,t,i){var u=e==null?0:e.length;return u?(t=i||t===n?1:he(t),St(e,t<0?0:t,u)):[]}function sf(e,t,i){var u=e==null?0:e.length;return u?(t=i||t===n?1:he(t),t=u-t,St(e,0,t<0?0:t)):[]}function af(e,t){return e&&e.length?Ls(e,se(t,3),!0,!0):[]}function of(e,t){return e&&e.length?Ls(e,se(t,3),!0):[]}function uf(e,t,i,u){var _=e==null?0:e.length;return _?(i&&typeof i!="number"&&Qe(e,t,i)&&(i=0,u=_),jh(e,t,i,u)):[]}function Mu(e,t,i){var u=e==null?0:e.length;if(!u)return-1;var _=i==null?0:he(i);return _<0&&(_=Pe(u+_,0)),fs(e,se(t,3),_)}function Ru(e,t,i){var u=e==null?0:e.length;if(!u)return-1;var _=u-1;return i!==n&&(_=he(i),_=i<0?Pe(u+_,0):He(_,u-1)),fs(e,se(t,3),_,!0)}function Bu(e){var t=e==null?0:e.length;return t?qe(e,1):[]}function lf(e){var t=e==null?0:e.length;return t?qe(e,Ut):[]}function cf(e,t){var i=e==null?0:e.length;return i?(t=t===n?1:he(t),qe(e,t)):[]}function hf(e){for(var t=-1,i=e==null?0:e.length,u={};++t<i;){var _=e[t];u[_[0]]=_[1]}return u}function Fu(e){return e&&e.length?e[0]:n}function _f(e,t,i){var u=e==null?0:e.length;if(!u)return-1;var _=i==null?0:he(i);return _<0&&(_=Pe(u+_,0)),ur(e,t,_)}function ff(e){var t=e==null?0:e.length;return t?St(e,0,-1):[]}var df=fe(function(e){var t=Ee(e,Yi);return t.length&&t[0]===e[0]?zi(t):[]}),gf=fe(function(e){var t=Ct(e),i=Ee(e,Yi);return t===Ct(i)?t=n:i.pop(),i.length&&i[0]===e[0]?zi(i,se(t,2)):[]}),pf=fe(function(e){var t=Ct(e),i=Ee(e,Yi);return t=typeof t=="function"?t:n,t&&i.pop(),i.length&&i[0]===e[0]?zi(i,n,t):[]});function mf(e,t){return e==null?"":_h.call(e,t)}function Ct(e){var t=e==null?0:e.length;return t?e[t-1]:n}function yf(e,t,i){var u=e==null?0:e.length;if(!u)return-1;var _=u;return i!==n&&(_=he(i),_=_<0?Pe(u+_,0):He(_,u-1)),t===t?Zc(e,t,_):fs(e,_o,_,!0)}function vf(e,t){return e&&e.length?Wo(e,he(t)):n}var wf=fe(Lu);function Lu(e,t){return e&&e.length&&t&&t.length?Ki(e,t):e}function bf(e,t,i){return e&&e.length&&t&&t.length?Ki(e,t,se(i,2)):e}function xf(e,t,i){return e&&e.length&&t&&t.length?Ki(e,t,n,i):e}var kf=cn(function(e,t){var i=e==null?0:e.length,u=Ui(e,t);return Vo(e,Ee(t,function(_){return hn(_,i)?+_:_}).sort(ru)),u});function Tf(e,t){var i=[];if(!(e&&e.length))return i;var u=-1,_=[],g=e.length;for(t=se(t,3);++u<g;){var v=e[u];t(v,u,e)&&(i.push(v),_.push(u))}return Vo(e,_),i}function la(e){return e==null?e:ph.call(e)}function Af(e,t,i){var u=e==null?0:e.length;return u?(i&&typeof i!="number"&&Qe(e,t,i)?(t=0,i=u):(t=t==null?0:he(t),i=i===n?u:he(i)),St(e,t,i)):[]}function Ef(e,t){return Fs(e,t)}function If(e,t,i){return Hi(e,t,se(i,2))}function Sf(e,t){var i=e==null?0:e.length;if(i){var u=Fs(e,t);if(u<i&&zt(e[u],t))return u}return-1}function Cf(e,t){return Fs(e,t,!0)}function Mf(e,t,i){return Hi(e,t,se(i,2),!0)}function Rf(e,t){var i=e==null?0:e.length;if(i){var u=Fs(e,t,!0)-1;if(zt(e[u],t))return u}return-1}function Bf(e){return e&&e.length?Yo(e):[]}function Ff(e,t){return e&&e.length?Yo(e,se(t,2)):[]}function Lf(e){var t=e==null?0:e.length;return t?St(e,1,t):[]}function Uf(e,t,i){return e&&e.length?(t=i||t===n?1:he(t),St(e,0,t<0?0:t)):[]}function Pf(e,t,i){var u=e==null?0:e.length;return u?(t=i||t===n?1:he(t),t=u-t,St(e,t<0?0:t,u)):[]}function Of(e,t){return e&&e.length?Ls(e,se(t,3),!1,!0):[]}function Nf(e,t){return e&&e.length?Ls(e,se(t,3)):[]}var zf=fe(function(e){return Cn(qe(e,1,Re,!0))}),Df=fe(function(e){var t=Ct(e);return Re(t)&&(t=n),Cn(qe(e,1,Re,!0),se(t,2))}),Gf=fe(function(e){var t=Ct(e);return t=typeof t=="function"?t:n,Cn(qe(e,1,Re,!0),n,t)});function qf(e){return e&&e.length?Cn(e):[]}function Kf(e,t){return e&&e.length?Cn(e,se(t,2)):[]}function Wf(e,t){return t=typeof t=="function"?t:n,e&&e.length?Cn(e,n,t):[]}function ca(e){if(!(e&&e.length))return[];var t=0;return e=Tn(e,function(i){if(Re(i))return t=Pe(i.length,t),!0}),Ii(t,function(i){return Ee(e,Ti(i))})}function Uu(e,t){if(!(e&&e.length))return[];var i=ca(e);return t==null?i:Ee(i,function(u){return _t(t,n,u)})}var $f=fe(function(e,t){return Re(e)?qr(e,t):[]}),Hf=fe(function(e){return Xi(Tn(e,Re))}),Vf=fe(function(e){var t=Ct(e);return Re(t)&&(t=n),Xi(Tn(e,Re),se(t,2))}),Xf=fe(function(e){var t=Ct(e);return t=typeof t=="function"?t:n,Xi(Tn(e,Re),n,t)}),Yf=fe(ca);function Zf(e,t){return jo(e||[],t||[],Gr)}function Jf(e,t){return jo(e||[],t||[],$r)}var Qf=fe(function(e){var t=e.length,i=t>1?e[t-1]:n;return i=typeof i=="function"?(e.pop(),i):n,Uu(e,i)});function Pu(e){var t=f(e);return t.__chain__=!0,t}function jf(e,t){return t(e),e}function Ks(e,t){return t(e)}var ed=cn(function(e){var t=e.length,i=t?e[0]:0,u=this.__wrapped__,_=function(g){return Ui(g,e)};return t>1||this.__actions__.length||!(u instanceof pe)||!hn(i)?this.thru(_):(u=u.slice(i,+i+(t?1:0)),u.__actions__.push({func:Ks,args:[_],thisArg:n}),new Et(u,this.__chain__).thru(function(g){return t&&!g.length&&g.push(n),g}))});function td(){return Pu(this)}function nd(){return new Et(this.value(),this.__chain__)}function rd(){this.__values__===n&&(this.__values__=Zu(this.value()));var e=this.__index__>=this.__values__.length,t=e?n:this.__values__[this.__index__++];return{done:e,value:t}}function sd(){return this}function id(e){for(var t,i=this;i instanceof Ss;){var u=Cu(i);u.__index__=0,u.__values__=n,t?_.__wrapped__=u:t=u;var _=u;i=i.__wrapped__}return _.__wrapped__=e,t}function ad(){var e=this.__wrapped__;if(e instanceof pe){var t=e;return this.__actions__.length&&(t=new pe(this)),t=t.reverse(),t.__actions__.push({func:Ks,args:[la],thisArg:n}),new Et(t,this.__chain__)}return this.thru(la)}function od(){return Qo(this.__wrapped__,this.__actions__)}var ud=Us(function(e,t,i){be.call(e,i)?++e[i]:un(e,i,1)});function ld(e,t,i){var u=le(e)?co:Qh;return i&&Qe(e,t,i)&&(t=n),u(e,se(t,3))}function cd(e,t){var i=le(e)?Tn:Uo;return i(e,se(t,3))}var hd=lu(Mu),_d=lu(Ru);function fd(e,t){return qe(Ws(e,t),1)}function dd(e,t){return qe(Ws(e,t),Ut)}function gd(e,t,i){return i=i===n?1:he(i),qe(Ws(e,t),i)}function Ou(e,t){var i=le(e)?Tt:Sn;return i(e,se(t,3))}function Nu(e,t){var i=le(e)?Fc:Lo;return i(e,se(t,3))}var pd=Us(function(e,t,i){be.call(e,i)?e[i].push(t):un(e,i,[t])});function md(e,t,i,u){e=it(e)?e:wr(e),i=i&&!u?he(i):0;var _=e.length;return i<0&&(i=Pe(_+i,0)),Ys(e)?i<=_&&e.indexOf(t,i)>-1:!!_&&ur(e,t,i)>-1}var yd=fe(function(e,t,i){var u=-1,_=typeof t=="function",g=it(e)?R(e.length):[];return Sn(e,function(v){g[++u]=_?_t(t,v,i):Kr(v,t,i)}),g}),vd=Us(function(e,t,i){un(e,i,t)});function Ws(e,t){var i=le(e)?Ee:Go;return i(e,se(t,3))}function wd(e,t,i,u){return e==null?[]:(le(t)||(t=t==null?[]:[t]),i=u?n:i,le(i)||(i=i==null?[]:[i]),$o(e,t,i))}var bd=Us(function(e,t,i){e[i?0:1].push(t)},function(){return[[],[]]});function xd(e,t,i){var u=le(e)?xi:go,_=arguments.length<3;return u(e,se(t,4),i,_,Sn)}function kd(e,t,i){var u=le(e)?Lc:go,_=arguments.length<3;return u(e,se(t,4),i,_,Lo)}function Td(e,t){var i=le(e)?Tn:Uo;return i(e,Vs(se(t,3)))}function Ad(e){var t=le(e)?Mo:p_;return t(e)}function Ed(e,t,i){(i?Qe(e,t,i):t===n)?t=1:t=he(t);var u=le(e)?Vh:m_;return u(e,t)}function Id(e){var t=le(e)?Xh:v_;return t(e)}function Sd(e){if(e==null)return 0;if(it(e))return Ys(e)?cr(e):e.length;var t=Ve(e);return t==nt||t==k?e.size:Gi(e).length}function Cd(e,t,i){var u=le(e)?ki:w_;return i&&Qe(e,t,i)&&(t=n),u(e,se(t,3))}var Md=fe(function(e,t){if(e==null)return[];var i=t.length;return i>1&&Qe(e,t[0],t[1])?t=[]:i>2&&Qe(t[0],t[1],t[2])&&(t=[t[0]]),$o(e,qe(t,1),[])}),$s=lh||function(){return Ge.Date.now()};function Rd(e,t){if(typeof t!="function")throw new At(d);return e=he(e),function(){if(--e<1)return t.apply(this,arguments)}}function zu(e,t,i){return t=i?n:t,t=e&&t==null?e.length:t,ln(e,Me,n,n,n,n,t)}function Du(e,t){var i;if(typeof t!="function")throw new At(d);return e=he(e),function(){return--e>0&&(i=t.apply(this,arguments)),e<=1&&(t=n),i}}var ha=fe(function(e,t,i){var u=D;if(i.length){var _=En(i,yr(ha));u|=ee}return ln(e,u,t,i,_)}),Gu=fe(function(e,t,i){var u=D|H;if(i.length){var _=En(i,yr(Gu));u|=ee}return ln(t,u,e,i,_)});function qu(e,t,i){t=i?n:t;var u=ln(e,Q,n,n,n,n,n,t);return u.placeholder=qu.placeholder,u}function Ku(e,t,i){t=i?n:t;var u=ln(e,ne,n,n,n,n,n,t);return u.placeholder=Ku.placeholder,u}function Wu(e,t,i){var u,_,g,v,x,A,U=0,P=!1,G=!1,$=!0;if(typeof e!="function")throw new At(d);t=Mt(t)||0,Se(i)&&(P=!!i.leading,G="maxWait"in i,g=G?Pe(Mt(i.maxWait)||0,t):g,$="trailing"in i?!!i.trailing:$);function te(Be){var Dt=u,dn=_;return u=_=n,U=Be,v=e.apply(dn,Dt),v}function ie(Be){return U=Be,x=Xr(de,t),P?te(Be):v}function _e(Be){var Dt=Be-A,dn=Be-U,ll=t-Dt;return G?He(ll,g-dn):ll}function ae(Be){var Dt=Be-A,dn=Be-U;return A===n||Dt>=t||Dt<0||G&&dn>=g}function de(){var Be=$s();if(ae(Be))return me(Be);x=Xr(de,_e(Be))}function me(Be){return x=n,$&&u?te(Be):(u=_=n,v)}function pt(){x!==n&&eu(x),U=0,u=A=_=x=n}function je(){return x===n?v:me($s())}function mt(){var Be=$s(),Dt=ae(Be);if(u=arguments,_=this,A=Be,Dt){if(x===n)return ie(A);if(G)return eu(x),x=Xr(de,t),te(A)}return x===n&&(x=Xr(de,t)),v}return mt.cancel=pt,mt.flush=je,mt}var Bd=fe(function(e,t){return Fo(e,1,t)}),Fd=fe(function(e,t,i){return Fo(e,Mt(t)||0,i)});function Ld(e){return ln(e,ht)}function Hs(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new At(d);var i=function(){var u=arguments,_=t?t.apply(this,u):u[0],g=i.cache;if(g.has(_))return g.get(_);var v=e.apply(this,u);return i.cache=g.set(_,v)||g,v};return i.cache=new(Hs.Cache||on),i}Hs.Cache=on;function Vs(e){if(typeof e!="function")throw new At(d);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}function Ud(e){return Du(2,e)}var Pd=b_(function(e,t){t=t.length==1&&le(t[0])?Ee(t[0],ft(se())):Ee(qe(t,1),ft(se()));var i=t.length;return fe(function(u){for(var _=-1,g=He(u.length,i);++_<g;)u[_]=t[_].call(this,u[_]);return _t(e,this,u)})}),_a=fe(function(e,t){var i=En(t,yr(_a));return ln(e,ee,n,t,i)}),$u=fe(function(e,t){var i=En(t,yr($u));return ln(e,j,n,t,i)}),Od=cn(function(e,t){return ln(e,Fe,n,n,n,t)});function Nd(e,t){if(typeof e!="function")throw new At(d);return t=t===n?t:he(t),fe(e,t)}function zd(e,t){if(typeof e!="function")throw new At(d);return t=t==null?0:Pe(he(t),0),fe(function(i){var u=i[t],_=Rn(i,0,t);return u&&An(_,u),_t(e,this,_)})}function Dd(e,t,i){var u=!0,_=!0;if(typeof e!="function")throw new At(d);return Se(i)&&(u="leading"in i?!!i.leading:u,_="trailing"in i?!!i.trailing:_),Wu(e,t,{leading:u,maxWait:t,trailing:_})}function Gd(e){return zu(e,1)}function qd(e,t){return _a(Zi(t),e)}function Kd(){if(!arguments.length)return[];var e=arguments[0];return le(e)?e:[e]}function Wd(e){return It(e,N)}function $d(e,t){return t=typeof t=="function"?t:n,It(e,N,t)}function Hd(e){return It(e,M|N)}function Vd(e,t){return t=typeof t=="function"?t:n,It(e,M|N,t)}function Xd(e,t){return t==null||Bo(e,t,ze(t))}function zt(e,t){return e===t||e!==e&&t!==t}var Yd=zs(Ni),Zd=zs(function(e,t){return e>=t}),Zn=No(function(){return arguments}())?No:function(e){return Ce(e)&&be.call(e,"callee")&&!To.call(e,"callee")},le=R.isArray,Jd=so?ft(so):s_;function it(e){return e!=null&&Xs(e.length)&&!_n(e)}function Re(e){return Ce(e)&&it(e)}function Qd(e){return e===!0||e===!1||Ce(e)&&Je(e)==tn}var Bn=hh||ka,jd=io?ft(io):i_;function eg(e){return Ce(e)&&e.nodeType===1&&!Yr(e)}function tg(e){if(e==null)return!0;if(it(e)&&(le(e)||typeof e=="string"||typeof e.splice=="function"||Bn(e)||vr(e)||Zn(e)))return!e.length;var t=Ve(e);if(t==nt||t==k)return!e.size;if(Vr(e))return!Gi(e).length;for(var i in e)if(be.call(e,i))return!1;return!0}function ng(e,t){return Wr(e,t)}function rg(e,t,i){i=typeof i=="function"?i:n;var u=i?i(e,t):n;return u===n?Wr(e,t,n,i):!!u}function fa(e){if(!Ce(e))return!1;var t=Je(e);return t==zn||t==Fr||typeof e.message=="string"&&typeof e.name=="string"&&!Yr(e)}function sg(e){return typeof e=="number"&&Eo(e)}function _n(e){if(!Se(e))return!1;var t=Je(e);return t==$e||t==tr||t==ss||t==as}function Hu(e){return typeof e=="number"&&e==he(e)}function Xs(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=Ze}function Se(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}function Ce(e){return e!=null&&typeof e=="object"}var Vu=ao?ft(ao):o_;function ig(e,t){return e===t||Di(e,t,ra(t))}function ag(e,t,i){return i=typeof i=="function"?i:n,Di(e,t,ra(t),i)}function og(e){return Xu(e)&&e!=+e}function ug(e){if(W_(e))throw new ue(c);return zo(e)}function lg(e){return e===null}function cg(e){return e==null}function Xu(e){return typeof e=="number"||Ce(e)&&Je(e)==vn}function Yr(e){if(!Ce(e)||Je(e)!=bt)return!1;var t=bs(e);if(t===null)return!0;var i=be.call(t,"constructor")&&t.constructor;return typeof i=="function"&&i instanceof i&&ms.call(i)==ih}var da=oo?ft(oo):u_;function hg(e){return Hu(e)&&e>=-Ze&&e<=Ze}var Yu=uo?ft(uo):l_;function Ys(e){return typeof e=="string"||!le(e)&&Ce(e)&&Je(e)==p}function gt(e){return typeof e=="symbol"||Ce(e)&&Je(e)==wn}var vr=lo?ft(lo):c_;function _g(e){return e===n}function fg(e){return Ce(e)&&Ve(e)==bn}function dg(e){return Ce(e)&&Je(e)==nn}var gg=zs(qi),pg=zs(function(e,t){return e<=t});function Zu(e){if(!e)return[];if(it(e))return Ys(e)?Ot(e):st(e);if(Pr&&e[Pr])return Vc(e[Pr]());var t=Ve(e),i=t==nt?Ci:t==k?ds:wr;return i(e)}function fn(e){if(!e)return e===0?e:0;if(e=Mt(e),e===Ut||e===-Ut){var t=e<0?-1:1;return t*tt}return e===e?e:0}function he(e){var t=fn(e),i=t%1;return t===t?i?t-i:t:0}function Ju(e){return e?Hn(he(e),0,Ne):0}function Mt(e){if(typeof e=="number")return e;if(gt(e))return mn;if(Se(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=Se(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=po(e);var i=Zl.test(e);return i||Ql.test(e)?Mc(e.slice(2),i?2:8):Yl.test(e)?mn:+e}function Qu(e){return Yt(e,at(e))}function mg(e){return e?Hn(he(e),-Ze,Ze):e===0?e:0}function we(e){return e==null?"":dt(e)}var yg=pr(function(e,t){if(Vr(t)||it(t)){Yt(t,ze(t),e);return}for(var i in t)be.call(t,i)&&Gr(e,i,t[i])}),ju=pr(function(e,t){Yt(t,at(t),e)}),Zs=pr(function(e,t,i,u){Yt(t,at(t),e,u)}),vg=pr(function(e,t,i,u){Yt(t,ze(t),e,u)}),wg=cn(Ui);function bg(e,t){var i=gr(e);return t==null?i:Ro(i,t)}var xg=fe(function(e,t){e=xe(e);var i=-1,u=t.length,_=u>2?t[2]:n;for(_&&Qe(t[0],t[1],_)&&(u=1);++i<u;)for(var g=t[i],v=at(g),x=-1,A=v.length;++x<A;){var U=v[x],P=e[U];(P===n||zt(P,_r[U])&&!be.call(e,U))&&(e[U]=g[U])}return e}),kg=fe(function(e){return e.push(n,pu),_t(el,n,e)});function Tg(e,t){return ho(e,se(t,3),Xt)}function Ag(e,t){return ho(e,se(t,3),Oi)}function Eg(e,t){return e==null?e:Pi(e,se(t,3),at)}function Ig(e,t){return e==null?e:Po(e,se(t,3),at)}function Sg(e,t){return e&&Xt(e,se(t,3))}function Cg(e,t){return e&&Oi(e,se(t,3))}function Mg(e){return e==null?[]:Rs(e,ze(e))}function Rg(e){return e==null?[]:Rs(e,at(e))}function ga(e,t,i){var u=e==null?n:Vn(e,t);return u===n?i:u}function Bg(e,t){return e!=null&&vu(e,t,e_)}function pa(e,t){return e!=null&&vu(e,t,t_)}var Fg=hu(function(e,t,i){t!=null&&typeof t.toString!="function"&&(t=ys.call(t)),e[t]=i},ya(ot)),Lg=hu(function(e,t,i){t!=null&&typeof t.toString!="function"&&(t=ys.call(t)),be.call(e,t)?e[t].push(i):e[t]=[i]},se),Ug=fe(Kr);function ze(e){return it(e)?Co(e):Gi(e)}function at(e){return it(e)?Co(e,!0):h_(e)}function Pg(e,t){var i={};return t=se(t,3),Xt(e,function(u,_,g){un(i,t(u,_,g),u)}),i}function Og(e,t){var i={};return t=se(t,3),Xt(e,function(u,_,g){un(i,_,t(u,_,g))}),i}var Ng=pr(function(e,t,i){Bs(e,t,i)}),el=pr(function(e,t,i,u){Bs(e,t,i,u)}),zg=cn(function(e,t){var i={};if(e==null)return i;var u=!1;t=Ee(t,function(g){return g=Mn(g,e),u||(u=g.length>1),g}),Yt(e,ta(e),i),u&&(i=It(i,M|z|N,B_));for(var _=t.length;_--;)Vi(i,t[_]);return i});function Dg(e,t){return tl(e,Vs(se(t)))}var Gg=cn(function(e,t){return e==null?{}:f_(e,t)});function tl(e,t){if(e==null)return{};var i=Ee(ta(e),function(u){return[u]});return t=se(t),Ho(e,i,function(u,_){return t(u,_[0])})}function qg(e,t,i){t=Mn(t,e);var u=-1,_=t.length;for(_||(_=1,e=n);++u<_;){var g=e==null?n:e[Zt(t[u])];g===n&&(u=_,g=i),e=_n(g)?g.call(e):g}return e}function Kg(e,t,i){return e==null?e:$r(e,t,i)}function Wg(e,t,i,u){return u=typeof u=="function"?u:n,e==null?e:$r(e,t,i,u)}var nl=du(ze),rl=du(at);function $g(e,t,i){var u=le(e),_=u||Bn(e)||vr(e);if(t=se(t,4),i==null){var g=e&&e.constructor;_?i=u?new g:[]:Se(e)?i=_n(g)?gr(bs(e)):{}:i={}}return(_?Tt:Xt)(e,function(v,x,A){return t(i,v,x,A)}),i}function Hg(e,t){return e==null?!0:Vi(e,t)}function Vg(e,t,i){return e==null?e:Jo(e,t,Zi(i))}function Xg(e,t,i,u){return u=typeof u=="function"?u:n,e==null?e:Jo(e,t,Zi(i),u)}function wr(e){return e==null?[]:Si(e,ze(e))}function Yg(e){return e==null?[]:Si(e,at(e))}function Zg(e,t,i){return i===n&&(i=t,t=n),i!==n&&(i=Mt(i),i=i===i?i:0),t!==n&&(t=Mt(t),t=t===t?t:0),Hn(Mt(e),t,i)}function Jg(e,t,i){return t=fn(t),i===n?(i=t,t=0):i=fn(i),e=Mt(e),n_(e,t,i)}function Qg(e,t,i){if(i&&typeof i!="boolean"&&Qe(e,t,i)&&(t=i=n),i===n&&(typeof t=="boolean"?(i=t,t=n):typeof e=="boolean"&&(i=e,e=n)),e===n&&t===n?(e=0,t=1):(e=fn(e),t===n?(t=e,e=0):t=fn(t)),e>t){var u=e;e=t,t=u}if(i||e%1||t%1){var _=Io();return He(e+_*(t-e+Cc("1e-"+((_+"").length-1))),t)}return Wi(e,t)}var jg=mr(function(e,t,i){return t=t.toLowerCase(),e+(i?sl(t):t)});function sl(e){return ma(we(e).toLowerCase())}function il(e){return e=we(e),e&&e.replace(ec,qc).replace(vc,"")}function ep(e,t,i){e=we(e),t=dt(t);var u=e.length;i=i===n?u:Hn(he(i),0,u);var _=i;return i-=t.length,i>=0&&e.slice(i,_)==t}function tp(e){return e=we(e),e&&m.test(e)?e.replace(a,Kc):e}function np(e){return e=we(e),e&&rt.test(e)?e.replace(Te,"\\$&"):e}var rp=mr(function(e,t,i){return e+(i?"-":"")+t.toLowerCase()}),sp=mr(function(e,t,i){return e+(i?" ":"")+t.toLowerCase()}),ip=uu("toLowerCase");function ap(e,t,i){e=we(e),t=he(t);var u=t?cr(e):0;if(!t||u>=t)return e;var _=(t-u)/2;return Ns(As(_),i)+e+Ns(Ts(_),i)}function op(e,t,i){e=we(e),t=he(t);var u=t?cr(e):0;return t&&u<t?e+Ns(t-u,i):e}function up(e,t,i){e=we(e),t=he(t);var u=t?cr(e):0;return t&&u<t?Ns(t-u,i)+e:e}function lp(e,t,i){return i||t==null?t=0:t&&(t=+t),gh(we(e).replace(ar,""),t||0)}function cp(e,t,i){return(i?Qe(e,t,i):t===n)?t=1:t=he(t),$i(we(e),t)}function hp(){var e=arguments,t=we(e[0]);return e.length<3?t:t.replace(e[1],e[2])}var _p=mr(function(e,t,i){return e+(i?"_":"")+t.toLowerCase()});function fp(e,t,i){return i&&typeof i!="number"&&Qe(e,t,i)&&(t=i=n),i=i===n?Ne:i>>>0,i?(e=we(e),e&&(typeof t=="string"||t!=null&&!da(t))&&(t=dt(t),!t&&lr(e))?Rn(Ot(e),0,i):e.split(t,i)):[]}var dp=mr(function(e,t,i){return e+(i?" ":"")+ma(t)});function gp(e,t,i){return e=we(e),i=i==null?0:Hn(he(i),0,e.length),t=dt(t),e.slice(i,i+t.length)==t}function pp(e,t,i){var u=f.templateSettings;i&&Qe(e,t,i)&&(t=n),e=we(e),t=Zs({},t,u,gu);var _=Zs({},t.imports,u.imports,gu),g=ze(_),v=Si(_,g),x,A,U=0,P=t.interpolate||ls,G="__p += '",$=Mi((t.escape||ls).source+"|"+P.source+"|"+(P===L?Xl:ls).source+"|"+(t.evaluate||ls).source+"|$","g"),te="//# sourceURL="+(be.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++Tc+"]")+`
`;e.replace($,function(ae,de,me,pt,je,mt){return me||(me=pt),G+=e.slice(U,mt).replace(tc,Wc),de&&(x=!0,G+=`' +
__e(`+de+`) +
'`),je&&(A=!0,G+=`';
`+je+`;
__p += '`),me&&(G+=`' +
((__t = (`+me+`)) == null ? '' : __t) +
'`),U=mt+ae.length,ae}),G+=`';
`;var ie=be.call(t,"variable")&&t.variable;if(!ie)G=`with (obj) {
`+G+`
}
`;else if(Hl.test(ie))throw new ue(y);G=(A?G.replace(us,""):G).replace(fi,"$1").replace(Pt,"$1;"),G="function("+(ie||"obj")+`) {
`+(ie?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(x?", __e = _.escape":"")+(A?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+G+`return __p
}`;var _e=ol(function(){return ve(g,te+"return "+G).apply(n,v)});if(_e.source=G,fa(_e))throw _e;return _e}function mp(e){return we(e).toLowerCase()}function yp(e){return we(e).toUpperCase()}function vp(e,t,i){if(e=we(e),e&&(i||t===n))return po(e);if(!e||!(t=dt(t)))return e;var u=Ot(e),_=Ot(t),g=mo(u,_),v=yo(u,_)+1;return Rn(u,g,v).join("")}function wp(e,t,i){if(e=we(e),e&&(i||t===n))return e.slice(0,wo(e)+1);if(!e||!(t=dt(t)))return e;var u=Ot(e),_=yo(u,Ot(t))+1;return Rn(u,0,_).join("")}function bp(e,t,i){if(e=we(e),e&&(i||t===n))return e.replace(ar,"");if(!e||!(t=dt(t)))return e;var u=Ot(e),_=mo(u,Ot(t));return Rn(u,_).join("")}function xp(e,t){var i=Wt,u=$t;if(Se(t)){var _="separator"in t?t.separator:_;i="length"in t?he(t.length):i,u="omission"in t?dt(t.omission):u}e=we(e);var g=e.length;if(lr(e)){var v=Ot(e);g=v.length}if(i>=g)return e;var x=i-cr(u);if(x<1)return u;var A=v?Rn(v,0,x).join(""):e.slice(0,x);if(_===n)return A+u;if(v&&(x+=A.length-x),da(_)){if(e.slice(x).search(_)){var U,P=A;for(_.global||(_=Mi(_.source,we(Oa.exec(_))+"g")),_.lastIndex=0;U=_.exec(P);)var G=U.index;A=A.slice(0,G===n?x:G)}}else if(e.indexOf(dt(_),x)!=x){var $=A.lastIndexOf(_);$>-1&&(A=A.slice(0,$))}return A+u}function kp(e){return e=we(e),e&&h.test(e)?e.replace(F,Jc):e}var Tp=mr(function(e,t,i){return e+(i?" ":"")+t.toUpperCase()}),ma=uu("toUpperCase");function al(e,t,i){return e=we(e),t=i?n:t,t===n?Hc(e)?eh(e):Oc(e):e.match(t)||[]}var ol=fe(function(e,t){try{return _t(e,n,t)}catch(i){return fa(i)?i:new ue(i)}}),Ap=cn(function(e,t){return Tt(t,function(i){i=Zt(i),un(e,i,ha(e[i],e))}),e});function Ep(e){var t=e==null?0:e.length,i=se();return e=t?Ee(e,function(u){if(typeof u[1]!="function")throw new At(d);return[i(u[0]),u[1]]}):[],fe(function(u){for(var _=-1;++_<t;){var g=e[_];if(_t(g[0],this,u))return _t(g[1],this,u)}})}function Ip(e){return Jh(It(e,M))}function ya(e){return function(){return e}}function Sp(e,t){return e==null||e!==e?t:e}var Cp=cu(),Mp=cu(!0);function ot(e){return e}function va(e){return Do(typeof e=="function"?e:It(e,M))}function Rp(e){return qo(It(e,M))}function Bp(e,t){return Ko(e,It(t,M))}var Fp=fe(function(e,t){return function(i){return Kr(i,e,t)}}),Lp=fe(function(e,t){return function(i){return Kr(e,i,t)}});function wa(e,t,i){var u=ze(t),_=Rs(t,u);i==null&&!(Se(t)&&(_.length||!u.length))&&(i=t,t=e,e=this,_=Rs(t,ze(t)));var g=!(Se(i)&&"chain"in i)||!!i.chain,v=_n(e);return Tt(_,function(x){var A=t[x];e[x]=A,v&&(e.prototype[x]=function(){var U=this.__chain__;if(g||U){var P=e(this.__wrapped__),G=P.__actions__=st(this.__actions__);return G.push({func:A,args:arguments,thisArg:e}),P.__chain__=U,P}return A.apply(e,An([this.value()],arguments))})}),e}function Up(){return Ge._===this&&(Ge._=ah),this}function ba(){}function Pp(e){return e=he(e),fe(function(t){return Wo(t,e)})}var Op=Qi(Ee),Np=Qi(co),zp=Qi(ki);function ul(e){return ia(e)?Ti(Zt(e)):d_(e)}function Dp(e){return function(t){return e==null?n:Vn(e,t)}}var Gp=_u(),qp=_u(!0);function xa(){return[]}function ka(){return!1}function Kp(){return{}}function Wp(){return""}function $p(){return!0}function Hp(e,t){if(e=he(e),e<1||e>Ze)return[];var i=Ne,u=He(e,Ne);t=se(t),e-=Ne;for(var _=Ii(u,t);++i<e;)t(i);return _}function Vp(e){return le(e)?Ee(e,Zt):gt(e)?[e]:st(Su(we(e)))}function Xp(e){var t=++sh;return we(e)+t}var Yp=Os(function(e,t){return e+t},0),Zp=ji("ceil"),Jp=Os(function(e,t){return e/t},1),Qp=ji("floor");function jp(e){return e&&e.length?Ms(e,ot,Ni):n}function em(e,t){return e&&e.length?Ms(e,se(t,2),Ni):n}function tm(e){return fo(e,ot)}function nm(e,t){return fo(e,se(t,2))}function rm(e){return e&&e.length?Ms(e,ot,qi):n}function sm(e,t){return e&&e.length?Ms(e,se(t,2),qi):n}var im=Os(function(e,t){return e*t},1),am=ji("round"),om=Os(function(e,t){return e-t},0);function um(e){return e&&e.length?Ei(e,ot):0}function lm(e,t){return e&&e.length?Ei(e,se(t,2)):0}return f.after=Rd,f.ary=zu,f.assign=yg,f.assignIn=ju,f.assignInWith=Zs,f.assignWith=vg,f.at=wg,f.before=Du,f.bind=ha,f.bindAll=Ap,f.bindKey=Gu,f.castArray=Kd,f.chain=Pu,f.chunk=J_,f.compact=Q_,f.concat=j_,f.cond=Ep,f.conforms=Ip,f.constant=ya,f.countBy=ud,f.create=bg,f.curry=qu,f.curryRight=Ku,f.debounce=Wu,f.defaults=xg,f.defaultsDeep=kg,f.defer=Bd,f.delay=Fd,f.difference=ef,f.differenceBy=tf,f.differenceWith=nf,f.drop=rf,f.dropRight=sf,f.dropRightWhile=af,f.dropWhile=of,f.fill=uf,f.filter=cd,f.flatMap=fd,f.flatMapDeep=dd,f.flatMapDepth=gd,f.flatten=Bu,f.flattenDeep=lf,f.flattenDepth=cf,f.flip=Ld,f.flow=Cp,f.flowRight=Mp,f.fromPairs=hf,f.functions=Mg,f.functionsIn=Rg,f.groupBy=pd,f.initial=ff,f.intersection=df,f.intersectionBy=gf,f.intersectionWith=pf,f.invert=Fg,f.invertBy=Lg,f.invokeMap=yd,f.iteratee=va,f.keyBy=vd,f.keys=ze,f.keysIn=at,f.map=Ws,f.mapKeys=Pg,f.mapValues=Og,f.matches=Rp,f.matchesProperty=Bp,f.memoize=Hs,f.merge=Ng,f.mergeWith=el,f.method=Fp,f.methodOf=Lp,f.mixin=wa,f.negate=Vs,f.nthArg=Pp,f.omit=zg,f.omitBy=Dg,f.once=Ud,f.orderBy=wd,f.over=Op,f.overArgs=Pd,f.overEvery=Np,f.overSome=zp,f.partial=_a,f.partialRight=$u,f.partition=bd,f.pick=Gg,f.pickBy=tl,f.property=ul,f.propertyOf=Dp,f.pull=wf,f.pullAll=Lu,f.pullAllBy=bf,f.pullAllWith=xf,f.pullAt=kf,f.range=Gp,f.rangeRight=qp,f.rearg=Od,f.reject=Td,f.remove=Tf,f.rest=Nd,f.reverse=la,f.sampleSize=Ed,f.set=Kg,f.setWith=Wg,f.shuffle=Id,f.slice=Af,f.sortBy=Md,f.sortedUniq=Bf,f.sortedUniqBy=Ff,f.split=fp,f.spread=zd,f.tail=Lf,f.take=Uf,f.takeRight=Pf,f.takeRightWhile=Of,f.takeWhile=Nf,f.tap=jf,f.throttle=Dd,f.thru=Ks,f.toArray=Zu,f.toPairs=nl,f.toPairsIn=rl,f.toPath=Vp,f.toPlainObject=Qu,f.transform=$g,f.unary=Gd,f.union=zf,f.unionBy=Df,f.unionWith=Gf,f.uniq=qf,f.uniqBy=Kf,f.uniqWith=Wf,f.unset=Hg,f.unzip=ca,f.unzipWith=Uu,f.update=Vg,f.updateWith=Xg,f.values=wr,f.valuesIn=Yg,f.without=$f,f.words=al,f.wrap=qd,f.xor=Hf,f.xorBy=Vf,f.xorWith=Xf,f.zip=Yf,f.zipObject=Zf,f.zipObjectDeep=Jf,f.zipWith=Qf,f.entries=nl,f.entriesIn=rl,f.extend=ju,f.extendWith=Zs,wa(f,f),f.add=Yp,f.attempt=ol,f.camelCase=jg,f.capitalize=sl,f.ceil=Zp,f.clamp=Zg,f.clone=Wd,f.cloneDeep=Hd,f.cloneDeepWith=Vd,f.cloneWith=$d,f.conformsTo=Xd,f.deburr=il,f.defaultTo=Sp,f.divide=Jp,f.endsWith=ep,f.eq=zt,f.escape=tp,f.escapeRegExp=np,f.every=ld,f.find=hd,f.findIndex=Mu,f.findKey=Tg,f.findLast=_d,f.findLastIndex=Ru,f.findLastKey=Ag,f.floor=Qp,f.forEach=Ou,f.forEachRight=Nu,f.forIn=Eg,f.forInRight=Ig,f.forOwn=Sg,f.forOwnRight=Cg,f.get=ga,f.gt=Yd,f.gte=Zd,f.has=Bg,f.hasIn=pa,f.head=Fu,f.identity=ot,f.includes=md,f.indexOf=_f,f.inRange=Jg,f.invoke=Ug,f.isArguments=Zn,f.isArray=le,f.isArrayBuffer=Jd,f.isArrayLike=it,f.isArrayLikeObject=Re,f.isBoolean=Qd,f.isBuffer=Bn,f.isDate=jd,f.isElement=eg,f.isEmpty=tg,f.isEqual=ng,f.isEqualWith=rg,f.isError=fa,f.isFinite=sg,f.isFunction=_n,f.isInteger=Hu,f.isLength=Xs,f.isMap=Vu,f.isMatch=ig,f.isMatchWith=ag,f.isNaN=og,f.isNative=ug,f.isNil=cg,f.isNull=lg,f.isNumber=Xu,f.isObject=Se,f.isObjectLike=Ce,f.isPlainObject=Yr,f.isRegExp=da,f.isSafeInteger=hg,f.isSet=Yu,f.isString=Ys,f.isSymbol=gt,f.isTypedArray=vr,f.isUndefined=_g,f.isWeakMap=fg,f.isWeakSet=dg,f.join=mf,f.kebabCase=rp,f.last=Ct,f.lastIndexOf=yf,f.lowerCase=sp,f.lowerFirst=ip,f.lt=gg,f.lte=pg,f.max=jp,f.maxBy=em,f.mean=tm,f.meanBy=nm,f.min=rm,f.minBy=sm,f.stubArray=xa,f.stubFalse=ka,f.stubObject=Kp,f.stubString=Wp,f.stubTrue=$p,f.multiply=im,f.nth=vf,f.noConflict=Up,f.noop=ba,f.now=$s,f.pad=ap,f.padEnd=op,f.padStart=up,f.parseInt=lp,f.random=Qg,f.reduce=xd,f.reduceRight=kd,f.repeat=cp,f.replace=hp,f.result=qg,f.round=am,f.runInContext=T,f.sample=Ad,f.size=Sd,f.snakeCase=_p,f.some=Cd,f.sortedIndex=Ef,f.sortedIndexBy=If,f.sortedIndexOf=Sf,f.sortedLastIndex=Cf,f.sortedLastIndexBy=Mf,f.sortedLastIndexOf=Rf,f.startCase=dp,f.startsWith=gp,f.subtract=om,f.sum=um,f.sumBy=lm,f.template=pp,f.times=Hp,f.toFinite=fn,f.toInteger=he,f.toLength=Ju,f.toLower=mp,f.toNumber=Mt,f.toSafeInteger=mg,f.toString=we,f.toUpper=yp,f.trim=vp,f.trimEnd=wp,f.trimStart=bp,f.truncate=xp,f.unescape=kp,f.uniqueId=Xp,f.upperCase=Tp,f.upperFirst=ma,f.each=Ou,f.eachRight=Nu,f.first=Fu,wa(f,function(){var e={};return Xt(f,function(t,i){be.call(f.prototype,i)||(e[i]=t)}),e}(),{chain:!1}),f.VERSION=o,Tt(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){f[e].placeholder=f}),Tt(["drop","take"],function(e,t){pe.prototype[e]=function(i){i=i===n?1:Pe(he(i),0);var u=this.__filtered__&&!t?new pe(this):this.clone();return u.__filtered__?u.__takeCount__=He(i,u.__takeCount__):u.__views__.push({size:He(i,Ne),type:e+(u.__dir__<0?"Right":"")}),u},pe.prototype[e+"Right"]=function(i){return this.reverse()[e](i).reverse()}}),Tt(["filter","map","takeWhile"],function(e,t){var i=t+1,u=i==ye||i==rs;pe.prototype[e]=function(_){var g=this.clone();return g.__iteratees__.push({iteratee:se(_,3),type:i}),g.__filtered__=g.__filtered__||u,g}}),Tt(["head","last"],function(e,t){var i="take"+(t?"Right":"");pe.prototype[e]=function(){return this[i](1).value()[0]}}),Tt(["initial","tail"],function(e,t){var i="drop"+(t?"":"Right");pe.prototype[e]=function(){return this.__filtered__?new pe(this):this[i](1)}}),pe.prototype.compact=function(){return this.filter(ot)},pe.prototype.find=function(e){return this.filter(e).head()},pe.prototype.findLast=function(e){return this.reverse().find(e)},pe.prototype.invokeMap=fe(function(e,t){return typeof e=="function"?new pe(this):this.map(function(i){return Kr(i,e,t)})}),pe.prototype.reject=function(e){return this.filter(Vs(se(e)))},pe.prototype.slice=function(e,t){e=he(e);var i=this;return i.__filtered__&&(e>0||t<0)?new pe(i):(e<0?i=i.takeRight(-e):e&&(i=i.drop(e)),t!==n&&(t=he(t),i=t<0?i.dropRight(-t):i.take(t-e)),i)},pe.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},pe.prototype.toArray=function(){return this.take(Ne)},Xt(pe.prototype,function(e,t){var i=/^(?:filter|find|map|reject)|While$/.test(t),u=/^(?:head|last)$/.test(t),_=f[u?"take"+(t=="last"?"Right":""):t],g=u||/^find/.test(t);_&&(f.prototype[t]=function(){var v=this.__wrapped__,x=u?[1]:arguments,A=v instanceof pe,U=x[0],P=A||le(v),G=function(de){var me=_.apply(f,An([de],x));return u&&$?me[0]:me};P&&i&&typeof U=="function"&&U.length!=1&&(A=P=!1);var $=this.__chain__,te=!!this.__actions__.length,ie=g&&!$,_e=A&&!te;if(!g&&P){v=_e?v:new pe(this);var ae=e.apply(v,x);return ae.__actions__.push({func:Ks,args:[G],thisArg:n}),new Et(ae,$)}return ie&&_e?e.apply(this,x):(ae=this.thru(G),ie?u?ae.value()[0]:ae.value():ae)})}),Tt(["pop","push","shift","sort","splice","unshift"],function(e){var t=gs[e],i=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",u=/^(?:pop|shift)$/.test(e);f.prototype[e]=function(){var _=arguments;if(u&&!this.__chain__){var g=this.value();return t.apply(le(g)?g:[],_)}return this[i](function(v){return t.apply(le(v)?v:[],_)})}}),Xt(pe.prototype,function(e,t){var i=f[t];if(i){var u=i.name+"";be.call(dr,u)||(dr[u]=[]),dr[u].push({name:t,func:i})}}),dr[Ps(n,H).name]=[{name:"wrapper",func:n}],pe.prototype.clone=xh,pe.prototype.reverse=kh,pe.prototype.value=Th,f.prototype.at=ed,f.prototype.chain=td,f.prototype.commit=nd,f.prototype.next=rd,f.prototype.plant=id,f.prototype.reverse=ad,f.prototype.toJSON=f.prototype.valueOf=f.prototype.value=od,f.prototype.first=f.prototype.head,Pr&&(f.prototype[Pr]=sd),f},hr=th();qn?((qn.exports=hr)._=hr,vi._=hr):Ge._=hr}).call(Zr)})(ai,ai.exports);var mm=ai.exports;const Xe=pm(mm);function Js(r,s,n){return r<<24|s<<16|n}function Ta(r){return r>>24&16777215}function Qs(r){return r>>16&255}const Jt=Object.freeze({Unknown:0,Image:1,Buffer:2}),_l=Object.freeze({handle:0,config:null}),js=Object.freeze({reference_count:0,physical_id:0,first_user:0,last_user:0,producers:[],consumers:[],b_is_persistent:!0,b_is_bindless:!1,max_frame_lifetime:2}),ym=Object.freeze({current_pass:0,context:null,global_bind_group:null,pass_bind_group:null,pass_bind_groups:Array(ge.Num).fill(null),pass_pipeline_state:0,resource_deletion_queue:null,pass_bindless_resources:[],pass_attachments:[],g_buffer_data:null}),vm=Object.freeze({pipeline_shaders:null,push_constant_data:null,rasterizer_state:null,attachment_blend:null,primitive_topology_type:null,viewport:null,depth_write_enabled:null,depth_stencil_compare_op:null}),fl=Object.freeze({name:"",width:0,height:0,depth:1,mip_levels:1,format:"",usage:0,sample_count:1,b_is_bindless:!1,flags:et.None}),dl=Object.freeze({size:0,usage:0,b_is_bindless:!1,flags:kl.None}),wm=Object.freeze({shader_setup:Xe.cloneDeep(vm),inputs:[],outputs:[],output_views:[],pass_inputs:[],bindless_inputs:[],b_skip_auto_descriptor_setup:!1,b_split_input_image_mips:!1,b_force_keep_pass:!1}),bm=Object.freeze({handle:0,pass_config:null,parameters:null,executor:null,physical_id:0,pipeline_state_id:0,reference_count:0}),xm=Object.freeze({image_resources:[],buffer_resources:[],render_passes:[],all_resource_handles:[],resource_metadata:new Map,all_bindless_resource_handles:[],resource_deletion_queue:new fm,b_global_bind_group_bound:!1}),km=Object.freeze({global_bind_group:null,bind_groups:new Map,pipeline_states:new Map});class La{constructor(){this.pass_cache=Xe.cloneDeep(km),this.registry=Xe.cloneDeep(xm),this.non_culled_passes=[],this.queued_global_bind_group_writes=[],this.image_resource_allocator=new ti(256,Xe.cloneDeep(_l)),this.buffer_resource_allocator=new ti(256,Xe.cloneDeep(_l)),this.render_pass_allocator=new ti(128,Xe.cloneDeep(bm))}destroy(s){this.reset(s),this.registry.resource_deletion_queue.flush()}begin(s){this.reset(s)}create_image(s){const n=this.image_resource_allocator.allocate();n.config={...Xe.cloneDeep(fl),...s};const o=this.registry.image_resources.length;return this.registry.image_resources.push(n),n.handle=Js(o,Jt.Image,1),this.registry.all_resource_handles.push(n.handle),this.registry.resource_metadata.set(n.handle,Xe.cloneDeep(js)),this.registry.resource_metadata.get(n.handle).b_is_bindless=s.b_is_bindless,this.registry.resource_metadata.get(n.handle).b_is_persistent=(n.config.flags&et.Transient)===0,n.handle}register_image(s){const n=oe.from(s),o=V.get().fetch(K.IMAGE,n),l=this.image_resource_allocator.allocate();l.config={...Xe.cloneDeep(fl),...o.config};const c=this.registry.image_resources.length;return this.registry.image_resources.push(l),l.handle=Js(c,Jt.Image,1),this.registry.all_resource_handles.push(l.handle),this.registry.resource_metadata.set(l.handle,Xe.cloneDeep(js)),this.registry.resource_metadata.get(l.handle).physical_id=n,this.registry.resource_metadata.get(l.handle).b_is_persistent=!0,this.registry.resource_metadata.get(l.handle).b_is_bindless=l.config.b_is_bindless,l.handle}create_buffer(s){const n=this.buffer_resource_allocator.allocate();n.config={...Xe.cloneDeep(dl),...s};const o=this.registry.buffer_resources.length;return this.registry.buffer_resources.push(n),n.handle=Js(o,Jt.Buffer,1),this.registry.all_resource_handles.push(n.handle),this.registry.resource_metadata.set(n.handle,Xe.cloneDeep(js)),this.registry.resource_metadata.get(n.handle).b_is_bindless=s.b_is_bindless,this.registry.resource_metadata.get(n.handle).b_is_persistent=(n.config.flags&kl.Transient)===0,n.handle}register_buffer(s){const n=oe.from(s),o=V.get().fetch(K.BUFFER,n),l=this.buffer_resource_allocator.allocate();l.config={...Xe.cloneDeep(dl),...o.config};const c=this.registry.buffer_resources.length;return this.registry.buffer_resources.push(l),l.handle=Js(c,Jt.Buffer,1),this.registry.all_resource_handles.push(l.handle),this.registry.resource_metadata.set(l.handle,Xe.cloneDeep(js)),this.registry.resource_metadata.get(l.handle).physical_id=n,this.registry.resource_metadata.get(l.handle).b_is_persistent=!0,this.registry.resource_metadata.get(l.handle).b_is_bindless=l.config.b_is_bindless,l.handle}add_pass(s,n,o,l){const c=this.render_pass_allocator.allocate();c.pass_config={name:s,flags:n,attachments:[]},c.parameters={...Xe.cloneDeep(wm),...o},c.executor=l;const d=this.registry.render_passes.length;return this.registry.render_passes.push(c),this.non_culled_passes.push(d),c.handle=d,o?(this._update_reference_counts(c),this._update_resource_param_producers_and_consumers(c),this._update_present_pass_status(c)):c.reference_count+=1,d}get_physical_pass(s){return V.get().fetch(K.PASS,s)}get_physical_image(s){return V.get().fetch(K.IMAGE,this.registry.resource_metadata.get(s).physical_id)}get_physical_buffer(s){return V.get().fetch(K.BUFFER,this.registry.resource_metadata.get(s).physical_id)}queue_global_bind_group_write(s,n=!1){n?this.queued_global_bind_group_writes=s:this.queued_global_bind_group_writes=[...this.queued_global_bind_group_writes,...s]}_update_reference_counts(s){s.reference_count+=s.parameters.outputs.length;for(const n of s.parameters.inputs)if(this.registry.resource_metadata.has(n)){const o=this.registry.resource_metadata.get(n);o.reference_count+=1}}_update_resource_param_producers_and_consumers(s){for(const n of s.parameters.inputs)this.registry.resource_metadata.has(n)&&this.registry.resource_metadata.get(n).consumers.push(s.handle);for(const n of s.parameters.outputs)this.registry.resource_metadata.has(n)&&this.registry.resource_metadata.get(n).producers.push(s.handle)}_update_present_pass_status(s){s.pass_config.b_is_present_pass=(s.pass_config.flags&Le.Present)!==Le.None,s.parameters.b_force_keep_pass=s.parameters.b_force_keep_pass||s.pass_config.b_is_present_pass}_compile(){this._cull_graph_passes(),this._compute_resource_first_and_last_users()}_cull_graph_passes(){const s=new Set,n=[],o=l=>{for(const c of l){const d=this.registry.render_passes[c];if(!d.parameters.b_force_keep_pass&&(--d.reference_count,d.reference_count<=0)){d.reference_count=0,s.add(c);for(const y of d.parameters.inputs)if(this.registry.resource_metadata.has(y)){const w=this.registry.resource_metadata.get(y);w.reference_count-=1,w.reference_count===0&&n.push(y)}}}};for(const l of this.registry.all_resource_handles)this.registry.resource_metadata.has(l)&&this.registry.resource_metadata.get(l).reference_count===0&&n.push(l);for(;n.length>0;){const l=n.pop();this.registry.resource_metadata.has(l)&&o(this.registry.resource_metadata.get(l).producers)}for(let l=this.non_culled_passes.length-1;l>=0;--l){const c=this.non_culled_passes[l];s.has(c)&&this.non_culled_passes.splice(l,1)}}_compute_resource_first_and_last_users(){for(const s of this.registry.all_resource_handles)if(this.registry.resource_metadata.has(s)){const n=this.registry.resource_metadata.get(s);if(n.reference_count===0)continue;n.first_user=Number.MAX_SAFE_INTEGER,n.last_user=Number.MIN_SAFE_INTEGER;for(const o of n.producers)o<n.first_user&&(n.first_user=o),o>n.last_user&&(n.last_user=o);for(const o of n.consumers)o<n.first_user&&(n.first_user=o),o>n.last_user&&(n.last_user=o)}}submit(s){if(this._compile(),this.non_culled_passes.length===0)return;const n=hl.create_encoder(s,"render_graph_encoder"),o=Xe.cloneDeep(ym);o.context=s,o.resource_deletion_queue=this.registry.resource_deletion_queue;for(const l of this.non_culled_passes)this._execute_pass(this.registry.render_passes[l],o,n);hl.submit(s,n)}reset(s){this._free_physical_resources(s),this.non_culled_passes.length=0,this.registry.all_resource_handles.length=0,this.registry.buffer_resources.length=0,this.registry.image_resources.length=0,this.registry.render_passes.length=0,this.registry.resource_metadata.clear(),this.image_resource_allocator.reset(),this.buffer_resource_allocator.reset(),this.render_pass_allocator.reset()}_execute_pass(s,n,o){if(!s)throw new Error("Cannot execute null pass");if(n.pass_attachments.length=0,(s.pass_config.flags&Le.GraphLocal)!==Le.None)s.executor(this,n,o);else{if(this._setup_physical_pass_and_resources(s,n,o),(s.pass_config.flags&Le.Compute)!==Le.None)s.executor(this,n,o);else{const l=V.get().fetch(K.PASS,s.physical_id);if(!l)throw new Error("Physical pass is null");const c=V.get().fetch(K.PIPELINE_STATE,s.pipeline_state_id);n.current_pass=s.physical_id,l.begin(o,c),this._bind_pass_bind_groups(s,n),s.executor(this,n,o),l.end()}this._update_transient_resources(s)}}_setup_physical_pass_and_resources(s,n,o){const l=(s.pass_config.flags&Le.Compute)!==Le.None,c=(d,y,w)=>{this.registry.resource_metadata.has(d)&&(this._setup_physical_resource(n.context,d,!l,w),l||this._tie_resource_to_pass_config_attachments(d,s,y,w,n),w&&this._setup_pass_input_resource_bindless_type(d,s,y))};s.parameters.inputs.forEach((d,y)=>c(d,y,!0)),s.parameters.outputs.forEach((d,y)=>c(d,y,!1)),s.physical_id=oe.from(s.pass_config.name),Fa.create(s.pass_config),this._setup_pass_bind_groups(s,n),this._setup_pass_pipeline_state(s,n)}_setup_physical_resource(s,n,o,l){const c=Qs(n),d=Ta(n);if(c===Jt.Buffer){const y=this.registry.buffer_resources[d],w=this.registry.resource_metadata.get(n);w.physical_id===0&&(w.physical_id=oe.from(y.config.name),Lt.create(s,y.config),w.b_is_persistent||(this.registry.resource_deletion_queue.remove_execution(w.physical_id),this.registry.resource_deletion_queue.push_execution(()=>{V.get().remove(K.BUFFER,w.physical_id)},w.physical_id,w.max_frame_lifetime)))}else if(c===Jt.Image){const y=this.registry.image_resources[d],w=this.registry.resource_metadata.get(n),S=(y.config.flags&et.LocalLoad)!==et.None,I=o&&(!l||S);w.physical_id===0&&(w.b_is_persistent|=I,w.physical_id=oe.from(y.config.name),es.create(s,y.config),w.b_is_persistent||(this.registry.resource_deletion_queue.remove_execution(w.physical_id),this.registry.resource_deletion_queue.push_execution(()=>{V.get().remove(K.IMAGE,w.physical_id)},w.physical_id,w.max_frame_lifetime)))}}_tie_resource_to_pass_config_attachments(s,n,o,l,c){const d=Qs(s),y=Ta(s);if(d===Jt.Image){const w=this.registry.image_resources[y],S=V.get().fetch(K.IMAGE,this.registry.resource_metadata.get(s).physical_id),I=(w.config.flags&et.LocalLoad)!==et.None;if(!l||I){const M=n.parameters.output_views.length>o?n.parameters.output_views[o]:0;S.config.type.includes("depth")?n.pass_config.depth_stencil_attachment={image:this.registry.resource_metadata.get(s).physical_id,image_view_index:M,b_image_view_considers_layer_split:w.config.split_array_layer_views}:n.pass_config.attachments.push({image:this.registry.resource_metadata.get(s).physical_id,image_view_index:M,b_image_view_considers_layer_split:w.config.split_array_layer_views})}c.pass_attachments.push(S)}}_setup_pass_input_resource_bindless_type(s,n){const o=Qs(s),l=Ta(s);o===Jt.Image?this.registry.image_resources[l].config.is_bindless?n.parameters.bindless_inputs.push(s):n.parameters.pass_inputs.push(s):o===Jt.Buffer&&(this.registry.buffer_resources[l].config.b_is_bindless?n.parameters.bindless_inputs.push(s):n.parameters.pass_inputs.push(s))}_setup_pass_pipeline_state(s,n){var c;if(this.pass_cache.pipeline_states.get(s.pass_config.name)){s.pipeline_state_id=this.pass_cache.pipeline_states.get(s.pass_config.name),n.pass_pipeline_state=s.pipeline_state_id;return}const o=this.pass_cache.bind_groups.get(s.pass_config.name),l=s.parameters.shader_setup;if(l.pipeline_shaders){if((s.pass_config.flags&Le.Compute)!==Le.None){const y=jt.create(n.context,l.pipeline_shaders.compute.path),w={label:s.pass_config.name,bind_layouts:o.bind_groups.filter(S=>S!==null).map(S=>S.layout),compute:{module:y.module,entryPoint:l.pipeline_shaders.compute.entry_point||"cs"}};s.pipeline_state_id=oe.from(s.pass_config.name),Ir.create_compute(n.context,s.pass_config.name,w)}else{const y=jt.create(n.context,l.pipeline_shaders.vertex.path),w=jt.create(n.context,l.pipeline_shaders.fragment.path),S=s.pass_config.attachments.filter(z=>!V.get().fetch(K.IMAGE,z.image).config.type.includes("depth")).map(z=>{const q={format:V.get().fetch(K.IMAGE,z.image).config.format||"bgra8unorm"};return l.attachment_blend&&(q.blend=l.attachment_blend),q});let I=null;if(s.pass_config.depth_stencil_attachment){const z=V.get().fetch(K.IMAGE,s.pass_config.depth_stencil_attachment.image);I={depthWriteEnabled:l.b_depth_write_enabled??!0,depthCompare:l.depth_stencil_compare_op||"less",format:z.config.format||"depth24plus"}}const M={label:s.pass_config.name,bind_layouts:o.bind_groups.filter(z=>z!==null).map(z=>z.layout),vertex:{module:y.module,entryPoint:l.pipeline_shaders.vertex.entry_point||"vs",buffers:[]},fragment:{module:w.module,entryPoint:l.pipeline_shaders.fragment.entry_point||"fs",targets:S},primitive:{topology:l.primitive_topology_type||"triangle-list",cullMode:((c=l.rasterizer_state)==null?void 0:c.cull_mode)||"back"}};I&&(M.depthStencil=I),s.pipeline_state_id=oe.from(s.pass_config.name),Ir.create_render(n.context,s.pass_config.name,M)}this.pass_cache.pipeline_states.set(s.pass_config.name,s.pipeline_state_id),n.pass_pipeline_state=s.pipeline_state_id}}async _setup_pass_bind_groups(s,n){const o=this.pass_cache.bind_groups.get(s.pass_config.name)||{bind_groups:Array(n.context.max_bind_groups()).fill(null)};if(this.pass_cache.bind_groups.set(s.pass_config.name,o),this._setup_global_bind_group(s,n),o.bind_groups[ge.Pass])return;let l=[],c=[];if(s.parameters.pass_inputs.forEach((d,y)=>{const w=this.registry.resource_metadata.get(d);if(w.b_is_persistent)if(Qs(d)===Jt.Image){const I=V.get().fetch(K.IMAGE,w.physical_id);l.push({binding:y,resource:I.view}),c.push({binding:y,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,texture:{viewDimension:I.config.dimension,sampleType:I.config.type==="depth"?"depth":"float"}})}else{const I=V.get().fetch(K.BUFFER,w.physical_id);l.push({binding:y,resource:{buffer:I.buffer,offset:0,size:I.size}}),c.push({binding:y,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,buffer:{type:I.config.usage&GPUBufferUsage.STORAGE?"read-only-storage":"uniform"}})}}),l.length>0){const d=Un.create_with_layout(n.context,`${s.pass_config.name}_bindgroup_${ge.Pass}`,c,ge.Pass,l);o.bind_groups[ge.Pass]=d}}_setup_global_bind_group(s,n){const o=this.pass_cache.bind_groups.get(s.pass_config.name);if(o.bind_groups[ge.Global]=this.pass_cache.global_bind_group,o.bind_groups[ge.Global]&&!this.queued_global_bind_group_writes.length)return;let l=[],c=[];if(this.queued_global_bind_group_writes.forEach((d,y)=>{d.buffer?(l.push({binding:y,resource:{buffer:d.buffer.buffer,offset:d.offset||0,size:d.size}}),c.push({binding:y,visibility:d.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,buffer:{type:d.buffer.config.usage&GPUBufferUsage.STORAGE?"read-only-storage":"uniform"}})):d.sampler?(l.push({binding:y,resource:d.sampler}),c.push({binding:y,visibility:d.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,sampler:{}})):d.texture_view&&(l.push({binding:y,resource:d.texture_view}),c.push({binding:y,visibility:d.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,texture:{}}))}),this.queued_global_bind_group_writes=[],l.length>0){const d=Un.create_with_layout(n.context,`global_bindgroup_${ge.Global}`,c,ge.Global,l,!0);this.pass_cache.global_bind_group=d,o.bind_groups[ge.Global]=this.pass_cache.global_bind_group}}_bind_pass_bind_groups(s,n){const o=V.get().fetch(K.PASS,s.physical_id),l=this.pass_cache.bind_groups.get(s.pass_config.name);l.bind_groups.length>0&&(this.pass_cache.global_bind_group.bind(o),this.registry.b_global_set_bound=!0,l.bind_groups.length&&l.bind_groups[ge.Pass]&&l.bind_groups[ge.Pass].bind(o),n.pass_bind_groups[ge.Global]=l.bind_groups[ge.Global],n.pass_bind_groups[ge.Pass]=l.bind_groups[ge.Pass])}_update_transient_resources(s){s.parameters.inputs.forEach(n=>{const o=this.registry.resource_metadata.get(n);o.physical_id!==0&&o.last_user===s.handle&&o.b_is_persistent}),s.parameters.outputs.forEach(n=>{const o=this.registry.resource_metadata.get(n);o.physical_id!==0&&o.last_user===s.handle&&o.b_is_persistent})}_free_physical_resources(s){this.registry.resource_deletion_queue.update()}static create(){return new La}}var Fn=1e-6,Ke=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,s=arguments.length;s--;)r+=arguments[s]*arguments[s];return Math.sqrt(r)});function Tm(){var r=new Ke(9);return Ke!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function Bt(){var r=new Ke(16);return Ke!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function gl(r){var s=new Ke(16);return s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=r[3],s[4]=r[4],s[5]=r[5],s[6]=r[6],s[7]=r[7],s[8]=r[8],s[9]=r[9],s[10]=r[10],s[11]=r[11],s[12]=r[12],s[13]=r[13],s[14]=r[14],s[15]=r[15],s}function Am(r,s){return r[0]=s[0],r[1]=s[1],r[2]=s[2],r[3]=s[3],r[4]=s[4],r[5]=s[5],r[6]=s[6],r[7]=s[7],r[8]=s[8],r[9]=s[9],r[10]=s[10],r[11]=s[11],r[12]=s[12],r[13]=s[13],r[14]=s[14],r[15]=s[15],r}function Tl(r,s,n,o,l,c,d,y,w,S,I,M,z,N,q,X){var D=new Ke(16);return D[0]=r,D[1]=s,D[2]=n,D[3]=o,D[4]=l,D[5]=c,D[6]=d,D[7]=y,D[8]=w,D[9]=S,D[10]=I,D[11]=M,D[12]=z,D[13]=N,D[14]=q,D[15]=X,D}function Em(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function Al(r,s){var n=s[0],o=s[1],l=s[2],c=s[3],d=s[4],y=s[5],w=s[6],S=s[7],I=s[8],M=s[9],z=s[10],N=s[11],q=s[12],X=s[13],D=s[14],H=s[15],ce=n*y-o*d,Q=n*w-l*d,ne=n*S-c*d,ee=o*w-l*y,j=o*S-c*y,Me=l*S-c*w,Fe=I*X-M*q,ht=I*D-z*q,Wt=I*H-N*q,$t=M*D-z*X,Ht=M*H-N*X,We=z*H-N*D,ye=ce*We-Q*Ht+ne*$t+ee*Wt-j*ht+Me*Fe;return ye?(ye=1/ye,r[0]=(y*We-w*Ht+S*$t)*ye,r[1]=(l*Ht-o*We-c*$t)*ye,r[2]=(X*Me-D*j+H*ee)*ye,r[3]=(z*j-M*Me-N*ee)*ye,r[4]=(w*Wt-d*We-S*ht)*ye,r[5]=(n*We-l*Wt+c*ht)*ye,r[6]=(D*ne-q*Me-H*Q)*ye,r[7]=(I*Me-z*ne+N*Q)*ye,r[8]=(d*Ht-y*Wt+S*Fe)*ye,r[9]=(o*Wt-n*Ht-c*Fe)*ye,r[10]=(q*j-X*ne+H*ce)*ye,r[11]=(M*ne-I*j-N*ce)*ye,r[12]=(y*ht-d*$t-w*Fe)*ye,r[13]=(n*$t-o*ht+l*Fe)*ye,r[14]=(X*Q-q*ee-D*ce)*ye,r[15]=(I*ee-M*Q+z*ce)*ye,r):null}function Im(r,s,n){var o=s[0],l=s[1],c=s[2],d=s[3],y=s[4],w=s[5],S=s[6],I=s[7],M=s[8],z=s[9],N=s[10],q=s[11],X=s[12],D=s[13],H=s[14],ce=s[15],Q=n[0],ne=n[1],ee=n[2],j=n[3];return r[0]=Q*o+ne*y+ee*M+j*X,r[1]=Q*l+ne*w+ee*z+j*D,r[2]=Q*c+ne*S+ee*N+j*H,r[3]=Q*d+ne*I+ee*q+j*ce,Q=n[4],ne=n[5],ee=n[6],j=n[7],r[4]=Q*o+ne*y+ee*M+j*X,r[5]=Q*l+ne*w+ee*z+j*D,r[6]=Q*c+ne*S+ee*N+j*H,r[7]=Q*d+ne*I+ee*q+j*ce,Q=n[8],ne=n[9],ee=n[10],j=n[11],r[8]=Q*o+ne*y+ee*M+j*X,r[9]=Q*l+ne*w+ee*z+j*D,r[10]=Q*c+ne*S+ee*N+j*H,r[11]=Q*d+ne*I+ee*q+j*ce,Q=n[12],ne=n[13],ee=n[14],j=n[15],r[12]=Q*o+ne*y+ee*M+j*X,r[13]=Q*l+ne*w+ee*z+j*D,r[14]=Q*c+ne*S+ee*N+j*H,r[15]=Q*d+ne*I+ee*q+j*ce,r}function Sm(r,s,n){var o=n[0],l=n[1],c=n[2];return r[0]=s[0]*o,r[1]=s[1]*o,r[2]=s[2]*o,r[3]=s[3]*o,r[4]=s[4]*l,r[5]=s[5]*l,r[6]=s[6]*l,r[7]=s[7]*l,r[8]=s[8]*c,r[9]=s[9]*c,r[10]=s[10]*c,r[11]=s[11]*c,r[12]=s[12],r[13]=s[13],r[14]=s[14],r[15]=s[15],r}function Cm(r,s,n){var o=s[0],l=s[1],c=s[2],d=s[3],y=o+o,w=l+l,S=c+c,I=o*y,M=o*w,z=o*S,N=l*w,q=l*S,X=c*S,D=d*y,H=d*w,ce=d*S;return r[0]=1-(N+X),r[1]=M+ce,r[2]=z-H,r[3]=0,r[4]=M-ce,r[5]=1-(I+X),r[6]=q+D,r[7]=0,r[8]=z+H,r[9]=q-D,r[10]=1-(I+N),r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Mm(r,s){return r[0]=s[12],r[1]=s[13],r[2]=s[14],r}function El(r,s){var n=s[0],o=s[1],l=s[2],c=s[4],d=s[5],y=s[6],w=s[8],S=s[9],I=s[10];return r[0]=Math.hypot(n,o,l),r[1]=Math.hypot(c,d,y),r[2]=Math.hypot(w,S,I),r}function Rm(r,s){var n=new Ke(3);El(n,s);var o=1/n[0],l=1/n[1],c=1/n[2],d=s[0]*o,y=s[1]*l,w=s[2]*c,S=s[4]*o,I=s[5]*l,M=s[6]*c,z=s[8]*o,N=s[9]*l,q=s[10]*c,X=d+I+q,D=0;return X>0?(D=Math.sqrt(X+1)*2,r[3]=.25*D,r[0]=(M-N)/D,r[1]=(z-w)/D,r[2]=(y-S)/D):d>I&&d>q?(D=Math.sqrt(1+d-I-q)*2,r[3]=(M-N)/D,r[0]=.25*D,r[1]=(y+S)/D,r[2]=(z+w)/D):I>q?(D=Math.sqrt(1+I-d-q)*2,r[3]=(z-w)/D,r[0]=(y+S)/D,r[1]=.25*D,r[2]=(M+N)/D):(D=Math.sqrt(1+q-d-I)*2,r[3]=(y-S)/D,r[0]=(z+w)/D,r[1]=(M+N)/D,r[2]=.25*D),r}function Bm(r,s,n,o){var l=s[0],c=s[1],d=s[2],y=s[3],w=l+l,S=c+c,I=d+d,M=l*w,z=l*S,N=l*I,q=c*S,X=c*I,D=d*I,H=y*w,ce=y*S,Q=y*I,ne=o[0],ee=o[1],j=o[2];return r[0]=(1-(q+D))*ne,r[1]=(z+Q)*ne,r[2]=(N-ce)*ne,r[3]=0,r[4]=(z-Q)*ee,r[5]=(1-(M+D))*ee,r[6]=(X+H)*ee,r[7]=0,r[8]=(N+ce)*j,r[9]=(X-H)*j,r[10]=(1-(M+q))*j,r[11]=0,r[12]=n[0],r[13]=n[1],r[14]=n[2],r[15]=1,r}function Fm(r,s,n,o,l){var c=1/Math.tan(s/2),d;return r[0]=c/n,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=c,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,l!=null&&l!==1/0?(d=1/(o-l),r[10]=(l+o)*d,r[14]=2*l*o*d):(r[10]=-1,r[14]=-2*o),r}var Lm=Fm;function Um(r,s,n,o){var l,c,d,y,w,S,I,M,z,N,q=s[0],X=s[1],D=s[2],H=o[0],ce=o[1],Q=o[2],ne=n[0],ee=n[1],j=n[2];return Math.abs(q-ne)<Fn&&Math.abs(X-ee)<Fn&&Math.abs(D-j)<Fn?Em(r):(I=q-ne,M=X-ee,z=D-j,N=1/Math.hypot(I,M,z),I*=N,M*=N,z*=N,l=ce*z-Q*M,c=Q*I-H*z,d=H*M-ce*I,N=Math.hypot(l,c,d),N?(N=1/N,l*=N,c*=N,d*=N):(l=0,c=0,d=0),y=M*d-z*c,w=z*l-I*d,S=I*c-M*l,N=Math.hypot(y,w,S),N?(N=1/N,y*=N,w*=N,S*=N):(y=0,w=0,S=0),r[0]=l,r[1]=y,r[2]=I,r[3]=0,r[4]=c,r[5]=w,r[6]=M,r[7]=0,r[8]=d,r[9]=S,r[10]=z,r[11]=0,r[12]=-(l*q+c*X+d*D),r[13]=-(y*q+w*X+S*D),r[14]=-(I*q+M*X+z*D),r[15]=1,r)}var Il=Im;function wt(){var r=new Ke(3);return Ke!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Ia(r){var s=new Ke(3);return s[0]=r[0],s[1]=r[1],s[2]=r[2],s}function Pm(r){var s=r[0],n=r[1],o=r[2];return Math.hypot(s,n,o)}function Kt(r,s,n){var o=new Ke(3);return o[0]=r,o[1]=s,o[2]=n,o}function pl(r,s){return r[0]=s[0],r[1]=s[1],r[2]=s[2],r}function Aa(r,s,n,o){return r[0]=s,r[1]=n,r[2]=o,r}function Qn(r,s,n){return r[0]=s[0]+n[0],r[1]=s[1]+n[1],r[2]=s[2]+n[2],r}function Om(r,s,n){return r[0]=s[0]-n[0],r[1]=s[1]-n[1],r[2]=s[2]-n[2],r}function Jr(r,s,n){return r[0]=Math.min(s[0],n[0]),r[1]=Math.min(s[1],n[1]),r[2]=Math.min(s[2],n[2]),r}function Qr(r,s,n){return r[0]=Math.max(s[0],n[0]),r[1]=Math.max(s[1],n[1]),r[2]=Math.max(s[2],n[2]),r}function br(r,s,n){return r[0]=s[0]*n,r[1]=s[1]*n,r[2]=s[2]*n,r}function Nm(r,s,n,o){return r[0]=s[0]+n[0]*o,r[1]=s[1]+n[1]*o,r[2]=s[2]+n[2]*o,r}function Sl(r,s){var n=s[0],o=s[1],l=s[2],c=n*n+o*o+l*l;return c>0&&(c=1/Math.sqrt(c)),r[0]=s[0]*c,r[1]=s[1]*c,r[2]=s[2]*c,r}function zm(r,s){return r[0]*s[0]+r[1]*s[1]+r[2]*s[2]}function ri(r,s,n){var o=s[0],l=s[1],c=s[2],d=n[0],y=n[1],w=n[2];return r[0]=l*w-c*y,r[1]=c*d-o*w,r[2]=o*y-l*d,r}function Dm(r,s,n){var o=n[0],l=n[1],c=n[2],d=n[3],y=s[0],w=s[1],S=s[2],I=l*S-c*w,M=c*y-o*S,z=o*w-l*y,N=l*z-c*M,q=c*I-o*z,X=o*M-l*I,D=d*2;return I*=D,M*=D,z*=D,N*=2,q*=2,X*=2,r[0]=y+I+N,r[1]=w+M+q,r[2]=S+z+X,r}var Gm=Om,qm=Pm;(function(){var r=wt();return function(s,n,o,l,c,d){var y,w;for(n||(n=3),o||(o=0),l?w=Math.min(l*n+o,s.length):w=s.length,y=o;y<w;y+=n)r[0]=s[y],r[1]=s[y+1],r[2]=s[y+2],c(r,r,d),s[y]=r[0],s[y+1]=r[1],s[y+2]=r[2];return s}})();function Ye(){var r=new Ke(4);return Ke!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function Ua(r){var s=new Ke(4);return s[0]=r[0],s[1]=r[1],s[2]=r[2],s[3]=r[3],s}function en(r,s,n,o){var l=new Ke(4);return l[0]=r,l[1]=s,l[2]=n,l[3]=o,l}function xr(r,s,n){return r[0]=s[0]+n[0],r[1]=s[1]+n[1],r[2]=s[2]+n[2],r[3]=s[3]+n[3],r}function kr(r,s,n){return r[0]=s[0]*n,r[1]=s[1]*n,r[2]=s[2]*n,r[3]=s[3]*n,r}function Km(r,s,n,o){return r[0]=s[0]+n[0]*o,r[1]=s[1]+n[1]*o,r[2]=s[2]+n[2]*o,r[3]=s[3]+n[3]*o,r}function Cl(r,s){var n=s[0],o=s[1],l=s[2],c=s[3],d=n*n+o*o+l*l+c*c;return d>0&&(d=1/Math.sqrt(d)),r[0]=n*d,r[1]=o*d,r[2]=l*d,r[3]=c*d,r}function Wm(r,s,n,o){var l=s[0],c=s[1],d=s[2],y=s[3];return r[0]=l+o*(n[0]-l),r[1]=c+o*(n[1]-c),r[2]=d+o*(n[2]-d),r[3]=y+o*(n[3]-y),r}function $m(r,s,n){var o=s[0],l=s[1],c=s[2],d=n[0],y=n[1],w=n[2],S=n[3],I=S*o+y*c-w*l,M=S*l+w*o-d*c,z=S*c+d*l-y*o,N=-d*o-y*l-w*c;return r[0]=I*S+N*-d+M*-w-z*-y,r[1]=M*S+N*-y+z*-d-I*-w,r[2]=z*S+N*-w+I*-y-M*-d,r[3]=s[3],r}function Ml(r,s){var n=r[0],o=r[1],l=r[2],c=r[3],d=s[0],y=s[1],w=s[2],S=s[3];return Math.abs(n-d)<=Fn*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(o-y)<=Fn*Math.max(1,Math.abs(o),Math.abs(y))&&Math.abs(l-w)<=Fn*Math.max(1,Math.abs(l),Math.abs(w))&&Math.abs(c-S)<=Fn*Math.max(1,Math.abs(c),Math.abs(S))}(function(){var r=Ye();return function(s,n,o,l,c,d){var y,w;for(n||(n=4),o||(o=0),l?w=Math.min(l*n+o,s.length):w=s.length,y=o;y<w;y+=n)r[0]=s[y],r[1]=s[y+1],r[2]=s[y+2],r[3]=s[y+3],c(r,r,d),s[y]=r[0],s[y+1]=r[1],s[y+2]=r[2],s[y+3]=r[3];return s}})();function Pn(){var r=new Ke(4);return Ke!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function Sa(r,s,n){n=n*.5;var o=Math.sin(n);return r[0]=o*s[0],r[1]=o*s[1],r[2]=o*s[2],r[3]=Math.cos(n),r}function ml(r,s,n){var o=s[0],l=s[1],c=s[2],d=s[3],y=n[0],w=n[1],S=n[2],I=n[3];return r[0]=o*I+d*y+l*S-c*w,r[1]=l*I+d*w+c*y-o*S,r[2]=c*I+d*S+o*w-l*y,r[3]=d*I-o*y-l*w-c*S,r}function si(r,s,n,o){var l=s[0],c=s[1],d=s[2],y=s[3],w=n[0],S=n[1],I=n[2],M=n[3],z,N,q,X,D;return N=l*w+c*S+d*I+y*M,N<0&&(N=-N,w=-w,S=-S,I=-I,M=-M),1-N>Fn?(z=Math.acos(N),q=Math.sin(z),X=Math.sin((1-o)*z)/q,D=Math.sin(o*z)/q):(X=1-o,D=o),r[0]=X*l+D*w,r[1]=X*c+D*S,r[2]=X*d+D*I,r[3]=X*y+D*M,r}function Hm(r,s){var n=s[0]+s[4]+s[8],o;if(n>0)o=Math.sqrt(n+1),r[3]=.5*o,o=.5/o,r[0]=(s[5]-s[7])*o,r[1]=(s[6]-s[2])*o,r[2]=(s[1]-s[3])*o;else{var l=0;s[4]>s[0]&&(l=1),s[8]>s[l*3+l]&&(l=2);var c=(l+1)%3,d=(l+2)%3;o=Math.sqrt(s[l*3+l]-s[c*3+c]-s[d*3+d]+1),r[l]=.5*o,o=.5/o,r[3]=(s[c*3+d]-s[d*3+c])*o,r[c]=(s[c*3+l]+s[l*3+c])*o,r[d]=(s[d*3+l]+s[l*3+d])*o}return r}function Vm(r,s,n,o){var l=.5*Math.PI/180;s*=l,n*=l,o*=l;var c=Math.sin(s),d=Math.cos(s),y=Math.sin(n),w=Math.cos(n),S=Math.sin(o),I=Math.cos(o);return r[0]=c*w*I-d*y*S,r[1]=d*y*I+c*w*S,r[2]=d*w*S-c*y*I,r[3]=d*w*I+c*y*S,r}var Rl=Ua,Xm=en,Bl=Cl,Ym=Ml;(function(){var r=wt(),s=Kt(1,0,0),n=Kt(0,1,0);return function(o,l,c){var d=zm(l,c);return d<-.999999?(ri(r,s,l),qm(r)<1e-6&&ri(r,n,l),Sl(r,r),Sa(o,r,Math.PI),o):d>.999999?(o[0]=0,o[1]=0,o[2]=0,o[3]=1,o):(ri(r,l,c),o[0]=r[0],o[1]=r[1],o[2]=r[2],o[3]=1+d,Bl(o,o))}})();(function(){var r=Pn(),s=Pn();return function(n,o,l,c,d,y){return si(r,o,d,y),si(s,l,c,y),si(n,r,s,2*y*(1-y)),n}})();(function(){var r=Tm();return function(s,n,o,l){return r[0]=o[0],r[3]=o[1],r[6]=o[2],r[1]=l[0],r[4]=l[1],r[7]=l[2],r[2]=-n[0],r[5]=-n[1],r[8]=-n[2],Bl(s,Hm(s,r))}})();var Ie=Ie||{},Fl=0,qt=null,Ll=65,Zm=Ie.Scene=function(r,s){this.name=s.name!==void 0?s.name:null,this.nodes=new Array(s.nodes.length);for(var n=0,o=s.nodes.length;n<o;n++)this.nodes[n]=r.nodes[s.nodes[n]];this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.boundingBox=null},pn=Ie.BoundingBox=function(r,s,n){r=r||Kt(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),s=s||Kt(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n===void 0||n===!0?(this.min=Ia(r),this.max=Ia(s)):(this.min=r,this.max=s),this.transform=Bt()};pn.prototype.updateBoundingBox=function(r){Jr(this.min,this.min,r.min),Qr(this.max,this.max,r.max)};pn.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]};pn.getAABBFromOBB=function(){var r=wt(),s=wt(),n=wt(),o=wt(),l=wt();return function(c,d){Aa(r,d[0],d[1],d[2]),Aa(s,d[4],d[5],d[6]),Aa(n,d[8],d[9],d[10]);var y=Kt(d[12],d[13],d[14]),w=Ia(y);br(o,r,c.min[0]),br(l,r,c.max[0]),Jr(r,o,l),Qn(y,y,r),Qr(r,o,l),Qn(w,w,r),br(o,s,c.min[1]),br(l,s,c.max[1]),Jr(s,o,l),Qn(y,y,s),Qr(s,o,l),Qn(w,w,s),br(o,n,c.min[2]),br(l,n,c.max[2]),Jr(n,o,l),Qn(y,y,n),Qr(n,o,l),Qn(w,w,n);var S=new pn(y,w,!1);return S.calculateTransform(),S}}();var Ul=Ie.Accessor=function(r,s){this.bufferView=s,this.componentType=r.componentType,this.byteOffset=r.byteOffset!==void 0?r.byteOffset:0,this.byteStride=s.byteStride,this.normalized=r.normalized!==void 0?r.normalized:!1,this.count=r.count,this.type=r.type,this.size=Pa[this.type],this.min=r.min,this.max=r.max,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null};Ul.prototype.prepareVertexAttrib=function(r,s){s.vertexAttribPointer(r,this.size,this.componentType,this.normalized,this.byteStride,this.byteOffset),s.enableVertexAttribArray(r)};var Jm=Ie.BufferView=function(r,s){this.byteLength=r.byteLength,this.byteOffset=r.byteOffset!==void 0?r.byteOffset:0,this.byteStride=r.byteStride!==void 0?r.byteStride:0,this.target=r.target!==void 0?r.target:null,this.data=s.slice(this.byteOffset,this.byteOffset+this.byteLength),this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null,this.buffer=null},Qm=Ie.Camera=function(r){this.name=r.name!==void 0?r.name:null,this.type=r.type,this.othographic=r.othographic===void 0?null:r.othographic,this.perspective=r.perspective===void 0?null:{yfov:r.perspective.yfov,znear:r.perspective.znear,zfar:r.perspective.zfar!==void 0?r.perspective.zfar:null,aspectRatio:r.perspective.aspectRatio!==void 0?r.perspective.aspectRatio:null},this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},Sr=Ie.Node=function(r,s){if(this.name=r.name!==void 0?r.name:null,this.nodeID=s,this.camera=r.camera!==void 0?r.camera:null,this.matrix=Bt(),r.hasOwnProperty("matrix")){for(var n=0;n<16;++n)this.matrix[n]=r.matrix[n];this.translation=wt(),Mm(this.translation,this.matrix),this.rotation=Pn(),Rm(this.rotation,this.matrix),this.scale=wt(),El(this.scale,this.matrix)}else this.getTransformMatrixFromTRS(r.translation,r.rotation,r.scale);if(this.children=r.children||[],this.mesh=r.mesh!==void 0?qt.glTF.meshes[r.mesh]:null,this.skin=r.skin!==void 0?r.skin:null,r.extensions!==void 0&&r.extensions.gl_avatar!==void 0&&qt.enableGLAvatar===!0){var o=qt.skeletonGltf.json.extensions.gl_avatar.skins[r.extensions.gl_avatar.skin.name],l=qt.skeletonGltf.skins[o];this.skin=new i0(qt.glTF,l,r.extensions.gl_avatar.skin.inverseBindMatrices)}this.weights=r.weights!==void 0?r.weights:null,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null,this.aabb=null,this.bvh=new pn};Sr.prototype.traverse=function(r,s){s(this,r);for(var n=0,o=this.children.length;n<o;n++)this.children[n].traverse(this,s)};Sr.prototype.traversePostOrder=function(r,s){for(var n=0,o=this.children.length;n<o;n++)this.children[n].traversePostOrder(this,s);s(this,r)};Sr.prototype.traverseTwoExecFun=function(r,s,n){s(this,r);for(var o=0,l=this.children.length;o<l;o++)this.children[o].traverseTwoExecFun(this,s,n);n(this,r)};var yl=Bt();Sr.prototype.getTransformMatrixFromTRS=function(r,s,n){this.translation=r!==void 0?Kt(r[0],r[1],r[2]):Kt(0,0,0),this.rotation=s!==void 0?en(s[0],s[1],s[2],s[3]):en(0,0,0,1),this.scale=n!==void 0?Kt(n[0],n[1],n[2]):Kt(1,1,1),this.updateMatrixFromTRS()};Sr.prototype.updateMatrixFromTRS=function(){Cm(yl,this.rotation,this.translation),Sm(this.matrix,yl,this.scale)};var jm=Ie.Mesh=function(r,s){this.meshID=s,this.name=r.name!==void 0?r.name:null,this.primitives=[],this.boundingBox=null;for(var n,o,l=0,c=r.primitives.length;l<c;++l)n=r.primitives[l],o=new e0(qt.glTF,n),this.primitives.push(o),o.boundingBox&&(this.boundingBox||(this.boundingBox=new pn),this.boundingBox.updateBoundingBox(o.boundingBox));this.boundingBox&&this.boundingBox.calculateTransform(),this.weights=r.weights!==void 0?r.weights:null,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},e0=Ie.Primitive=function(r,s){this.attributes=s.attributes,this.indices=s.indices!==void 0?s.indices:null;var n;if(s.extensions!==void 0&&s.extensions.gl_avatar!==void 0&&qt.enableGLAvatar===!0&&s.extensions.gl_avatar.attributes)for(n in s.extensions.gl_avatar.attributes)this.attributes[n]=s.extensions.gl_avatar.attributes[n];this.indices!==null?(this.indicesComponentType=r.json.accessors[this.indices].componentType,this.indicesLength=r.json.accessors[this.indices].count,this.indicesOffset=r.json.accessors[this.indices].byteOffset||0):(this.drawArraysCount=r.json.accessors[this.attributes.POSITION].count,this.drawArraysOffset=r.json.accessors[this.attributes.POSITION].byteOffset||0);for(n in this.attributes)this.attributes[n]=r.accessors[this.attributes[n]];if(this.material=s.material!==void 0?r.materials[s.material]:null,this.mode=s.mode!==void 0?s.mode:4,this.targets=s.targets,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.shader=null,this.boundingBox=null,this.attributes.POSITION!==void 0){var o=this.attributes.POSITION;o.max&&o.type==="VEC3"&&(this.boundingBox=new pn(Kt(o.min[0],o.min[1],o.min[2]),Kt(o.max[0],o.max[1],o.max[2]),!1),this.boundingBox.calculateTransform())}},Pl=Ie.Texture=function(r){this.name=r.name!==void 0?r.name:null,this.sampler=r.sampler!==void 0?qt.glTF.samplers[r.sampler]:null,this.source=r.source!==void 0?qt.glTF.images[r.source]:null,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null,this.texture=null};Pl.prototype.createTexture=function(r){this.texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this.texture),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,this.source),r.generateMipmap(r.TEXTURE_2D),r.bindTexture(r.TEXTURE_2D,null)};var Ol=Ie.Sampler=function(r){this.name=r.name!==void 0?r.name:null,this.magFilter=r.magFilter!==void 0?r.magFilter:null,this.minFilter=r.minFilter!==void 0?r.minFilter:null,this.wrapS=r.wrapS!==void 0?r.wrapS:10497,this.wrapT=r.wrapT!==void 0?r.wrapT:10497,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null,this.sampler=null};Ol.prototype.createSampler=function(r){this.sampler=r.createSampler(),this.minFilter?r.samplerParameteri(this.sampler,r.TEXTURE_MIN_FILTER,this.minFilter):r.samplerParameteri(this.sampler,r.TEXTURE_MIN_FILTER,r.NEAREST_MIPMAP_LINEAR),this.magFilter?r.samplerParameteri(this.sampler,r.TEXTURE_MAG_FILTER,this.magFilter):r.samplerParameteri(this.sampler,r.TEXTURE_MAG_FILTER,r.LINEAR),r.samplerParameteri(this.sampler,r.TEXTURE_WRAP_S,this.wrapS),r.samplerParameteri(this.sampler,r.TEXTURE_WRAP_T,this.wrapT)};var Ca=Ie.TextureInfo=function(r){this.index=r.index,this.texCoord=r.texCoord!==void 0?r.texCoord:0,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},vl=Ie.PbrMetallicRoughness=function(r){this.baseColorFactor=r.baseColorFactor!==void 0?r.baseColorFactor:[1,1,1,1],this.baseColorTexture=r.baseColorTexture!==void 0?new Ca(r.baseColorTexture):null,this.metallicFactor=r.metallicFactor!==void 0?r.metallicFactor:1,this.roughnessFactor=r.roughnessFactor!==void 0?r.roughnessFactor:1,this.metallicRoughnessTexture=r.metallicRoughnessTexture!==void 0?new Ca(r.metallicRoughnessTexture):null,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},t0=Ie.NormalTextureInfo=function(r){this.index=r.index,this.texCoord=r.texCoord!==void 0?r.texCoord:0,this.scale=r.scale!==void 0?r.scale:1,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},n0=Ie.OcclusionTextureInfo=function(r){this.index=r.index,this.texCoord=r.texCoord!==void 0?r.texCoord:0,this.strength=r.strength!==void 0?r.strength:1,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},r0=Ie.Material=function(r){this.name=r.name!==void 0?r.name:null,this.pbrMetallicRoughness=r.pbrMetallicRoughness!==void 0?new vl(r.pbrMetallicRoughness):new vl({baseColorFactor:[1,1,1,1],metallicFactor:1,metallicRoughnessTexture:1}),this.normalTexture=r.normalTexture!==void 0?new t0(r.normalTexture):null,this.occlusionTexture=r.occlusionTexture!==void 0?new n0(r.occlusionTexture):null,this.emissiveTexture=r.emissiveTexture!==void 0?new Ca(r.emissiveTexture):null,this.emissiveFactor=r.emissiveFactor!==void 0?r.emissiveFactor:[0,0,0],this.alphaMode=r.alphaMode!==void 0?r.alphaMode:"OPAQUE",this.alphaCutoff=r.alphaCutoff!==void 0?r.alphaCutoff:.5,this.doubleSided=r.doubleSided||!1,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},s0=Ie.Skin=function(r,s,n){this.name=s.name!==void 0?s.name:null,this.skinID=n,this.joints=new Array(s.joints.length);var o,l;for(o=0,l=this.joints.length;o<l;o++)this.joints[o]=r.nodes[s.joints[o]];if(this.skeleton=s.skeleton!==void 0?r.nodes[s.skeleton]:null,this.inverseBindMatrices=s.inverseBindMatrices!==void 0?r.accessors[s.inverseBindMatrices]:null,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.uniformBlockID=Fl++,this.inverseBindMatrices)for(this.inverseBindMatricesData=oi(this.inverseBindMatrices),this.inverseBindMatrix=[],this.jointMatrixUniformBuffer=null,this.jointMatrixUnidormBufferData=new Float32Array(Ll*16),o=0,l=this.inverseBindMatricesData.length;o<l;o+=16)this.inverseBindMatrix.push(Tl(this.inverseBindMatricesData[o],this.inverseBindMatricesData[o+1],this.inverseBindMatricesData[o+2],this.inverseBindMatricesData[o+3],this.inverseBindMatricesData[o+4],this.inverseBindMatricesData[o+5],this.inverseBindMatricesData[o+6],this.inverseBindMatricesData[o+7],this.inverseBindMatricesData[o+8],this.inverseBindMatricesData[o+9],this.inverseBindMatricesData[o+10],this.inverseBindMatricesData[o+11],this.inverseBindMatricesData[o+12],this.inverseBindMatricesData[o+13],this.inverseBindMatricesData[o+14],this.inverseBindMatricesData[o+15]))},i0=Ie.SkinLink=function(r,s,n){if(this.isLink=!0,r.skins||(r.skins=[]),r.skins.push(this),this.name=s.name,this.skinID=r.skins.length-1,this.joints=s.joints,this.skeleton=s.skeleton,this.inverseBindMatrices=n!==void 0?r.accessors[n]:null,this.uniformBlockID=Fl++,this.inverseBindMatrices){this.inverseBindMatricesData=oi(this.inverseBindMatrices),this.inverseBindMatrix=[],this.jointMatrixUniformBuffer=null,this.jointMatrixUnidormBufferData=new Float32Array(Ll*16);for(var o=0,l=this.inverseBindMatricesData.length;o<l;o+=16)this.inverseBindMatrix.push(Tl(this.inverseBindMatricesData[o],this.inverseBindMatricesData[o+1],this.inverseBindMatricesData[o+2],this.inverseBindMatricesData[o+3],this.inverseBindMatricesData[o+4],this.inverseBindMatricesData[o+5],this.inverseBindMatricesData[o+6],this.inverseBindMatricesData[o+7],this.inverseBindMatricesData[o+8],this.inverseBindMatricesData[o+9],this.inverseBindMatricesData[o+10],this.inverseBindMatricesData[o+11],this.inverseBindMatricesData[o+12],this.inverseBindMatricesData[o+13],this.inverseBindMatricesData[o+14],this.inverseBindMatricesData[o+15]))}},a0=Ie.Target=function(r){this.nodeID=r.node!==void 0?r.node:null,this.path=r.path,this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},o0=Ie.Channel=function(r,s){this.sampler=s.samplers[r.sampler],this.target=new a0(r.target),this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},Nl=Ie.AnimationSampler=function(r,s){this.input=r.accessors[s.input],this.output=r.accessors[s.output],this.inputTypedArray=oi(this.input),this.outputTypedArray=oi(this.output),this.interpolation=s.interpolation!==void 0?s.interpolation:"LINEAR",this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.curIdx=0,this.curValue=Ye(),this.endT=this.inputTypedArray[this.inputTypedArray.length-1],this.inputMax=this.endT-this.inputTypedArray[0]},wl=Ye(),bl=Ye();Nl.prototype.getValue=function(r){r>this.endT&&(r-=this.inputMax*Math.ceil((r-this.endT)/this.inputMax),this.curIdx=0);for(var s=this.inputTypedArray.length;this.curIdx<=s-2&&r>=this.inputTypedArray[this.curIdx+1];)this.curIdx++;this.curIdx>=s-1&&(r-=this.inputMax,this.curIdx=0);for(var n=Pa[this.output.type],o=n===4?si:Wm,l=this.curIdx,c=l*n,d=c+n,y=Math.max(0,r-this.inputTypedArray[l])/(this.inputTypedArray[l+1]-this.inputTypedArray[l]),w=0;w<n;w++)wl[w]=this.outputTypedArray[c+w],bl[w]=this.outputTypedArray[d+w];switch(this.interpolation){case"LINEAR":o(this.curValue,wl,bl,y);break}};var u0=Ie.Animation=function(r,s){this.name=s.name!==void 0?s.name:null;var n,o;for(this.samplers=[],n=0,o=s.samplers.length;n<o;n++)this.samplers[n]=new Nl(r,s.samplers[n]);for(this.channels=[],n=0,o=s.channels.length;n<o;n++)this.channels[n]=new o0(s.channels[n],this);this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},l0=Ie.glTFModel=function(r){this.json=r,this.defaultScene=r.scene!==void 0?r.scene:0,this.version=Number(r.asset.version),r.accessors&&(this.accessors=new Array(r.accessors.length)),r.bufferViews&&(this.bufferViews=new Array(r.bufferViews.length)),r.scenes&&(this.scenes=new Array(r.scenes.length)),r.nodes&&(this.nodes=new Array(r.nodes.length)),r.meshes&&(this.meshes=new Array(r.meshes.length)),r.materials&&(this.materials=new Array(r.materials.length)),r.textures&&(this.textures=new Array(r.textures.length)),r.samplers&&(this.samplers=new Array(r.samplers.length)),r.images&&(this.images=new Array(r.images.length)),r.skins&&(this.skins=new Array(r.skins.length)),r.animations&&(this.animations=new Array(r.animations.length)),r.cameras&&(this.cameras=new Array(r.cameras.length)),this.extensions=r.extensions!==void 0?r.extensions:null,this.extras=r.extras!==void 0?r.extras:null},Cr=Ie.glTFLoader=function(){this._init(),this.glTF=null,this.enableGLAvatar=!1,this.linkSkeletonGltf=null};Cr.prototype._init=function(){this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers=[],this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null,qt=this};Cr.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))};Cr.prototype.load_GL_Avatar_Skin=function(r,s,n){this.enableGLAvatar=!0,this.skeletonGltf=s,this.load(r,n)};Cr.prototype.load=function(r,s){this._init(),this.onload=s||function(o){console.log("glTF model loaded."),console.log(o)},this.baseUri=h0(r);var n=this;_0(r,function(o){var l=JSON.parse(o);n.glTF=new l0(l);var c,d=function(S){if(n._buffers[c]=S,n._bufferLoaded++,n._bufferTasks[c]){var I,M;for(I=0,M=n._bufferTasks[c].length;I<M;++I)n._bufferTasks[c][I](S)}n._checkComplete()};if(l.buffers)for(c in l.buffers)n._bufferRequested++,f0(n.baseUri+l.buffers[c].uri,d);var y=function(S,I){n._imageLoaded++,n.glTF.images[I]=S,n._checkComplete()},w;if(l.images)for(w in l.images)n._imageRequested++,d0(n.baseUri+l.images[w].uri,w,y);n._checkComplete()})};Cr.prototype._postprocess=function(){qt=this;var r,s,n,o,l,c,d;if(this.glTF.cameras)for(r=0,s=this.glTF.cameras.length;r<s;r++)this.glTF.cameras[r]=new Qm(this.glTF.json.cameras[r]);if(this.glTF.bufferViews)for(r=0,s=this.glTF.bufferViews.length;r<s;r++)this.glTF.bufferViews[r]=new Jm(this.glTF.json.bufferViews[r],this._buffers[this.glTF.json.bufferViews[r].buffer]);if(this.glTF.accessors)for(r=0,s=this.glTF.accessors.length;r<s;r++)this.glTF.accessors[r]=new Ul(this.glTF.json.accessors[r],this.glTF.bufferViews[this.glTF.json.accessors[r].bufferView]);if(this.glTF.materials)for(r=0,s=this.glTF.materials.length;r<s;r++)this.glTF.materials[r]=new r0(this.glTF.json.materials[r]);if(this.glTF.samplers)for(r=0,s=this.glTF.samplers.length;r<s;r++)this.glTF.samplers[r]=new Ol(this.glTF.json.samplers[r]);if(this.glTF.textures)for(r=0,s=this.glTF.textures.length;r<s;r++)this.glTF.textures[r]=new Pl(this.glTF.json.textures[r]);for(r=0,s=this.glTF.meshes.length;r<s;r++)this.glTF.meshes[r]=new jm(this.glTF.json.meshes[r],r);for(r=0,s=this.glTF.nodes.length;r<s;r++)this.glTF.nodes[r]=new Sr(this.glTF.json.nodes[r],r);for(r=0,s=this.glTF.nodes.length;r<s;r++)for(c=this.glTF.nodes[r],n=0,o=c.children.length;n<o;n++)c.children[n]=this.glTF.nodes[c.children[n]];var y=new Array(this.glTF.nodes.length);for(r=0,s=y.length;r<s;r++)y[r]=Bt();function w(M,z){var N=y[M.nodeID];z!==null?Il(N,y[z.nodeID],M.matrix):Am(N,M.matrix)}function S(M,z){var N=y[M.nodeID],q;z!==null?q=z.bvh:q=l.boundingBox,M.mesh&&(d=M.mesh,d.boundingBox&&(M.aabb=pn.getAABBFromOBB(d.boundingBox,N),M.children.length===0&&(pl(M.bvh.min,M.aabb.min),pl(M.bvh.max,M.aabb.max)))),Jr(q.min,q.min,M.bvh.min),Qr(q.max,q.max,M.bvh.max)}for(r=0,s=this.glTF.scenes.length;r<s;r++){for(l=this.glTF.scenes[r]=new Zm(this.glTF,this.glTF.json.scenes[r]),l.boundingBox=new pn,n=0,o=l.nodes.length;n<o;n++)c=l.nodes[n],c.traverseTwoExecFun(null,w,S);l.boundingBox.calculateTransform()}for(n=0,o=this.glTF.nodes.length;n<o;n++)c=this.glTF.nodes[n],c.bvh!==null&&c.bvh.calculateTransform();if(this.glTF.animations)for(r=0,s=this.glTF.animations.length;r<s;r++)this.glTF.animations[r]=new u0(this.glTF,this.glTF.json.animations[r]);var I;if(this.glTF.json.skins)for(r=0,s=this.glTF.skins.length;r<s;r++)for(this.glTF.skins[r]=new s0(this.glTF,this.glTF.json.skins[r],r),I=this.glTF.skins[r].joints,n=0,o=I.length;n<o;n++)I[n].jointID=n;for(r=0,s=this.glTF.nodes.length;r<s;r++)c=this.glTF.nodes[r],c.skin!==null&&typeof c.skin=="number"&&(c.skin=this.glTF.skins[c.skin])};var Pa={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function c0(r,s,n,o){switch(o){case 5122:return new Int16Array(r,s,n);case 5123:return new Uint16Array(r,s,n);case 5124:return new Int32Array(r,s,n);case 5125:return new Uint32Array(r,s,n);case 5126:return new Float32Array(r,s,n);default:return null}}function oi(r){return c0(r.bufferView.data,r.byteOffset,r.count*Pa[r.type],r.componentType)}function h0(r){var s="",n=r.lastIndexOf("/");return n!==-1&&(s=r.substring(0,n+1)),s}function _0(r,s){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",r,!0),n.onreadystatechange=function(){n.readyState==4&&n.status=="200"&&s(n.responseText,this)},n.send(null)}function f0(r,s){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",r,!0),n.onreadystatechange=function(){if(n.readyState==4&&n.status=="200"){var o=n.response;o&&s&&s(o)}},n.send(null)}function d0(r,s,n){var o=new Image;o.crossOrigin="Anonymous",o.src=r,o.onload=function(){n(o,s)}}const ui=en(0,1,0,0),ii=en(0,0,1,0);en(1,0,0,0);class lt{constructor(){O(this,"buffer",null);O(this,"vertex_data",[]);O(this,"size",0);if(lt.instance)return lt.instance;lt.instance=this}static get(){return lt.instance||(lt.instance=new lt),lt.instance}add_vertex_data(s,n){const o=this.vertex_data.length;return this.vertex_data.push(...n),this.size=this._get_byte_size(),this.build(s),o}_get_byte_size(){return this.vertex_data.map(s=>s.position.concat(s.normal,s.color,s.uv,s.tangent,s.bitangent)).flat().length*4}build(s){this.buffer&&this.buffer.destroy(),this.buffer=Lt.create(s,{name:"vertex_buffer",data:this.vertex_data.map(n=>n.position.concat(n.normal,n.color,n.uv,n.tangent,n.bitangent)),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Oe.get().refresh_global_shader_bindings()}}class ct{constructor(){O(this,"view_data",[]);O(this,"type_size_bytes",0);O(this,"raw_data",null);O(this,"size",0);if(ct.instance)return ct.instance;ct.instance=this}static get(){return ct.instance?ct.instance:new ct}add_view_data(s,n={}){this.view_data.push({position:n.position??Ye(),rotation:n.rotation??Pn(),fov:n.fov??75,aspect_ratio:n.aspect_ratio??1,near:n.near??.01,far:n.far??1e3,view_forward:n.view_forward??Ye(),view_right:n.view_right??Ye(),view_matrix:n.view_matrix??Bt(),projection_matrix:n.projection_matrix??Bt(),prev_view_matrix:n.prev_view_matrix??Bt(),prev_projection_matrix:n.prev_projection_matrix??Bt(),view_projection_matrix:n.view_projection_matrix??Bt(),inverse_view_projection_matrix:n.inverse_view_projection_matrix_direction_only??Bt()}),this.type_size_bytes===0&&(this.type_size_bytes=this._get_gpu_type_layout(this.view_data[0]).length*4);const o=this.view_data.map(l=>this._get_gpu_type_layout(l)).flat();return this.raw_data=new Float32Array(o.length),this.raw_data.set(o),this.size=this.type_size_bytes*this.view_data.length,this.build(s),this.view_data.length-1}get_view_data(s){return console.assert(s<this.view_data.length&&s>=0,"View data index out of bounds"),this.view_data[s]}set_view_data(s,n,o){let l=!1;o.position&&!Ml(this.view_data[n].position,o.position)&&(this.view_data[n].position=Ua(o.position),l=!0),o.rotation&&!Ym(this.view_data[n].rotation,o.rotation)&&(this.view_data[n].rotation=Rl(o.rotation),l=!0),o.fov&&this.view_data[n].fov!==o.fov&&(this.view_data[n].fov=o.fov,l=!0),o.aspect_ratio&&this.view_data[n].aspect_ratio!==o.aspect_ratio&&(this.view_data[n].aspect_ratio=o.aspect_ratio,l=!0),o.near&&this.view_data[n].near!==o.near&&(this.view_data[n].near=o.near,l=!0),o.far&&this.view_data[n].far!==o.far&&(this.view_data[n].far=o.far,l=!0),this.view_data[n].dirty=l}update_transforms(s,n){if(this.view_data[n].dirty){this.view_data[n].projection_matrix&&(this.view_data[n].prev_projection_matrix=gl(this.view_data[n].projection_matrix)),this.view_data[n].view_matrix&&(this.view_data[n].prev_view_matrix=gl(this.view_data[n].view_matrix)),Lm(this.view_data[n].projection_matrix,this.view_data[n].fov,this.view_data[n].aspect_ratio,this.view_data[n].near,this.view_data[n].far);{this.view_data[n].view_forward=$m(Ye(),ii,this.view_data[n].rotation),this.view_data[n].view_forward=Cl(Ye(),this.view_data[n].view_forward);const o=ri(wt(),this.view_data[n].view_forward,ui);this.view_data[n].view_right=en(o[0],o[1],o[2],0),this.view_data[n].view_right=Sl(wt(),this.view_data[n].view_right);const l=Ye();Km(l,this.view_data[n].position,this.view_data[n].view_forward,1),Um(this.view_data[n].view_matrix,this.view_data[n].position,l,ui)}Il(this.view_data[n].view_projection_matrix,this.view_data[n].projection_matrix,this.view_data[n].view_matrix),Al(this.view_data[n].inverse_view_projection_matrix,this.view_data[n].view_projection_matrix),this.buffer?(n*this.type_size_bytes,this.buffer.write(s,this.view_data.map(this._get_gpu_type_layout))):this.build(s),this.view_data[n].dirty=!1}}build(s){this.buffer&&this.buffer.destroy(),this.buffer=Lt.create(s,{name:"view_buffer",data:this.view_data.map(this._get_gpu_type_layout),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Oe.get().refresh_global_shader_bindings()}_get_gpu_type_layout(s){return Array.of(...s.view_matrix,...s.prev_view_matrix,...s.projection_matrix,...s.prev_projection_matrix,...s.view_projection_matrix,...s.inverse_view_projection_matrix,...s.view_forward)}}class gn{constructor(){O(this,"skybox",null);if(gn.instance)return gn.instance;gn.instance=this}static get(){return gn.instance?gn.instance:new gn}async add_skybox(s,n,o){const l=await es.load(s,o,{name:n,format:"rgba8unorm",dimension:"cube",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.skybox=l,l}remove_skybox(){this.skybox=null}get_skybox(){return this.skybox}}class Ln{constructor(){this.name="",this.vertices=[],this.indices=[],this.vertex_buffer_offset=0,this.index_buffer=null}_build_index_buffer(s){let n="uint16";this.indices.constructor.name==="Uint32Array"&&(n="uint32"),this.index_buffer=Lt.create(s,{name:`${this.name}_index_buffer`,raw_data:this.indices,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,element_type:n})}_get_tangents_and_bitangents(s,n){let o=[],l=[];for(let c=0;c<s.length;c+=9){const d=[s[c],s[c+1],s[c+2]],y=[s[c+3],s[c+4],s[c+5]],w=[s[c+6],s[c+7],s[c+8]],S=[n[c/3*2],n[c/3*2+1]],I=[n[c/3*2+2],n[c/3*2+3]],M=[n[c/3*2+4],n[c/3*2+5]],z=[y[0]-d[0],y[1]-d[1],y[2]-d[2]],N=[w[0]-d[0],w[1]-d[1],w[2]-d[2]],q=[I[0]-S[0],I[1]-S[1]],X=[M[0]-S[0],M[1]-S[1]],D=1/(q[0]*X[1]-q[1]*X[0]),H=[(X[1]*z[0]-q[1]*N[0])*D,(X[1]*z[1]-q[1]*N[1])*D,(X[1]*z[2]-q[1]*N[2])*D],ce=[(q[0]*N[0]-X[0]*z[0])*D,(q[0]*N[1]-X[0]*z[1])*D,(q[0]*N[2]-X[0]*z[2])*D];o.push(...H,...H,...H),l.push(...ce,...ce,...ce)}return{t:o,b:l}}static create(s,n,o,l){let c=V.get().fetch(K.MESH,oe.from(n));return c||(c=new Ln,c.name=n,c.vertices=o,c.indices=new Uint16Array(l),c.vertex_buffer_offset=lt.get().add_vertex_data(s,c.vertices),c._build_index_buffer(s),V.get().store(K.MESH,oe.from(n),c),c)}static quad(s){let n=V.get().fetch(K.MESH,oe.from("engine_quad"));return n||(n=new Ln,n.name="engine_quad",n.vertices=[{position:[-1,1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,-1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]}],n.indices=new Uint16Array([0,1,2,0,2,3]),n.vertex_buffer_offset=lt.get().add_vertex_data(s,n.vertices),n._build_index_buffer(s),V.get().store(K.MESH,oe.from("engine_quad"),n),n)}static cube(s){let n=V.get().fetch(K.MESH,oe.from("engine_cube"));return n||(n=new Ln,n.name="engine_cube",n.vertices=[{position:[-1,-1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,-1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[1,1,1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[1,1,-1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[-1,1,-1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[-1,-1,-1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,-1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[-1,-1,1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,-1,-1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,1,-1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,1,1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[-1,-1,-1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,-1,1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,1,-1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]}],n.indices=new Uint16Array([0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20]),n.vertex_buffer_offset=lt.get().add_vertex_data(s,n.vertices),n._build_index_buffer(s),V.get().store(K.MESH,oe.from("engine_cube"),n),n)}static async from_gltf(s,n){let o=V.get().fetch(K.MESH,oe.from(n));return o||new Promise(l=>{new Cr().load(n,d=>{o=new Ln;for(const y of d.scenes)for(const w of y.nodes)if(w.mesh)for(const S of w.mesh.primitives){S.indices&&(S.indicesComponentType===5122||S.indicesComponentType===5123?o.indices=new Uint16Array(d.accessors[S.indices].bufferView.data):S.indicesComponentType===5125&&(o.indices=new Uint32Array(d.accessors[S.indices].bufferView.data)));let I=[];S.attributes.POSITION&&(I=new Float32Array(S.attributes.POSITION.bufferView.data));let M=[];S.attributes.NORMAL&&(M=new Float32Array(S.attributes.NORMAL.bufferView.data));let z=[];S.attributes.COLOR_0&&(z=new Float32Array(S.attributes.COLOR_0.bufferView.data));let N=[];S.attributes.TEXCOORD_0&&(N=new Float32Array(S.attributes.TEXCOORD_0.bufferView.data));let q=[];S.attributes.TANGENT&&(q=new Float32Array(S.attributes.TANGENT.bufferView.data));let X=[];if(S.attributes.BITANGENT&&(X=new Float32Array(S.attributes.BITANGENT.bufferView.data)),q.length===0||X.length===0){const{t:H,b:ce}=o._get_tangents_and_bitangents(I,N);q=H,X=ce}let D=0;for(let H=0;H<I.length;H+=3)o.vertices.push({position:[I[H]??0,I[H+1]??0,I[H+2]??0,1],normal:[M[H]??0,M[H+1]??0,M[H+2]??0,0],color:[z[H]??0,z[H+1]??0,z[H+2]??0,z[H+3]??1],uv:[N[D]??0,N[D+1]??0,0,0],tangent:[q[H]??0,q[H+1]??0,q[H+2]??0,0],bitangent:[X[H]??0,X[H+1]??0,X[H+2]??0,0]}),D+=2}o.name=n,o.vertex_buffer_offset=lt.get().add_vertex_data(s,o.vertices),o._build_index_buffer(s),V.get().store(K.MESH,oe.from(n),o),l(o)})})}}function ts(r,s){performance.mark(`${r}_start`),s(),performance.mark(`${r}_end`),performance.measure(`${r}`,`${r}_start`,`${r}_end`)}class g0{constructor(){O(this,"mesh_id",0);O(this,"material_id",0);O(this,"index_buffer_id",null);O(this,"instance_count",0);O(this,"first_index",0);O(this,"index_count",0);O(this,"base_vertex",0);O(this,"base_instance",0)}}class p0{constructor(s,n,o){this.batch_index=s,this.entity_index=n}}class m0{constructor(){O(this,"indirect_draw_buffer",null);O(this,"object_instance_buffer",null)}update_buffers(s,n,o){ts("update_indirect_buffers",()=>{if(!this.indirect_draw_buffer){const w=new Uint32Array(Math.max(n.length*5,5));n.forEach((S,I)=>{const M=I*5;w[M]=S.index_count,w[M+1]=S.instance_count,w[M+2]=S.first_index,w[M+3]=S.base_vertex,w[M+4]=S.base_instance}),this.indirect_draw_buffer=Lt.create(s,{name:"indirect_draw_buffer",raw_data:w,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})}if(!this.object_instance_buffer){const w=new Uint32Array(Math.max(o.length*2,2));o.forEach((S,I)=>{const M=I*3;w[M]=S.batch_index,w[M+1]=S.entity_index}),this.object_instance_buffer=Lt.create(s,{name:"object_instance_buffer",raw_data:w,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})}const l=n.length*5*4;this.indirect_draw_buffer.size<l&&(V.get().remove(K.BUFFER,this.indirect_draw_buffer.physical_id),this.indirect_draw_buffer=Lt.create(s,{name:"indirect_draw_buffer",data:n.map(w=>[w.index_count,w.instance_count,w.first_index,w.base_vertex,w.base_instance]),usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST}));const c=o.length*2*4;this.object_instance_buffer.size<c&&(V.get().remove(K.BUFFER,this.object_instance_buffer.physical_id),this.object_instance_buffer=Lt.create(s,{name:"object_instance_buffer",data:o.map(w=>[w.batch_index,w.entity_index]),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}));const d=new Uint32Array(n.length*5);n.forEach((w,S)=>{const I=S*5;d[I]=w.index_count,d[I+1]=w.instance_count,d[I+2]=w.first_index,d[I+3]=w.base_vertex,d[I+4]=w.base_instance}),this.indirect_draw_buffer.write(s,d);const y=new Uint32Array(o.length*2);o.forEach((w,S)=>{const I=S*3;y[I]=w.batch_index,y[I+1]=w.entity_index}),this.object_instance_buffer.write(s,y)})}}class xl{constructor(){O(this,"mesh_id",null);O(this,"entity",null);O(this,"material_id",null);O(this,"instance_count",1)}static init(s,n,o,l=null,c=1){s.mesh_id=n,s.entity=o,s.material_id=l,s.instance_count=c}}class De{constructor(){if(De.instance)return De.instance;const s=1e6;this.tasks=[],this.batches=[],this.object_instances=[],this.material_buckets=new Set,this.current_task_offset=0,this.indirect_draw_object=new m0,this.tasks_allocator=new ti(s,new xl),De.instance=this}static get(){return De.instance||(De.instance=new De),De.instance}reserve(s){this.tasks.length=s}reset(){this.tasks.length=0,this.current_task_offset=0,this.tasks_allocator.reset()}new_task(s,n,o=null,l=1){const c=this.tasks_allocator.allocate();return xl.init(c,s,n,o,l),this.current_task_offset>=this.tasks.length?this.tasks.push(c):this.tasks[this.current_task_offset++]=c,c}sort_and_batch(s){this.tasks.sort((n,o)=>n.mesh_id-o.mesh_id-(n.material_id-o.material_id)),this.batches=[],this.object_instances=[],this.tasks.forEach((n,o)=>{const l=this.batches[this.batches.length-1];if(l&&l.mesh_id===n.mesh_id&&l.material_id===n.material_id)l.instance_count+=1;else{const c=V.get().fetch(K.MESH,n.mesh_id),d=new g0;d.mesh_id=n.mesh_id,d.material_id=n.material_id,d.index_buffer_id=oe.from(c.index_buffer.config.name),d.instance_count=1,d.first_index=0,d.index_count=c.indices.length,d.base_vertex=c.vertex_buffer_offset,d.base_instance=o,this.batches.push(d)}}),this.batches.sort((n,o)=>n.material_id-o.material_id),this.material_buckets.clear(),this.batches.forEach((n,o)=>{this.material_buckets.add(n.material_id);for(let l=0;l<n.instance_count;l++){const c=new p0(o,this.tasks[n.base_instance+l].entity);this.object_instances.push(c)}}),this.indirect_draw_object.update_buffers(s,this.batches,this.object_instances)}get_object_instance_buffer(){return this.indirect_draw_object.object_instance_buffer}get_indirect_draw_buffer(){return this.indirect_draw_object.indirect_draw_buffer}get_material_buckets(){return this.material_buckets}submit_draws(s,n,o=!1){let l=null;this.tasks.forEach(c=>{const d=V.get().fetch(K.MESH,c.mesh_id),y=V.get().fetch(K.MATERIAL,c.material_id);y&&y!==l&&(y.bind(s,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[ge.Global]&&n.pass_bind_groups[ge.Global].bind(s),n.pass_bind_groups[ge.Pass]&&n.pass_bind_groups[ge.Pass].bind(s),l=y),s.pass.draw(d.vertices.length,c.instance_count,d.vertex_buffer_offset)}),o&&this.reset()}submit_indexed_draws(s,n,o=!1){let l=null;this.tasks.forEach(c=>{const d=V.get().fetch(K.MESH,c.mesh_id),y=V.get().fetch(K.MATERIAL,c.material_id);y&&y!==l&&(y.bind(s,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[ge.Global]&&n.pass_bind_groups[ge.Global].bind(s),n.pass_bind_groups[ge.Pass]&&n.pass_bind_groups[ge.Pass].bind(s),l=y),s.pass.setIndexBuffer(d.index_buffer.buffer,d.index_buffer.config.element_type),s.pass.drawIndexed(d.indices.length,c.instance_count,0,d.vertex_buffer_offset)}),o&&this.reset()}submit_indexed_indirect_draws(s,n,o=!1,l=!0){let c=null;for(let d=0;d<this.batches.length;++d){const y=this.batches[d],w=V.get().fetch(K.BUFFER,y.index_buffer_id),S=V.get().fetch(K.MATERIAL,y.material_id);!l&&S&&S!==c&&(S.bind(s,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[ge.Global]&&n.pass_bind_groups[ge.Global].bind(s),n.pass_bind_groups[ge.Pass]&&n.pass_bind_groups[ge.Pass].bind(s),c=S),s.pass.setIndexBuffer(w.buffer,w.config.element_type),s.pass.drawIndexedIndirect(this.indirect_draw_object.indirect_draw_buffer.buffer,d*20)}o&&this.reset()}submit_material_indexed_indirect_draws(s,n,o,l=!1){const c=V.get().fetch(K.MATERIAL,o);c&&(c.bind(s,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[ge.Global]&&n.pass_bind_groups[ge.Global].bind(s),n.pass_bind_groups[ge.Pass]&&n.pass_bind_groups[ge.Pass].bind(s));const d=this.batches.filter(y=>y.material_id===o);for(let y=0;y<d.length;++y){const w=d[y],S=V.get().fetch(K.BUFFER,w.index_buffer_id);s.pass.setIndexBuffer(S.buffer,S.config.element_type),s.pass.drawIndexedIndirect(this.indirect_draw_object.indirect_draw_buffer.buffer,y*20)}l&&this.reset()}draw_quad(s,n){const o=Ln.quad(s);n.pass.setIndexBuffer(o.index_buffer.buffer,o.index_buffer.config.element_type),n.pass.drawIndexed(o.indices.length,1,0,o.vertex_buffer_offset)}draw_cube(s,n){const o=Ln.cube(s);n.pass.setIndexBuffer(o.index_buffer.buffer,o.index_buffer.config.element_type),n.pass.drawIndexed(o.indices.length,1,0,o.vertex_buffer_offset)}}class Er{static initialize(){}static resize(s){this.size=s}static to_gpu_data(){}static add_entity(s,n){this.entity_set.add(s),this.entity_set.size>=this.size&&this.resize(this.entity_set.size*2),n&&this.update_entity_data(s,n)}static remove_entity(s){this.entity_set.delete(s),s===this.size-1&&this.resize(Math.max(...this.entity_set)*2)}static update_entity_data(s,n){const o=(l,c,d)=>{for(const[y,w]of Object.entries(c)){if(l[y]===void 0)throw new Error(`Invalid property ${y} for fragment ${this.constructor.name}`);typeof w=="object"&&w!==null&&!Array.isArray(w)&&!ArrayBuffer.isView(w)?o(l[y],w,d):l[y][d]=w}};o(this.data,n,s)}static get_entity_data(s){const n=(o,l)=>{const c={};for(const[d,y]of Object.entries(o))typeof y=="object"&&y!==null&&!ArrayBuffer.isView(y)?c[d]=n(y,l):ArrayBuffer.isView(y)?c[d]=y[l]:c[d]=y;return c};if(!this.entity_set.has(s))throw new Error(`Entity ${s} does not exist in fragment ${this.constructor.name}`);return n(this.data,s)}}O(Er,"data",null),O(Er,"size",0),O(Er,"entity_set",new Set);class li extends Er{static initialize(){this.data={position:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},rotation:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},scale:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},prev_world_transform:new Float32Array(16),world_transform:new Float32Array(16),inverse_world_transform:new Float32Array(16),dirty:new Uint8Array(1),gpu_buffer:null,gpu_data_dirty:!0}}static resize(s){this.data||this.initialize(),super.resize(s);const n=(o,l,c=Float32Array,d=1)=>{if(o[l].length<this.size*d){const y=o[l];o[l]=new c(this.size*d),o[l].set(y)}};["position","rotation","scale"].forEach(o=>{["x","y","z"].forEach(l=>{n(this.data[o],l)})}),n(this.data,"prev_world_transform",Float32Array,16),n(this.data,"world_transform",Float32Array,16),n(this.data,"inverse_world_transform",Float32Array,16),n(this.data,"dirty",Uint8Array)}static update_entity_data(s,n){this.data||this.initialize(),super.update_entity_data(s,n),this.data.dirty[s]=1,this.data.gpu_data_dirty=!0}static to_gpu_data(s){if(this.data||this.initialize(),!this.data.gpu_data_dirty)return{gpu_buffer:this.data.gpu_buffer};const n=new Float32Array(Math.max(this.size*32,32));for(let o=0;o<this.size;o++){const l=o*16,c=o*32;for(let d=0;d<16;d++)n[c+d]=this.data.world_transform[l+d];for(let d=0;d<16;d++)n[c+16+d]=this.data.inverse_world_transform[l+d]}return this.data.gpu_buffer&&this.data.gpu_buffer.config.size<n.byteLength&&(this.data.gpu_buffer.destroy(s),this.data.gpu_buffer=null),this.data.gpu_buffer?this.data.gpu_buffer.write(s,n):this.data.gpu_buffer=Lt.create(s,{name:"transform_fragment_buffer",usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,raw_data:n}),this.data.gpu_data_dirty=!1,{gpu_buffer:this.data.gpu_buffer}}}const y0={DIRECTIONAL:0,POINT:1,SPOT:2,AREA:3};class zl extends Er{static initialize(){this.data={position:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},direction:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},color:{r:new Float32Array(1),g:new Float32Array(1),b:new Float32Array(1)},type:new Uint8Array(1),intensity:new Float32Array(1),radius:new Float32Array(1),attenuation:new Float32Array(1),outer_angle:new Float32Array(1),dirty:new Uint8Array(1),active:new Uint8Array(1),gpu_buffer:null,gpu_data_dirty:!0}}static resize(s){this.data||this.initialize(),super.resize(s);const n=(o,l,c=Float32Array,d=1)=>{if(o[l].length<this.size*d){const y=o[l];o[l]=new c(this.size*d),o[l].set(y)}};["position","direction"].forEach(o=>{["x","y","z"].forEach(l=>{n(this.data[o],l)})}),["color"].forEach(o=>{["r","g","b"].forEach(l=>{n(this.data[o],l)})}),n(this.data,"type",Uint8Array),n(this.data,"intensity",Float32Array),n(this.data,"radius",Float32Array),n(this.data,"attenuation",Float32Array),n(this.data,"outer_angle",Float32Array),n(this.data,"dirty",Uint8Array),n(this.data,"active",Uint8Array)}static update_entity_data(s,n){this.data||this.initialize(),super.update_entity_data(s,n),this.data.dirty[s]=1,this.data.active[s]=1,this.data.gpu_data_dirty=!0}static to_gpu_data(s){if(this.data||this.initialize(),!this.data.gpu_data_dirty)return{gpu_buffer:this.data.gpu_buffer};let n=0;for(let c=0;c<this.size;c++)this.data.active[c]&&n++;const o=new Float32Array(Math.max(n*16,16));let l=0;for(let c=0;c<this.size;c++)this.data.active[c]&&(o[l]=this.data.position.x[c],o[l+1]=this.data.position.y[c],o[l+2]=this.data.position.z[c],o[l+3]=0,o[l+4]=this.data.direction.x[c],o[l+5]=this.data.direction.y[c],o[l+6]=this.data.direction.z[c],o[l+7]=0,o[l+8]=this.data.color.r[c],o[l+9]=this.data.color.g[c],o[l+10]=this.data.color.b[c],o[l+11]=this.data.type[c],o[l+12]=this.data.intensity[c],o[l+13]=this.data.radius[c],o[l+14]=this.data.attenuation[c],o[l+15]=this.data.outer_angle[c],l+=16);return this.data.gpu_buffer&&this.data.gpu_buffer.config.size<o.byteLength&&(this.data.gpu_buffer.destroy(s),this.data.gpu_buffer=null),this.data.gpu_buffer?this.data.gpu_buffer.write(s,o):this.data.gpu_buffer=Lt.create(s,{name:"light_fragment_buffer",usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,raw_data:o}),this.data.gpu_data_dirty=!1,{gpu_buffer:this.data.gpu_buffer}}}function ei(r,s){let n=s;for(const[o,l]of r)n=(n<<5)-n+Ma(o),n=(n<<5)-n+Ma(l),n|=0;return n}function Ma(r){return typeof r=="number"?r:typeof r=="string"?r.split("").reduce((s,n)=>(s<<5)-s+n.charCodeAt(0),0):typeof r=="object"&&r.config&&r.config.name?r.config.name.split("").reduce((s,n)=>(s<<5)-s+n.charCodeAt(0),0):0}const _i=class _i{constructor(s,n,o,l={},c=null){this.context=s,this.name=n,this.shader=o,this.pipeline_state_config=l,this.resources=[],this.parent=c,this.reflection=o?o.reflect():null}add_resource(s){this.resources.push(s)}static create(s,n,o,l={},c=null){if(this.templates.has(n))return this.templates.get(n);let d=null,y=null;if(c){if(d=this.get_template(c),!d)throw new Error(`Parent template '${c}' not found`);y=d.shader}o&&(y=jt.create(s,o));const w=new _i(s,n,y,l,d);d&&(w.resources=[...d.resources]);const S=w.reflection?w.reflection.getBindGroups():[];if(ge.Material<S.length){const I=S[ge.Material];for(let M=0;M<I.length;M++){const z=I[M],N=jt.resource_type_from_reflection_type(z.resourceType);this.add_resource({type:N,name:z.name,binding:M})}}return this.templates.set(n,w),w}create_pipeline_state(s,n,o=[]){var I;let l=[...n];const c=this.reflection.getBindGroups();if(ge.Material<c.length){const M=c[ge.Material];M.forEach((z,N)=>{this.add_resource({binding:N,name:z.name,type:jt.resource_type_from_reflection_type(z.resourceType)})}),l.push(Un.create_layout(s,this.name,M.map(z=>{let N={};switch(jt.resource_type_from_reflection_type(z.resourceType)){case vt.Uniform:N={buffer:{type:"uniform"}};break;case vt.Storage:N={buffer:{type:"read-only-storage"}};break;case vt.Texture:N={texture:{viewDimension:es.dimension_from_type_name(z.type.name),sampleType:z.type.name.includes("depth")?"depth":"float"}};break;case vt.Sampler:N={sampler:{}};break}return{type:z.resourceType,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,...N}}),!0))}const d=o.filter(M=>M.config.type!=="depth").map(M=>({name:M.config.name,format:M.config.format}));this.reflection.entry.fragment[0].outputs.forEach((M,z)=>{if(d[z])return;const N={format:jt.get_optimal_texture_format(M.type.name)};this.pipeline_state_config.targets&&z<this.pipeline_state_config.targets.length&&(this.pipeline_state_config.targets[z].format&&(N.format=this.pipeline_state_config.targets[z].format),this.pipeline_state_config.targets[z].blend&&(N.blend=this.pipeline_state_config.targets[z].blend)),d.push(N)});let w={label:this.name,bind_layouts:l.filter(M=>M!==null),vertex:{module:this.shader.module,entryPoint:this.pipeline_state_config.vertex&&this.pipeline_state_config.vertex.entry_point||"vs",buffers:[]},fragment:{module:this.shader.module,entryPoint:this.pipeline_state_config.fragment&&this.pipeline_state_config.fragment.entry_point||"fs",targets:d},primitive:{topology:this.pipeline_state_config.primitive_topology_type||"triangle-list",cullMode:((I=this.pipeline_state_config.rasterizer_state)==null?void 0:I.cull_mode)||"back"}};const S=o.find(M=>M.config.type==="depth");return this.pipeline_state_config.depth_stencil_target?w.depthStencil={format:this.pipeline_state_config.depth_stencil_target.format??"depth32float",depthWriteEnabled:this.pipeline_state_config.depth_stencil_target.depth_write_enabled??!0,depthCompare:this.pipeline_state_config.depth_stencil_target.depth_compare??"less"}:S&&(w.depthStencil={format:S.config.format,depthWriteEnabled:!0,depthCompare:"less"}),Ir.create_render(s,this.name,w)}static get_template(s){return this.templates.get(s)}get_all_resources(){return this.parent?[...this.parent.get_all_resources(),...this.resources]:this.resources}};O(_i,"templates",new Map);let ci=_i;const jn=class jn{constructor(s){this.template=s,this.pipeline_state=null,this.bind_group=null,this.uniform_data=new Map,this.storage_data=new Map,this.texture_data=new Map,this.sampler_data=new Map,this.state_hash=0,this._update_state_hash()}_update_state_hash(){ts("Material._update_state_hash",()=>{jn.materials.delete(this.state_hash),V.get().remove(K.MATERIAL,this.state_hash);let s=Ma(this.template.name);s=ei(this.uniform_data,s),s=ei(this.storage_data,s),s=ei(this.texture_data,s),s=ei(this.sampler_data,s),this.state_hash=s,V.get().store(K.MATERIAL,this.state_hash,this),jn.materials.set(this.state_hash,this)})}_refresh_bind_group(){const s=this.template.get_all_resources().map(n=>{switch(n.type){case vt.Uniform:return{binding:n.binding,resource:{buffer:this.uniform_data.get(n.name).buffer}};case vt.Storage:return{binding:n.binding,resource:{buffer:this.storage_data.get(n.name).buffer}};case vt.Texture:return{binding:n.binding,resource:this.texture_data.get(n.name).view};case vt.Sampler:return{binding:n.binding,resource:this.sampler_data.get(n.name)}}});this.bind_group=Un.create(this.template.context,this.template.name,this.template.pipeline_state,ge.Material,s,!0)}update_pipeline_state(s,n=[]){this.pipeline_state=this.template.create_pipeline_state(this.template.context,s.filter(o=>o!==null).map(o=>o.layout),n)}set_uniform_data(s,n){this.uniform_data.set(s,n),this._update_state_hash(),this._refresh_bind_group()}set_storage_data(s,n){this.storage_data.set(s,n),this._update_state_hash(),this._refresh_bind_group()}set_texture_data(s,n){this.texture_data.set(s,n),this._update_state_hash(),this._refresh_bind_group()}set_sampler_data(s,n){this.sampler_data.set(s,n),this._update_state_hash(),this._refresh_bind_group()}bind(s,n=[],o=[]){!this.pipeline_state&&n.length>0&&o.length>0&&(this.update_pipeline_state(n,o),n.forEach(l=>{l&&l.bind(s)})),this.pipeline_state&&s.set_pipeline(this.pipeline_state),this.bind_group&&this.bind_group.bind(s)}get_state_hash(){return this.state_hash}static create(s){const n=ci.get_template(s);if(!n)throw new Error(`Material template '${s}' not found`);return new jn(n)}static get(s){return jn.materials.get(s)}};O(jn,"materials",new Map);let hi=jn;class v0{constructor(){O(this,"initialized",!1)}setup(s,n){}draw(s,n){this.initialized||(this.setup(s,n),this.initialized=!0),De.get().sort_and_batch(s);const o=li.to_gpu_data(s),l=n.register_buffer(o.gpu_buffer.config.name),c=zl.to_gpu_data(s),d=n.register_buffer(c.gpu_buffer.config.name),y=De.get().get_object_instance_buffer(),w=n.register_buffer(y.config.name);let S=null,I=null,M=null,z=null,N=null,q=null,X=null,D=null;const H=s.get_canvas_resolution();{const ce={pipeline_shaders:{vertex:{path:"skybox.wgsl"},fragment:{path:"skybox.wgsl"}},rasterizer_state:{cull_mode:"none"},depth_write_enabled:!1},Q=gn.get().get_skybox(),ne=n.register_image(Q.config.name);S=n.create_image({name:"skybox_output",format:"bgra8unorm",width:H.width,height:H.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),n.add_pass("skybox_pass",Le.Graphics,{inputs:[ne],outputs:[S],shader_setup:ce},(ee,j,Me)=>{const Fe=ee.get_physical_pass(j.current_pass);De.get().draw_cube(j.context,Fe)})}{const ce={pipeline_shaders:{vertex:{path:"entity_prepass.wgsl"},fragment:{path:"entity_prepass.wgsl"}}};X=n.create_image({name:"main_entity_id",format:"r32uint",width:H.width,height:H.height,depth:1,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),M=n.create_image({name:"main_depth",format:"depth32float",width:H.width,height:H.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient,load_op:"load"}),n.add_pass("entity_prepass",Le.Graphics,{inputs:[l,w],outputs:[X,M],shader_setup:ce},(Q,ne,ee)=>{const j=Q.get_physical_pass(ne.current_pass);De.get().submit_indexed_indirect_draws(j,ne,!1)})}{I=n.create_image({name:"main_albedo",format:"bgra8unorm",width:H.width,height:H.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),z=n.create_image({name:"main_smra",format:"bgra8unorm",width:H.width,height:H.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),N=n.create_image({name:"main_normal",format:"rgba16float",width:H.width,height:H.height,depth:1,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),q=n.create_image({name:"main_position",format:"rgba16float",width:H.width,height:H.height,depth:1,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient});const ce=De.get().get_material_buckets();for(const Q of ce){const ne=hi.get(Q);n.add_pass(`g_buffer_${ne.template.name}_${Q}`,Le.Graphics,{inputs:[l,w],outputs:[I,z,q,N,M]},(ee,j,Me)=>{const Fe=ee.get_physical_pass(j.current_pass);j.g_buffer_data||(j.g_buffer_data={albedo:ee.get_physical_image(I),smra:ee.get_physical_image(z),position:ee.get_physical_image(q),normal:ee.get_physical_image(N),entity_id:ee.get_physical_image(X),depth:ee.get_physical_image(M)},j.g_buffer_data.albedo.config.load_op="load",j.g_buffer_data.smra.config.load_op="load",j.g_buffer_data.position.config.load_op="load",j.g_buffer_data.normal.config.load_op="load"),De.get().submit_material_indexed_indirect_draws(Fe,j,Q,!1)})}}n.add_pass("reset_mesh_task_queue",Le.GraphLocal,{},(ce,Q,ne)=>{Q.g_buffer_data.albedo.config.load_op="clear",Q.g_buffer_data.smra.config.load_op="clear",Q.g_buffer_data.position.config.load_op="clear",Q.g_buffer_data.normal.config.load_op="clear",Q.g_buffer_data.depth.config.load_op="clear",De.get().reset()});{const ce={pipeline_shaders:{vertex:{path:"deferred_lighting.wgsl"},fragment:{path:"deferred_lighting.wgsl"}}};D=n.create_image({name:"post_lighting",format:"bgra8unorm",width:H.width,height:H.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:et.Transient}),n.add_pass("lighting_pass",Le.Graphics,{inputs:[S,I,z,N,q,M,d],outputs:[D],shader_setup:ce},(Q,ne,ee)=>{const j=Q.get_physical_pass(ne.current_pass);De.get().draw_quad(ne.context,j)})}{const ce=es.create_from_texture(s.context.getCurrentTexture(),"swapchain"),Q=n.register_image(ce.config.name),ne={pipeline_shaders:{vertex:{path:"fullscreen.wgsl"},fragment:{path:"fullscreen.wgsl"}}};n.add_pass("fullscreen_present_pass",Le.Graphics|Le.Present,{inputs:[D],outputs:[Q],shader_setup:ne},(ee,j,Me)=>{const Fe=ee.get_physical_pass(j.current_pass);De.get().draw_quad(j.context,Fe)})}n.submit(s)}}class Oe{constructor(){O(this,"graphics_context",null);O(this,"render_strategy",null);O(this,"simple_shader",null);O(this,"simple_vertex_buffer",null);O(this,"render_graph",null);if(Oe.instance)return Oe.instance;Oe.instance=this}static get(){return Oe.instance?Oe.instance:new Oe}async setup(s){this.graphics_context=await Ba.create(s,{pointer_lock:!0}),this.render_graph=La.create(),this.render_strategy=new v0,this.refresh_global_shader_bindings(),this.setup_builtin_material_template()}render(){performance.mark("frame_render"),this.graphics_context.advance_frame(),this.render_graph.begin(this.graphics_context),this.render_strategy.draw(this.graphics_context,this.render_graph)}refresh_global_shader_bindings(){this.render_graph.queue_global_bind_group_write([{buffer:lt.get().buffer,offset:0,size:lt.get().size},{buffer:ct.get().buffer,offset:0,size:ct.get().size},{sampler:es.get_default_sampler(this.graphics_context)}],!0)}setup_builtin_material_template(){ci.create(Oe.get().graphics_context,"StandardMaterial","standard_material.wgsl")}}class Gt{constructor(){O(this,"simulation_layers",[]);O(this,"current_time",0);O(this,"delta_time",0);O(this,"previous_time",0);if(Gt.instance)return Gt.instance;Gt.instance=this}static get(){return Gt.instance||(Gt.instance=new Gt),Gt.instance}async register_simulation_layer(s){this.simulation_layers.push(s),await s.init()}unregister_simulation_layer(s){s.cleanup(),this.simulation_layers.splice(this.simulation_layers.indexOf(s),1)}update(){performance.mark("simulation_core_update"),this.current_time=performance.now(),this.delta_time=Math.min((this.current_time-this.previous_time)/1e3,.1),this.previous_time=this.current_time;for(const s of this.simulation_layers)s.pre_update();for(const s of this.simulation_layers)s.update(this.delta_time);for(const s of this.simulation_layers)s.post_update()}}class w0{constructor(s=[]){O(this,"input_states",[]);O(this,"action_mappings",[]);O(this,"state_mappings",[]);O(this,"range_mappings",[]);O(this,"raw_to_state_mappings",{});O(this,"action_to_state_mappings",{});O(this,"dirty_states",new Set);this.set_states(s)}num_states(){return this.input_states.length}set_states(s){this.input_states=s,this.action_mappings=new Array(this.input_states.length).fill(!1),this.state_mappings=new Array(this.input_states.length).fill(!1),this.range_mappings=new Array(this.input_states.length).fill(0),this.raw_to_state_mappings={},this.action_to_state_mappings={},this.dirty_states=new Set;for(let n=0;n<this.input_states.length;++n){const o=this.input_states[n];this.raw_to_state_mappings[o.raw_input]=n,this.action_to_state_mappings[o.mapped_name]=n}}set_state(s,n){console.assert(s<this.state_mappings.length&&s>=0,"Invalid input state index"),this.state_mappings[s]=n,n&&this.dirty_states.add(s)}set_action(s,n){console.assert(s<this.action_mappings.length&&s>=0,"Invalid input state index");const o=!this.action_mappings[s]&&n;this.action_mappings[s]=n,o&&this.dirty_states.add(s)}set_range(s,n){console.assert(s<this.range_mappings.length&&s>=0,"Invalid input state index"),n!==0&&(this.range_mappings[s]=n,this.input_states[s].range_value=n,this.dirty_states.add(s))}visit_dirty_states(s){if(typeof s=="function"){for(const n of this.dirty_states){console.assert(n<this.input_states.length&&n>=0,"Invalid dirty state index");const o=this.input_states[n];s(o)}this.dirty_states.clear()}}}const J={K_Return:0,K_Escape:1,K_Backspace:2,K_Tab:3,K_Space:4,K_Exclaim:5,K_Quotedbl:6,K_Hash:7,K_Percent:8,K_Dollar:9,K_Ampersand:10,K_Quote:11,K_Leftparen:12,K_Rightparen:13,K_Asterisk:14,K_Plus:15,K_Comma:16,K_Minus:17,K_Period:18,K_Slash:19,K_Colon:20,K_Semicolon:21,K_Less:22,K_Equals:23,K_Greater:24,K_Question:25,K_At:26,K_Leftbracket:27,K_Backslash:28,K_Rightbracket:29,K_Caret:30,K_Underscore:31,K_Backquote:32,K_0:33,K_1:34,K_2:35,K_3:36,K_4:37,K_5:38,K_6:39,K_7:40,K_8:41,K_9:42,K_a:43,K_b:44,K_c:45,K_d:46,K_e:47,K_f:48,K_g:49,K_h:50,K_i:51,K_j:52,K_k:53,K_l:54,K_m:55,K_n:56,K_o:57,K_p:58,K_q:59,K_r:60,K_s:61,K_t:62,K_u:63,K_v:64,K_w:65,K_x:66,K_y:67,K_z:68,B_mouse_left:69,B_mouse_right:70,B_mouse_middle:71,NumKeys:72},On={M_x:0,M_y:1,NumRanges:2},Qt={Action:0,State:1,Range:2};class Ea{constructor(s,n,o,l){this.mapped_name=s,this.raw_input=n,this.raw_range=o,this.input_type=l,this.range_value=0}}const Ar=class Ar{constructor(){O(this,"key_map",new Map);O(this,"ranges_array",new Array(On.NumRanges).fill(0));O(this,"mouse_x",0);O(this,"mouse_y",0);this.handle_key_down=this.handle_key_down.bind(this),this.handle_key_up=this.handle_key_up.bind(this),this.handle_mouse_down=this.handle_mouse_down.bind(this),this.handle_mouse_up=this.handle_mouse_up.bind(this),this.handle_mouse_move=this.handle_mouse_move.bind(this)}init(){window.addEventListener("keydown",this.handle_key_down),window.addEventListener("keyup",this.handle_key_up),window.addEventListener("mousedown",this.handle_mouse_down),window.addEventListener("mouseup",this.handle_mouse_up),window.addEventListener("mousemove",this.handle_mouse_move)}shutdown(){window.removeEventListener("keydown",this.handle_key_down),window.removeEventListener("keyup",this.handle_key_up),window.removeEventListener("mousedown",this.handle_mouse_down),window.removeEventListener("mouseup",this.handle_mouse_up),window.removeEventListener("mousemove",this.handle_mouse_move)}handle_key_down(s){const n=this.browser_key_to_input_key(s.code);n!==void 0&&this.key_map.set(n,!0)}handle_key_up(s){const n=this.browser_key_to_input_key(s.code);n!==void 0&&this.key_map.set(n,!1)}handle_mouse_down(s){const n=this.browser_button_to_input_key(s.button);n!==void 0&&this.key_map.set(n,!0)}handle_mouse_up(s){const n=this.browser_button_to_input_key(s.button);n!==void 0&&this.key_map.set(n,!1)}handle_mouse_move(s){this.mouse_x=s.movementX,this.mouse_y=s.movementY}update(s,n,o){this.ranges_array[On.M_x]=this.mouse_x/o.width,this.ranges_array[On.M_y]=this.mouse_y/o.height,this.mouse_x*=Math.exp(-.5*.5),this.mouse_y*=Math.exp(-.5*.5);for(let l=0;l<s.input_states.length;++l){const c=s.input_states[l];switch(c.input_type){case Qt.State:case Qt.Action:{const d=this.key_map.get(c.raw_input)||!1;c.input_type===Qt.State?s.set_state(l,d):s.set_action(l,d);break}case Qt.Range:{const d=this.ranges_array[c.raw_range];s.set_range(l,d);break}}}}browser_key_to_input_key(s){return Ar.key_mapping[s]}browser_button_to_input_key(s){return Ar.button_mapping[s]}};O(Ar,"key_mapping",{Enter:J.K_Return,Escape:J.K_Escape,Backspace:J.K_Backspace,Tab:J.K_Tab,Space:J.K_Space,Pause:J.K_Pause,Quote:J.K_Quote,Comma:J.K_Comma,Minus:J.K_Minus,Period:J.K_Period,Slash:J.K_Slash,Digit0:J.K_0,Digit1:J.K_1,Digit2:J.K_2,Digit3:J.K_3,Digit4:J.K_4,Digit5:J.K_5,Digit6:J.K_6,Digit7:J.K_7,Digit8:J.K_8,Digit9:J.K_9,Semicolon:J.K_Semicolon,Equal:J.K_Equals,BracketLeft:J.K_LeftBracket,Backslash:J.K_Backslash,BracketRight:J.K_RightBracket,Backquote:J.K_Backquote,KeyA:J.K_a,KeyB:J.K_b,KeyC:J.K_c,KeyD:J.K_d,KeyE:J.K_e,KeyF:J.K_f,KeyG:J.K_g,KeyH:J.K_h,KeyI:J.K_i,KeyJ:J.K_j,KeyK:J.K_k,KeyL:J.K_l,KeyM:J.K_m,KeyN:J.K_n,KeyO:J.K_o,KeyP:J.K_p,KeyQ:J.K_q,KeyR:J.K_r,KeyS:J.K_s,KeyT:J.K_t,KeyU:J.K_u,KeyV:J.K_v,KeyW:J.K_w,KeyX:J.K_x,KeyY:J.K_y,KeyZ:J.K_z}),O(Ar,"button_mapping",{0:J.B_mouse_left,1:J.B_mouse_middle,2:J.B_mouse_right});let Ra=Ar;class b0{constructor(s,n){this.entity_manager=s,this.fragment_requirements=n,this.matching_entities=new Set,this.update_matching_entities()}update_matching_entities(){this.matching_entities.clear();for(let s=0;s<this.entity_manager.get_entity_count();s++)this.fragment_requirements.every(n=>{var o;return(o=this.entity_manager.entity_fragments.get(s))==null?void 0:o.has(n)})&&this.matching_entities.add(s)}get_entity_count(){return this.matching_entities.size}*[Symbol.iterator](){for(const s of this.matching_entities)yield s}}class Ft{constructor(){O(this,"next_entity_id",0);O(this,"entity_fragments",new Map);O(this,"fragment_types",new Set);O(this,"queries",new Set);O(this,"deleted_entities",new Set);if(Ft.instance)return Ft.instance;Ft.instance=this}static get(){return Ft.instance?Ft.instance:new Ft}create_entity(s=!0){let n;if(this.deleted_entities.size>0)n=this.deleted_entities.values().next().value,this.deleted_entities.delete(n);else if(n=this.next_entity_id++,s)for(const o of this.fragment_types)o.resize(n);return this.entity_fragments.set(n,new Set),s&&this.update_queries(),n}delete_entity(s,n=!0){if(this.entity_fragments.has(s)){for(const o of this.entity_fragments.get(s))o.remove_entity(s);this.entity_fragments.delete(s),this.deleted_entities.add(s),n&&this.update_queries()}}add_fragment(s,n,o,l=!0){this.fragment_types.has(n)||(n.initialize(),this.fragment_types.add(n)),n.add_entity(s,o),this.entity_fragments.get(s).add(n),l&&this.update_queries()}remove_fragment(s,n,o=!0){!this.entity_fragments.has(s)||!this.entity_fragments.get(s).has(n)||(n.remove_entity(s),this.entity_fragments.get(s).delete(n),o&&this.update_queries())}update_fragment(s,n,o){if(!this.entity_fragments.has(s)||!this.entity_fragments.get(s).has(n))throw new Error(`Entity ${s} does not have fragment ${n.constructor.name}`);n.update_entity_data(s,o)}get_fragment(s,n){return!this.entity_fragments.has(s)||!this.entity_fragments.get(s).has(n)?null:n.get_entity_data(s)}get_fragment_array(s){return s.data}get_entity_count(){return this.next_entity_id-this.deleted_entities.size}create_query({fragment_requirements:s}){const n=new b0(this,s);return this.queries.add(n),n}update_queries(){for(const s of this.queries)s.update_matching_entities()}}class x0{constructor(){O(this,"current_view",null);O(this,"entity_manager",Ft.get())}}class ns{constructor(){O(this,"layers",[]);O(this,"context",new x0);this.name="SimulationLayer"}init(s){}pre_update(s){for(const n of this.layers)n.pre_update(this.context)}update(s,n){for(const o of this.layers)o.update(s,this.context)}post_update(s){for(const n of this.layers)n.post_update(this.context)}add_layer(s){let n=this.get_layer(s);if(n)return n;const o=new s;return o.init(this.context),this.layers.push(o),o}remove_layer(s){const n=this.get_layer(s);n&&this.layers.splice(this.layers.indexOf(n),1)}get_layer(s){return this.layers.find(n=>n.constructor.name===s.constructor.name)}}const ut=class ut extends ns{constructor(){if(ut.instance)return ut.instance;super();O(this,"contexts",[]);O(this,"current_dirty_states",[]);O(this,"b_initialized",!1);O(this,"processor",null);ut.instance=this}static get(){return ut.instance?ut.instance:new ut}static default_context(){if(!ut.default_context_instance&&(ut.default_context_instance=new w0,ut.default_context_instance.num_states()===0)){const n=[];for(let o=0;o<J.NumKeys;++o)n.push(new Ea("",o,On.NumRanges,Qt.State)),n.push(new Ea("",o,On.NumRanges,Qt.Action));for(let o=0;o<On.NumRanges;++o)n.push(new Ea("",J.NumKeys,o,Qt.Range));ut.default_context_instance.set_states(n)}return ut.default_context_instance}init(){this.b_initialized||(this.b_initialized=!0,this.processor=new Ra,this.processor.init())}update(n){if(super.update(n),performance.mark("input provider update"),this.contexts.length>0){const o=this.contexts[this.contexts.length-1];this.processor.update(o,n,Oe.get().graphics_context.canvas),this.current_dirty_states=[],o.visit_dirty_states(l=>{this.current_dirty_states.push(l)})}}push_context(n){this.contexts.push(n)}pop_context(){return this.contexts.length>0?this.contexts.pop():null}get_state(n){return this.current_dirty_states.some(o=>(typeof n=="number"?o.raw_input===n:o.mapped_name===n)&&o.input_type===Qt.State)}get_action(n){return this.current_dirty_states.some(o=>(typeof n=="number"?o.raw_input===n:o.mapped_name===n)&&o.input_type===Qt.Action)}get_range(n){const o=this.current_dirty_states.find(l=>(typeof n=="number"?l.raw_range===n:l.mapped_name===n)&&l.input_type===Qt.Range);return o?o.range_value:0}};O(ut,"default_context_instance",null);let Rt=ut;function k0(r){return r*(Math.PI/180)}class T0 extends ns{constructor(){super(),this.move_speed=10,this.rotation_speed=1,this.orbit_distance=10}init(s){super.init(s);const n=en(0,0,-2,1),o=Xm(0,0,0,1);ct.get().set_view_data(Oe.get().graphics_context,s.current_view,{position:n,rotation:o,aspect_ratio:Oe.get().graphics_context.aspect_ratio,fov:k0(75)})}update(s,n){super.update(s,n);const o=ct.get().get_view_data(n.current_view);let l=Ua(o.position),c=Rl(o.rotation),d=!1;if(Rt.get().get_state(J.K_w)){const I=kr(Ye(),o.view_forward??ii,this.move_speed*s);xr(l,l,I),d=!0}if(Rt.get().get_state(J.K_s)){const I=kr(Ye(),o.view_forward??ii,-this.move_speed*s);xr(l,l,I),d=!0}if(Rt.get().get_state(J.K_a)){const I=kr(Ye(),o.view_right??WORLD_RIGHT,-this.move_speed*s);xr(l,l,I),d=!0}if(Rt.get().get_state(J.K_d)){const I=kr(Ye(),o.view_right??WORLD_RIGHT,this.move_speed*s);xr(l,l,I),d=!0}if(Rt.get().get_state(J.K_q)){const I=kr(Ye(),ui,this.move_speed*s);xr(l,l,I),d=!0}if(Rt.get().get_state(J.K_e)){const I=kr(Ye(),ui,-this.move_speed*s);xr(l,l,I),d=!0}const y=Rt.get().get_range(On.M_x),w=Rt.get().get_range(On.M_y);if(y||w){const M=Nm(wt(),l,o.view_forward??ii,10),z=Sa(Pn(),[1,0,0],w*this.rotation_speed),N=Sa(Pn(),[0,1,0],y*this.rotation_speed),q=ml(Pn(),N,z);ml(c,q,c);const X=Gm(wt(),l,M);Dm(X,X,q),Qn(l,M,X),d=!0}const S=Oe.get().graphics_context;d&&ct.get().set_view_data(S,n.current_view,{position:l,rotation:c}),ct.get().update_transforms(S,n.current_view)}}class jr extends Er{static initialize(){this.data={mesh:new BigInt64Array(1),material_slots:new BigInt64Array(this.material_slot_stride)}}static update_entity_data(s,n){if(this.data||this.initialize(),super.update_entity_data(s,n),!Array.isArray(n.material_slots))throw new Error(`Material slots must be an array for entity ${s} in fragment ${this.constructor.name}`);if(n.material_slots.length>this.material_slot_stride)throw new Error(`Material slots must be less than ${this.material_slot_stride} for entity ${s} in fragment ${this.constructor.name}`);for(let o=0;o<n.material_slots.length;o++)this.data.material_slots[s*this.material_slot_stride+o]=BigInt(n.material_slots[o])}static resize(s){super.resize(s);const n=(o,l,c,d)=>{if(o[l].length<this.size*c){const y=o[l];o[l]=new d(this.size*c),o[l].set(y)}};["mesh"].forEach(o=>{n(this.data,o,1,BigInt64Array)}),["material_slots"].forEach(o=>{n(this.data,o,this.material_slot_stride,BigInt64Array)})}}O(jr,"material_slot_stride",64);class A0 extends ns{constructor(){super();O(this,"entity_query",null)}init(n){this.entity_query=Ft.get().create_query({fragment_requirements:[jr]})}update(n,o){ts("static_mesh_processor_update",()=>{const l=Ft.get().get_fragment_array(jr),c=V.get(),d=De.get();let y=null;d.reserve(this.entity_query.get_entity_count());for(const w of this.entity_query){const S=Number(l.mesh[w]),I=Number(l.material_slots[w*jr.material_slot_stride]);S!==y&&(c.fetch(K.MESH,S),y=S),d.new_task(S,w,I)}})}}class E0 extends ns{constructor(){super();O(this,"entity_query",null)}init(n){this.entity_query=Ft.get().create_query({fragment_requirements:[li]})}update(n,o){ts("transform_processor_update",()=>{const l=Ft.get().get_fragment_array(li);for(const c of this.entity_query){if(l.dirty[c]===0)continue;l.prev_world_transform.set(l.world_transform.subarray(c*16,c*16+16),c*16);const d=Bm(Bt(),Vm(Pn(),l.rotation.x[c],l.rotation.y[c],l.rotation.z[c]),en(l.position.x[c],l.position.y[c],l.position.z[c],1),en(l.scale.x[c],l.scale.y[c],l.scale.z[c],0));l.world_transform.set(d,c*16),l.inverse_world_transform.set(Al(Bt(),d),c*16),l.dirty[c]=0}})}}class I0 extends ns{constructor(n){super();O(this,"name","");O(this,"sphere_mesh",null);this.name=n}async init(n){super.init(this.context),this.context.current_view=ct.get().add_view_data(Oe.get().graphics_context),this.setup_default_subsystems()}update(n,o){super.update(n,this.context),performance.mark("scene_update")}setup_default_subsystems(){this.add_layer(T0),this.add_layer(A0),this.add_layer(E0)}create_entity(n=!0){return this.context.entity_manager.create_entity(n)}delete_entity(n,o=!0){this.context.entity_manager.delete_entity(n,o)}add_fragment(n,o,l,c=!0){this.context.entity_manager.add_fragment(n,o,l,c)}remove_fragment(n,o,l=!0){this.context.entity_manager.remove_fragment(n,o,l)}update_fragment(n,o,l,c=!0){this.context.entity_manager.update_fragment(n,o,l,c)}get_fragment(n,o){return this.context.entity_manager.get_fragment(n,o)}refresh_entity_queries(){this.context.entity_manager.update_queries()}}const Dl={is_running:!1};async function S0(){Dl.is_running=!0;const r=Rt.get();await Gt.get().register_simulation_layer(r),r.push_context(Rt.default_context());const s=document.getElementById("gpu-canvas");await Oe.get().setup(s);{const n=new I0("TestScene");await Gt.get().register_simulation_layer(n),await gn.get().add_skybox(Oe.get().graphics_context,"test_scene_skybox",["engine/textures/spacebox/px.png","engine/textures/spacebox/nx.png","engine/textures/spacebox/ny.png","engine/textures/spacebox/py.png","engine/textures/spacebox/pz.png","engine/textures/spacebox/nz.png"]);const o=n.create_entity();n.add_fragment(o,zl,{type:y0.DIRECTIONAL,color:{r:1,g:1,b:1},intensity:3,position:{x:50,y:100,z:50}});const l=await Ln.from_gltf(Oe.get().graphics_context,"engine/models/monkey/monkey.gltf"),d=hi.create("StandardMaterial").get_state_hash(),y=100,w=2;for(let S=0;S<y;S++)for(let I=0;I<y;I++){const M=n.create_entity(!1);n.add_fragment(M,jr,{mesh:BigInt(oe.from(l.name)),material_slots:[d]},!1),n.add_fragment(M,li,{position:{x:(S-Math.floor(y/2))*w,y:0,z:(I-Math.floor(y/2))*w},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},!1)}n.refresh_entity_queries()}}function C0(){function r(){Dl.is_running&&(ts("frame_loop",()=>{Gt.get().update(),Oe.get().render()}),requestAnimationFrame(r))}requestAnimationFrame(r)}(async()=>(await S0(),C0()))();
