var fm=Object.defineProperty;var dm=(s,i,n)=>i in s?fm(s,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[i]=n;var P=(s,i,n)=>dm(s,typeof i!="symbol"?i+"":i,n);(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const f of c.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&a(f)}).observe(document,{childList:!0,subtree:!0});function n(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerPolicy&&(c.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?c.credentials="include":l.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(l){if(l.ep)return;l.ep=!0;const c=n(l);fetch(l.href,c)}})();const pm=2;class Fa{constructor(){P(this,"canvas",null);P(this,"adapter",null);P(this,"device",null);P(this,"context",null);P(this,"canvas_format",null);P(this,"frame_number",0);P(this,"aspect_ratio",1)}async init(i,n={}){if(!navigator.gpu)throw Error("WebGPU is not supported");if(this.canvas=i,this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.adapter=await navigator.gpu.requestAdapter(),!this.adapter)throw Error("Unable to request WebGPU adapter");try{this.device=await this.adapter.requestDevice({requiredLimits:{maxColorAttachmentBytesPerSample:64}})}catch(a){console.log(a),console.log("Falling back to default limits"),this.device=await this.adapter.requestDevice()}this.context=this.canvas.getContext("webgpu"),this.canvas_format=navigator.gpu.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.canvas_format,alphaMode:"premultiplied"}),this.aspect_ratio=this.canvas.width/this.canvas.height,n.pointer_lock&&this.canvas.addEventListener("click",async()=>{await this.canvas.requestPointerLock()})}advance_frame(){this.frame_number++}get_frame_number(){return this.frame_number}get_buffered_frame_number(){return this.frame_number%pm}get_canvas_resolution(){return{width:this.canvas.width,height:this.canvas.height}}draw_pass(i,n,a=1){i.pass.draw(n,a)}max_bind_groups(){return this.adapter.limits.maxBindGroups}static async create(i,n={}){let a=new Fa;return await a.init(i,n),a}}class gm{constructor(){this.executions=[],this.execution_delays=[]}push_execution(i,n=0){this.executions.push(i),this.execution_delays.push(n)}remove_execution(i){const n=this.executions.indexOf(i);n!==-1&&(this.executions.splice(n,1),this.execution_delays.splice(n,1))}update(){for(let i=this.executions.length-1;i>=0;--i)--this.execution_delays[i]<0&&(this.executions[i](),this.executions.splice(i,1),this.execution_delays.splice(i,1))}flush(){for(let i=this.executions.length-1;i>=0;--i)this.executions[i]();this.executions=[],this.execution_delays=[]}}class ni{constructor(i,n){this.max_objects=i,this.buffer=new Array(i).fill(null).map(()=>({...n})),this.offset=0}allocate(){if(this.offset>=this.max_objects)throw new Error("Out of memory on frame allocator");const i=this.offset;return this.offset++,this.buffer[i]}get(i){if(i<0||i>=this.offset)throw new Error("Invalid allocator index");return this.buffer[i]}reset(){this.offset=0}[Symbol.iterator](){let i=0;return{next:()=>i<this.offset?{value:this.buffer[i++],done:!1}:{done:!0}}}}const W=Object.freeze({SHADER:0,PIPELINE_STATE:1,RENDER_PASS:2,BIND_GROUP:3,BIND_GROUP_LAYOUT:4,BUFFER:5,IMAGE:6,SAMPLER:7,MESH:8,MATERIAL:9});class ${constructor(){if($.instance)return $.instance;$.instance=this,this.cache=new Map,this.cache.set(W.SHADER,new Map),this.cache.set(W.PIPELINE_STATE,new Map),this.cache.set(W.PASS,new Map),this.cache.set(W.BIND_GROUP,new Map),this.cache.set(W.BIND_GROUP_LAYOUT,new Map),this.cache.set(W.BUFFER,new Map),this.cache.set(W.IMAGE,new Map),this.cache.set(W.SAMPLER,new Map),this.cache.set(W.MESH,new Map),this.cache.set(W.MATERIAL,new Map)}static get(){return $.instance||($.instance=new $),$.instance}fetch(i,n){return this.cache.get(i).get(n)}store(i,n,a){this.cache.get(i).set(n,a)}remove(i,n){this.cache.get(i).delete(n)}size(i){return this.cache.get(i).size}}const At=class At{constructor(i){At.string_to_hash.has(i)?this.hash=At.string_to_hash.get(i):(this.hash=At.fnv1a_hash(i),At.string_to_hash.set(i,this.hash),At.hash_to_string.set(this.hash,i))}static fnv1a_hash(i){let n=2166136261;for(let a=0;a<i.length;a++)n^=i.charCodeAt(a),n*=16777619;return n}static string(i){return At.hash_to_string.get(i)}static hash(i){return At.string_to_hash.get(i)}static from(i){return new At(i),At.hash(i)}};P(At,"string_to_hash",new Map),P(At,"hash_to_string",new Map);let ae=At;const pe={Global:0,Pass:1,Material:2,Num:3};class mm{constructor(i){this.total_bindings_count=i,this.free_indices=Array.from({length:i},(n,a)=>a),this.bound_indices=[]}}class _l{constructor(){this.binding_table=new Map}has_binding_slot(i){return this.binding_table.has(i)}add_binding_slot(i,n){this.has_binding_slot(i)||this.binding_table.set(i,new mm(n))}get_new(i){if(!this.has_binding_slot(i))throw new Error(`Binding slot ${i} does not exist`);const n=this.binding_table.get(i);if(n.free_indices.length===0)throw new Error(`No free indices available for binding slot ${i}`);const a=n.free_indices.pop();return n.bound_indices.push(a),{slot:i,index:a}}free(i){const{slot:n,index:a}=i;if(!this.has_binding_slot(n))throw new Error(`Binding slot ${n} does not exist`);const l=this.binding_table.get(n),c=l.bound_indices.indexOf(a);if(c===-1)throw new Error(`Index ${a} is not bound for slot ${n}`);l.bound_indices.splice(c,1),l.free_indices.push(a)}reset(i){if(!this.has_binding_slot(i))throw new Error(`Binding slot ${i} does not exist`);const n=this.binding_table.get(i);n.free_indices=Array.from({length:n.total_bindings_count},(a,l)=>l),n.bound_indices=[]}}class qn{constructor(){P(this,"index",0);P(this,"name","");P(this,"bind_group",null);P(this,"layout",null);P(this,"binding_table",null)}init(i,n,a,l,c){this.name=n,this.index=l,this.layout=a.pipeline.getBindGroupLayout(l),this.bind_group=i.device.createBindGroup({label:n,layout:this.layout,entries:c}),this.binding_table=new _l}init_with_layout(i,n,a,l,c){this.name=n,this.index=l,this.layout=qn.create_layout(i,n,a),this.bind_group=i.device.createBindGroup({label:n,layout:this.layout,entries:c}),this.binding_table=new _l}destroy(){this.bind_group&&($.get().remove(W.BIND_GROUP,ae.from(this.name)),this.bind_group=null,this.layout=null,this.binding_table=null)}bind(i){i.pass.setBindGroup(this.index,this.bind_group)}static create(i,n,a,l,c,f=!1){let g=$.get().fetch(W.BIND_GROUP,ae.from(n));return g&&f&&(g.destroy(),g=null),g||(g=new qn,g.init(i,n,a,l,c),$.get().store(W.BIND_GROUP,ae.from(n),g)),g}static create_with_layout(i,n,a,l,c,f=!1){let g=$.get().fetch(W.BIND_GROUP,ae.from(n));return g&&f&&(g.destroy(),g=null),g||(g=new qn,g.init_with_layout(i,n,a,l,c),$.get().store(W.BIND_GROUP,ae.from(n),g)),g}static create_layout(i,n,a,l=!1){let c=$.get().fetch(W.BIND_GROUP_LAYOUT,ae.from(n));return c&&l&&(c.destroy(),c=null),c||(c=i.device.createBindGroupLayout({label:n,entries:a}),$.get().store(W.BIND_GROUP_LAYOUT,ae.from(n),c)),c}}const Ee=Object.freeze({None:0,Graphics:1,Present:2,Compute:4,GraphLocal:8});class Pa{constructor(){P(this,"pass",null);P(this,"config",null)}init(i){this.config=i}begin(i,n){if(this.config.flags&Ee.Graphics){const a=this.config.attachments.map(c=>{const f=$.get().fetch(W.IMAGE,c.image);return{view:f.get_view(c.view_index)||f.view,clearValue:f.config.clear_value??{r:0,g:0,b:0,a:1},loadOp:f.config.load_op??"clear",storeOp:f.config.store_op??"store"}}),l={label:this.config.name,colorAttachments:a};if(this.config.depth_stencil_attachment){const c=$.get().fetch(W.IMAGE,this.config.depth_stencil_attachment.image);l.depthStencilAttachment={view:c.get_view(this.config.depth_stencil_attachment.view_index)||c.view,depthClearValue:c.config.clear_value??0,depthLoadOp:c.config.load_op??"load",depthStoreOp:c.config.store_op??"store"}}this.pass=i.beginRenderPass(l)}else this.config.flags&Ee.Compute&&(this.pass=i.beginComputePass({label:this.config.name}));this.config.viewport&&this.pass.setViewport(this.config.viewport),this.config.scissor_rect&&this.pass.setScissorRect(this.config.scissor_rect),this.config.vertex_buffer&&this.pass.setVertexBuffer(this.config.vertex_buffer),this.config.index_buffer&&this.pass.setIndexBuffer(this.config.index_buffer),n&&this.set_pipeline(n)}set_pipeline(i){this.pass.setPipeline(i.pipeline)}set_attachments(i){this.config.attachments=i}set_depth_stencil_attachment(i){this.config.depth_stencil_attachment=i}dispatch(i,n,a){this.config.flags&Ee.Compute&&this.pass.dispatchWorkgroups(i,n,a)}end(){this.pass&&this.pass.end()}static create(i){let n=$.get().fetch(W.PASS,ae.from(i.name));return n||(n=new Pa,n.init(i),$.get().store(W.PASS,ae.from(i.name),n)),n}}class Bs{constructor(){P(this,"pipeline",null);P(this,"layout",null)}init_render_pipeline(i,n,a){a.bind_layouts&&a.bind_layouts.length&&(this.layout=i.device.createPipelineLayout({label:ae.string(n),bindGroupLayouts:a.bind_layouts})),this.pipeline=i.device.createRenderPipeline({label:ae.string(n),layout:this.layout??"auto",...a})}init_compute_pipeline(i,n,a){a.bind_layouts&&a.bind_layouts.length&&(this.layout=i.device.createPipelineLayout({label:ae.string(n),bindGroupLayouts:a.bind_layouts})),this.pipeline=i.device.createComputePipeline({label:ae.string(n),layout:this.layout??"auto",...a})}static create_render(i,n,a){let l=ae.from(n),c=$.get().fetch(W.PIPELINE_STATE,l);return c||(c=new Bs,c.init_render_pipeline(i,l,a),$.get().store(W.PIPELINE_STATE,l,c)),c}static create_compute(i,n,a){let l=ae.from(n),c=$.get().fetch(W.PIPELINE_STATE,l);return c||(c=new Bs,c.init_compute_pipeline(i,l,a),$.get().store(W.PIPELINE_STATE,l,c)),c}}class fl{constructor(){P(this,"queue",null)}static create_encoder(i,n){return i.device.createCommandEncoder({label:n})}static submit(i,n){const a=n.finish();i.device.queue.submit([a])}}const El=Object.freeze({None:0,Transient:1});class qt{constructor(){P(this,"config",null);P(this,"buffer",null)}init(i,n){this.config=n;let a=null;if(n.raw_data)a=n.raw_data;else{const l=n.data.flat();a=new Float32Array(l.length),a.set(l)}this.config.size=this.config.size||a.byteLength,this.buffer=i.device.createBuffer({label:this.config.name,size:this.config.size,usage:this.config.usage}),this.write(i,a)}destroy(i){this.buffer&&(this.buffer=null,$.get().remove(W.BUFFER,ae.from(this.config.name)))}write(i,n,a=0,l=null){const c=ArrayBuffer.isView(n),f=c?n:n.flat(),g=c?f:new Float32Array(f.length);g.set(f),i.device.queue.writeBuffer(this.buffer,a,g,0,l??g.length)}write_raw(i,n,a=0,l=null){i.device.queue.writeBuffer(this.buffer,a,n,0,l??n.length)}read(i,n,a,l=0,c=0){const f=new Float32Array(this.buffer.getMappedRange());n.set(f.subarray(l,l+a),c),this.buffer.unmap()}bind_vertex(i,n=0){i.setVertexBuffer(n,this.buffer)}get physical_id(){return ae.from(this.config.name)}static create(i,n){let a=$.get().fetch(W.BUFFER,ae.from(n.name));return a||(a=new qt,a.init(i,n),$.get().store(W.BUFFER,ae.from(n.name),a)),a}}const lt=Object.freeze({None:0,Transient:1,LocalLoad:2});class ym{constructor(){P(this,"name",null);P(this,"width",0);P(this,"height",0);P(this,"depth",0);P(this,"mip_levels",1);P(this,"format","rgba8unorm");P(this,"usage",GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.SAMPLED);P(this,"sample_count",1);P(this,"dimension","2d");P(this,"b_is_bindless",!1);P(this,"flags",lt.None);P(this,"clear_value",{r:0,g:0,b:0,a:1});P(this,"load_op","clear");P(this,"store_op","store");P(this,"b_one_view_per_mip",!1);P(this,"b_one_view_per_layer",!1)}}let Fs=class sr{constructor(){P(this,"config",new ym);P(this,"image",null);P(this,"views",[]);P(this,"current_view",0)}init(i,n){this.config={...this.config,...n},this.config.type=n.format.includes("depth")?"depth":"color",this.config.type==="depth"&&(this.config.clear_value=1,this.config.load_op="clear"),this.image=i.device.createTexture({label:n.name,size:{width:n.width,height:n.height,depthOrArrayLayers:n.depth},mipLevelCount:n.mip_levels,sampleCount:n.sample_count,dimension:n.dimension,format:n.format,usage:n.usage}),this._setup_views()}async load(i,n,a){this.config={...this.config,...a},this.config.type=a.format.includes("depth")?"depth":"color",this.config.type==="depth"&&(this.config.clear_value=1,this.config.load_op="clear");async function l(f){const g=await new Promise((b,C)=>{const S=new Image;S.onload=()=>b(S),S.onerror=C,S.src=f});return await createImageBitmap(g,{colorSpaceConversion:"none"})}const c=await Promise.all(n.map(l));this.config.width=c[0].width,this.config.height=c[0].height,this.config.depth=c.length,this.image=i.device.createTexture({label:this.config.name,size:{width:this.config.width,height:this.config.height,depthOrArrayLayers:this.config.depth},mipLevelCount:a.mip_levels,sampleCount:a.sample_count,format:a.format,usage:a.usage}),c.forEach((f,g)=>{i.device.queue.copyExternalImageToTexture({source:f,flipY:!0},{texture:this.image,origin:{x:0,y:0,z:g}},[f.width,f.height])}),this._setup_views()}set_image(i){this.image=i,this.config.width=i.width,this.config.height=i.height,this.config.depth=i.depthOrArrayLayers,this.config.mip_levels=i.mipLevelCount,this.config.sample_count=i.sampleCount,this.config.usage=i.usage,this.config.format=i.format,this.config.dimension=i.dimension,this.config.type=this.config.format.includes("depth")?"depth":"color",this.config.type==="depth"?(this.config.clear_value=1,this.config.load_op="clear"):(this.config.clear_value={r:0,g:0,b:0,a:1},this.config.load_op="clear"),this._setup_views()}create_view(i={}){const n={label:i.label??this.config.name,format:this.config.format,dimension:i.dimension??this.config.dimension,aspect:i.aspect??"all",baseMipLevel:i.base_mip_level??0,baseArrayLayer:i.base_array_layer??0,arrayLayerCount:i.array_layers??this.config.depth};return i.mip_levels&&(n.mipLevelCount=i.mip_levels),this.image.createView(n)}set_current_view(i){this.current_view=i}get_view(i){return this.views[i]}copy_buffer(i,n){i.copyBufferToImage({buffer:n.buffer},{texture:this.image},{width:this.config.width,height:this.config.height,depthOrArrayLayers:this.config.depth})}copy_texture(i,n){i.copyTextureToTexture({texture:n.image},{texture:this.image},{width:n.config.width,height:n.config.height,depthOrArrayLayers:this.config.depth})}get physical_id(){return ae.from(this.config.name)}get view(){return this.views[this.current_view]}_setup_views(i={}){if(this.views=[],this.current_view=0,!this.config.b_one_view_per_layer&&!this.config.b_one_view_per_mip&&this.views.push(this.create_view(i)),this.config.b_one_view_per_layer)for(let n=0;n<this.config.depth;n++){const a={...i,label:`${this.config.name}_layer_${n}`,base_array_layer:n,array_layers:1};this.views.push(this.create_view(a))}if(this.config.b_one_view_per_mip)for(let n=0;n<this.config.mip_levels;n++){const a={...i,label:`${this.config.name}_mip_${n}`,base_mip_level:n,mip_levels:1};this.views.push(this.create_view(a))}}static get_default_sampler(i){let n=$.get().fetch(W.SAMPLER,ae.from("default_sampler"));return n||(n=i.device.createSampler({magFilter:"linear",minFilter:"linear",mipmapFilter:"linear"}),$.get().store(W.SAMPLER,ae.from("default_sampler"),n),n)}static create(i,n){let a=$.get().fetch(W.IMAGE,ae.from(n.name));return a||(a=new sr,a.init(i,n),$.get().store(W.IMAGE,ae.from(n.name),a),a)}static create_from_texture(i,n){let a=$.get().fetch(W.IMAGE,ae.from(n));return a?(a.set_image(i),a):(a=new sr,a.config={name:n},$.get().store(W.IMAGE,ae.from(n),a),a.set_image(i),a)}static async load(i,n,a){let l=$.get().fetch(W.IMAGE,ae.from(a.name));return l||(l=new sr,await l.load(i,n,a),$.get().store(W.IMAGE,ae.from(a.name),l),l)}static dimension_from_type_name(i){switch(i){case"texture_2d":case"texture_2d_depth":return"2d";case"texture_cube":return"cube";case"texture_3d":return"3d";case"texture_array":return"2d_array";case"texture_cube_array":return"cube_array";default:return"2d"}}};var ei=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function vm(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var is={};(function(s){Object.defineProperty(s,"__esModule",{value:!0});class i{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class n{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(o){throw new Error("Cannot evaluate node")}evaluateString(o){return this.evaluate(o).toString()}search(o){}searchBlock(o,h){if(o){h(a.instance);for(const y of o)y instanceof Array?this.searchBlock(y,h):y.search(h);h(l.instance)}}}class a extends n{}a.instance=new a;class l extends n{}l.instance=new l;class c extends n{constructor(){super()}}class f extends c{constructor(o,h,y,w,I,O){super(),this.calls=new Set,this.name=o,this.args=h,this.returnType=y,this.body=w,this.startLine=I,this.endLine=O}get astNodeType(){return"function"}search(o){this.searchBlock(this.body,o)}}class g extends c{constructor(o){super(),this.expression=o}get astNodeType(){return"staticAssert"}search(o){this.expression.search(o)}}class b extends c{constructor(o,h){super(),this.condition=o,this.body=h}get astNodeType(){return"while"}search(o){this.condition.search(o),this.searchBlock(this.body,o)}}class C extends c{constructor(o){super(),this.body=o}get astNodeType(){return"continuing"}search(o){this.searchBlock(this.body,o)}}class S extends c{constructor(o,h,y,w){super(),this.init=o,this.condition=h,this.increment=y,this.body=w}get astNodeType(){return"for"}search(o){var h,y,w;(h=this.init)===null||h===void 0||h.search(o),(y=this.condition)===null||y===void 0||y.search(o),(w=this.increment)===null||w===void 0||w.search(o),this.searchBlock(this.body,o)}}class M extends c{constructor(o,h,y,w,I){super(),this.name=o,this.type=h,this.storage=y,this.access=w,this.value=I}get astNodeType(){return"var"}search(o){var h;o(this),(h=this.value)===null||h===void 0||h.search(o)}}class F extends c{constructor(o,h,y){super(),this.name=o,this.type=h,this.value=y}get astNodeType(){return"override"}search(o){var h;(h=this.value)===null||h===void 0||h.search(o)}}class U extends c{constructor(o,h,y,w,I){super(),this.name=o,this.type=h,this.storage=y,this.access=w,this.value=I}get astNodeType(){return"let"}search(o){var h;o(this),(h=this.value)===null||h===void 0||h.search(o)}}class K extends c{constructor(o,h,y,w,I){super(),this.name=o,this.type=h,this.storage=y,this.access=w,this.value=I}get astNodeType(){return"const"}evaluate(o){return this.value.evaluate(o)}search(o){var h;o(this),(h=this.value)===null||h===void 0||h.search(o)}}s.IncrementOperator=void 0,function(L){L.increment="++",L.decrement="--"}(s.IncrementOperator||(s.IncrementOperator={})),function(L){function o(h){const y=h;if(y=="parse")throw new Error("Invalid value for IncrementOperator");return L[y]}L.parse=o}(s.IncrementOperator||(s.IncrementOperator={}));class q extends c{constructor(o,h){super(),this.operator=o,this.variable=h}get astNodeType(){return"increment"}search(o){this.variable.search(o)}}s.AssignOperator=void 0,function(L){L.assign="=",L.addAssign="+=",L.subtractAssin="-=",L.multiplyAssign="*=",L.divideAssign="/=",L.moduloAssign="%=",L.andAssign="&=",L.orAssign="|=",L.xorAssign="^=",L.shiftLeftAssign="<<=",L.shiftRightAssign=">>="}(s.AssignOperator||(s.AssignOperator={})),function(L){function o(h){const y=h;if(y=="parse")throw new Error("Invalid value for AssignOperator");return y}L.parse=o}(s.AssignOperator||(s.AssignOperator={}));class G extends c{constructor(o,h,y){super(),this.operator=o,this.variable=h,this.value=y}get astNodeType(){return"assign"}search(o){this.variable.search(o),this.value.search(o)}}class fe extends c{constructor(o,h){super(),this.name=o,this.args=h}get astNodeType(){return"call"}search(o){for(const h of this.args)h.search(o);o(this)}}class oe extends c{constructor(o,h){super(),this.body=o,this.continuing=h}get astNodeType(){return"loop"}}class re extends c{constructor(o,h){super(),this.condition=o,this.body=h}get astNodeType(){return"body"}}class ue extends c{constructor(o,h,y,w){super(),this.condition=o,this.body=h,this.elseif=y,this.else=w}get astNodeType(){return"if"}search(o){this.condition.search(o),this.searchBlock(this.body,o),this.searchBlock(this.elseif,o),this.searchBlock(this.else,o)}}class Q extends c{constructor(o){super(),this.value=o}get astNodeType(){return"return"}search(o){var h;(h=this.value)===null||h===void 0||h.search(o)}}class X extends c{constructor(o){super(),this.name=o}get astNodeType(){return"enable"}}class he extends c{constructor(o){super(),this.extensions=o}get astNodeType(){return"requires"}}class ye extends c{constructor(o,h){super(),this.severity=o,this.rule=h}get astNodeType(){return"diagnostic"}}class me extends c{constructor(o,h){super(),this.name=o,this.type=h}get astNodeType(){return"alias"}}class rt extends c{constructor(){super()}get astNodeType(){return"discard"}}class $e extends c{constructor(){super()}get astNodeType(){return"break"}}class St extends c{constructor(){super()}get astNodeType(){return"continue"}}class ze extends c{constructor(o){super(),this.name=o}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class ee extends ze{constructor(o,h,y,w){super(o),this.members=h,this.startLine=y,this.endLine=w}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(o){for(let h=0;h<this.members.length;h++)if(this.members[h].name==o)return h;return-1}}class Ve extends ze{constructor(o,h,y){super(o),this.format=h,this.access=y}get astNodeType(){return"template"}}class Ge extends ze{constructor(o,h,y,w){super(o),this.storage=h,this.type=y,this.access=w}get astNodeType(){return"pointer"}}class De extends ze{constructor(o,h,y,w){super(o),this.attributes=h,this.format=y,this.count=w}get astNodeType(){return"array"}get isArray(){return!0}}class Be extends ze{constructor(o,h,y){super(o),this.format=h,this.access=y}get astNodeType(){return"sampler"}}class Qe extends n{constructor(){super()}}class It extends Qe{constructor(o){super(),this.value=o}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class Fe extends Qe{constructor(o,h){super(),this.type=o,this.args=h}get astNodeType(){return"createExpr"}search(o){o(this);for(const h of this.args)h.search(o)}}class on extends Qe{constructor(o,h){super(),this.name=o,this.args=h}get astNodeType(){return"callExpr"}evaluate(o){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(o));case"acos":return Math.acos(this.args[0].evaluate(o));case"acosh":return Math.acosh(this.args[0].evaluate(o));case"asin":return Math.asin(this.args[0].evaluate(o));case"asinh":return Math.asinh(this.args[0].evaluate(o));case"atan":return Math.atan(this.args[0].evaluate(o));case"atan2":return Math.atan2(this.args[0].evaluate(o),this.args[1].evaluate(o));case"atanh":return Math.atanh(this.args[0].evaluate(o));case"ceil":return Math.ceil(this.args[0].evaluate(o));case"clamp":return Math.min(Math.max(this.args[0].evaluate(o),this.args[1].evaluate(o)),this.args[2].evaluate(o));case"cos":return Math.cos(this.args[0].evaluate(o));case"degrees":return this.args[0].evaluate(o)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(o)-this.args[1].evaluate(o),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(o));case"exp2":return Math.pow(2,this.args[0].evaluate(o));case"floor":return Math.floor(this.args[0].evaluate(o));case"fma":return this.args[0].evaluate(o)*this.args[1].evaluate(o)+this.args[2].evaluate(o);case"fract":return this.args[0].evaluate(o)-Math.floor(this.args[0].evaluate(o));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(o));case"log":return Math.log(this.args[0].evaluate(o));case"log2":return Math.log2(this.args[0].evaluate(o));case"max":return Math.max(this.args[0].evaluate(o),this.args[1].evaluate(o));case"min":return Math.min(this.args[0].evaluate(o),this.args[1].evaluate(o));case"mix":return this.args[0].evaluate(o)*(1-this.args[2].evaluate(o))+this.args[1].evaluate(o)*this.args[2].evaluate(o);case"modf":return this.args[0].evaluate(o)-Math.floor(this.args[0].evaluate(o));case"pow":return Math.pow(this.args[0].evaluate(o),this.args[1].evaluate(o));case"radians":return this.args[0].evaluate(o)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(o));case"sign":return Math.sign(this.args[0].evaluate(o));case"sin":return Math.sin(this.args[0].evaluate(o));case"sinh":return Math.sinh(this.args[0].evaluate(o));case"saturate":return Math.min(Math.max(this.args[0].evaluate(o),0),1);case"smoothstep":return this.args[0].evaluate(o)*this.args[0].evaluate(o)*(3-2*this.args[0].evaluate(o));case"sqrt":return Math.sqrt(this.args[0].evaluate(o));case"step":return this.args[0].evaluate(o)<this.args[1].evaluate(o)?0:1;case"tan":return Math.tan(this.args[0].evaluate(o));case"tanh":return Math.tanh(this.args[0].evaluate(o));case"trunc":return Math.trunc(this.args[0].evaluate(o));default:throw new Error("Non const function: "+this.name)}}search(o){for(const h of this.args)h.search(o);o(this)}}class en extends Qe{constructor(o){super(),this.name=o}get astNodeType(){return"varExpr"}search(o){o(this),this.postfix&&this.postfix.search(o)}evaluate(o){const h=o.constants.get(this.name);if(!h)throw new Error("Cannot evaluate node");return h.evaluate(o)}}class Kt extends Qe{constructor(o,h){super(),this.name=o,this.initializer=h}get astNodeType(){return"constExpr"}evaluate(o){var h,y;if(this.initializer instanceof Fe){const w=(h=this.postfix)===null||h===void 0?void 0:h.evaluateString(o),I=(y=this.initializer.type)===null||y===void 0?void 0:y.name,O=o.structs.get(I),H=O==null?void 0:O.getMemberIndex(w);if(H!=-1)return this.initializer.args[H].evaluate(o);console.log(H)}return this.initializer.evaluate(o)}search(o){this.initializer.search(o)}}class je extends Qe{constructor(o){super(),this.value=o}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class $n extends Qe{constructor(o,h){super(),this.type=o,this.value=h}get astNodeType(){return"bitcastExpr"}search(o){this.value.search(o)}}class oi extends Qe{constructor(o,h){super(),this.type=o,this.args=h}get astNodeType(){return"typecastExpr"}evaluate(o){return this.args[0].evaluate(o)}search(o){this.searchBlock(this.args,o)}}class un extends Qe{constructor(o){super(),this.contents=o}get astNodeType(){return"groupExpr"}evaluate(o){return this.contents[0].evaluate(o)}search(o){this.searchBlock(this.contents,o)}}class Tn extends Qe{constructor(o){super(),this.index=o}search(o){this.index.search(o)}}class Os extends Qe{constructor(){super()}}class Hn extends Os{constructor(o,h){super(),this.operator=o,this.right=h}get astNodeType(){return"unaryOp"}evaluate(o){switch(this.operator){case"+":return this.right.evaluate(o);case"-":return-this.right.evaluate(o);case"!":return this.right.evaluate(o)?0:1;case"~":return~this.right.evaluate(o);default:throw new Error("Unknown unary operator: "+this.operator)}}search(o){this.right.search(o)}}class et extends Os{constructor(o,h,y){super(),this.operator=o,this.left=h,this.right=y}get astNodeType(){return"binaryOp"}evaluate(o){switch(this.operator){case"+":return this.left.evaluate(o)+this.right.evaluate(o);case"-":return this.left.evaluate(o)-this.right.evaluate(o);case"*":return this.left.evaluate(o)*this.right.evaluate(o);case"/":return this.left.evaluate(o)/this.right.evaluate(o);case"%":return this.left.evaluate(o)%this.right.evaluate(o);case"==":return this.left.evaluate(o)==this.right.evaluate(o)?1:0;case"!=":return this.left.evaluate(o)!=this.right.evaluate(o)?1:0;case"<":return this.left.evaluate(o)<this.right.evaluate(o)?1:0;case">":return this.left.evaluate(o)>this.right.evaluate(o)?1:0;case"<=":return this.left.evaluate(o)<=this.right.evaluate(o)?1:0;case">=":return this.left.evaluate(o)>=this.right.evaluate(o)?1:0;case"&&":return this.left.evaluate(o)&&this.right.evaluate(o)?1:0;case"||":return this.left.evaluate(o)||this.right.evaluate(o)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(o){this.left.search(o),this.right.search(o)}}class os extends n{constructor(){super()}}class ct extends os{constructor(o,h){super(),this.selector=o,this.body=h}get astNodeType(){return"case"}search(o){this.searchBlock(this.body,o)}}class An extends os{constructor(o){super(),this.body=o}get astNodeType(){return"default"}search(o){this.searchBlock(this.body,o)}}class ui extends n{constructor(o,h,y){super(),this.name=o,this.type=h,this.attributes=y}get astNodeType(){return"argument"}}class Ct extends n{constructor(o,h){super(),this.condition=o,this.body=h}get astNodeType(){return"elseif"}search(o){this.condition.search(o),this.searchBlock(this.body,o)}}class Ns extends n{constructor(o,h,y){super(),this.name=o,this.type=h,this.attributes=y}get astNodeType(){return"member"}}class li extends n{constructor(o,h){super(),this.name=o,this.value=h}get astNodeType(){return"attribute"}}var E;s.TokenClass=void 0,function(L){L[L.token=0]="token",L[L.keyword=1]="keyword",L[L.reserved=2]="reserved"}(s.TokenClass||(s.TokenClass={}));class k{constructor(o,h,y){this.name=o,this.type=h,this.rule=y}toString(){return this.name}}class m{}E=m,m.none=new k("",s.TokenClass.reserved,""),m.eof=new k("EOF",s.TokenClass.token,""),m.reserved={asm:new k("asm",s.TokenClass.reserved,"asm"),bf16:new k("bf16",s.TokenClass.reserved,"bf16"),do:new k("do",s.TokenClass.reserved,"do"),enum:new k("enum",s.TokenClass.reserved,"enum"),f16:new k("f16",s.TokenClass.reserved,"f16"),f64:new k("f64",s.TokenClass.reserved,"f64"),handle:new k("handle",s.TokenClass.reserved,"handle"),i8:new k("i8",s.TokenClass.reserved,"i8"),i16:new k("i16",s.TokenClass.reserved,"i16"),i64:new k("i64",s.TokenClass.reserved,"i64"),mat:new k("mat",s.TokenClass.reserved,"mat"),premerge:new k("premerge",s.TokenClass.reserved,"premerge"),regardless:new k("regardless",s.TokenClass.reserved,"regardless"),typedef:new k("typedef",s.TokenClass.reserved,"typedef"),u8:new k("u8",s.TokenClass.reserved,"u8"),u16:new k("u16",s.TokenClass.reserved,"u16"),u64:new k("u64",s.TokenClass.reserved,"u64"),unless:new k("unless",s.TokenClass.reserved,"unless"),using:new k("using",s.TokenClass.reserved,"using"),vec:new k("vec",s.TokenClass.reserved,"vec"),void:new k("void",s.TokenClass.reserved,"void")},m.keywords={array:new k("array",s.TokenClass.keyword,"array"),atomic:new k("atomic",s.TokenClass.keyword,"atomic"),bool:new k("bool",s.TokenClass.keyword,"bool"),f32:new k("f32",s.TokenClass.keyword,"f32"),i32:new k("i32",s.TokenClass.keyword,"i32"),mat2x2:new k("mat2x2",s.TokenClass.keyword,"mat2x2"),mat2x3:new k("mat2x3",s.TokenClass.keyword,"mat2x3"),mat2x4:new k("mat2x4",s.TokenClass.keyword,"mat2x4"),mat3x2:new k("mat3x2",s.TokenClass.keyword,"mat3x2"),mat3x3:new k("mat3x3",s.TokenClass.keyword,"mat3x3"),mat3x4:new k("mat3x4",s.TokenClass.keyword,"mat3x4"),mat4x2:new k("mat4x2",s.TokenClass.keyword,"mat4x2"),mat4x3:new k("mat4x3",s.TokenClass.keyword,"mat4x3"),mat4x4:new k("mat4x4",s.TokenClass.keyword,"mat4x4"),ptr:new k("ptr",s.TokenClass.keyword,"ptr"),sampler:new k("sampler",s.TokenClass.keyword,"sampler"),sampler_comparison:new k("sampler_comparison",s.TokenClass.keyword,"sampler_comparison"),struct:new k("struct",s.TokenClass.keyword,"struct"),texture_1d:new k("texture_1d",s.TokenClass.keyword,"texture_1d"),texture_2d:new k("texture_2d",s.TokenClass.keyword,"texture_2d"),texture_2d_array:new k("texture_2d_array",s.TokenClass.keyword,"texture_2d_array"),texture_3d:new k("texture_3d",s.TokenClass.keyword,"texture_3d"),texture_cube:new k("texture_cube",s.TokenClass.keyword,"texture_cube"),texture_cube_array:new k("texture_cube_array",s.TokenClass.keyword,"texture_cube_array"),texture_multisampled_2d:new k("texture_multisampled_2d",s.TokenClass.keyword,"texture_multisampled_2d"),texture_storage_1d:new k("texture_storage_1d",s.TokenClass.keyword,"texture_storage_1d"),texture_storage_2d:new k("texture_storage_2d",s.TokenClass.keyword,"texture_storage_2d"),texture_storage_2d_array:new k("texture_storage_2d_array",s.TokenClass.keyword,"texture_storage_2d_array"),texture_storage_3d:new k("texture_storage_3d",s.TokenClass.keyword,"texture_storage_3d"),texture_depth_2d:new k("texture_depth_2d",s.TokenClass.keyword,"texture_depth_2d"),texture_depth_2d_array:new k("texture_depth_2d_array",s.TokenClass.keyword,"texture_depth_2d_array"),texture_depth_cube:new k("texture_depth_cube",s.TokenClass.keyword,"texture_depth_cube"),texture_depth_cube_array:new k("texture_depth_cube_array",s.TokenClass.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new k("texture_depth_multisampled_2d",s.TokenClass.keyword,"texture_depth_multisampled_2d"),texture_external:new k("texture_external",s.TokenClass.keyword,"texture_external"),u32:new k("u32",s.TokenClass.keyword,"u32"),vec2:new k("vec2",s.TokenClass.keyword,"vec2"),vec3:new k("vec3",s.TokenClass.keyword,"vec3"),vec4:new k("vec4",s.TokenClass.keyword,"vec4"),bitcast:new k("bitcast",s.TokenClass.keyword,"bitcast"),block:new k("block",s.TokenClass.keyword,"block"),break:new k("break",s.TokenClass.keyword,"break"),case:new k("case",s.TokenClass.keyword,"case"),continue:new k("continue",s.TokenClass.keyword,"continue"),continuing:new k("continuing",s.TokenClass.keyword,"continuing"),default:new k("default",s.TokenClass.keyword,"default"),diagnostic:new k("diagnostic",s.TokenClass.keyword,"diagnostic"),discard:new k("discard",s.TokenClass.keyword,"discard"),else:new k("else",s.TokenClass.keyword,"else"),enable:new k("enable",s.TokenClass.keyword,"enable"),fallthrough:new k("fallthrough",s.TokenClass.keyword,"fallthrough"),false:new k("false",s.TokenClass.keyword,"false"),fn:new k("fn",s.TokenClass.keyword,"fn"),for:new k("for",s.TokenClass.keyword,"for"),function:new k("function",s.TokenClass.keyword,"function"),if:new k("if",s.TokenClass.keyword,"if"),let:new k("let",s.TokenClass.keyword,"let"),const:new k("const",s.TokenClass.keyword,"const"),loop:new k("loop",s.TokenClass.keyword,"loop"),while:new k("while",s.TokenClass.keyword,"while"),private:new k("private",s.TokenClass.keyword,"private"),read:new k("read",s.TokenClass.keyword,"read"),read_write:new k("read_write",s.TokenClass.keyword,"read_write"),return:new k("return",s.TokenClass.keyword,"return"),requires:new k("requires",s.TokenClass.keyword,"requires"),storage:new k("storage",s.TokenClass.keyword,"storage"),switch:new k("switch",s.TokenClass.keyword,"switch"),true:new k("true",s.TokenClass.keyword,"true"),alias:new k("alias",s.TokenClass.keyword,"alias"),type:new k("type",s.TokenClass.keyword,"type"),uniform:new k("uniform",s.TokenClass.keyword,"uniform"),var:new k("var",s.TokenClass.keyword,"var"),override:new k("override",s.TokenClass.keyword,"override"),workgroup:new k("workgroup",s.TokenClass.keyword,"workgroup"),write:new k("write",s.TokenClass.keyword,"write"),r8unorm:new k("r8unorm",s.TokenClass.keyword,"r8unorm"),r8snorm:new k("r8snorm",s.TokenClass.keyword,"r8snorm"),r8uint:new k("r8uint",s.TokenClass.keyword,"r8uint"),r8sint:new k("r8sint",s.TokenClass.keyword,"r8sint"),r16uint:new k("r16uint",s.TokenClass.keyword,"r16uint"),r16sint:new k("r16sint",s.TokenClass.keyword,"r16sint"),r16float:new k("r16float",s.TokenClass.keyword,"r16float"),rg8unorm:new k("rg8unorm",s.TokenClass.keyword,"rg8unorm"),rg8snorm:new k("rg8snorm",s.TokenClass.keyword,"rg8snorm"),rg8uint:new k("rg8uint",s.TokenClass.keyword,"rg8uint"),rg8sint:new k("rg8sint",s.TokenClass.keyword,"rg8sint"),r32uint:new k("r32uint",s.TokenClass.keyword,"r32uint"),r32sint:new k("r32sint",s.TokenClass.keyword,"r32sint"),r32float:new k("r32float",s.TokenClass.keyword,"r32float"),rg16uint:new k("rg16uint",s.TokenClass.keyword,"rg16uint"),rg16sint:new k("rg16sint",s.TokenClass.keyword,"rg16sint"),rg16float:new k("rg16float",s.TokenClass.keyword,"rg16float"),rgba8unorm:new k("rgba8unorm",s.TokenClass.keyword,"rgba8unorm"),rgba8unorm_srgb:new k("rgba8unorm_srgb",s.TokenClass.keyword,"rgba8unorm_srgb"),rgba8snorm:new k("rgba8snorm",s.TokenClass.keyword,"rgba8snorm"),rgba8uint:new k("rgba8uint",s.TokenClass.keyword,"rgba8uint"),rgba8sint:new k("rgba8sint",s.TokenClass.keyword,"rgba8sint"),bgra8unorm:new k("bgra8unorm",s.TokenClass.keyword,"bgra8unorm"),bgra8unorm_srgb:new k("bgra8unorm_srgb",s.TokenClass.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new k("rgb10a2unorm",s.TokenClass.keyword,"rgb10a2unorm"),rg11b10float:new k("rg11b10float",s.TokenClass.keyword,"rg11b10float"),rg32uint:new k("rg32uint",s.TokenClass.keyword,"rg32uint"),rg32sint:new k("rg32sint",s.TokenClass.keyword,"rg32sint"),rg32float:new k("rg32float",s.TokenClass.keyword,"rg32float"),rgba16uint:new k("rgba16uint",s.TokenClass.keyword,"rgba16uint"),rgba16sint:new k("rgba16sint",s.TokenClass.keyword,"rgba16sint"),rgba16float:new k("rgba16float",s.TokenClass.keyword,"rgba16float"),rgba32uint:new k("rgba32uint",s.TokenClass.keyword,"rgba32uint"),rgba32sint:new k("rgba32sint",s.TokenClass.keyword,"rgba32sint"),rgba32float:new k("rgba32float",s.TokenClass.keyword,"rgba32float"),static_assert:new k("static_assert",s.TokenClass.keyword,"static_assert")},m.tokens={decimal_float_literal:new k("decimal_float_literal",s.TokenClass.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new k("hex_float_literal",s.TokenClass.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new k("int_literal",s.TokenClass.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new k("uint_literal",s.TokenClass.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new k("ident",s.TokenClass.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new k("and",s.TokenClass.token,"&"),and_and:new k("and_and",s.TokenClass.token,"&&"),arrow:new k("arrow ",s.TokenClass.token,"->"),attr:new k("attr",s.TokenClass.token,"@"),forward_slash:new k("forward_slash",s.TokenClass.token,"/"),bang:new k("bang",s.TokenClass.token,"!"),bracket_left:new k("bracket_left",s.TokenClass.token,"["),bracket_right:new k("bracket_right",s.TokenClass.token,"]"),brace_left:new k("brace_left",s.TokenClass.token,"{"),brace_right:new k("brace_right",s.TokenClass.token,"}"),colon:new k("colon",s.TokenClass.token,":"),comma:new k("comma",s.TokenClass.token,","),equal:new k("equal",s.TokenClass.token,"="),equal_equal:new k("equal_equal",s.TokenClass.token,"=="),not_equal:new k("not_equal",s.TokenClass.token,"!="),greater_than:new k("greater_than",s.TokenClass.token,">"),greater_than_equal:new k("greater_than_equal",s.TokenClass.token,">="),shift_right:new k("shift_right",s.TokenClass.token,">>"),less_than:new k("less_than",s.TokenClass.token,"<"),less_than_equal:new k("less_than_equal",s.TokenClass.token,"<="),shift_left:new k("shift_left",s.TokenClass.token,"<<"),modulo:new k("modulo",s.TokenClass.token,"%"),minus:new k("minus",s.TokenClass.token,"-"),minus_minus:new k("minus_minus",s.TokenClass.token,"--"),period:new k("period",s.TokenClass.token,"."),plus:new k("plus",s.TokenClass.token,"+"),plus_plus:new k("plus_plus",s.TokenClass.token,"++"),or:new k("or",s.TokenClass.token,"|"),or_or:new k("or_or",s.TokenClass.token,"||"),paren_left:new k("paren_left",s.TokenClass.token,"("),paren_right:new k("paren_right",s.TokenClass.token,")"),semicolon:new k("semicolon",s.TokenClass.token,";"),star:new k("star",s.TokenClass.token,"*"),tilde:new k("tilde",s.TokenClass.token,"~"),underscore:new k("underscore",s.TokenClass.token,"_"),xor:new k("xor",s.TokenClass.token,"^"),plus_equal:new k("plus_equal",s.TokenClass.token,"+="),minus_equal:new k("minus_equal",s.TokenClass.token,"-="),times_equal:new k("times_equal",s.TokenClass.token,"*="),division_equal:new k("division_equal",s.TokenClass.token,"/="),modulo_equal:new k("modulo_equal",s.TokenClass.token,"%="),and_equal:new k("and_equal",s.TokenClass.token,"&="),or_equal:new k("or_equal",s.TokenClass.token,"|="),xor_equal:new k("xor_equal",s.TokenClass.token,"^="),shift_right_equal:new k("shift_right_equal",s.TokenClass.token,">>="),shift_left_equal:new k("shift_left_equal",s.TokenClass.token,"<<=")},m.simpleTokens={"@":E.tokens.attr,"{":E.tokens.brace_left,"}":E.tokens.brace_right,":":E.tokens.colon,",":E.tokens.comma,"(":E.tokens.paren_left,")":E.tokens.paren_right,";":E.tokens.semicolon},m.literalTokens={"&":E.tokens.and,"&&":E.tokens.and_and,"->":E.tokens.arrow,"/":E.tokens.forward_slash,"!":E.tokens.bang,"[":E.tokens.bracket_left,"]":E.tokens.bracket_right,"=":E.tokens.equal,"==":E.tokens.equal_equal,"!=":E.tokens.not_equal,">":E.tokens.greater_than,">=":E.tokens.greater_than_equal,">>":E.tokens.shift_right,"<":E.tokens.less_than,"<=":E.tokens.less_than_equal,"<<":E.tokens.shift_left,"%":E.tokens.modulo,"-":E.tokens.minus,"--":E.tokens.minus_minus,".":E.tokens.period,"+":E.tokens.plus,"++":E.tokens.plus_plus,"|":E.tokens.or,"||":E.tokens.or_or,"*":E.tokens.star,"~":E.tokens.tilde,_:E.tokens.underscore,"^":E.tokens.xor,"+=":E.tokens.plus_equal,"-=":E.tokens.minus_equal,"*=":E.tokens.times_equal,"/=":E.tokens.division_equal,"%=":E.tokens.modulo_equal,"&=":E.tokens.and_equal,"|=":E.tokens.or_equal,"^=":E.tokens.xor_equal,">>=":E.tokens.shift_right_equal,"<<=":E.tokens.shift_left_equal},m.regexTokens={decimal_float_literal:E.tokens.decimal_float_literal,hex_float_literal:E.tokens.hex_float_literal,int_literal:E.tokens.int_literal,uint_literal:E.tokens.uint_literal,ident:E.tokens.ident},m.storage_class=[E.keywords.function,E.keywords.private,E.keywords.workgroup,E.keywords.uniform,E.keywords.storage],m.access_mode=[E.keywords.read,E.keywords.write,E.keywords.read_write],m.sampler_type=[E.keywords.sampler,E.keywords.sampler_comparison],m.sampled_texture_type=[E.keywords.texture_1d,E.keywords.texture_2d,E.keywords.texture_2d_array,E.keywords.texture_3d,E.keywords.texture_cube,E.keywords.texture_cube_array],m.multisampled_texture_type=[E.keywords.texture_multisampled_2d],m.storage_texture_type=[E.keywords.texture_storage_1d,E.keywords.texture_storage_2d,E.keywords.texture_storage_2d_array,E.keywords.texture_storage_3d],m.depth_texture_type=[E.keywords.texture_depth_2d,E.keywords.texture_depth_2d_array,E.keywords.texture_depth_cube,E.keywords.texture_depth_cube_array,E.keywords.texture_depth_multisampled_2d],m.texture_external_type=[E.keywords.texture_external],m.any_texture_type=[...E.sampled_texture_type,...E.multisampled_texture_type,...E.storage_texture_type,...E.depth_texture_type,...E.texture_external_type],m.texel_format=[E.keywords.r8unorm,E.keywords.r8snorm,E.keywords.r8uint,E.keywords.r8sint,E.keywords.r16uint,E.keywords.r16sint,E.keywords.r16float,E.keywords.rg8unorm,E.keywords.rg8snorm,E.keywords.rg8uint,E.keywords.rg8sint,E.keywords.r32uint,E.keywords.r32sint,E.keywords.r32float,E.keywords.rg16uint,E.keywords.rg16sint,E.keywords.rg16float,E.keywords.rgba8unorm,E.keywords.rgba8unorm_srgb,E.keywords.rgba8snorm,E.keywords.rgba8uint,E.keywords.rgba8sint,E.keywords.bgra8unorm,E.keywords.bgra8unorm_srgb,E.keywords.rgb10a2unorm,E.keywords.rg11b10float,E.keywords.rg32uint,E.keywords.rg32sint,E.keywords.rg32float,E.keywords.rgba16uint,E.keywords.rgba16sint,E.keywords.rgba16float,E.keywords.rgba32uint,E.keywords.rgba32sint,E.keywords.rgba32float],m.const_literal=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal,E.keywords.true,E.keywords.false],m.literal_or_ident=[E.tokens.ident,E.tokens.int_literal,E.tokens.uint_literal,E.tokens.decimal_float_literal,E.tokens.hex_float_literal],m.element_count_expression=[E.tokens.int_literal,E.tokens.uint_literal,E.tokens.ident],m.template_types=[E.keywords.vec2,E.keywords.vec3,E.keywords.vec4,E.keywords.mat2x2,E.keywords.mat2x3,E.keywords.mat2x4,E.keywords.mat3x2,E.keywords.mat3x3,E.keywords.mat3x4,E.keywords.mat4x2,E.keywords.mat4x3,E.keywords.mat4x4,E.keywords.atomic,E.keywords.bitcast,...E.any_texture_type],m.attribute_name=[E.tokens.ident,E.keywords.block,E.keywords.diagnostic],m.assignment_operators=[E.tokens.equal,E.tokens.plus_equal,E.tokens.minus_equal,E.tokens.times_equal,E.tokens.division_equal,E.tokens.modulo_equal,E.tokens.and_equal,E.tokens.or_equal,E.tokens.xor_equal,E.tokens.shift_right_equal,E.tokens.shift_left_equal],m.increment_operators=[E.tokens.plus_plus,E.tokens.minus_minus];class En{constructor(o,h,y){this.type=o,this.lexeme=h,this.line=y}toString(){return this.lexeme}isTemplateType(){return m.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==m.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class ci{constructor(o){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=o??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new En(m.eof,"",this._line)),this._tokens}scanToken(){let o=this._advance();if(o==`
`)return this._line++,!0;if(this._isWhitespace(o))return!0;if(o=="/"){if(this._peekAhead()=="/"){for(;o!=`
`;){if(this._isAtEnd())return!0;o=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let O=1;for(;O>0;){if(this._isAtEnd())return!0;if(o=this._advance(),o==`
`)this._line++;else if(o=="*"){if(this._peekAhead()=="/"&&(this._advance(),O--,O==0))return!0}else o=="/"&&this._peekAhead()=="*"&&(this._advance(),O++)}return!0}}const h=m.simpleTokens[o];if(h)return this._addToken(h),!0;let y=m.none;const w=this._isAlpha(o),I=o==="_";if(this._isAlphaNumeric(o)){let O=this._peekAhead();for(;this._isAlphaNumeric(O);)o+=this._advance(),O=this._peekAhead()}if(w){const O=m.keywords[o];if(O)return this._addToken(O),!0}if(w||I)return this._addToken(m.tokens.ident),!0;for(;;){let O=this._findType(o);const H=this._peekAhead();if(o==">"&&(H==">"||H=="=")){let Y=!1,te=this._tokens.length-1;for(let Ie=0;Ie<5&&te>=0;++Ie,--te)if(this._tokens[te].type===m.tokens.less_than){te>0&&this._tokens[te-1].isArrayOrTemplateType()&&(Y=!0);break}if(Y)return this._addToken(O),!0}if(O===m.none){let Y=o,te=0;const Ie=2;for(let ht=0;ht<Ie;++ht)if(Y+=this._peekAhead(ht),O=this._findType(Y),O!==m.none){te=ht;break}if(O===m.none)return y===m.none?!1:(this._current--,this._addToken(y),!0);o=Y,this._current+=te+1}if(y=O,this._isAtEnd())break;o+=this._advance()}return y===m.none?!1:(this._addToken(y),!0)}_findType(o){for(const y in m.regexTokens){const w=m.regexTokens[y];if(this._match(o,w.rule))return w}const h=m.literalTokens[o];return h||m.none}_match(o,h){const y=h.exec(o);return y&&y.index==0&&y[0]==o}_isAtEnd(){return this._current>=this._source.length}_isAlpha(o){return o>="a"&&o<="z"||o>="A"&&o<="Z"}_isAlphaNumeric(o){return o>="a"&&o<="z"||o>="A"&&o<="Z"||o=="_"||o>="0"&&o<="9"}_isWhitespace(o){return o==" "||o=="	"||o=="\r"}_advance(o=0){let h=this._source[this._current];return o=o||0,o++,this._current+=o,h}_peekAhead(o=0){return o=o||0,this._current+o>=this._source.length?"\0":this._source[this._current+o]}_addToken(o){const h=this._source.substring(this._start,this._current);this._tokens.push(new En(o,h,this._line))}}class Sn{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new i,this._deferArrayCountEval=[]}parse(o){this._initialize(o),this._deferArrayCountEval.length=0;const h=[];for(;!this._isAtEnd();){const y=this._global_decl_or_directive();if(!y)break;h.push(y)}if(this._deferArrayCountEval.length>0){for(const y of this._deferArrayCountEval){const w=y.arrayType,I=y.countNode;if(I instanceof en){const H=I.name,Y=this._context.constants.get(H);if(Y)try{const te=Y.evaluate(this._context);w.count=te}catch{}}}this._deferArrayCountEval.length=0}return h}_initialize(o){if(o)if(typeof o=="string"){const h=new ci(o);this._tokens=h.scanTokens()}else this._tokens=o;else this._tokens=[];this._current=0}_error(o,h){return{token:o,message:h,toString:function(){return`${h}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==m.eof}_match(o){if(o instanceof k)return this._check(o)?(this._advance(),!0):!1;for(let h=0,y=o.length;h<y;++h){const w=o[h];if(this._check(w))return this._advance(),!0}return!1}_consume(o,h){if(this._check(o))return this._advance();throw this._error(this._peek(),h)}_check(o){if(this._isAtEnd())return!1;const h=this._peek();if(o instanceof Array){const y=h.type;return o.indexOf(y)!=-1}return h.type==o}_advance(){var o,h;return this._currentLine=(h=(o=this._peek())===null||o===void 0?void 0:o.line)!==null&&h!==void 0?h:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(m.tokens.semicolon)&&!this._isAtEnd(););if(this._match(m.keywords.alias)){const h=this._type_alias();return this._consume(m.tokens.semicolon,"Expected ';'"),h}if(this._match(m.keywords.diagnostic)){const h=this._diagnostic();return this._consume(m.tokens.semicolon,"Expected ';'"),h}if(this._match(m.keywords.requires)){const h=this._requires_directive();return this._consume(m.tokens.semicolon,"Expected ';'"),h}if(this._match(m.keywords.enable)){const h=this._enable_directive();return this._consume(m.tokens.semicolon,"Expected ';'"),h}const o=this._attribute();if(this._check(m.keywords.var)){const h=this._global_variable_decl();return h!=null&&(h.attributes=o),this._consume(m.tokens.semicolon,"Expected ';'."),h}if(this._check(m.keywords.override)){const h=this._override_variable_decl();return h!=null&&(h.attributes=o),this._consume(m.tokens.semicolon,"Expected ';'."),h}if(this._check(m.keywords.let)){const h=this._global_let_decl();return h!=null&&(h.attributes=o),this._consume(m.tokens.semicolon,"Expected ';'."),h}if(this._check(m.keywords.const)){const h=this._global_const_decl();return h!=null&&(h.attributes=o),this._consume(m.tokens.semicolon,"Expected ';'."),h}if(this._check(m.keywords.struct)){const h=this._struct_decl();return h!=null&&(h.attributes=o),h}if(this._check(m.keywords.fn)){const h=this._function_decl();return h!=null&&(h.attributes=o),h}return null}_function_decl(){if(!this._match(m.keywords.fn))return null;const o=this._currentLine,h=this._consume(m.tokens.ident,"Expected function name.").toString();this._consume(m.tokens.paren_left,"Expected '(' for function arguments.");const y=[];if(!this._check(m.tokens.paren_right))do{if(this._check(m.tokens.paren_right))break;const H=this._attribute(),Y=this._consume(m.tokens.ident,"Expected argument name.").toString();this._consume(m.tokens.colon,"Expected ':' for argument type.");const te=this._attribute(),Ie=this._type_decl();Ie!=null&&(Ie.attributes=te,y.push(new ui(Y,Ie,H)))}while(this._match(m.tokens.comma));this._consume(m.tokens.paren_right,"Expected ')' after function arguments.");let w=null;if(this._match(m.tokens.arrow)){const H=this._attribute();w=this._type_decl(),w!=null&&(w.attributes=H)}const I=this._compound_statement(),O=this._currentLine;return new f(h,y,w,I,o,O)}_compound_statement(){const o=[];for(this._consume(m.tokens.brace_left,"Expected '{' for block.");!this._check(m.tokens.brace_right);){const h=this._statement();h!==null&&o.push(h)}return this._consume(m.tokens.brace_right,"Expected '}' for block."),o}_statement(){for(;this._match(m.tokens.semicolon)&&!this._isAtEnd(););if(this._check(m.tokens.attr)&&this._attribute(),this._check(m.keywords.if))return this._if_statement();if(this._check(m.keywords.switch))return this._switch_statement();if(this._check(m.keywords.loop))return this._loop_statement();if(this._check(m.keywords.for))return this._for_statement();if(this._check(m.keywords.while))return this._while_statement();if(this._check(m.keywords.continuing))return this._continuing_statement();if(this._check(m.keywords.static_assert))return this._static_assert_statement();if(this._check(m.tokens.brace_left))return this._compound_statement();let o=null;return this._check(m.keywords.return)?o=this._return_statement():this._check([m.keywords.var,m.keywords.let,m.keywords.const])?o=this._variable_statement():this._match(m.keywords.discard)?o=new rt:this._match(m.keywords.break)?o=new $e:this._match(m.keywords.continue)?o=new St:o=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),o!=null&&this._consume(m.tokens.semicolon,"Expected ';' after statement."),o}_static_assert_statement(){if(!this._match(m.keywords.static_assert))return null;const o=this._optional_paren_expression();return new g(o)}_while_statement(){if(!this._match(m.keywords.while))return null;const o=this._optional_paren_expression();this._check(m.tokens.attr)&&this._attribute();const h=this._compound_statement();return new b(o,h)}_continuing_statement(){if(!this._match(m.keywords.continuing))return null;const o=this._compound_statement();return new C(o)}_for_statement(){if(!this._match(m.keywords.for))return null;this._consume(m.tokens.paren_left,"Expected '('.");const o=this._check(m.tokens.semicolon)?null:this._for_init();this._consume(m.tokens.semicolon,"Expected ';'.");const h=this._check(m.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(m.tokens.semicolon,"Expected ';'.");const y=this._check(m.tokens.paren_right)?null:this._for_increment();this._consume(m.tokens.paren_right,"Expected ')'."),this._check(m.tokens.attr)&&this._attribute();const w=this._compound_statement();return new S(o,h,y,w)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(m.keywords.var)){const o=this._variable_decl();if(o===null)throw this._error(this._peek(),"Variable declaration expected.");let h=null;return this._match(m.tokens.equal)&&(h=this._short_circuit_or_expression()),new M(o.name,o.type,o.storage,o.access,h)}if(this._match(m.keywords.let)){const o=this._consume(m.tokens.ident,"Expected name for let.").toString();let h=null;if(this._match(m.tokens.colon)){const w=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=w)}this._consume(m.tokens.equal,"Expected '=' for let.");const y=this._short_circuit_or_expression();return new U(o,h,null,null,y)}if(this._match(m.keywords.const)){const o=this._consume(m.tokens.ident,"Expected name for const.").toString();let h=null;if(this._match(m.tokens.colon)){const w=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=w)}this._consume(m.tokens.equal,"Expected '=' for const.");const y=this._short_circuit_or_expression();return new K(o,h,null,null,y)}return null}_increment_decrement_statement(){const o=this._current,h=this._unary_expression();if(h==null)return null;if(!this._check(m.increment_operators))return this._current=o,null;const y=this._consume(m.increment_operators,"Expected increment operator");return new q(y.type===m.tokens.plus_plus?s.IncrementOperator.increment:s.IncrementOperator.decrement,h)}_assignment_statement(){let o=null;if(this._check(m.tokens.brace_right))return null;let h=this._match(m.tokens.underscore);if(h||(o=this._unary_expression()),!h&&o==null)return null;const y=this._consume(m.assignment_operators,"Expected assignment operator."),w=this._short_circuit_or_expression();return new G(s.AssignOperator.parse(y.lexeme),o,w)}_func_call_statement(){if(!this._check(m.tokens.ident))return null;const o=this._current,h=this._consume(m.tokens.ident,"Expected function name."),y=this._argument_expression_list();return y===null?(this._current=o,null):new fe(h.lexeme,y)}_loop_statement(){if(!this._match(m.keywords.loop))return null;this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Expected '{' for loop.");const o=[];let h=this._statement();for(;h!==null;){if(Array.isArray(h))for(let w of h)o.push(w);else o.push(h);h=this._statement()}let y=null;return this._match(m.keywords.continuing)&&(y=this._compound_statement()),this._consume(m.tokens.brace_right,"Expected '}' for loop."),new oe(o,y)}_switch_statement(){if(!this._match(m.keywords.switch))return null;const o=this._optional_paren_expression();this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Expected '{' for switch.");const h=this._switch_body();if(h==null||h.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(m.tokens.brace_right,"Expected '}' for switch."),new re(o,h)}_switch_body(){const o=[];if(this._match(m.keywords.case)){const h=this._case_selectors();this._match(m.tokens.colon),this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Exected '{' for switch case.");const y=this._case_body();this._consume(m.tokens.brace_right,"Exected '}' for switch case."),o.push(new ct(h,y))}if(this._match(m.keywords.default)){this._match(m.tokens.colon),this._check(m.tokens.attr)&&this._attribute(),this._consume(m.tokens.brace_left,"Exected '{' for switch default.");const h=this._case_body();this._consume(m.tokens.brace_right,"Exected '}' for switch default."),o.push(new An(h))}if(this._check([m.keywords.default,m.keywords.case])){const h=this._switch_body();o.push(h[0])}return o}_case_selectors(){const o=[this._shift_expression()];for(;this._match(m.tokens.comma);)o.push(this._shift_expression());return o}_case_body(){if(this._match(m.keywords.fallthrough))return this._consume(m.tokens.semicolon,"Expected ';'"),[];let o=this._statement();if(o==null)return[];o instanceof Array||(o=[o]);const h=this._case_body();return h.length==0?o:[...o,h[0]]}_if_statement(){if(!this._match(m.keywords.if))return null;const o=this._optional_paren_expression();this._check(m.tokens.attr)&&this._attribute();const h=this._compound_statement();let y=[];this._match_elseif()&&(this._check(m.tokens.attr)&&this._attribute(),y=this._elseif_statement(y));let w=null;return this._match(m.keywords.else)&&(this._check(m.tokens.attr)&&this._attribute(),w=this._compound_statement()),new ue(o,h,y,w)}_match_elseif(){return this._tokens[this._current].type===m.keywords.else&&this._tokens[this._current+1].type===m.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(o=[]){const h=this._optional_paren_expression(),y=this._compound_statement();return o.push(new Ct(h,y)),this._match_elseif()&&(this._check(m.tokens.attr)&&this._attribute(),this._elseif_statement(o)),o}_return_statement(){if(!this._match(m.keywords.return))return null;const o=this._short_circuit_or_expression();return new Q(o)}_short_circuit_or_expression(){let o=this._short_circuit_and_expr();for(;this._match(m.tokens.or_or);)o=new et(this._previous().toString(),o,this._short_circuit_and_expr());return o}_short_circuit_and_expr(){let o=this._inclusive_or_expression();for(;this._match(m.tokens.and_and);)o=new et(this._previous().toString(),o,this._inclusive_or_expression());return o}_inclusive_or_expression(){let o=this._exclusive_or_expression();for(;this._match(m.tokens.or);)o=new et(this._previous().toString(),o,this._exclusive_or_expression());return o}_exclusive_or_expression(){let o=this._and_expression();for(;this._match(m.tokens.xor);)o=new et(this._previous().toString(),o,this._and_expression());return o}_and_expression(){let o=this._equality_expression();for(;this._match(m.tokens.and);)o=new et(this._previous().toString(),o,this._equality_expression());return o}_equality_expression(){const o=this._relational_expression();return this._match([m.tokens.equal_equal,m.tokens.not_equal])?new et(this._previous().toString(),o,this._relational_expression()):o}_relational_expression(){let o=this._shift_expression();for(;this._match([m.tokens.less_than,m.tokens.greater_than,m.tokens.less_than_equal,m.tokens.greater_than_equal]);)o=new et(this._previous().toString(),o,this._shift_expression());return o}_shift_expression(){let o=this._additive_expression();for(;this._match([m.tokens.shift_left,m.tokens.shift_right]);)o=new et(this._previous().toString(),o,this._additive_expression());return o}_additive_expression(){let o=this._multiplicative_expression();for(;this._match([m.tokens.plus,m.tokens.minus]);)o=new et(this._previous().toString(),o,this._multiplicative_expression());return o}_multiplicative_expression(){let o=this._unary_expression();for(;this._match([m.tokens.star,m.tokens.forward_slash,m.tokens.modulo]);)o=new et(this._previous().toString(),o,this._unary_expression());return o}_unary_expression(){return this._match([m.tokens.minus,m.tokens.bang,m.tokens.tilde,m.tokens.star,m.tokens.and])?new Hn(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const o=this._primary_expression(),h=this._postfix_expression();return h&&(o.postfix=h),o}_postfix_expression(){if(this._match(m.tokens.bracket_left)){const o=this._short_circuit_or_expression();this._consume(m.tokens.bracket_right,"Expected ']'.");const h=new Tn(o),y=this._postfix_expression();return y&&(h.postfix=y),h}if(this._match(m.tokens.period)){const o=this._consume(m.tokens.ident,"Expected member name."),h=this._postfix_expression(),y=new It(o.lexeme);return h&&(y.postfix=h),y}return null}_getStruct(o){return this._context.aliases.has(o)?this._context.aliases.get(o).type:this._context.structs.has(o)?this._context.structs.get(o):null}_primary_expression(){if(this._match(m.tokens.ident)){const y=this._previous().toString();if(this._check(m.tokens.paren_left)){const w=this._argument_expression_list(),I=this._getStruct(y);return I!=null?new Fe(I,w):new on(y,w)}if(this._context.constants.has(y)){const w=this._context.constants.get(y);return new Kt(y,w.value)}return new en(y)}if(this._match(m.const_literal))return new je(parseFloat(this._previous().toString()));if(this._check(m.tokens.paren_left))return this._paren_expression();if(this._match(m.keywords.bitcast)){this._consume(m.tokens.less_than,"Expected '<'.");const y=this._type_decl();this._consume(m.tokens.greater_than,"Expected '>'.");const w=this._paren_expression();return new $n(y,w)}const o=this._type_decl(),h=this._argument_expression_list();return new oi(o,h)}_argument_expression_list(){if(!this._match(m.tokens.paren_left))return null;const o=[];do{if(this._check(m.tokens.paren_right))break;const h=this._short_circuit_or_expression();o.push(h)}while(this._match(m.tokens.comma));return this._consume(m.tokens.paren_right,"Expected ')' for agument list"),o}_optional_paren_expression(){this._match(m.tokens.paren_left);const o=this._short_circuit_or_expression();return this._match(m.tokens.paren_right),new un([o])}_paren_expression(){this._consume(m.tokens.paren_left,"Expected '('.");const o=this._short_circuit_or_expression();return this._consume(m.tokens.paren_right,"Expected ')'."),new un([o])}_struct_decl(){if(!this._match(m.keywords.struct))return null;const o=this._currentLine,h=this._consume(m.tokens.ident,"Expected name for struct.").toString();this._consume(m.tokens.brace_left,"Expected '{' for struct body.");const y=[];for(;!this._check(m.tokens.brace_right);){const O=this._attribute(),H=this._consume(m.tokens.ident,"Expected variable name.").toString();this._consume(m.tokens.colon,"Expected ':' for struct member type.");const Y=this._attribute(),te=this._type_decl();te!=null&&(te.attributes=Y),this._check(m.tokens.brace_right)?this._match(m.tokens.comma):this._consume(m.tokens.comma,"Expected ',' for struct member."),y.push(new Ns(H,te,O))}this._consume(m.tokens.brace_right,"Expected '}' after struct body.");const w=this._currentLine,I=new ee(h,y,o,w);return this._context.structs.set(h,I),I}_global_variable_decl(){const o=this._variable_decl();return o&&this._match(m.tokens.equal)&&(o.value=this._const_expression()),o}_override_variable_decl(){const o=this._override_decl();return o&&this._match(m.tokens.equal)&&(o.value=this._const_expression()),o}_global_const_decl(){if(!this._match(m.keywords.const))return null;const o=this._consume(m.tokens.ident,"Expected variable name");let h=null;if(this._match(m.tokens.colon)){const I=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=I)}let y=null;if(this._match(m.tokens.equal)){const I=this._short_circuit_or_expression();if(I instanceof Fe)y=I;else if(I instanceof Kt&&I.initializer instanceof Fe)y=I.initializer;else try{const O=I.evaluate(this._context);y=new je(O)}catch{y=I}}const w=new K(o.toString(),h,"","",y);return this._context.constants.set(w.name,w),w}_global_let_decl(){if(!this._match(m.keywords.let))return null;const o=this._consume(m.tokens.ident,"Expected variable name");let h=null;if(this._match(m.tokens.colon)){const w=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=w)}let y=null;return this._match(m.tokens.equal)&&(y=this._const_expression()),new U(o.toString(),h,"","",y)}_const_expression(){if(this._match(m.const_literal))return new It(this._previous().toString());const o=this._type_decl();this._consume(m.tokens.paren_left,"Expected '('.");let h=[];for(;!this._check(m.tokens.paren_right)&&(h.push(this._const_expression()),!!this._check(m.tokens.comma));)this._advance();return this._consume(m.tokens.paren_right,"Expected ')'."),new Fe(o,h)}_variable_decl(){if(!this._match(m.keywords.var))return null;let o="",h="";this._match(m.tokens.less_than)&&(o=this._consume(m.storage_class,"Expected storage_class.").toString(),this._match(m.tokens.comma)&&(h=this._consume(m.access_mode,"Expected access_mode.").toString()),this._consume(m.tokens.greater_than,"Expected '>'."));const y=this._consume(m.tokens.ident,"Expected variable name");let w=null;if(this._match(m.tokens.colon)){const I=this._attribute();w=this._type_decl(),w!=null&&(w.attributes=I)}return new M(y.toString(),w,o,h,null)}_override_decl(){if(!this._match(m.keywords.override))return null;const o=this._consume(m.tokens.ident,"Expected variable name");let h=null;if(this._match(m.tokens.colon)){const y=this._attribute();h=this._type_decl(),h!=null&&(h.attributes=y)}return new F(o.toString(),h,null)}_diagnostic(){this._consume(m.tokens.paren_left,"Expected '('");const o=this._consume(m.tokens.ident,"Expected severity control name.");this._consume(m.tokens.comma,"Expected ','");const h=this._consume(m.tokens.ident,"Expected diagnostic rule name.");return this._consume(m.tokens.paren_right,"Expected ')'"),new ye(o.toString(),h.toString())}_enable_directive(){const o=this._consume(m.tokens.ident,"identity expected.");return new X(o.toString())}_requires_directive(){const o=[this._consume(m.tokens.ident,"identity expected.").toString()];for(;this._match(m.tokens.comma);){const h=this._consume(m.tokens.ident,"identity expected.");o.push(h.toString())}return new he(o)}_type_alias(){const o=this._consume(m.tokens.ident,"identity expected.");this._consume(m.tokens.equal,"Expected '=' for type alias.");let h=this._type_decl();if(h===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(h.name)&&(h=this._context.aliases.get(h.name).type);const y=new me(o.toString(),h);return this._context.aliases.set(y.name,y),y}_type_decl(){if(this._check([m.tokens.ident,...m.texel_format,m.keywords.bool,m.keywords.f32,m.keywords.i32,m.keywords.u32])){const y=this._advance(),w=y.toString();return this._context.structs.has(w)?this._context.structs.get(w):this._context.aliases.has(w)?this._context.aliases.get(w).type:new ze(y.toString())}let o=this._texture_sampler_types();if(o)return o;if(this._check(m.template_types)){let y=this._advance().toString(),w=null,I=null;return this._match(m.tokens.less_than)&&(w=this._type_decl(),I=null,this._match(m.tokens.comma)&&(I=this._consume(m.access_mode,"Expected access_mode for pointer").toString()),this._consume(m.tokens.greater_than,"Expected '>' for type.")),new Ve(y,w,I)}if(this._match(m.keywords.ptr)){let y=this._previous().toString();this._consume(m.tokens.less_than,"Expected '<' for pointer.");const w=this._consume(m.storage_class,"Expected storage_class for pointer");this._consume(m.tokens.comma,"Expected ',' for pointer.");const I=this._type_decl();let O=null;return this._match(m.tokens.comma)&&(O=this._consume(m.access_mode,"Expected access_mode for pointer").toString()),this._consume(m.tokens.greater_than,"Expected '>' for pointer."),new Ge(y,w.toString(),I,O)}const h=this._attribute();if(this._match(m.keywords.array)){let y=null,w=-1;const I=this._previous();let O=null;if(this._match(m.tokens.less_than)){y=this._type_decl(),this._context.aliases.has(y.name)&&(y=this._context.aliases.get(y.name).type);let Y="";if(this._match(m.tokens.comma)){O=this._shift_expression();try{Y=O.evaluate(this._context).toString(),O=null}catch{Y="1"}}this._consume(m.tokens.greater_than,"Expected '>' for array."),w=Y?parseInt(Y):0}const H=new De(I.toString(),h,y,w);return O&&this._deferArrayCountEval.push({arrayType:H,countNode:O}),H}return null}_texture_sampler_types(){if(this._match(m.sampler_type))return new Be(this._previous().toString(),null,null);if(this._match(m.depth_texture_type))return new Be(this._previous().toString(),null,null);if(this._match(m.sampled_texture_type)||this._match(m.multisampled_texture_type)){const o=this._previous();this._consume(m.tokens.less_than,"Expected '<' for sampler type.");const h=this._type_decl();return this._consume(m.tokens.greater_than,"Expected '>' for sampler type."),new Be(o.toString(),h,null)}if(this._match(m.storage_texture_type)){const o=this._previous();this._consume(m.tokens.less_than,"Expected '<' for sampler type.");const h=this._consume(m.texel_format,"Invalid texel format.").toString();this._consume(m.tokens.comma,"Expected ',' after texel format.");const y=this._consume(m.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(m.tokens.greater_than,"Expected '>' for sampler type."),new Be(o.toString(),h,y)}return null}_attribute(){let o=[];for(;this._match(m.tokens.attr);){const h=this._consume(m.attribute_name,"Expected attribute name"),y=new li(h.toString(),null);if(this._match(m.tokens.paren_left)){if(y.value=this._consume(m.literal_or_ident,"Expected attribute value").toString(),this._check(m.tokens.comma)){this._advance();do{const w=this._consume(m.literal_or_ident,"Expected attribute value").toString();y.value instanceof Array||(y.value=[y.value]),y.value.push(w)}while(this._match(m.tokens.comma))}this._consume(m.tokens.paren_right,"Expected ')'")}o.push(y)}return o.length==0?null:o}}class ln{constructor(o,h){this.name=o,this.attributes=h,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class cn{constructor(o,h,y){this.name=o,this.type=h,this.attributes=y,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Mt extends ln{constructor(o,h){super(o,h),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class In extends ln{constructor(o,h){super(o,h),this.count=0,this.stride=0}get isArray(){return!0}}class Vn extends ln{constructor(o,h,y,w){super(o,y),this.format=h,this.access=w}get isTemplate(){return!0}}s.ResourceType=void 0,function(L){L[L.Uniform=0]="Uniform",L[L.Storage=1]="Storage",L[L.Texture=2]="Texture",L[L.Sampler=3]="Sampler",L[L.StorageTexture=4]="StorageTexture"}(s.ResourceType||(s.ResourceType={}));class hn{constructor(o,h,y,w,I,O,H){this.name=o,this.type=h,this.group=y,this.binding=w,this.attributes=I,this.resourceType=O,this.access=H}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class us{constructor(o,h){this.name=o,this.type=h}}class Cn{constructor(o,h){this.align=o,this.size=h}}class ls{constructor(o,h,y,w){this.name=o,this.type=h,this.locationType=y,this.location=w,this.interpolation=null}}class Xn{constructor(o,h,y,w){this.name=o,this.type=h,this.locationType=y,this.location=w}}class cs{constructor(o,h=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=o,this.stage=h}}class hs{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class hi{constructor(o,h,y,w){this.name=o,this.type=h,this.attributes=y,this.id=w}}class pr{constructor(o){this.resources=null,this.inUse=!1,this.info=null,this.node=o}}class Wt{constructor(o){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new hs,this.functions=[],this._types=new Map,this._functions=new Map,o&&this.update(o)}_isStorageTexture(o){return o.name=="texture_storage_1d"||o.name=="texture_storage_2d"||o.name=="texture_storage_2d_array"||o.name=="texture_storage_3d"}update(o){const y=new Sn().parse(o);for(const w of y)w instanceof f&&this._functions.set(w.name,new pr(w));for(const w of y)if(w instanceof ee){const I=this._getTypeInfo(w,null);I instanceof Mt&&this.structs.push(I)}for(const w of y){if(w instanceof me){this.aliases.push(this._getAliasInfo(w));continue}if(w instanceof F){const I=w,O=this._getAttributeNum(I.attributes,"id",0),H=I.type!=null?this._getTypeInfo(I.type,I.attributes):null;this.overrides.push(new hi(I.name,H,I.attributes,O));continue}if(this._isUniformVar(w)){const I=w,O=this._getAttributeNum(I.attributes,"group",0),H=this._getAttributeNum(I.attributes,"binding",0),Y=this._getTypeInfo(I.type,I.attributes),te=new hn(I.name,Y,O,H,I.attributes,s.ResourceType.Uniform,I.access);this.uniforms.push(te);continue}if(this._isStorageVar(w)){const I=w,O=this._getAttributeNum(I.attributes,"group",0),H=this._getAttributeNum(I.attributes,"binding",0),Y=this._getTypeInfo(I.type,I.attributes),te=this._isStorageTexture(Y),Ie=new hn(I.name,Y,O,H,I.attributes,te?s.ResourceType.StorageTexture:s.ResourceType.Storage,I.access);this.storage.push(Ie);continue}if(this._isTextureVar(w)){const I=w,O=this._getAttributeNum(I.attributes,"group",0),H=this._getAttributeNum(I.attributes,"binding",0),Y=this._getTypeInfo(I.type,I.attributes),te=this._isStorageTexture(Y),Ie=new hn(I.name,Y,O,H,I.attributes,te?s.ResourceType.StorageTexture:s.ResourceType.Texture,I.access);te?this.storage.push(Ie):this.textures.push(Ie);continue}if(this._isSamplerVar(w)){const I=w,O=this._getAttributeNum(I.attributes,"group",0),H=this._getAttributeNum(I.attributes,"binding",0),Y=this._getTypeInfo(I.type,I.attributes),te=new hn(I.name,Y,O,H,I.attributes,s.ResourceType.Sampler,I.access);this.samplers.push(te);continue}if(w instanceof f){const I=this._getAttribute(w,"vertex"),O=this._getAttribute(w,"fragment"),H=this._getAttribute(w,"compute"),Y=I||O||H,te=new cs(w.name,Y==null?void 0:Y.name);te.startLine=w.startLine,te.endLine=w.endLine,this.functions.push(te),this._functions.get(w.name).info=te,Y&&(this._functions.get(w.name).inUse=!0,te.inUse=!0,te.resources=this._findResources(w,!!Y),te.inputs=this._getInputs(w.args),te.outputs=this._getOutputs(w.returnType),this.entry[Y.name].push(te));continue}}for(const w of this._functions.values())w.info&&(w.info.inUse=w.inUse,this._addCalls(w.node,w.info.calls));for(const w of this.uniforms)this._markStructsInUse(w.type);for(const w of this.storage)this._markStructsInUse(w.type)}_markStructsInUse(o){if(o.isStruct){o.inUse=!0;for(const h of o.members)this._markStructsInUse(h.type)}else if(o.isArray)this._markStructsInUse(o.format);else if(o.isTemplate)this._markStructsInUse(o.format);else{const h=this._getAlias(o.name);h&&this._markStructsInUse(h)}}_addCalls(o,h){var y;for(const w of o.calls){const I=(y=this._functions.get(w.name))===null||y===void 0?void 0:y.info;I&&h.add(I)}}findResource(o,h){for(const y of this.uniforms)if(y.group==o&&y.binding==h)return y;for(const y of this.storage)if(y.group==o&&y.binding==h)return y;for(const y of this.textures)if(y.group==o&&y.binding==h)return y;for(const y of this.samplers)if(y.group==o&&y.binding==h)return y;return null}_findResource(o){for(const h of this.uniforms)if(h.name==o)return h;for(const h of this.storage)if(h.name==o)return h;for(const h of this.textures)if(h.name==o)return h;for(const h of this.samplers)if(h.name==o)return h;return null}_markStructsFromAST(o){const h=this._getTypeInfo(o,null);this._markStructsInUse(h)}_findResources(o,h){const y=[],w=this,I=[];return o.search(O=>{if(O instanceof a)I.push({});else if(O instanceof l)I.pop();else if(O instanceof M){const H=O;h&&H.type!==null&&this._markStructsFromAST(H.type),I.length>0&&(I[I.length-1][H.name]=H)}else if(O instanceof Fe){const H=O;h&&H.type!==null&&this._markStructsFromAST(H.type)}else if(O instanceof U){const H=O;h&&H.type!==null&&this._markStructsFromAST(H.type),I.length>0&&(I[I.length-1][H.name]=H)}else if(O instanceof en){const H=O;if(I.length>0&&I[I.length-1][H.name])return;const Y=w._findResource(H.name);Y&&y.push(Y)}else if(O instanceof on){const H=O,Y=w._functions.get(H.name);Y&&(h&&(Y.inUse=!0),o.calls.add(Y.node),Y.resources===null&&(Y.resources=w._findResources(Y.node,h)),y.push(...Y.resources))}else if(O instanceof fe){const H=O,Y=w._functions.get(H.name);Y&&(h&&(Y.inUse=!0),o.calls.add(Y.node),Y.resources===null&&(Y.resources=w._findResources(Y.node,h)),y.push(...Y.resources))}}),[...new Map(y.map(O=>[O.name,O])).values()]}getBindGroups(){const o=[];function h(y,w){y>=o.length&&(o.length=y+1),o[y]===void 0&&(o[y]=[]),w>=o[y].length&&(o[y].length=w+1)}for(const y of this.uniforms){h(y.group,y.binding);const w=o[y.group];w[y.binding]=y}for(const y of this.storage){h(y.group,y.binding);const w=o[y.group];w[y.binding]=y}for(const y of this.textures){h(y.group,y.binding);const w=o[y.group];w[y.binding]=y}for(const y of this.samplers){h(y.group,y.binding);const w=o[y.group];w[y.binding]=y}return o}_getOutputs(o,h=void 0){if(h===void 0&&(h=[]),o instanceof ee)this._getStructOutputs(o,h);else{const y=this._getOutputInfo(o);y!==null&&h.push(y)}return h}_getStructOutputs(o,h){for(const y of o.members)if(y.type instanceof ee)this._getStructOutputs(y.type,h);else{const w=this._getAttribute(y,"location")||this._getAttribute(y,"builtin");if(w!==null){const I=this._getTypeInfo(y.type,y.type.attributes),O=this._parseInt(w.value),H=new Xn(y.name,I,w.name,O);h.push(H)}}}_getOutputInfo(o){const h=this._getAttribute(o,"location")||this._getAttribute(o,"builtin");if(h!==null){const y=this._getTypeInfo(o,o.attributes),w=this._parseInt(h.value);return new Xn("",y,h.name,w)}return null}_getInputs(o,h=void 0){h===void 0&&(h=[]);for(const y of o)if(y.type instanceof ee)this._getStructInputs(y.type,h);else{const w=this._getInputInfo(y);w!==null&&h.push(w)}return h}_getStructInputs(o,h){for(const y of o.members)if(y.type instanceof ee)this._getStructInputs(y.type,h);else{const w=this._getInputInfo(y);w!==null&&h.push(w)}}_getInputInfo(o){const h=this._getAttribute(o,"location")||this._getAttribute(o,"builtin");if(h!==null){const y=this._getAttribute(o,"interpolation"),w=this._getTypeInfo(o.type,o.attributes),I=this._parseInt(h.value),O=new ls(o.name,w,h.name,I);return y!==null&&(O.interpolation=this._parseString(y.value)),O}return null}_parseString(o){return o instanceof Array&&(o=o[0]),o}_parseInt(o){o instanceof Array&&(o=o[0]);const h=parseInt(o);return isNaN(h)?o:h}_getAlias(o){for(const h of this.aliases)if(h.name==o)return h.type;return null}_getAliasInfo(o){return new us(o.name,this._getTypeInfo(o.type,null))}_getTypeInfo(o,h){if(this._types.has(o))return this._types.get(o);if(o instanceof De){const w=o,I=this._getTypeInfo(w.format,w.attributes),O=new In(w.name,h);return O.format=I,O.count=w.count,this._types.set(o,O),this._updateTypeInfo(O),O}if(o instanceof ee){const w=o,I=new Mt(w.name,h);I.startLine=w.startLine,I.endLine=w.endLine;for(const O of w.members){const H=this._getTypeInfo(O.type,O.attributes);I.members.push(new cn(O.name,H,O.attributes))}return this._types.set(o,I),this._updateTypeInfo(I),I}if(o instanceof Be){const w=o,I=w.format instanceof ze,O=w.format?I?this._getTypeInfo(w.format,null):new ln(w.format,null):null,H=new Vn(w.name,O,h,w.access);return this._types.set(o,H),this._updateTypeInfo(H),H}if(o instanceof Ve){const w=o,I=w.format?this._getTypeInfo(w.format,null):null,O=new Vn(w.name,I,h,w.access);return this._types.set(o,O),this._updateTypeInfo(O),O}const y=new ln(o.name,h);return this._types.set(o,y),this._updateTypeInfo(y),y}_updateTypeInfo(o){var h,y;const w=this._getTypeSize(o);if(o.size=(h=w==null?void 0:w.size)!==null&&h!==void 0?h:0,o instanceof In){const I=this._getTypeSize(o.format);o.stride=(y=I==null?void 0:I.size)!==null&&y!==void 0?y:0,this._updateTypeInfo(o.format)}o instanceof Mt&&this._updateStructInfo(o)}_updateStructInfo(o){var h;let y=0,w=0,I=0,O=0;for(let H=0,Y=o.members.length;H<Y;++H){const te=o.members[H],Ie=this._getTypeSize(te);if(!Ie)continue;(h=this._getAlias(te.type.name))!==null&&h!==void 0||te.type;const ht=Ie.align,_s=Ie.size;y=this._roundUp(ht,y+w),w=_s,I=y,O=Math.max(O,ht),te.offset=y,te.size=_s,this._updateTypeInfo(te.type)}o.size=this._roundUp(O,I+w),o.align=O}_getTypeSize(o){var h;if(o==null)return null;const y=this._getAttributeNum(o.attributes,"size",0),w=this._getAttributeNum(o.attributes,"align",0);if(o instanceof cn&&(o=o.type),o instanceof ln){const I=this._getAlias(o.name);I!==null&&(o=I)}{const I=Wt._typeInfo[o.name];if(I!==void 0){const O=o.format==="f16"?2:1;return new Cn(Math.max(w,I.align/O),Math.max(y,I.size/O))}}{const I=Wt._typeInfo[o.name.substring(0,o.name.length-1)];if(I){const O=o.name[o.name.length-1]==="h"?2:1;return new Cn(Math.max(w,I.align/O),Math.max(y,I.size/O))}}if(o instanceof In){let I=o,O=8,H=8;const Y=this._getTypeSize(I.format);Y!==null&&(H=Y.size,O=Y.align);const te=I.count,Ie=this._getAttributeNum((h=o==null?void 0:o.attributes)!==null&&h!==void 0?h:null,"stride",this._roundUp(O,H));return H=te*Ie,y&&(H=y),new Cn(Math.max(w,O),Math.max(y,H))}if(o instanceof Mt){let I=0,O=0,H=0,Y=0,te=0;for(const Ie of o.members){const ht=this._getTypeSize(Ie.type);ht!==null&&(I=Math.max(ht.align,I),H=this._roundUp(ht.align,H+Y),Y=ht.size,te=H)}return O=this._roundUp(I,te+Y),new Cn(Math.max(w,I),Math.max(y,O))}return null}_isUniformVar(o){return o instanceof M&&o.storage=="uniform"}_isStorageVar(o){return o instanceof M&&o.storage=="storage"}_isTextureVar(o){return o instanceof M&&o.type!==null&&Wt._textureTypes.indexOf(o.type.name)!=-1}_isSamplerVar(o){return o instanceof M&&o.type!==null&&Wt._samplerTypes.indexOf(o.type.name)!=-1}_getAttribute(o,h){const y=o;if(!y||!y.attributes)return null;const w=y.attributes;for(let I of w)if(I.name==h)return I;return null}_getAttributeNum(o,h,y){if(o===null)return y;for(let w of o)if(w.name==h){let I=w!==null&&w.value!==null?w.value:y;return I instanceof Array&&(I=I[0]),typeof I=="number"?I:typeof I=="string"?parseInt(I):y}return y}_roundUp(o,h){return Math.ceil(h/o)*o}}Wt._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},Wt._textureTypes=m.any_texture_type.map(L=>L.name),Wt._samplerTypes=m.sampler_type.map(L=>L.name),s.Alias=me,s.AliasInfo=us,s.Argument=ui,s.ArrayIndex=Tn,s.ArrayInfo=In,s.ArrayType=De,s.Assign=G,s.Attribute=li,s.BinaryOperator=et,s.BitcastExpr=$n,s.Break=$e,s.Call=fe,s.CallExpr=on,s.Case=ct,s.Const=K,s.ConstExpr=Kt,s.Continue=St,s.Continuing=C,s.CreateExpr=Fe,s.Default=An,s.Diagnostic=ye,s.Discard=rt,s.ElseIf=Ct,s.Enable=X,s.EntryFunctions=hs,s.Expression=Qe,s.For=S,s.Function=f,s.FunctionInfo=cs,s.GroupingExpr=un,s.If=ue,s.Increment=q,s.InputInfo=ls,s.Let=U,s.LiteralExpr=je,s.Loop=oe,s.Member=Ns,s.MemberInfo=cn,s.Node=n,s.Operator=Os,s.OutputInfo=Xn,s.Override=F,s.OverrideInfo=hi,s.ParseContext=i,s.PointerType=Ge,s.Requires=he,s.Return=Q,s.SamplerType=Be,s.Statement=c,s.StaticAssert=g,s.StringExpr=It,s.Struct=ee,s.StructInfo=Mt,s.Switch=re,s.SwitchCase=os,s.TemplateInfo=Vn,s.TemplateType=Ve,s.Token=En,s.TokenType=k,s.TokenTypes=m,s.Type=ze,s.TypeInfo=ln,s.TypecastExpr=oi,s.UnaryOperator=Hn,s.Var=M,s.VariableExpr=en,s.VariableInfo=hn,s.WgslParser=Sn,s.WgslReflect=Wt,s.WgslScanner=ci,s.While=b,s._BlockEnd=l,s._BlockStart=a})(is);const We={Uniform:0,Storage:1,Texture:2,Sampler:3,StorageTexture:4},Ms=class Ms{constructor(){P(this,"module",null);P(this,"code",null);P(this,"file_path","");P(this,"defines",{});P(this,"reflection",null)}static register_shader_path(i){Ms.shader_paths.push(i)}initialize(i,n){let a=this._load_shader_text(n);if(a)try{this.code=a,this.module=i.device.createShaderModule({label:n,code:a}),this.file_path=n,this.reflection=this.reflect()}catch(l){console.error(`WebGPU shader error: could not create shader module at ${n}`,l)}}reflect(){return new is.WgslReflect(this.code)}_load_shader_text(i,n=0){let a=null;for(const l of Ms.shader_paths)try{const c=new URL(`${l}/${i}`,window.location.href),f=new XMLHttpRequest;if(f.open("GET",c.href,!1),f.send(null),f.status===200){a=f.responseText;break}}catch(c){console.warn(`Failed to load shader from ${l}/${i}:`,c)}if(!a)return console.error(`WebGPU shader error: could not find shader at ${i}`),null;if(a=this._parse_shader_includes(a,n),n===0){const{defines_map:l,stripped_code:c}=this._build_defines_map_and_strip(a);a=c,this.defines=l,a=this._parse_conditional_defines(a)}return a}_parse_shader_includes(i,n=0){let a=[],l=i.indexOf("#include",0);for(;l!==-1;)a.push(l),l=i.indexOf("#include",l+1);const c=/^#include\s+"(\S+)".*$/m;for(let f=a.length-1;f>=0;--f){const g=a[f],b=i.indexOf(`
`,g),S=i.substring(g,b).match(c);if(S){const M=this._load_shader_text(S[1],n+1);i=i.slice(0,g)+M+i.slice(b)}}return i}_build_defines_map_and_strip(i){const n={},a=/#define\s+(\S+)(?:\s+(\S*))?$/gm,l=i.replace(a,(c,f,g)=>(n[f]=g||!0,""));return{defines_map:n,stripped_code:l}}_parse_conditional_defines(i){let n="",a=0,l;const c=/#(if|ifndef)\s+(\S+)(?:\s+(\S+))?$/gm;for(;(l=c.exec(i))!==null;){const[f,g,b,C]=l,S=l.index,M=i.indexOf("#endif",S);if(M===-1){console.warn(`Unmatched #${g} at position ${S}`);continue}if(n+=i.slice(a,S),g==="if"?this.defines[b]===(C||!0):!this.defines[b]){const U=i.slice(S,M).replace(f,"").trim();n+=U}a=M+6}return n+=i.slice(a),n.trim()}static create(i,n){let a=$.get().fetch(W.SHADER,n);return a||(a=new Ms,a.initialize(i,n),$.get().store(W.SHADER,n,a)),a}static resource_type_from_reflection_type(i){switch(i){case is.ResourceType.Texture:return We.Texture;case is.ResourceType.Sampler:return We.Sampler;case is.ResourceType.Storage:return We.Storage;case is.ResourceType.Uniform:return We.Uniform;case is.ResourceType.StorageTexture:return We.StorageTexture;default:throw new Error(`Unknown binding type: ${i}`)}}static get_optimal_texture_format(i){switch(i){case"f32":return"bgra8unorm";case"vec4<f32>":case"vec4f":return"bgra8unorm";case"vec4<u32>":case"vec4u":return"rgba32uint";case"vec4<i32>":case"vec4i":return"rgba32sint";case"vec2<f32>":case"vec2f":return"rg32float";case"u32":case"u":return"r32uint";case"i32":case"i":return"r32sint";case"f16":return"rgba16float";case"vec4<f16>":case"vec4f16":return"rgba16float";case"vec2<f16>":case"vec2f16":return"rg16float";case"u16":case"u16":return"r16uint";case"i16":case"i16":return"r16sint";case"vec4<unorm>":case"vec4unorm":return"rgba8unorm";case"vec4<snorm>":case"vec4snorm":return"rgba8snorm";case"vec4<u8>":case"vec4u8":return"rgba8uint";case"vec4<i8>":case"vec4i8":return"rgba8sint";default:return"rgba8unorm"}}};P(Ms,"shader_paths",["engine/shaders"]);let Jt=Ms;var or={exports:{}};/**
 * @license
 * Lodash <https://lodash.com/>
 * Copyright OpenJS Foundation and other contributors <https://openjsf.org/>
 * Released under MIT license <https://lodash.com/license>
 * Based on Underscore.js 1.8.3 <http://underscorejs.org/LICENSE>
 * Copyright Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 */or.exports;(function(s,i){(function(){var n,a="4.17.21",l=200,c="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",f="Expected a function",g="Invalid `variable` option passed into `_.template`",b="__lodash_hash_undefined__",C=500,S="__lodash_placeholder__",M=1,F=2,U=4,K=1,q=2,G=1,fe=2,oe=4,re=8,ue=16,Q=32,X=64,he=128,ye=256,me=512,rt=30,$e="...",St=800,ze=16,ee=1,Ve=2,Ge=3,De=1/0,Be=9007199254740991,Qe=17976931348623157e292,It=NaN,Fe=4294967295,on=Fe-1,en=Fe>>>1,Kt=[["ary",he],["bind",G],["bindKey",fe],["curry",re],["curryRight",ue],["flip",me],["partial",Q],["partialRight",X],["rearg",ye]],je="[object Arguments]",$n="[object Array]",oi="[object AsyncFunction]",un="[object Boolean]",Tn="[object Date]",Os="[object DOMException]",Hn="[object Error]",et="[object Function]",os="[object GeneratorFunction]",ct="[object Map]",An="[object Number]",ui="[object Null]",Ct="[object Object]",Ns="[object Promise]",li="[object Proxy]",E="[object RegExp]",k="[object Set]",m="[object String]",En="[object Symbol]",ci="[object Undefined]",Sn="[object WeakMap]",ln="[object WeakSet]",cn="[object ArrayBuffer]",Mt="[object DataView]",In="[object Float32Array]",Vn="[object Float64Array]",hn="[object Int8Array]",us="[object Int16Array]",Cn="[object Int32Array]",ls="[object Uint8Array]",Xn="[object Uint8ClampedArray]",cs="[object Uint16Array]",hs="[object Uint32Array]",hi=/\b__p \+= '';/g,pr=/\b(__p \+=) '' \+/g,Wt=/(__e\(.*?\)|\b__t\)) \+\n'';/g,L=/&(?:amp|lt|gt|quot|#39);/g,o=/[&<>"']/g,h=RegExp(L.source),y=RegExp(o.source),w=/<%-([\s\S]+?)%>/g,I=/<%([\s\S]+?)%>/g,O=/<%=([\s\S]+?)%>/g,H=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,Y=/^\w*$/,te=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Ie=/[\\^$.*+?()[\]{}|]/g,ht=RegExp(Ie.source),_s=/^\s+/,Wl=/\s/,$l=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,Hl=/\{\n\/\* \[wrapped with (.+)\] \*/,Vl=/,? & /,Xl=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,Yl=/[()=,{}\[\]\/\s]/,Zl=/\\(\\)?/g,Jl=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,za=/\w*$/,Ql=/^[-+]0x[0-9a-f]+$/i,jl=/^0b[01]+$/i,ec=/^\[object .+?Constructor\]$/,tc=/^0o[0-7]+$/i,nc=/^(?:0|[1-9]\d*)$/,sc=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,_i=/($^)/,ic=/['\n\r\u2028\u2029\\]/g,fi="\\ud800-\\udfff",rc="\\u0300-\\u036f",ac="\\ufe20-\\ufe2f",oc="\\u20d0-\\u20ff",Ga=rc+ac+oc,Da="\\u2700-\\u27bf",qa="a-z\\xdf-\\xf6\\xf8-\\xff",uc="\\xac\\xb1\\xd7\\xf7",lc="\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf",cc="\\u2000-\\u206f",hc=" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Ka="A-Z\\xc0-\\xd6\\xd8-\\xde",Wa="\\ufe0e\\ufe0f",$a=uc+lc+cc+hc,gr="['’]",_c="["+fi+"]",Ha="["+$a+"]",di="["+Ga+"]",Va="\\d+",fc="["+Da+"]",Xa="["+qa+"]",Ya="[^"+fi+$a+Va+Da+qa+Ka+"]",mr="\\ud83c[\\udffb-\\udfff]",dc="(?:"+di+"|"+mr+")",Za="[^"+fi+"]",yr="(?:\\ud83c[\\udde6-\\uddff]){2}",vr="[\\ud800-\\udbff][\\udc00-\\udfff]",fs="["+Ka+"]",Ja="\\u200d",Qa="(?:"+Xa+"|"+Ya+")",pc="(?:"+fs+"|"+Ya+")",ja="(?:"+gr+"(?:d|ll|m|re|s|t|ve))?",eo="(?:"+gr+"(?:D|LL|M|RE|S|T|VE))?",to=dc+"?",no="["+Wa+"]?",gc="(?:"+Ja+"(?:"+[Za,yr,vr].join("|")+")"+no+to+")*",mc="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",yc="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",so=no+to+gc,vc="(?:"+[fc,yr,vr].join("|")+")"+so,wc="(?:"+[Za+di+"?",di,yr,vr,_c].join("|")+")",bc=RegExp(gr,"g"),xc=RegExp(di,"g"),wr=RegExp(mr+"(?="+mr+")|"+wc+so,"g"),kc=RegExp([fs+"?"+Xa+"+"+ja+"(?="+[Ha,fs,"$"].join("|")+")",pc+"+"+eo+"(?="+[Ha,fs+Qa,"$"].join("|")+")",fs+"?"+Qa+"+"+ja,fs+"+"+eo,yc,mc,Va,vc].join("|"),"g"),Tc=RegExp("["+Ja+fi+Ga+Wa+"]"),Ac=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,Ec=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],Sc=-1,Ce={};Ce[In]=Ce[Vn]=Ce[hn]=Ce[us]=Ce[Cn]=Ce[ls]=Ce[Xn]=Ce[cs]=Ce[hs]=!0,Ce[je]=Ce[$n]=Ce[cn]=Ce[un]=Ce[Mt]=Ce[Tn]=Ce[Hn]=Ce[et]=Ce[ct]=Ce[An]=Ce[Ct]=Ce[E]=Ce[k]=Ce[m]=Ce[Sn]=!1;var Se={};Se[je]=Se[$n]=Se[cn]=Se[Mt]=Se[un]=Se[Tn]=Se[In]=Se[Vn]=Se[hn]=Se[us]=Se[Cn]=Se[ct]=Se[An]=Se[Ct]=Se[E]=Se[k]=Se[m]=Se[En]=Se[ls]=Se[Xn]=Se[cs]=Se[hs]=!0,Se[Hn]=Se[et]=Se[Sn]=!1;var Ic={À:"A",Á:"A",Â:"A",Ã:"A",Ä:"A",Å:"A",à:"a",á:"a",â:"a",ã:"a",ä:"a",å:"a",Ç:"C",ç:"c",Ð:"D",ð:"d",È:"E",É:"E",Ê:"E",Ë:"E",è:"e",é:"e",ê:"e",ë:"e",Ì:"I",Í:"I",Î:"I",Ï:"I",ì:"i",í:"i",î:"i",ï:"i",Ñ:"N",ñ:"n",Ò:"O",Ó:"O",Ô:"O",Õ:"O",Ö:"O",Ø:"O",ò:"o",ó:"o",ô:"o",õ:"o",ö:"o",ø:"o",Ù:"U",Ú:"U",Û:"U",Ü:"U",ù:"u",ú:"u",û:"u",ü:"u",Ý:"Y",ý:"y",ÿ:"y",Æ:"Ae",æ:"ae",Þ:"Th",þ:"th",ß:"ss",Ā:"A",Ă:"A",Ą:"A",ā:"a",ă:"a",ą:"a",Ć:"C",Ĉ:"C",Ċ:"C",Č:"C",ć:"c",ĉ:"c",ċ:"c",č:"c",Ď:"D",Đ:"D",ď:"d",đ:"d",Ē:"E",Ĕ:"E",Ė:"E",Ę:"E",Ě:"E",ē:"e",ĕ:"e",ė:"e",ę:"e",ě:"e",Ĝ:"G",Ğ:"G",Ġ:"G",Ģ:"G",ĝ:"g",ğ:"g",ġ:"g",ģ:"g",Ĥ:"H",Ħ:"H",ĥ:"h",ħ:"h",Ĩ:"I",Ī:"I",Ĭ:"I",Į:"I",İ:"I",ĩ:"i",ī:"i",ĭ:"i",į:"i",ı:"i",Ĵ:"J",ĵ:"j",Ķ:"K",ķ:"k",ĸ:"k",Ĺ:"L",Ļ:"L",Ľ:"L",Ŀ:"L",Ł:"L",ĺ:"l",ļ:"l",ľ:"l",ŀ:"l",ł:"l",Ń:"N",Ņ:"N",Ň:"N",Ŋ:"N",ń:"n",ņ:"n",ň:"n",ŋ:"n",Ō:"O",Ŏ:"O",Ő:"O",ō:"o",ŏ:"o",ő:"o",Ŕ:"R",Ŗ:"R",Ř:"R",ŕ:"r",ŗ:"r",ř:"r",Ś:"S",Ŝ:"S",Ş:"S",Š:"S",ś:"s",ŝ:"s",ş:"s",š:"s",Ţ:"T",Ť:"T",Ŧ:"T",ţ:"t",ť:"t",ŧ:"t",Ũ:"U",Ū:"U",Ŭ:"U",Ů:"U",Ű:"U",Ų:"U",ũ:"u",ū:"u",ŭ:"u",ů:"u",ű:"u",ų:"u",Ŵ:"W",ŵ:"w",Ŷ:"Y",ŷ:"y",Ÿ:"Y",Ź:"Z",Ż:"Z",Ž:"Z",ź:"z",ż:"z",ž:"z",Ĳ:"IJ",ĳ:"ij",Œ:"Oe",œ:"oe",ŉ:"'n",ſ:"s"},Cc={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Mc={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},Rc={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},Uc=parseFloat,Bc=parseInt,io=typeof ei=="object"&&ei&&ei.Object===Object&&ei,Fc=typeof self=="object"&&self&&self.Object===Object&&self,Xe=io||Fc||Function("return this")(),br=i&&!i.nodeType&&i,Yn=br&&!0&&s&&!s.nodeType&&s,ro=Yn&&Yn.exports===br,xr=ro&&io.process,Rt=function(){try{var T=Yn&&Yn.require&&Yn.require("util").types;return T||xr&&xr.binding&&xr.binding("util")}catch{}}(),ao=Rt&&Rt.isArrayBuffer,oo=Rt&&Rt.isDate,uo=Rt&&Rt.isMap,lo=Rt&&Rt.isRegExp,co=Rt&&Rt.isSet,ho=Rt&&Rt.isTypedArray;function vt(T,B,R){switch(R.length){case 0:return T.call(B);case 1:return T.call(B,R[0]);case 2:return T.call(B,R[0],R[1]);case 3:return T.call(B,R[0],R[1],R[2])}return T.apply(B,R)}function Pc(T,B,R,Z){for(var le=-1,xe=T==null?0:T.length;++le<xe;){var qe=T[le];B(Z,qe,R(qe),T)}return Z}function Ut(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z&&B(T[R],R,T)!==!1;);return T}function Lc(T,B){for(var R=T==null?0:T.length;R--&&B(T[R],R,T)!==!1;);return T}function _o(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z;)if(!B(T[R],R,T))return!1;return!0}function Mn(T,B){for(var R=-1,Z=T==null?0:T.length,le=0,xe=[];++R<Z;){var qe=T[R];B(qe,R,T)&&(xe[le++]=qe)}return xe}function pi(T,B){var R=T==null?0:T.length;return!!R&&ds(T,B,0)>-1}function kr(T,B,R){for(var Z=-1,le=T==null?0:T.length;++Z<le;)if(R(B,T[Z]))return!0;return!1}function Me(T,B){for(var R=-1,Z=T==null?0:T.length,le=Array(Z);++R<Z;)le[R]=B(T[R],R,T);return le}function Rn(T,B){for(var R=-1,Z=B.length,le=T.length;++R<Z;)T[le+R]=B[R];return T}function Tr(T,B,R,Z){var le=-1,xe=T==null?0:T.length;for(Z&&xe&&(R=T[++le]);++le<xe;)R=B(R,T[le],le,T);return R}function Oc(T,B,R,Z){var le=T==null?0:T.length;for(Z&&le&&(R=T[--le]);le--;)R=B(R,T[le],le,T);return R}function Ar(T,B){for(var R=-1,Z=T==null?0:T.length;++R<Z;)if(B(T[R],R,T))return!0;return!1}var Nc=Er("length");function zc(T){return T.split("")}function Gc(T){return T.match(Xl)||[]}function fo(T,B,R){var Z;return R(T,function(le,xe,qe){if(B(le,xe,qe))return Z=xe,!1}),Z}function gi(T,B,R,Z){for(var le=T.length,xe=R+(Z?1:-1);Z?xe--:++xe<le;)if(B(T[xe],xe,T))return xe;return-1}function ds(T,B,R){return B===B?Qc(T,B,R):gi(T,po,R)}function Dc(T,B,R,Z){for(var le=R-1,xe=T.length;++le<xe;)if(Z(T[le],B))return le;return-1}function po(T){return T!==T}function go(T,B){var R=T==null?0:T.length;return R?Ir(T,B)/R:It}function Er(T){return function(B){return B==null?n:B[T]}}function Sr(T){return function(B){return T==null?n:T[B]}}function mo(T,B,R,Z,le){return le(T,function(xe,qe,Ae){R=Z?(Z=!1,xe):B(R,xe,qe,Ae)}),R}function qc(T,B){var R=T.length;for(T.sort(B);R--;)T[R]=T[R].value;return T}function Ir(T,B){for(var R,Z=-1,le=T.length;++Z<le;){var xe=B(T[Z]);xe!==n&&(R=R===n?xe:R+xe)}return R}function Cr(T,B){for(var R=-1,Z=Array(T);++R<T;)Z[R]=B(R);return Z}function Kc(T,B){return Me(B,function(R){return[R,T[R]]})}function yo(T){return T&&T.slice(0,xo(T)+1).replace(_s,"")}function wt(T){return function(B){return T(B)}}function Mr(T,B){return Me(B,function(R){return T[R]})}function zs(T,B){return T.has(B)}function vo(T,B){for(var R=-1,Z=T.length;++R<Z&&ds(B,T[R],0)>-1;);return R}function wo(T,B){for(var R=T.length;R--&&ds(B,T[R],0)>-1;);return R}function Wc(T,B){for(var R=T.length,Z=0;R--;)T[R]===B&&++Z;return Z}var $c=Sr(Ic),Hc=Sr(Cc);function Vc(T){return"\\"+Rc[T]}function Xc(T,B){return T==null?n:T[B]}function ps(T){return Tc.test(T)}function Yc(T){return Ac.test(T)}function Zc(T){for(var B,R=[];!(B=T.next()).done;)R.push(B.value);return R}function Rr(T){var B=-1,R=Array(T.size);return T.forEach(function(Z,le){R[++B]=[le,Z]}),R}function bo(T,B){return function(R){return T(B(R))}}function Un(T,B){for(var R=-1,Z=T.length,le=0,xe=[];++R<Z;){var qe=T[R];(qe===B||qe===S)&&(T[R]=S,xe[le++]=R)}return xe}function mi(T){var B=-1,R=Array(T.size);return T.forEach(function(Z){R[++B]=Z}),R}function Jc(T){var B=-1,R=Array(T.size);return T.forEach(function(Z){R[++B]=[Z,Z]}),R}function Qc(T,B,R){for(var Z=R-1,le=T.length;++Z<le;)if(T[Z]===B)return Z;return-1}function jc(T,B,R){for(var Z=R+1;Z--;)if(T[Z]===B)return Z;return Z}function gs(T){return ps(T)?th(T):Nc(T)}function $t(T){return ps(T)?nh(T):zc(T)}function xo(T){for(var B=T.length;B--&&Wl.test(T.charAt(B)););return B}var eh=Sr(Mc);function th(T){for(var B=wr.lastIndex=0;wr.test(T);)++B;return B}function nh(T){return T.match(wr)||[]}function sh(T){return T.match(kc)||[]}var ih=function T(B){B=B==null?Xe:ms.defaults(Xe.Object(),B,ms.pick(Xe,Ec));var R=B.Array,Z=B.Date,le=B.Error,xe=B.Function,qe=B.Math,Ae=B.Object,Ur=B.RegExp,rh=B.String,Bt=B.TypeError,yi=R.prototype,ah=xe.prototype,ys=Ae.prototype,vi=B["__core-js_shared__"],wi=ah.toString,Te=ys.hasOwnProperty,oh=0,ko=function(){var e=/[^.]+$/.exec(vi&&vi.keys&&vi.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),bi=ys.toString,uh=wi.call(Ae),lh=Xe._,ch=Ur("^"+wi.call(Te).replace(Ie,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),xi=ro?B.Buffer:n,Bn=B.Symbol,ki=B.Uint8Array,To=xi?xi.allocUnsafe:n,Ti=bo(Ae.getPrototypeOf,Ae),Ao=Ae.create,Eo=ys.propertyIsEnumerable,Ai=yi.splice,So=Bn?Bn.isConcatSpreadable:n,Gs=Bn?Bn.iterator:n,Zn=Bn?Bn.toStringTag:n,Ei=function(){try{var e=ts(Ae,"defineProperty");return e({},"",{}),e}catch{}}(),hh=B.clearTimeout!==Xe.clearTimeout&&B.clearTimeout,_h=Z&&Z.now!==Xe.Date.now&&Z.now,fh=B.setTimeout!==Xe.setTimeout&&B.setTimeout,Si=qe.ceil,Ii=qe.floor,Br=Ae.getOwnPropertySymbols,dh=xi?xi.isBuffer:n,Io=B.isFinite,ph=yi.join,gh=bo(Ae.keys,Ae),Ke=qe.max,tt=qe.min,mh=Z.now,yh=B.parseInt,Co=qe.random,vh=yi.reverse,Fr=ts(B,"DataView"),Ds=ts(B,"Map"),Pr=ts(B,"Promise"),vs=ts(B,"Set"),qs=ts(B,"WeakMap"),Ks=ts(Ae,"create"),Ci=qs&&new qs,ws={},wh=ns(Fr),bh=ns(Ds),xh=ns(Pr),kh=ns(vs),Th=ns(qs),Mi=Bn?Bn.prototype:n,Ws=Mi?Mi.valueOf:n,Mo=Mi?Mi.toString:n;function d(e){if(Pe(e)&&!ce(e)&&!(e instanceof we)){if(e instanceof Ft)return e;if(Te.call(e,"__wrapped__"))return Ru(e)}return new Ft(e)}var bs=function(){function e(){}return function(t){if(!Ue(t))return{};if(Ao)return Ao(t);e.prototype=t;var r=new e;return e.prototype=n,r}}();function Ri(){}function Ft(e,t){this.__wrapped__=e,this.__actions__=[],this.__chain__=!!t,this.__index__=0,this.__values__=n}d.templateSettings={escape:w,evaluate:I,interpolate:O,variable:"",imports:{_:d}},d.prototype=Ri.prototype,d.prototype.constructor=d,Ft.prototype=bs(Ri.prototype),Ft.prototype.constructor=Ft;function we(e){this.__wrapped__=e,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Fe,this.__views__=[]}function Ah(){var e=new we(this.__wrapped__);return e.__actions__=_t(this.__actions__),e.__dir__=this.__dir__,e.__filtered__=this.__filtered__,e.__iteratees__=_t(this.__iteratees__),e.__takeCount__=this.__takeCount__,e.__views__=_t(this.__views__),e}function Eh(){if(this.__filtered__){var e=new we(this);e.__dir__=-1,e.__filtered__=!0}else e=this.clone(),e.__dir__*=-1;return e}function Sh(){var e=this.__wrapped__.value(),t=this.__dir__,r=ce(e),u=t<0,_=r?e.length:0,p=z_(0,_,this.__views__),v=p.start,x=p.end,A=x-v,N=u?x:v-1,z=this.__iteratees__,D=z.length,V=0,j=tt(A,this.__takeCount__);if(!r||!u&&_==A&&j==A)return eu(e,this.__actions__);var se=[];e:for(;A--&&V<j;){N+=t;for(var de=-1,ie=e[N];++de<D;){var ve=z[de],be=ve.iteratee,kt=ve.type,ut=be(ie);if(kt==Ve)ie=ut;else if(!ut){if(kt==ee)continue e;break e}}se[V++]=ie}return se}we.prototype=bs(Ri.prototype),we.prototype.constructor=we;function Jn(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var u=e[t];this.set(u[0],u[1])}}function Ih(){this.__data__=Ks?Ks(null):{},this.size=0}function Ch(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}function Mh(e){var t=this.__data__;if(Ks){var r=t[e];return r===b?n:r}return Te.call(t,e)?t[e]:n}function Rh(e){var t=this.__data__;return Ks?t[e]!==n:Te.call(t,e)}function Uh(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=Ks&&t===n?b:t,this}Jn.prototype.clear=Ih,Jn.prototype.delete=Ch,Jn.prototype.get=Mh,Jn.prototype.has=Rh,Jn.prototype.set=Uh;function _n(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var u=e[t];this.set(u[0],u[1])}}function Bh(){this.__data__=[],this.size=0}function Fh(e){var t=this.__data__,r=Ui(t,e);if(r<0)return!1;var u=t.length-1;return r==u?t.pop():Ai.call(t,r,1),--this.size,!0}function Ph(e){var t=this.__data__,r=Ui(t,e);return r<0?n:t[r][1]}function Lh(e){return Ui(this.__data__,e)>-1}function Oh(e,t){var r=this.__data__,u=Ui(r,e);return u<0?(++this.size,r.push([e,t])):r[u][1]=t,this}_n.prototype.clear=Bh,_n.prototype.delete=Fh,_n.prototype.get=Ph,_n.prototype.has=Lh,_n.prototype.set=Oh;function fn(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var u=e[t];this.set(u[0],u[1])}}function Nh(){this.size=0,this.__data__={hash:new Jn,map:new(Ds||_n),string:new Jn}}function zh(e){var t=Wi(this,e).delete(e);return this.size-=t?1:0,t}function Gh(e){return Wi(this,e).get(e)}function Dh(e){return Wi(this,e).has(e)}function qh(e,t){var r=Wi(this,e),u=r.size;return r.set(e,t),this.size+=r.size==u?0:1,this}fn.prototype.clear=Nh,fn.prototype.delete=zh,fn.prototype.get=Gh,fn.prototype.has=Dh,fn.prototype.set=qh;function Qn(e){var t=-1,r=e==null?0:e.length;for(this.__data__=new fn;++t<r;)this.add(e[t])}function Kh(e){return this.__data__.set(e,b),this}function Wh(e){return this.__data__.has(e)}Qn.prototype.add=Qn.prototype.push=Kh,Qn.prototype.has=Wh;function Ht(e){var t=this.__data__=new _n(e);this.size=t.size}function $h(){this.__data__=new _n,this.size=0}function Hh(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}function Vh(e){return this.__data__.get(e)}function Xh(e){return this.__data__.has(e)}function Yh(e,t){var r=this.__data__;if(r instanceof _n){var u=r.__data__;if(!Ds||u.length<l-1)return u.push([e,t]),this.size=++r.size,this;r=this.__data__=new fn(u)}return r.set(e,t),this.size=r.size,this}Ht.prototype.clear=$h,Ht.prototype.delete=Hh,Ht.prototype.get=Vh,Ht.prototype.has=Xh,Ht.prototype.set=Yh;function Ro(e,t){var r=ce(e),u=!r&&ss(e),_=!r&&!u&&Nn(e),p=!r&&!u&&!_&&As(e),v=r||u||_||p,x=v?Cr(e.length,rh):[],A=x.length;for(var N in e)(t||Te.call(e,N))&&!(v&&(N=="length"||_&&(N=="offset"||N=="parent")||p&&(N=="buffer"||N=="byteLength"||N=="byteOffset")||mn(N,A)))&&x.push(N);return x}function Uo(e){var t=e.length;return t?e[Hr(0,t-1)]:n}function Zh(e,t){return $i(_t(e),jn(t,0,e.length))}function Jh(e){return $i(_t(e))}function Lr(e,t,r){(r!==n&&!Vt(e[t],r)||r===n&&!(t in e))&&dn(e,t,r)}function $s(e,t,r){var u=e[t];(!(Te.call(e,t)&&Vt(u,r))||r===n&&!(t in e))&&dn(e,t,r)}function Ui(e,t){for(var r=e.length;r--;)if(Vt(e[r][0],t))return r;return-1}function Qh(e,t,r,u){return Fn(e,function(_,p,v){t(u,_,r(_),v)}),u}function Bo(e,t){return e&&nn(t,He(t),e)}function jh(e,t){return e&&nn(t,dt(t),e)}function dn(e,t,r){t=="__proto__"&&Ei?Ei(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}function Or(e,t){for(var r=-1,u=t.length,_=R(u),p=e==null;++r<u;)_[r]=p?n:ma(e,t[r]);return _}function jn(e,t,r){return e===e&&(r!==n&&(e=e<=r?e:r),t!==n&&(e=e>=t?e:t)),e}function Pt(e,t,r,u,_,p){var v,x=t&M,A=t&F,N=t&U;if(r&&(v=_?r(e,u,_,p):r(e)),v!==n)return v;if(!Ue(e))return e;var z=ce(e);if(z){if(v=D_(e),!x)return _t(e,v)}else{var D=nt(e),V=D==et||D==os;if(Nn(e))return su(e,x);if(D==Ct||D==je||V&&!_){if(v=A||V?{}:xu(e),!x)return A?M_(e,jh(v,e)):C_(e,Bo(v,e))}else{if(!Se[D])return _?e:{};v=q_(e,D,x)}}p||(p=new Ht);var j=p.get(e);if(j)return j;p.set(e,v),Ju(e)?e.forEach(function(ie){v.add(Pt(ie,t,r,ie,e,p))}):Yu(e)&&e.forEach(function(ie,ve){v.set(ve,Pt(ie,t,r,ve,e,p))});var se=N?A?sa:na:A?dt:He,de=z?n:se(e);return Ut(de||e,function(ie,ve){de&&(ve=ie,ie=e[ve]),$s(v,ve,Pt(ie,t,r,ve,e,p))}),v}function e_(e){var t=He(e);return function(r){return Fo(r,e,t)}}function Fo(e,t,r){var u=r.length;if(e==null)return!u;for(e=Ae(e);u--;){var _=r[u],p=t[_],v=e[_];if(v===n&&!(_ in e)||!p(v))return!1}return!0}function Po(e,t,r){if(typeof e!="function")throw new Bt(f);return Qs(function(){e.apply(n,r)},t)}function Hs(e,t,r,u){var _=-1,p=pi,v=!0,x=e.length,A=[],N=t.length;if(!x)return A;r&&(t=Me(t,wt(r))),u?(p=kr,v=!1):t.length>=l&&(p=zs,v=!1,t=new Qn(t));e:for(;++_<x;){var z=e[_],D=r==null?z:r(z);if(z=u||z!==0?z:0,v&&D===D){for(var V=N;V--;)if(t[V]===D)continue e;A.push(z)}else p(t,D,u)||A.push(z)}return A}var Fn=uu(tn),Lo=uu(zr,!0);function t_(e,t){var r=!0;return Fn(e,function(u,_,p){return r=!!t(u,_,p),r}),r}function Bi(e,t,r){for(var u=-1,_=e.length;++u<_;){var p=e[u],v=t(p);if(v!=null&&(x===n?v===v&&!xt(v):r(v,x)))var x=v,A=p}return A}function n_(e,t,r,u){var _=e.length;for(r=_e(r),r<0&&(r=-r>_?0:_+r),u=u===n||u>_?_:_e(u),u<0&&(u+=_),u=r>u?0:ju(u);r<u;)e[r++]=t;return e}function Oo(e,t){var r=[];return Fn(e,function(u,_,p){t(u,_,p)&&r.push(u)}),r}function Ye(e,t,r,u,_){var p=-1,v=e.length;for(r||(r=W_),_||(_=[]);++p<v;){var x=e[p];t>0&&r(x)?t>1?Ye(x,t-1,r,u,_):Rn(_,x):u||(_[_.length]=x)}return _}var Nr=lu(),No=lu(!0);function tn(e,t){return e&&Nr(e,t,He)}function zr(e,t){return e&&No(e,t,He)}function Fi(e,t){return Mn(t,function(r){return yn(e[r])})}function es(e,t){t=Ln(t,e);for(var r=0,u=t.length;e!=null&&r<u;)e=e[sn(t[r++])];return r&&r==u?e:n}function zo(e,t,r){var u=t(e);return ce(e)?u:Rn(u,r(e))}function at(e){return e==null?e===n?ci:ui:Zn&&Zn in Ae(e)?N_(e):J_(e)}function Gr(e,t){return e>t}function s_(e,t){return e!=null&&Te.call(e,t)}function i_(e,t){return e!=null&&t in Ae(e)}function r_(e,t,r){return e>=tt(t,r)&&e<Ke(t,r)}function Dr(e,t,r){for(var u=r?kr:pi,_=e[0].length,p=e.length,v=p,x=R(p),A=1/0,N=[];v--;){var z=e[v];v&&t&&(z=Me(z,wt(t))),A=tt(z.length,A),x[v]=!r&&(t||_>=120&&z.length>=120)?new Qn(v&&z):n}z=e[0];var D=-1,V=x[0];e:for(;++D<_&&N.length<A;){var j=z[D],se=t?t(j):j;if(j=r||j!==0?j:0,!(V?zs(V,se):u(N,se,r))){for(v=p;--v;){var de=x[v];if(!(de?zs(de,se):u(e[v],se,r)))continue e}V&&V.push(se),N.push(j)}}return N}function a_(e,t,r,u){return tn(e,function(_,p,v){t(u,r(_),p,v)}),u}function Vs(e,t,r){t=Ln(t,e),e=Eu(e,t);var u=e==null?e:e[sn(Ot(t))];return u==null?n:vt(u,e,r)}function Go(e){return Pe(e)&&at(e)==je}function o_(e){return Pe(e)&&at(e)==cn}function u_(e){return Pe(e)&&at(e)==Tn}function Xs(e,t,r,u,_){return e===t?!0:e==null||t==null||!Pe(e)&&!Pe(t)?e!==e&&t!==t:l_(e,t,r,u,Xs,_)}function l_(e,t,r,u,_,p){var v=ce(e),x=ce(t),A=v?$n:nt(e),N=x?$n:nt(t);A=A==je?Ct:A,N=N==je?Ct:N;var z=A==Ct,D=N==Ct,V=A==N;if(V&&Nn(e)){if(!Nn(t))return!1;v=!0,z=!1}if(V&&!z)return p||(p=new Ht),v||As(e)?vu(e,t,r,u,_,p):L_(e,t,A,r,u,_,p);if(!(r&K)){var j=z&&Te.call(e,"__wrapped__"),se=D&&Te.call(t,"__wrapped__");if(j||se){var de=j?e.value():e,ie=se?t.value():t;return p||(p=new Ht),_(de,ie,r,u,p)}}return V?(p||(p=new Ht),O_(e,t,r,u,_,p)):!1}function c_(e){return Pe(e)&&nt(e)==ct}function qr(e,t,r,u){var _=r.length,p=_,v=!u;if(e==null)return!p;for(e=Ae(e);_--;){var x=r[_];if(v&&x[2]?x[1]!==e[x[0]]:!(x[0]in e))return!1}for(;++_<p;){x=r[_];var A=x[0],N=e[A],z=x[1];if(v&&x[2]){if(N===n&&!(A in e))return!1}else{var D=new Ht;if(u)var V=u(N,z,A,e,t,D);if(!(V===n?Xs(z,N,K|q,u,D):V))return!1}}return!0}function Do(e){if(!Ue(e)||H_(e))return!1;var t=yn(e)?ch:ec;return t.test(ns(e))}function h_(e){return Pe(e)&&at(e)==E}function __(e){return Pe(e)&&nt(e)==k}function f_(e){return Pe(e)&&Ji(e.length)&&!!Ce[at(e)]}function qo(e){return typeof e=="function"?e:e==null?pt:typeof e=="object"?ce(e)?$o(e[0],e[1]):Wo(e):cl(e)}function Kr(e){if(!Js(e))return gh(e);var t=[];for(var r in Ae(e))Te.call(e,r)&&r!="constructor"&&t.push(r);return t}function d_(e){if(!Ue(e))return Z_(e);var t=Js(e),r=[];for(var u in e)u=="constructor"&&(t||!Te.call(e,u))||r.push(u);return r}function Wr(e,t){return e<t}function Ko(e,t){var r=-1,u=ft(e)?R(e.length):[];return Fn(e,function(_,p,v){u[++r]=t(_,p,v)}),u}function Wo(e){var t=ra(e);return t.length==1&&t[0][2]?Tu(t[0][0],t[0][1]):function(r){return r===e||qr(r,e,t)}}function $o(e,t){return oa(e)&&ku(t)?Tu(sn(e),t):function(r){var u=ma(r,e);return u===n&&u===t?ya(r,e):Xs(t,u,K|q)}}function Pi(e,t,r,u,_){e!==t&&Nr(t,function(p,v){if(_||(_=new Ht),Ue(p))p_(e,t,v,r,Pi,u,_);else{var x=u?u(la(e,v),p,v+"",e,t,_):n;x===n&&(x=p),Lr(e,v,x)}},dt)}function p_(e,t,r,u,_,p,v){var x=la(e,r),A=la(t,r),N=v.get(A);if(N){Lr(e,r,N);return}var z=p?p(x,A,r+"",e,t,v):n,D=z===n;if(D){var V=ce(A),j=!V&&Nn(A),se=!V&&!j&&As(A);z=A,V||j||se?ce(x)?z=x:Le(x)?z=_t(x):j?(D=!1,z=su(A,!0)):se?(D=!1,z=iu(A,!0)):z=[]:js(A)||ss(A)?(z=x,ss(x)?z=el(x):(!Ue(x)||yn(x))&&(z=xu(A))):D=!1}D&&(v.set(A,z),_(z,A,u,p,v),v.delete(A)),Lr(e,r,z)}function Ho(e,t){var r=e.length;if(r)return t+=t<0?r:0,mn(t,r)?e[t]:n}function Vo(e,t,r){t.length?t=Me(t,function(p){return ce(p)?function(v){return es(v,p.length===1?p[0]:p)}:p}):t=[pt];var u=-1;t=Me(t,wt(ne()));var _=Ko(e,function(p,v,x){var A=Me(t,function(N){return N(p)});return{criteria:A,index:++u,value:p}});return qc(_,function(p,v){return I_(p,v,r)})}function g_(e,t){return Xo(e,t,function(r,u){return ya(e,u)})}function Xo(e,t,r){for(var u=-1,_=t.length,p={};++u<_;){var v=t[u],x=es(e,v);r(x,v)&&Ys(p,Ln(v,e),x)}return p}function m_(e){return function(t){return es(t,e)}}function $r(e,t,r,u){var _=u?Dc:ds,p=-1,v=t.length,x=e;for(e===t&&(t=_t(t)),r&&(x=Me(e,wt(r)));++p<v;)for(var A=0,N=t[p],z=r?r(N):N;(A=_(x,z,A,u))>-1;)x!==e&&Ai.call(x,A,1),Ai.call(e,A,1);return e}function Yo(e,t){for(var r=e?t.length:0,u=r-1;r--;){var _=t[r];if(r==u||_!==p){var p=_;mn(_)?Ai.call(e,_,1):Yr(e,_)}}return e}function Hr(e,t){return e+Ii(Co()*(t-e+1))}function y_(e,t,r,u){for(var _=-1,p=Ke(Si((t-e)/(r||1)),0),v=R(p);p--;)v[u?p:++_]=e,e+=r;return v}function Vr(e,t){var r="";if(!e||t<1||t>Be)return r;do t%2&&(r+=e),t=Ii(t/2),t&&(e+=e);while(t);return r}function ge(e,t){return ca(Au(e,t,pt),e+"")}function v_(e){return Uo(Es(e))}function w_(e,t){var r=Es(e);return $i(r,jn(t,0,r.length))}function Ys(e,t,r,u){if(!Ue(e))return e;t=Ln(t,e);for(var _=-1,p=t.length,v=p-1,x=e;x!=null&&++_<p;){var A=sn(t[_]),N=r;if(A==="__proto__"||A==="constructor"||A==="prototype")return e;if(_!=v){var z=x[A];N=u?u(z,A,x):n,N===n&&(N=Ue(z)?z:mn(t[_+1])?[]:{})}$s(x,A,N),x=x[A]}return e}var Zo=Ci?function(e,t){return Ci.set(e,t),e}:pt,b_=Ei?function(e,t){return Ei(e,"toString",{configurable:!0,enumerable:!1,value:wa(t),writable:!0})}:pt;function x_(e){return $i(Es(e))}function Lt(e,t,r){var u=-1,_=e.length;t<0&&(t=-t>_?0:_+t),r=r>_?_:r,r<0&&(r+=_),_=t>r?0:r-t>>>0,t>>>=0;for(var p=R(_);++u<_;)p[u]=e[u+t];return p}function k_(e,t){var r;return Fn(e,function(u,_,p){return r=t(u,_,p),!r}),!!r}function Li(e,t,r){var u=0,_=e==null?u:e.length;if(typeof t=="number"&&t===t&&_<=en){for(;u<_;){var p=u+_>>>1,v=e[p];v!==null&&!xt(v)&&(r?v<=t:v<t)?u=p+1:_=p}return _}return Xr(e,t,pt,r)}function Xr(e,t,r,u){var _=0,p=e==null?0:e.length;if(p===0)return 0;t=r(t);for(var v=t!==t,x=t===null,A=xt(t),N=t===n;_<p;){var z=Ii((_+p)/2),D=r(e[z]),V=D!==n,j=D===null,se=D===D,de=xt(D);if(v)var ie=u||se;else N?ie=se&&(u||V):x?ie=se&&V&&(u||!j):A?ie=se&&V&&!j&&(u||!de):j||de?ie=!1:ie=u?D<=t:D<t;ie?_=z+1:p=z}return tt(p,on)}function Jo(e,t){for(var r=-1,u=e.length,_=0,p=[];++r<u;){var v=e[r],x=t?t(v):v;if(!r||!Vt(x,A)){var A=x;p[_++]=v===0?0:v}}return p}function Qo(e){return typeof e=="number"?e:xt(e)?It:+e}function bt(e){if(typeof e=="string")return e;if(ce(e))return Me(e,bt)+"";if(xt(e))return Mo?Mo.call(e):"";var t=e+"";return t=="0"&&1/e==-De?"-0":t}function Pn(e,t,r){var u=-1,_=pi,p=e.length,v=!0,x=[],A=x;if(r)v=!1,_=kr;else if(p>=l){var N=t?null:F_(e);if(N)return mi(N);v=!1,_=zs,A=new Qn}else A=t?[]:x;e:for(;++u<p;){var z=e[u],D=t?t(z):z;if(z=r||z!==0?z:0,v&&D===D){for(var V=A.length;V--;)if(A[V]===D)continue e;t&&A.push(D),x.push(z)}else _(A,D,r)||(A!==x&&A.push(D),x.push(z))}return x}function Yr(e,t){return t=Ln(t,e),e=Eu(e,t),e==null||delete e[sn(Ot(t))]}function jo(e,t,r,u){return Ys(e,t,r(es(e,t)),u)}function Oi(e,t,r,u){for(var _=e.length,p=u?_:-1;(u?p--:++p<_)&&t(e[p],p,e););return r?Lt(e,u?0:p,u?p+1:_):Lt(e,u?p+1:0,u?_:p)}function eu(e,t){var r=e;return r instanceof we&&(r=r.value()),Tr(t,function(u,_){return _.func.apply(_.thisArg,Rn([u],_.args))},r)}function Zr(e,t,r){var u=e.length;if(u<2)return u?Pn(e[0]):[];for(var _=-1,p=R(u);++_<u;)for(var v=e[_],x=-1;++x<u;)x!=_&&(p[_]=Hs(p[_]||v,e[x],t,r));return Pn(Ye(p,1),t,r)}function tu(e,t,r){for(var u=-1,_=e.length,p=t.length,v={};++u<_;){var x=u<p?t[u]:n;r(v,e[u],x)}return v}function Jr(e){return Le(e)?e:[]}function Qr(e){return typeof e=="function"?e:pt}function Ln(e,t){return ce(e)?e:oa(e,t)?[e]:Mu(ke(e))}var T_=ge;function On(e,t,r){var u=e.length;return r=r===n?u:r,!t&&r>=u?e:Lt(e,t,r)}var nu=hh||function(e){return Xe.clearTimeout(e)};function su(e,t){if(t)return e.slice();var r=e.length,u=To?To(r):new e.constructor(r);return e.copy(u),u}function jr(e){var t=new e.constructor(e.byteLength);return new ki(t).set(new ki(e)),t}function A_(e,t){var r=t?jr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}function E_(e){var t=new e.constructor(e.source,za.exec(e));return t.lastIndex=e.lastIndex,t}function S_(e){return Ws?Ae(Ws.call(e)):{}}function iu(e,t){var r=t?jr(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}function ru(e,t){if(e!==t){var r=e!==n,u=e===null,_=e===e,p=xt(e),v=t!==n,x=t===null,A=t===t,N=xt(t);if(!x&&!N&&!p&&e>t||p&&v&&A&&!x&&!N||u&&v&&A||!r&&A||!_)return 1;if(!u&&!p&&!N&&e<t||N&&r&&_&&!u&&!p||x&&r&&_||!v&&_||!A)return-1}return 0}function I_(e,t,r){for(var u=-1,_=e.criteria,p=t.criteria,v=_.length,x=r.length;++u<v;){var A=ru(_[u],p[u]);if(A){if(u>=x)return A;var N=r[u];return A*(N=="desc"?-1:1)}}return e.index-t.index}function au(e,t,r,u){for(var _=-1,p=e.length,v=r.length,x=-1,A=t.length,N=Ke(p-v,0),z=R(A+N),D=!u;++x<A;)z[x]=t[x];for(;++_<v;)(D||_<p)&&(z[r[_]]=e[_]);for(;N--;)z[x++]=e[_++];return z}function ou(e,t,r,u){for(var _=-1,p=e.length,v=-1,x=r.length,A=-1,N=t.length,z=Ke(p-x,0),D=R(z+N),V=!u;++_<z;)D[_]=e[_];for(var j=_;++A<N;)D[j+A]=t[A];for(;++v<x;)(V||_<p)&&(D[j+r[v]]=e[_++]);return D}function _t(e,t){var r=-1,u=e.length;for(t||(t=R(u));++r<u;)t[r]=e[r];return t}function nn(e,t,r,u){var _=!r;r||(r={});for(var p=-1,v=t.length;++p<v;){var x=t[p],A=u?u(r[x],e[x],x,r,e):n;A===n&&(A=e[x]),_?dn(r,x,A):$s(r,x,A)}return r}function C_(e,t){return nn(e,aa(e),t)}function M_(e,t){return nn(e,wu(e),t)}function Ni(e,t){return function(r,u){var _=ce(r)?Pc:Qh,p=t?t():{};return _(r,e,ne(u,2),p)}}function xs(e){return ge(function(t,r){var u=-1,_=r.length,p=_>1?r[_-1]:n,v=_>2?r[2]:n;for(p=e.length>3&&typeof p=="function"?(_--,p):n,v&&ot(r[0],r[1],v)&&(p=_<3?n:p,_=1),t=Ae(t);++u<_;){var x=r[u];x&&e(t,x,u,p)}return t})}function uu(e,t){return function(r,u){if(r==null)return r;if(!ft(r))return e(r,u);for(var _=r.length,p=t?_:-1,v=Ae(r);(t?p--:++p<_)&&u(v[p],p,v)!==!1;);return r}}function lu(e){return function(t,r,u){for(var _=-1,p=Ae(t),v=u(t),x=v.length;x--;){var A=v[e?x:++_];if(r(p[A],A,p)===!1)break}return t}}function R_(e,t,r){var u=t&G,_=Zs(e);function p(){var v=this&&this!==Xe&&this instanceof p?_:e;return v.apply(u?r:this,arguments)}return p}function cu(e){return function(t){t=ke(t);var r=ps(t)?$t(t):n,u=r?r[0]:t.charAt(0),_=r?On(r,1).join(""):t.slice(1);return u[e]()+_}}function ks(e){return function(t){return Tr(ul(ol(t).replace(bc,"")),e,"")}}function Zs(e){return function(){var t=arguments;switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3]);case 5:return new e(t[0],t[1],t[2],t[3],t[4]);case 6:return new e(t[0],t[1],t[2],t[3],t[4],t[5]);case 7:return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6])}var r=bs(e.prototype),u=e.apply(r,t);return Ue(u)?u:r}}function U_(e,t,r){var u=Zs(e);function _(){for(var p=arguments.length,v=R(p),x=p,A=Ts(_);x--;)v[x]=arguments[x];var N=p<3&&v[0]!==A&&v[p-1]!==A?[]:Un(v,A);if(p-=N.length,p<r)return pu(e,t,zi,_.placeholder,n,v,N,n,n,r-p);var z=this&&this!==Xe&&this instanceof _?u:e;return vt(z,this,v)}return _}function hu(e){return function(t,r,u){var _=Ae(t);if(!ft(t)){var p=ne(r,3);t=He(t),r=function(x){return p(_[x],x,_)}}var v=e(t,r,u);return v>-1?_[p?t[v]:v]:n}}function _u(e){return gn(function(t){var r=t.length,u=r,_=Ft.prototype.thru;for(e&&t.reverse();u--;){var p=t[u];if(typeof p!="function")throw new Bt(f);if(_&&!v&&Ki(p)=="wrapper")var v=new Ft([],!0)}for(u=v?u:r;++u<r;){p=t[u];var x=Ki(p),A=x=="wrapper"?ia(p):n;A&&ua(A[0])&&A[1]==(he|re|Q|ye)&&!A[4].length&&A[9]==1?v=v[Ki(A[0])].apply(v,A[3]):v=p.length==1&&ua(p)?v[x]():v.thru(p)}return function(){var N=arguments,z=N[0];if(v&&N.length==1&&ce(z))return v.plant(z).value();for(var D=0,V=r?t[D].apply(this,N):z;++D<r;)V=t[D].call(this,V);return V}})}function zi(e,t,r,u,_,p,v,x,A,N){var z=t&he,D=t&G,V=t&fe,j=t&(re|ue),se=t&me,de=V?n:Zs(e);function ie(){for(var ve=arguments.length,be=R(ve),kt=ve;kt--;)be[kt]=arguments[kt];if(j)var ut=Ts(ie),Tt=Wc(be,ut);if(u&&(be=au(be,u,_,j)),p&&(be=ou(be,p,v,j)),ve-=Tt,j&&ve<N){var Oe=Un(be,ut);return pu(e,t,zi,ie.placeholder,r,be,Oe,x,A,N-ve)}var Xt=D?r:this,wn=V?Xt[e]:e;return ve=be.length,x?be=Q_(be,x):se&&ve>1&&be.reverse(),z&&A<ve&&(be.length=A),this&&this!==Xe&&this instanceof ie&&(wn=de||Zs(wn)),wn.apply(Xt,be)}return ie}function fu(e,t){return function(r,u){return a_(r,e,t(u),{})}}function Gi(e,t){return function(r,u){var _;if(r===n&&u===n)return t;if(r!==n&&(_=r),u!==n){if(_===n)return u;typeof r=="string"||typeof u=="string"?(r=bt(r),u=bt(u)):(r=Qo(r),u=Qo(u)),_=e(r,u)}return _}}function ea(e){return gn(function(t){return t=Me(t,wt(ne())),ge(function(r){var u=this;return e(t,function(_){return vt(_,u,r)})})})}function Di(e,t){t=t===n?" ":bt(t);var r=t.length;if(r<2)return r?Vr(t,e):t;var u=Vr(t,Si(e/gs(t)));return ps(t)?On($t(u),0,e).join(""):u.slice(0,e)}function B_(e,t,r,u){var _=t&G,p=Zs(e);function v(){for(var x=-1,A=arguments.length,N=-1,z=u.length,D=R(z+A),V=this&&this!==Xe&&this instanceof v?p:e;++N<z;)D[N]=u[N];for(;A--;)D[N++]=arguments[++x];return vt(V,_?r:this,D)}return v}function du(e){return function(t,r,u){return u&&typeof u!="number"&&ot(t,r,u)&&(r=u=n),t=vn(t),r===n?(r=t,t=0):r=vn(r),u=u===n?t<r?1:-1:vn(u),y_(t,r,u,e)}}function qi(e){return function(t,r){return typeof t=="string"&&typeof r=="string"||(t=Nt(t),r=Nt(r)),e(t,r)}}function pu(e,t,r,u,_,p,v,x,A,N){var z=t&re,D=z?v:n,V=z?n:v,j=z?p:n,se=z?n:p;t|=z?Q:X,t&=~(z?X:Q),t&oe||(t&=~(G|fe));var de=[e,t,_,j,D,se,V,x,A,N],ie=r.apply(n,de);return ua(e)&&Su(ie,de),ie.placeholder=u,Iu(ie,e,t)}function ta(e){var t=qe[e];return function(r,u){if(r=Nt(r),u=u==null?0:tt(_e(u),292),u&&Io(r)){var _=(ke(r)+"e").split("e"),p=t(_[0]+"e"+(+_[1]+u));return _=(ke(p)+"e").split("e"),+(_[0]+"e"+(+_[1]-u))}return t(r)}}var F_=vs&&1/mi(new vs([,-0]))[1]==De?function(e){return new vs(e)}:ka;function gu(e){return function(t){var r=nt(t);return r==ct?Rr(t):r==k?Jc(t):Kc(t,e(t))}}function pn(e,t,r,u,_,p,v,x){var A=t&fe;if(!A&&typeof e!="function")throw new Bt(f);var N=u?u.length:0;if(N||(t&=~(Q|X),u=_=n),v=v===n?v:Ke(_e(v),0),x=x===n?x:_e(x),N-=_?_.length:0,t&X){var z=u,D=_;u=_=n}var V=A?n:ia(e),j=[e,t,r,u,_,z,D,p,v,x];if(V&&Y_(j,V),e=j[0],t=j[1],r=j[2],u=j[3],_=j[4],x=j[9]=j[9]===n?A?0:e.length:Ke(j[9]-N,0),!x&&t&(re|ue)&&(t&=~(re|ue)),!t||t==G)var se=R_(e,t,r);else t==re||t==ue?se=U_(e,t,x):(t==Q||t==(G|Q))&&!_.length?se=B_(e,t,r,u):se=zi.apply(n,j);var de=V?Zo:Su;return Iu(de(se,j),e,t)}function mu(e,t,r,u){return e===n||Vt(e,ys[r])&&!Te.call(u,r)?t:e}function yu(e,t,r,u,_,p){return Ue(e)&&Ue(t)&&(p.set(t,e),Pi(e,t,n,yu,p),p.delete(t)),e}function P_(e){return js(e)?n:e}function vu(e,t,r,u,_,p){var v=r&K,x=e.length,A=t.length;if(x!=A&&!(v&&A>x))return!1;var N=p.get(e),z=p.get(t);if(N&&z)return N==t&&z==e;var D=-1,V=!0,j=r&q?new Qn:n;for(p.set(e,t),p.set(t,e);++D<x;){var se=e[D],de=t[D];if(u)var ie=v?u(de,se,D,t,e,p):u(se,de,D,e,t,p);if(ie!==n){if(ie)continue;V=!1;break}if(j){if(!Ar(t,function(ve,be){if(!zs(j,be)&&(se===ve||_(se,ve,r,u,p)))return j.push(be)})){V=!1;break}}else if(!(se===de||_(se,de,r,u,p))){V=!1;break}}return p.delete(e),p.delete(t),V}function L_(e,t,r,u,_,p,v){switch(r){case Mt:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case cn:return!(e.byteLength!=t.byteLength||!p(new ki(e),new ki(t)));case un:case Tn:case An:return Vt(+e,+t);case Hn:return e.name==t.name&&e.message==t.message;case E:case m:return e==t+"";case ct:var x=Rr;case k:var A=u&K;if(x||(x=mi),e.size!=t.size&&!A)return!1;var N=v.get(e);if(N)return N==t;u|=q,v.set(e,t);var z=vu(x(e),x(t),u,_,p,v);return v.delete(e),z;case En:if(Ws)return Ws.call(e)==Ws.call(t)}return!1}function O_(e,t,r,u,_,p){var v=r&K,x=na(e),A=x.length,N=na(t),z=N.length;if(A!=z&&!v)return!1;for(var D=A;D--;){var V=x[D];if(!(v?V in t:Te.call(t,V)))return!1}var j=p.get(e),se=p.get(t);if(j&&se)return j==t&&se==e;var de=!0;p.set(e,t),p.set(t,e);for(var ie=v;++D<A;){V=x[D];var ve=e[V],be=t[V];if(u)var kt=v?u(be,ve,V,t,e,p):u(ve,be,V,e,t,p);if(!(kt===n?ve===be||_(ve,be,r,u,p):kt)){de=!1;break}ie||(ie=V=="constructor")}if(de&&!ie){var ut=e.constructor,Tt=t.constructor;ut!=Tt&&"constructor"in e&&"constructor"in t&&!(typeof ut=="function"&&ut instanceof ut&&typeof Tt=="function"&&Tt instanceof Tt)&&(de=!1)}return p.delete(e),p.delete(t),de}function gn(e){return ca(Au(e,n,Fu),e+"")}function na(e){return zo(e,He,aa)}function sa(e){return zo(e,dt,wu)}var ia=Ci?function(e){return Ci.get(e)}:ka;function Ki(e){for(var t=e.name+"",r=ws[t],u=Te.call(ws,t)?r.length:0;u--;){var _=r[u],p=_.func;if(p==null||p==e)return _.name}return t}function Ts(e){var t=Te.call(d,"placeholder")?d:e;return t.placeholder}function ne(){var e=d.iteratee||ba;return e=e===ba?qo:e,arguments.length?e(arguments[0],arguments[1]):e}function Wi(e,t){var r=e.__data__;return $_(t)?r[typeof t=="string"?"string":"hash"]:r.map}function ra(e){for(var t=He(e),r=t.length;r--;){var u=t[r],_=e[u];t[r]=[u,_,ku(_)]}return t}function ts(e,t){var r=Xc(e,t);return Do(r)?r:n}function N_(e){var t=Te.call(e,Zn),r=e[Zn];try{e[Zn]=n;var u=!0}catch{}var _=bi.call(e);return u&&(t?e[Zn]=r:delete e[Zn]),_}var aa=Br?function(e){return e==null?[]:(e=Ae(e),Mn(Br(e),function(t){return Eo.call(e,t)}))}:Ta,wu=Br?function(e){for(var t=[];e;)Rn(t,aa(e)),e=Ti(e);return t}:Ta,nt=at;(Fr&&nt(new Fr(new ArrayBuffer(1)))!=Mt||Ds&&nt(new Ds)!=ct||Pr&&nt(Pr.resolve())!=Ns||vs&&nt(new vs)!=k||qs&&nt(new qs)!=Sn)&&(nt=function(e){var t=at(e),r=t==Ct?e.constructor:n,u=r?ns(r):"";if(u)switch(u){case wh:return Mt;case bh:return ct;case xh:return Ns;case kh:return k;case Th:return Sn}return t});function z_(e,t,r){for(var u=-1,_=r.length;++u<_;){var p=r[u],v=p.size;switch(p.type){case"drop":e+=v;break;case"dropRight":t-=v;break;case"take":t=tt(t,e+v);break;case"takeRight":e=Ke(e,t-v);break}}return{start:e,end:t}}function G_(e){var t=e.match(Hl);return t?t[1].split(Vl):[]}function bu(e,t,r){t=Ln(t,e);for(var u=-1,_=t.length,p=!1;++u<_;){var v=sn(t[u]);if(!(p=e!=null&&r(e,v)))break;e=e[v]}return p||++u!=_?p:(_=e==null?0:e.length,!!_&&Ji(_)&&mn(v,_)&&(ce(e)||ss(e)))}function D_(e){var t=e.length,r=new e.constructor(t);return t&&typeof e[0]=="string"&&Te.call(e,"index")&&(r.index=e.index,r.input=e.input),r}function xu(e){return typeof e.constructor=="function"&&!Js(e)?bs(Ti(e)):{}}function q_(e,t,r){var u=e.constructor;switch(t){case cn:return jr(e);case un:case Tn:return new u(+e);case Mt:return A_(e,r);case In:case Vn:case hn:case us:case Cn:case ls:case Xn:case cs:case hs:return iu(e,r);case ct:return new u;case An:case m:return new u(e);case E:return E_(e);case k:return new u;case En:return S_(e)}}function K_(e,t){var r=t.length;if(!r)return e;var u=r-1;return t[u]=(r>1?"& ":"")+t[u],t=t.join(r>2?", ":" "),e.replace($l,`{
/* [wrapped with `+t+`] */
`)}function W_(e){return ce(e)||ss(e)||!!(So&&e&&e[So])}function mn(e,t){var r=typeof e;return t=t??Be,!!t&&(r=="number"||r!="symbol"&&nc.test(e))&&e>-1&&e%1==0&&e<t}function ot(e,t,r){if(!Ue(r))return!1;var u=typeof t;return(u=="number"?ft(r)&&mn(t,r.length):u=="string"&&t in r)?Vt(r[t],e):!1}function oa(e,t){if(ce(e))return!1;var r=typeof e;return r=="number"||r=="symbol"||r=="boolean"||e==null||xt(e)?!0:Y.test(e)||!H.test(e)||t!=null&&e in Ae(t)}function $_(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}function ua(e){var t=Ki(e),r=d[t];if(typeof r!="function"||!(t in we.prototype))return!1;if(e===r)return!0;var u=ia(r);return!!u&&e===u[0]}function H_(e){return!!ko&&ko in e}var V_=vi?yn:Aa;function Js(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||ys;return e===r}function ku(e){return e===e&&!Ue(e)}function Tu(e,t){return function(r){return r==null?!1:r[e]===t&&(t!==n||e in Ae(r))}}function X_(e){var t=Yi(e,function(u){return r.size===C&&r.clear(),u}),r=t.cache;return t}function Y_(e,t){var r=e[1],u=t[1],_=r|u,p=_<(G|fe|he),v=u==he&&r==re||u==he&&r==ye&&e[7].length<=t[8]||u==(he|ye)&&t[7].length<=t[8]&&r==re;if(!(p||v))return e;u&G&&(e[2]=t[2],_|=r&G?0:oe);var x=t[3];if(x){var A=e[3];e[3]=A?au(A,x,t[4]):x,e[4]=A?Un(e[3],S):t[4]}return x=t[5],x&&(A=e[5],e[5]=A?ou(A,x,t[6]):x,e[6]=A?Un(e[5],S):t[6]),x=t[7],x&&(e[7]=x),u&he&&(e[8]=e[8]==null?t[8]:tt(e[8],t[8])),e[9]==null&&(e[9]=t[9]),e[0]=t[0],e[1]=_,e}function Z_(e){var t=[];if(e!=null)for(var r in Ae(e))t.push(r);return t}function J_(e){return bi.call(e)}function Au(e,t,r){return t=Ke(t===n?e.length-1:t,0),function(){for(var u=arguments,_=-1,p=Ke(u.length-t,0),v=R(p);++_<p;)v[_]=u[t+_];_=-1;for(var x=R(t+1);++_<t;)x[_]=u[_];return x[t]=r(v),vt(e,this,x)}}function Eu(e,t){return t.length<2?e:es(e,Lt(t,0,-1))}function Q_(e,t){for(var r=e.length,u=tt(t.length,r),_=_t(e);u--;){var p=t[u];e[u]=mn(p,r)?_[p]:n}return e}function la(e,t){if(!(t==="constructor"&&typeof e[t]=="function")&&t!="__proto__")return e[t]}var Su=Cu(Zo),Qs=fh||function(e,t){return Xe.setTimeout(e,t)},ca=Cu(b_);function Iu(e,t,r){var u=t+"";return ca(e,K_(u,j_(G_(u),r)))}function Cu(e){var t=0,r=0;return function(){var u=mh(),_=ze-(u-r);if(r=u,_>0){if(++t>=St)return arguments[0]}else t=0;return e.apply(n,arguments)}}function $i(e,t){var r=-1,u=e.length,_=u-1;for(t=t===n?u:t;++r<t;){var p=Hr(r,_),v=e[p];e[p]=e[r],e[r]=v}return e.length=t,e}var Mu=X_(function(e){var t=[];return e.charCodeAt(0)===46&&t.push(""),e.replace(te,function(r,u,_,p){t.push(_?p.replace(Zl,"$1"):u||r)}),t});function sn(e){if(typeof e=="string"||xt(e))return e;var t=e+"";return t=="0"&&1/e==-De?"-0":t}function ns(e){if(e!=null){try{return wi.call(e)}catch{}try{return e+""}catch{}}return""}function j_(e,t){return Ut(Kt,function(r){var u="_."+r[0];t&r[1]&&!pi(e,u)&&e.push(u)}),e.sort()}function Ru(e){if(e instanceof we)return e.clone();var t=new Ft(e.__wrapped__,e.__chain__);return t.__actions__=_t(e.__actions__),t.__index__=e.__index__,t.__values__=e.__values__,t}function ef(e,t,r){(r?ot(e,t,r):t===n)?t=1:t=Ke(_e(t),0);var u=e==null?0:e.length;if(!u||t<1)return[];for(var _=0,p=0,v=R(Si(u/t));_<u;)v[p++]=Lt(e,_,_+=t);return v}function tf(e){for(var t=-1,r=e==null?0:e.length,u=0,_=[];++t<r;){var p=e[t];p&&(_[u++]=p)}return _}function nf(){var e=arguments.length;if(!e)return[];for(var t=R(e-1),r=arguments[0],u=e;u--;)t[u-1]=arguments[u];return Rn(ce(r)?_t(r):[r],Ye(t,1))}var sf=ge(function(e,t){return Le(e)?Hs(e,Ye(t,1,Le,!0)):[]}),rf=ge(function(e,t){var r=Ot(t);return Le(r)&&(r=n),Le(e)?Hs(e,Ye(t,1,Le,!0),ne(r,2)):[]}),af=ge(function(e,t){var r=Ot(t);return Le(r)&&(r=n),Le(e)?Hs(e,Ye(t,1,Le,!0),n,r):[]});function of(e,t,r){var u=e==null?0:e.length;return u?(t=r||t===n?1:_e(t),Lt(e,t<0?0:t,u)):[]}function uf(e,t,r){var u=e==null?0:e.length;return u?(t=r||t===n?1:_e(t),t=u-t,Lt(e,0,t<0?0:t)):[]}function lf(e,t){return e&&e.length?Oi(e,ne(t,3),!0,!0):[]}function cf(e,t){return e&&e.length?Oi(e,ne(t,3),!0):[]}function hf(e,t,r,u){var _=e==null?0:e.length;return _?(r&&typeof r!="number"&&ot(e,t,r)&&(r=0,u=_),n_(e,t,r,u)):[]}function Uu(e,t,r){var u=e==null?0:e.length;if(!u)return-1;var _=r==null?0:_e(r);return _<0&&(_=Ke(u+_,0)),gi(e,ne(t,3),_)}function Bu(e,t,r){var u=e==null?0:e.length;if(!u)return-1;var _=u-1;return r!==n&&(_=_e(r),_=r<0?Ke(u+_,0):tt(_,u-1)),gi(e,ne(t,3),_,!0)}function Fu(e){var t=e==null?0:e.length;return t?Ye(e,1):[]}function _f(e){var t=e==null?0:e.length;return t?Ye(e,De):[]}function ff(e,t){var r=e==null?0:e.length;return r?(t=t===n?1:_e(t),Ye(e,t)):[]}function df(e){for(var t=-1,r=e==null?0:e.length,u={};++t<r;){var _=e[t];u[_[0]]=_[1]}return u}function Pu(e){return e&&e.length?e[0]:n}function pf(e,t,r){var u=e==null?0:e.length;if(!u)return-1;var _=r==null?0:_e(r);return _<0&&(_=Ke(u+_,0)),ds(e,t,_)}function gf(e){var t=e==null?0:e.length;return t?Lt(e,0,-1):[]}var mf=ge(function(e){var t=Me(e,Jr);return t.length&&t[0]===e[0]?Dr(t):[]}),yf=ge(function(e){var t=Ot(e),r=Me(e,Jr);return t===Ot(r)?t=n:r.pop(),r.length&&r[0]===e[0]?Dr(r,ne(t,2)):[]}),vf=ge(function(e){var t=Ot(e),r=Me(e,Jr);return t=typeof t=="function"?t:n,t&&r.pop(),r.length&&r[0]===e[0]?Dr(r,n,t):[]});function wf(e,t){return e==null?"":ph.call(e,t)}function Ot(e){var t=e==null?0:e.length;return t?e[t-1]:n}function bf(e,t,r){var u=e==null?0:e.length;if(!u)return-1;var _=u;return r!==n&&(_=_e(r),_=_<0?Ke(u+_,0):tt(_,u-1)),t===t?jc(e,t,_):gi(e,po,_,!0)}function xf(e,t){return e&&e.length?Ho(e,_e(t)):n}var kf=ge(Lu);function Lu(e,t){return e&&e.length&&t&&t.length?$r(e,t):e}function Tf(e,t,r){return e&&e.length&&t&&t.length?$r(e,t,ne(r,2)):e}function Af(e,t,r){return e&&e.length&&t&&t.length?$r(e,t,n,r):e}var Ef=gn(function(e,t){var r=e==null?0:e.length,u=Or(e,t);return Yo(e,Me(t,function(_){return mn(_,r)?+_:_}).sort(ru)),u});function Sf(e,t){var r=[];if(!(e&&e.length))return r;var u=-1,_=[],p=e.length;for(t=ne(t,3);++u<p;){var v=e[u];t(v,u,e)&&(r.push(v),_.push(u))}return Yo(e,_),r}function ha(e){return e==null?e:vh.call(e)}function If(e,t,r){var u=e==null?0:e.length;return u?(r&&typeof r!="number"&&ot(e,t,r)?(t=0,r=u):(t=t==null?0:_e(t),r=r===n?u:_e(r)),Lt(e,t,r)):[]}function Cf(e,t){return Li(e,t)}function Mf(e,t,r){return Xr(e,t,ne(r,2))}function Rf(e,t){var r=e==null?0:e.length;if(r){var u=Li(e,t);if(u<r&&Vt(e[u],t))return u}return-1}function Uf(e,t){return Li(e,t,!0)}function Bf(e,t,r){return Xr(e,t,ne(r,2),!0)}function Ff(e,t){var r=e==null?0:e.length;if(r){var u=Li(e,t,!0)-1;if(Vt(e[u],t))return u}return-1}function Pf(e){return e&&e.length?Jo(e):[]}function Lf(e,t){return e&&e.length?Jo(e,ne(t,2)):[]}function Of(e){var t=e==null?0:e.length;return t?Lt(e,1,t):[]}function Nf(e,t,r){return e&&e.length?(t=r||t===n?1:_e(t),Lt(e,0,t<0?0:t)):[]}function zf(e,t,r){var u=e==null?0:e.length;return u?(t=r||t===n?1:_e(t),t=u-t,Lt(e,t<0?0:t,u)):[]}function Gf(e,t){return e&&e.length?Oi(e,ne(t,3),!1,!0):[]}function Df(e,t){return e&&e.length?Oi(e,ne(t,3)):[]}var qf=ge(function(e){return Pn(Ye(e,1,Le,!0))}),Kf=ge(function(e){var t=Ot(e);return Le(t)&&(t=n),Pn(Ye(e,1,Le,!0),ne(t,2))}),Wf=ge(function(e){var t=Ot(e);return t=typeof t=="function"?t:n,Pn(Ye(e,1,Le,!0),n,t)});function $f(e){return e&&e.length?Pn(e):[]}function Hf(e,t){return e&&e.length?Pn(e,ne(t,2)):[]}function Vf(e,t){return t=typeof t=="function"?t:n,e&&e.length?Pn(e,n,t):[]}function _a(e){if(!(e&&e.length))return[];var t=0;return e=Mn(e,function(r){if(Le(r))return t=Ke(r.length,t),!0}),Cr(t,function(r){return Me(e,Er(r))})}function Ou(e,t){if(!(e&&e.length))return[];var r=_a(e);return t==null?r:Me(r,function(u){return vt(t,n,u)})}var Xf=ge(function(e,t){return Le(e)?Hs(e,t):[]}),Yf=ge(function(e){return Zr(Mn(e,Le))}),Zf=ge(function(e){var t=Ot(e);return Le(t)&&(t=n),Zr(Mn(e,Le),ne(t,2))}),Jf=ge(function(e){var t=Ot(e);return t=typeof t=="function"?t:n,Zr(Mn(e,Le),n,t)}),Qf=ge(_a);function jf(e,t){return tu(e||[],t||[],$s)}function ed(e,t){return tu(e||[],t||[],Ys)}var td=ge(function(e){var t=e.length,r=t>1?e[t-1]:n;return r=typeof r=="function"?(e.pop(),r):n,Ou(e,r)});function Nu(e){var t=d(e);return t.__chain__=!0,t}function nd(e,t){return t(e),e}function Hi(e,t){return t(e)}var sd=gn(function(e){var t=e.length,r=t?e[0]:0,u=this.__wrapped__,_=function(p){return Or(p,e)};return t>1||this.__actions__.length||!(u instanceof we)||!mn(r)?this.thru(_):(u=u.slice(r,+r+(t?1:0)),u.__actions__.push({func:Hi,args:[_],thisArg:n}),new Ft(u,this.__chain__).thru(function(p){return t&&!p.length&&p.push(n),p}))});function id(){return Nu(this)}function rd(){return new Ft(this.value(),this.__chain__)}function ad(){this.__values__===n&&(this.__values__=Qu(this.value()));var e=this.__index__>=this.__values__.length,t=e?n:this.__values__[this.__index__++];return{done:e,value:t}}function od(){return this}function ud(e){for(var t,r=this;r instanceof Ri;){var u=Ru(r);u.__index__=0,u.__values__=n,t?_.__wrapped__=u:t=u;var _=u;r=r.__wrapped__}return _.__wrapped__=e,t}function ld(){var e=this.__wrapped__;if(e instanceof we){var t=e;return this.__actions__.length&&(t=new we(this)),t=t.reverse(),t.__actions__.push({func:Hi,args:[ha],thisArg:n}),new Ft(t,this.__chain__)}return this.thru(ha)}function cd(){return eu(this.__wrapped__,this.__actions__)}var hd=Ni(function(e,t,r){Te.call(e,r)?++e[r]:dn(e,r,1)});function _d(e,t,r){var u=ce(e)?_o:t_;return r&&ot(e,t,r)&&(t=n),u(e,ne(t,3))}function fd(e,t){var r=ce(e)?Mn:Oo;return r(e,ne(t,3))}var dd=hu(Uu),pd=hu(Bu);function gd(e,t){return Ye(Vi(e,t),1)}function md(e,t){return Ye(Vi(e,t),De)}function yd(e,t,r){return r=r===n?1:_e(r),Ye(Vi(e,t),r)}function zu(e,t){var r=ce(e)?Ut:Fn;return r(e,ne(t,3))}function Gu(e,t){var r=ce(e)?Lc:Lo;return r(e,ne(t,3))}var vd=Ni(function(e,t,r){Te.call(e,r)?e[r].push(t):dn(e,r,[t])});function wd(e,t,r,u){e=ft(e)?e:Es(e),r=r&&!u?_e(r):0;var _=e.length;return r<0&&(r=Ke(_+r,0)),Qi(e)?r<=_&&e.indexOf(t,r)>-1:!!_&&ds(e,t,r)>-1}var bd=ge(function(e,t,r){var u=-1,_=typeof t=="function",p=ft(e)?R(e.length):[];return Fn(e,function(v){p[++u]=_?vt(t,v,r):Vs(v,t,r)}),p}),xd=Ni(function(e,t,r){dn(e,r,t)});function Vi(e,t){var r=ce(e)?Me:Ko;return r(e,ne(t,3))}function kd(e,t,r,u){return e==null?[]:(ce(t)||(t=t==null?[]:[t]),r=u?n:r,ce(r)||(r=r==null?[]:[r]),Vo(e,t,r))}var Td=Ni(function(e,t,r){e[r?0:1].push(t)},function(){return[[],[]]});function Ad(e,t,r){var u=ce(e)?Tr:mo,_=arguments.length<3;return u(e,ne(t,4),r,_,Fn)}function Ed(e,t,r){var u=ce(e)?Oc:mo,_=arguments.length<3;return u(e,ne(t,4),r,_,Lo)}function Sd(e,t){var r=ce(e)?Mn:Oo;return r(e,Zi(ne(t,3)))}function Id(e){var t=ce(e)?Uo:v_;return t(e)}function Cd(e,t,r){(r?ot(e,t,r):t===n)?t=1:t=_e(t);var u=ce(e)?Zh:w_;return u(e,t)}function Md(e){var t=ce(e)?Jh:x_;return t(e)}function Rd(e){if(e==null)return 0;if(ft(e))return Qi(e)?gs(e):e.length;var t=nt(e);return t==ct||t==k?e.size:Kr(e).length}function Ud(e,t,r){var u=ce(e)?Ar:k_;return r&&ot(e,t,r)&&(t=n),u(e,ne(t,3))}var Bd=ge(function(e,t){if(e==null)return[];var r=t.length;return r>1&&ot(e,t[0],t[1])?t=[]:r>2&&ot(t[0],t[1],t[2])&&(t=[t[0]]),Vo(e,Ye(t,1),[])}),Xi=_h||function(){return Xe.Date.now()};function Fd(e,t){if(typeof t!="function")throw new Bt(f);return e=_e(e),function(){if(--e<1)return t.apply(this,arguments)}}function Du(e,t,r){return t=r?n:t,t=e&&t==null?e.length:t,pn(e,he,n,n,n,n,t)}function qu(e,t){var r;if(typeof t!="function")throw new Bt(f);return e=_e(e),function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=n),r}}var fa=ge(function(e,t,r){var u=G;if(r.length){var _=Un(r,Ts(fa));u|=Q}return pn(e,u,t,r,_)}),Ku=ge(function(e,t,r){var u=G|fe;if(r.length){var _=Un(r,Ts(Ku));u|=Q}return pn(t,u,e,r,_)});function Wu(e,t,r){t=r?n:t;var u=pn(e,re,n,n,n,n,n,t);return u.placeholder=Wu.placeholder,u}function $u(e,t,r){t=r?n:t;var u=pn(e,ue,n,n,n,n,n,t);return u.placeholder=$u.placeholder,u}function Hu(e,t,r){var u,_,p,v,x,A,N=0,z=!1,D=!1,V=!0;if(typeof e!="function")throw new Bt(f);t=Nt(t)||0,Ue(r)&&(z=!!r.leading,D="maxWait"in r,p=D?Ke(Nt(r.maxWait)||0,t):p,V="trailing"in r?!!r.trailing:V);function j(Oe){var Xt=u,wn=_;return u=_=n,N=Oe,v=e.apply(wn,Xt),v}function se(Oe){return N=Oe,x=Qs(ve,t),z?j(Oe):v}function de(Oe){var Xt=Oe-A,wn=Oe-N,hl=t-Xt;return D?tt(hl,p-wn):hl}function ie(Oe){var Xt=Oe-A,wn=Oe-N;return A===n||Xt>=t||Xt<0||D&&wn>=p}function ve(){var Oe=Xi();if(ie(Oe))return be(Oe);x=Qs(ve,de(Oe))}function be(Oe){return x=n,V&&u?j(Oe):(u=_=n,v)}function kt(){x!==n&&nu(x),N=0,u=A=_=x=n}function ut(){return x===n?v:be(Xi())}function Tt(){var Oe=Xi(),Xt=ie(Oe);if(u=arguments,_=this,A=Oe,Xt){if(x===n)return se(A);if(D)return nu(x),x=Qs(ve,t),j(A)}return x===n&&(x=Qs(ve,t)),v}return Tt.cancel=kt,Tt.flush=ut,Tt}var Pd=ge(function(e,t){return Po(e,1,t)}),Ld=ge(function(e,t,r){return Po(e,Nt(t)||0,r)});function Od(e){return pn(e,me)}function Yi(e,t){if(typeof e!="function"||t!=null&&typeof t!="function")throw new Bt(f);var r=function(){var u=arguments,_=t?t.apply(this,u):u[0],p=r.cache;if(p.has(_))return p.get(_);var v=e.apply(this,u);return r.cache=p.set(_,v)||p,v};return r.cache=new(Yi.Cache||fn),r}Yi.Cache=fn;function Zi(e){if(typeof e!="function")throw new Bt(f);return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}function Nd(e){return qu(2,e)}var zd=T_(function(e,t){t=t.length==1&&ce(t[0])?Me(t[0],wt(ne())):Me(Ye(t,1),wt(ne()));var r=t.length;return ge(function(u){for(var _=-1,p=tt(u.length,r);++_<p;)u[_]=t[_].call(this,u[_]);return vt(e,this,u)})}),da=ge(function(e,t){var r=Un(t,Ts(da));return pn(e,Q,n,t,r)}),Vu=ge(function(e,t){var r=Un(t,Ts(Vu));return pn(e,X,n,t,r)}),Gd=gn(function(e,t){return pn(e,ye,n,n,n,t)});function Dd(e,t){if(typeof e!="function")throw new Bt(f);return t=t===n?t:_e(t),ge(e,t)}function qd(e,t){if(typeof e!="function")throw new Bt(f);return t=t==null?0:Ke(_e(t),0),ge(function(r){var u=r[t],_=On(r,0,t);return u&&Rn(_,u),vt(e,this,_)})}function Kd(e,t,r){var u=!0,_=!0;if(typeof e!="function")throw new Bt(f);return Ue(r)&&(u="leading"in r?!!r.leading:u,_="trailing"in r?!!r.trailing:_),Hu(e,t,{leading:u,maxWait:t,trailing:_})}function Wd(e){return Du(e,1)}function $d(e,t){return da(Qr(t),e)}function Hd(){if(!arguments.length)return[];var e=arguments[0];return ce(e)?e:[e]}function Vd(e){return Pt(e,U)}function Xd(e,t){return t=typeof t=="function"?t:n,Pt(e,U,t)}function Yd(e){return Pt(e,M|U)}function Zd(e,t){return t=typeof t=="function"?t:n,Pt(e,M|U,t)}function Jd(e,t){return t==null||Fo(e,t,He(t))}function Vt(e,t){return e===t||e!==e&&t!==t}var Qd=qi(Gr),jd=qi(function(e,t){return e>=t}),ss=Go(function(){return arguments}())?Go:function(e){return Pe(e)&&Te.call(e,"callee")&&!Eo.call(e,"callee")},ce=R.isArray,ep=ao?wt(ao):o_;function ft(e){return e!=null&&Ji(e.length)&&!yn(e)}function Le(e){return Pe(e)&&ft(e)}function tp(e){return e===!0||e===!1||Pe(e)&&at(e)==un}var Nn=dh||Aa,np=oo?wt(oo):u_;function sp(e){return Pe(e)&&e.nodeType===1&&!js(e)}function ip(e){if(e==null)return!0;if(ft(e)&&(ce(e)||typeof e=="string"||typeof e.splice=="function"||Nn(e)||As(e)||ss(e)))return!e.length;var t=nt(e);if(t==ct||t==k)return!e.size;if(Js(e))return!Kr(e).length;for(var r in e)if(Te.call(e,r))return!1;return!0}function rp(e,t){return Xs(e,t)}function ap(e,t,r){r=typeof r=="function"?r:n;var u=r?r(e,t):n;return u===n?Xs(e,t,n,r):!!u}function pa(e){if(!Pe(e))return!1;var t=at(e);return t==Hn||t==Os||typeof e.message=="string"&&typeof e.name=="string"&&!js(e)}function op(e){return typeof e=="number"&&Io(e)}function yn(e){if(!Ue(e))return!1;var t=at(e);return t==et||t==os||t==oi||t==li}function Xu(e){return typeof e=="number"&&e==_e(e)}function Ji(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=Be}function Ue(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}function Pe(e){return e!=null&&typeof e=="object"}var Yu=uo?wt(uo):c_;function up(e,t){return e===t||qr(e,t,ra(t))}function lp(e,t,r){return r=typeof r=="function"?r:n,qr(e,t,ra(t),r)}function cp(e){return Zu(e)&&e!=+e}function hp(e){if(V_(e))throw new le(c);return Do(e)}function _p(e){return e===null}function fp(e){return e==null}function Zu(e){return typeof e=="number"||Pe(e)&&at(e)==An}function js(e){if(!Pe(e)||at(e)!=Ct)return!1;var t=Ti(e);if(t===null)return!0;var r=Te.call(t,"constructor")&&t.constructor;return typeof r=="function"&&r instanceof r&&wi.call(r)==uh}var ga=lo?wt(lo):h_;function dp(e){return Xu(e)&&e>=-Be&&e<=Be}var Ju=co?wt(co):__;function Qi(e){return typeof e=="string"||!ce(e)&&Pe(e)&&at(e)==m}function xt(e){return typeof e=="symbol"||Pe(e)&&at(e)==En}var As=ho?wt(ho):f_;function pp(e){return e===n}function gp(e){return Pe(e)&&nt(e)==Sn}function mp(e){return Pe(e)&&at(e)==ln}var yp=qi(Wr),vp=qi(function(e,t){return e<=t});function Qu(e){if(!e)return[];if(ft(e))return Qi(e)?$t(e):_t(e);if(Gs&&e[Gs])return Zc(e[Gs]());var t=nt(e),r=t==ct?Rr:t==k?mi:Es;return r(e)}function vn(e){if(!e)return e===0?e:0;if(e=Nt(e),e===De||e===-De){var t=e<0?-1:1;return t*Qe}return e===e?e:0}function _e(e){var t=vn(e),r=t%1;return t===t?r?t-r:t:0}function ju(e){return e?jn(_e(e),0,Fe):0}function Nt(e){if(typeof e=="number")return e;if(xt(e))return It;if(Ue(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=Ue(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=yo(e);var r=jl.test(e);return r||tc.test(e)?Bc(e.slice(2),r?2:8):Ql.test(e)?It:+e}function el(e){return nn(e,dt(e))}function wp(e){return e?jn(_e(e),-Be,Be):e===0?e:0}function ke(e){return e==null?"":bt(e)}var bp=xs(function(e,t){if(Js(t)||ft(t)){nn(t,He(t),e);return}for(var r in t)Te.call(t,r)&&$s(e,r,t[r])}),tl=xs(function(e,t){nn(t,dt(t),e)}),ji=xs(function(e,t,r,u){nn(t,dt(t),e,u)}),xp=xs(function(e,t,r,u){nn(t,He(t),e,u)}),kp=gn(Or);function Tp(e,t){var r=bs(e);return t==null?r:Bo(r,t)}var Ap=ge(function(e,t){e=Ae(e);var r=-1,u=t.length,_=u>2?t[2]:n;for(_&&ot(t[0],t[1],_)&&(u=1);++r<u;)for(var p=t[r],v=dt(p),x=-1,A=v.length;++x<A;){var N=v[x],z=e[N];(z===n||Vt(z,ys[N])&&!Te.call(e,N))&&(e[N]=p[N])}return e}),Ep=ge(function(e){return e.push(n,yu),vt(nl,n,e)});function Sp(e,t){return fo(e,ne(t,3),tn)}function Ip(e,t){return fo(e,ne(t,3),zr)}function Cp(e,t){return e==null?e:Nr(e,ne(t,3),dt)}function Mp(e,t){return e==null?e:No(e,ne(t,3),dt)}function Rp(e,t){return e&&tn(e,ne(t,3))}function Up(e,t){return e&&zr(e,ne(t,3))}function Bp(e){return e==null?[]:Fi(e,He(e))}function Fp(e){return e==null?[]:Fi(e,dt(e))}function ma(e,t,r){var u=e==null?n:es(e,t);return u===n?r:u}function Pp(e,t){return e!=null&&bu(e,t,s_)}function ya(e,t){return e!=null&&bu(e,t,i_)}var Lp=fu(function(e,t,r){t!=null&&typeof t.toString!="function"&&(t=bi.call(t)),e[t]=r},wa(pt)),Op=fu(function(e,t,r){t!=null&&typeof t.toString!="function"&&(t=bi.call(t)),Te.call(e,t)?e[t].push(r):e[t]=[r]},ne),Np=ge(Vs);function He(e){return ft(e)?Ro(e):Kr(e)}function dt(e){return ft(e)?Ro(e,!0):d_(e)}function zp(e,t){var r={};return t=ne(t,3),tn(e,function(u,_,p){dn(r,t(u,_,p),u)}),r}function Gp(e,t){var r={};return t=ne(t,3),tn(e,function(u,_,p){dn(r,_,t(u,_,p))}),r}var Dp=xs(function(e,t,r){Pi(e,t,r)}),nl=xs(function(e,t,r,u){Pi(e,t,r,u)}),qp=gn(function(e,t){var r={};if(e==null)return r;var u=!1;t=Me(t,function(p){return p=Ln(p,e),u||(u=p.length>1),p}),nn(e,sa(e),r),u&&(r=Pt(r,M|F|U,P_));for(var _=t.length;_--;)Yr(r,t[_]);return r});function Kp(e,t){return sl(e,Zi(ne(t)))}var Wp=gn(function(e,t){return e==null?{}:g_(e,t)});function sl(e,t){if(e==null)return{};var r=Me(sa(e),function(u){return[u]});return t=ne(t),Xo(e,r,function(u,_){return t(u,_[0])})}function $p(e,t,r){t=Ln(t,e);var u=-1,_=t.length;for(_||(_=1,e=n);++u<_;){var p=e==null?n:e[sn(t[u])];p===n&&(u=_,p=r),e=yn(p)?p.call(e):p}return e}function Hp(e,t,r){return e==null?e:Ys(e,t,r)}function Vp(e,t,r,u){return u=typeof u=="function"?u:n,e==null?e:Ys(e,t,r,u)}var il=gu(He),rl=gu(dt);function Xp(e,t,r){var u=ce(e),_=u||Nn(e)||As(e);if(t=ne(t,4),r==null){var p=e&&e.constructor;_?r=u?new p:[]:Ue(e)?r=yn(p)?bs(Ti(e)):{}:r={}}return(_?Ut:tn)(e,function(v,x,A){return t(r,v,x,A)}),r}function Yp(e,t){return e==null?!0:Yr(e,t)}function Zp(e,t,r){return e==null?e:jo(e,t,Qr(r))}function Jp(e,t,r,u){return u=typeof u=="function"?u:n,e==null?e:jo(e,t,Qr(r),u)}function Es(e){return e==null?[]:Mr(e,He(e))}function Qp(e){return e==null?[]:Mr(e,dt(e))}function jp(e,t,r){return r===n&&(r=t,t=n),r!==n&&(r=Nt(r),r=r===r?r:0),t!==n&&(t=Nt(t),t=t===t?t:0),jn(Nt(e),t,r)}function eg(e,t,r){return t=vn(t),r===n?(r=t,t=0):r=vn(r),e=Nt(e),r_(e,t,r)}function tg(e,t,r){if(r&&typeof r!="boolean"&&ot(e,t,r)&&(t=r=n),r===n&&(typeof t=="boolean"?(r=t,t=n):typeof e=="boolean"&&(r=e,e=n)),e===n&&t===n?(e=0,t=1):(e=vn(e),t===n?(t=e,e=0):t=vn(t)),e>t){var u=e;e=t,t=u}if(r||e%1||t%1){var _=Co();return tt(e+_*(t-e+Uc("1e-"+((_+"").length-1))),t)}return Hr(e,t)}var ng=ks(function(e,t,r){return t=t.toLowerCase(),e+(r?al(t):t)});function al(e){return va(ke(e).toLowerCase())}function ol(e){return e=ke(e),e&&e.replace(sc,$c).replace(xc,"")}function sg(e,t,r){e=ke(e),t=bt(t);var u=e.length;r=r===n?u:jn(_e(r),0,u);var _=r;return r-=t.length,r>=0&&e.slice(r,_)==t}function ig(e){return e=ke(e),e&&y.test(e)?e.replace(o,Hc):e}function rg(e){return e=ke(e),e&&ht.test(e)?e.replace(Ie,"\\$&"):e}var ag=ks(function(e,t,r){return e+(r?"-":"")+t.toLowerCase()}),og=ks(function(e,t,r){return e+(r?" ":"")+t.toLowerCase()}),ug=cu("toLowerCase");function lg(e,t,r){e=ke(e),t=_e(t);var u=t?gs(e):0;if(!t||u>=t)return e;var _=(t-u)/2;return Di(Ii(_),r)+e+Di(Si(_),r)}function cg(e,t,r){e=ke(e),t=_e(t);var u=t?gs(e):0;return t&&u<t?e+Di(t-u,r):e}function hg(e,t,r){e=ke(e),t=_e(t);var u=t?gs(e):0;return t&&u<t?Di(t-u,r)+e:e}function _g(e,t,r){return r||t==null?t=0:t&&(t=+t),yh(ke(e).replace(_s,""),t||0)}function fg(e,t,r){return(r?ot(e,t,r):t===n)?t=1:t=_e(t),Vr(ke(e),t)}function dg(){var e=arguments,t=ke(e[0]);return e.length<3?t:t.replace(e[1],e[2])}var pg=ks(function(e,t,r){return e+(r?"_":"")+t.toLowerCase()});function gg(e,t,r){return r&&typeof r!="number"&&ot(e,t,r)&&(t=r=n),r=r===n?Fe:r>>>0,r?(e=ke(e),e&&(typeof t=="string"||t!=null&&!ga(t))&&(t=bt(t),!t&&ps(e))?On($t(e),0,r):e.split(t,r)):[]}var mg=ks(function(e,t,r){return e+(r?" ":"")+va(t)});function yg(e,t,r){return e=ke(e),r=r==null?0:jn(_e(r),0,e.length),t=bt(t),e.slice(r,r+t.length)==t}function vg(e,t,r){var u=d.templateSettings;r&&ot(e,t,r)&&(t=n),e=ke(e),t=ji({},t,u,mu);var _=ji({},t.imports,u.imports,mu),p=He(_),v=Mr(_,p),x,A,N=0,z=t.interpolate||_i,D="__p += '",V=Ur((t.escape||_i).source+"|"+z.source+"|"+(z===O?Jl:_i).source+"|"+(t.evaluate||_i).source+"|$","g"),j="//# sourceURL="+(Te.call(t,"sourceURL")?(t.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++Sc+"]")+`
`;e.replace(V,function(ie,ve,be,kt,ut,Tt){return be||(be=kt),D+=e.slice(N,Tt).replace(ic,Vc),ve&&(x=!0,D+=`' +
__e(`+ve+`) +
'`),ut&&(A=!0,D+=`';
`+ut+`;
__p += '`),be&&(D+=`' +
((__t = (`+be+`)) == null ? '' : __t) +
'`),N=Tt+ie.length,ie}),D+=`';
`;var se=Te.call(t,"variable")&&t.variable;if(!se)D=`with (obj) {
`+D+`
}
`;else if(Yl.test(se))throw new le(g);D=(A?D.replace(hi,""):D).replace(pr,"$1").replace(Wt,"$1;"),D="function("+(se||"obj")+`) {
`+(se?"":`obj || (obj = {});
`)+"var __t, __p = ''"+(x?", __e = _.escape":"")+(A?`, __j = Array.prototype.join;
function print() { __p += __j.call(arguments, '') }
`:`;
`)+D+`return __p
}`;var de=ll(function(){return xe(p,j+"return "+D).apply(n,v)});if(de.source=D,pa(de))throw de;return de}function wg(e){return ke(e).toLowerCase()}function bg(e){return ke(e).toUpperCase()}function xg(e,t,r){if(e=ke(e),e&&(r||t===n))return yo(e);if(!e||!(t=bt(t)))return e;var u=$t(e),_=$t(t),p=vo(u,_),v=wo(u,_)+1;return On(u,p,v).join("")}function kg(e,t,r){if(e=ke(e),e&&(r||t===n))return e.slice(0,xo(e)+1);if(!e||!(t=bt(t)))return e;var u=$t(e),_=wo(u,$t(t))+1;return On(u,0,_).join("")}function Tg(e,t,r){if(e=ke(e),e&&(r||t===n))return e.replace(_s,"");if(!e||!(t=bt(t)))return e;var u=$t(e),_=vo(u,$t(t));return On(u,_).join("")}function Ag(e,t){var r=rt,u=$e;if(Ue(t)){var _="separator"in t?t.separator:_;r="length"in t?_e(t.length):r,u="omission"in t?bt(t.omission):u}e=ke(e);var p=e.length;if(ps(e)){var v=$t(e);p=v.length}if(r>=p)return e;var x=r-gs(u);if(x<1)return u;var A=v?On(v,0,x).join(""):e.slice(0,x);if(_===n)return A+u;if(v&&(x+=A.length-x),ga(_)){if(e.slice(x).search(_)){var N,z=A;for(_.global||(_=Ur(_.source,ke(za.exec(_))+"g")),_.lastIndex=0;N=_.exec(z);)var D=N.index;A=A.slice(0,D===n?x:D)}}else if(e.indexOf(bt(_),x)!=x){var V=A.lastIndexOf(_);V>-1&&(A=A.slice(0,V))}return A+u}function Eg(e){return e=ke(e),e&&h.test(e)?e.replace(L,eh):e}var Sg=ks(function(e,t,r){return e+(r?" ":"")+t.toUpperCase()}),va=cu("toUpperCase");function ul(e,t,r){return e=ke(e),t=r?n:t,t===n?Yc(e)?sh(e):Gc(e):e.match(t)||[]}var ll=ge(function(e,t){try{return vt(e,n,t)}catch(r){return pa(r)?r:new le(r)}}),Ig=gn(function(e,t){return Ut(t,function(r){r=sn(r),dn(e,r,fa(e[r],e))}),e});function Cg(e){var t=e==null?0:e.length,r=ne();return e=t?Me(e,function(u){if(typeof u[1]!="function")throw new Bt(f);return[r(u[0]),u[1]]}):[],ge(function(u){for(var _=-1;++_<t;){var p=e[_];if(vt(p[0],this,u))return vt(p[1],this,u)}})}function Mg(e){return e_(Pt(e,M))}function wa(e){return function(){return e}}function Rg(e,t){return e==null||e!==e?t:e}var Ug=_u(),Bg=_u(!0);function pt(e){return e}function ba(e){return qo(typeof e=="function"?e:Pt(e,M))}function Fg(e){return Wo(Pt(e,M))}function Pg(e,t){return $o(e,Pt(t,M))}var Lg=ge(function(e,t){return function(r){return Vs(r,e,t)}}),Og=ge(function(e,t){return function(r){return Vs(e,r,t)}});function xa(e,t,r){var u=He(t),_=Fi(t,u);r==null&&!(Ue(t)&&(_.length||!u.length))&&(r=t,t=e,e=this,_=Fi(t,He(t)));var p=!(Ue(r)&&"chain"in r)||!!r.chain,v=yn(e);return Ut(_,function(x){var A=t[x];e[x]=A,v&&(e.prototype[x]=function(){var N=this.__chain__;if(p||N){var z=e(this.__wrapped__),D=z.__actions__=_t(this.__actions__);return D.push({func:A,args:arguments,thisArg:e}),z.__chain__=N,z}return A.apply(e,Rn([this.value()],arguments))})}),e}function Ng(){return Xe._===this&&(Xe._=lh),this}function ka(){}function zg(e){return e=_e(e),ge(function(t){return Ho(t,e)})}var Gg=ea(Me),Dg=ea(_o),qg=ea(Ar);function cl(e){return oa(e)?Er(sn(e)):m_(e)}function Kg(e){return function(t){return e==null?n:es(e,t)}}var Wg=du(),$g=du(!0);function Ta(){return[]}function Aa(){return!1}function Hg(){return{}}function Vg(){return""}function Xg(){return!0}function Yg(e,t){if(e=_e(e),e<1||e>Be)return[];var r=Fe,u=tt(e,Fe);t=ne(t),e-=Fe;for(var _=Cr(u,t);++r<e;)t(r);return _}function Zg(e){return ce(e)?Me(e,sn):xt(e)?[e]:_t(Mu(ke(e)))}function Jg(e){var t=++oh;return ke(e)+t}var Qg=Gi(function(e,t){return e+t},0),jg=ta("ceil"),em=Gi(function(e,t){return e/t},1),tm=ta("floor");function nm(e){return e&&e.length?Bi(e,pt,Gr):n}function sm(e,t){return e&&e.length?Bi(e,ne(t,2),Gr):n}function im(e){return go(e,pt)}function rm(e,t){return go(e,ne(t,2))}function am(e){return e&&e.length?Bi(e,pt,Wr):n}function om(e,t){return e&&e.length?Bi(e,ne(t,2),Wr):n}var um=Gi(function(e,t){return e*t},1),lm=ta("round"),cm=Gi(function(e,t){return e-t},0);function hm(e){return e&&e.length?Ir(e,pt):0}function _m(e,t){return e&&e.length?Ir(e,ne(t,2)):0}return d.after=Fd,d.ary=Du,d.assign=bp,d.assignIn=tl,d.assignInWith=ji,d.assignWith=xp,d.at=kp,d.before=qu,d.bind=fa,d.bindAll=Ig,d.bindKey=Ku,d.castArray=Hd,d.chain=Nu,d.chunk=ef,d.compact=tf,d.concat=nf,d.cond=Cg,d.conforms=Mg,d.constant=wa,d.countBy=hd,d.create=Tp,d.curry=Wu,d.curryRight=$u,d.debounce=Hu,d.defaults=Ap,d.defaultsDeep=Ep,d.defer=Pd,d.delay=Ld,d.difference=sf,d.differenceBy=rf,d.differenceWith=af,d.drop=of,d.dropRight=uf,d.dropRightWhile=lf,d.dropWhile=cf,d.fill=hf,d.filter=fd,d.flatMap=gd,d.flatMapDeep=md,d.flatMapDepth=yd,d.flatten=Fu,d.flattenDeep=_f,d.flattenDepth=ff,d.flip=Od,d.flow=Ug,d.flowRight=Bg,d.fromPairs=df,d.functions=Bp,d.functionsIn=Fp,d.groupBy=vd,d.initial=gf,d.intersection=mf,d.intersectionBy=yf,d.intersectionWith=vf,d.invert=Lp,d.invertBy=Op,d.invokeMap=bd,d.iteratee=ba,d.keyBy=xd,d.keys=He,d.keysIn=dt,d.map=Vi,d.mapKeys=zp,d.mapValues=Gp,d.matches=Fg,d.matchesProperty=Pg,d.memoize=Yi,d.merge=Dp,d.mergeWith=nl,d.method=Lg,d.methodOf=Og,d.mixin=xa,d.negate=Zi,d.nthArg=zg,d.omit=qp,d.omitBy=Kp,d.once=Nd,d.orderBy=kd,d.over=Gg,d.overArgs=zd,d.overEvery=Dg,d.overSome=qg,d.partial=da,d.partialRight=Vu,d.partition=Td,d.pick=Wp,d.pickBy=sl,d.property=cl,d.propertyOf=Kg,d.pull=kf,d.pullAll=Lu,d.pullAllBy=Tf,d.pullAllWith=Af,d.pullAt=Ef,d.range=Wg,d.rangeRight=$g,d.rearg=Gd,d.reject=Sd,d.remove=Sf,d.rest=Dd,d.reverse=ha,d.sampleSize=Cd,d.set=Hp,d.setWith=Vp,d.shuffle=Md,d.slice=If,d.sortBy=Bd,d.sortedUniq=Pf,d.sortedUniqBy=Lf,d.split=gg,d.spread=qd,d.tail=Of,d.take=Nf,d.takeRight=zf,d.takeRightWhile=Gf,d.takeWhile=Df,d.tap=nd,d.throttle=Kd,d.thru=Hi,d.toArray=Qu,d.toPairs=il,d.toPairsIn=rl,d.toPath=Zg,d.toPlainObject=el,d.transform=Xp,d.unary=Wd,d.union=qf,d.unionBy=Kf,d.unionWith=Wf,d.uniq=$f,d.uniqBy=Hf,d.uniqWith=Vf,d.unset=Yp,d.unzip=_a,d.unzipWith=Ou,d.update=Zp,d.updateWith=Jp,d.values=Es,d.valuesIn=Qp,d.without=Xf,d.words=ul,d.wrap=$d,d.xor=Yf,d.xorBy=Zf,d.xorWith=Jf,d.zip=Qf,d.zipObject=jf,d.zipObjectDeep=ed,d.zipWith=td,d.entries=il,d.entriesIn=rl,d.extend=tl,d.extendWith=ji,xa(d,d),d.add=Qg,d.attempt=ll,d.camelCase=ng,d.capitalize=al,d.ceil=jg,d.clamp=jp,d.clone=Vd,d.cloneDeep=Yd,d.cloneDeepWith=Zd,d.cloneWith=Xd,d.conformsTo=Jd,d.deburr=ol,d.defaultTo=Rg,d.divide=em,d.endsWith=sg,d.eq=Vt,d.escape=ig,d.escapeRegExp=rg,d.every=_d,d.find=dd,d.findIndex=Uu,d.findKey=Sp,d.findLast=pd,d.findLastIndex=Bu,d.findLastKey=Ip,d.floor=tm,d.forEach=zu,d.forEachRight=Gu,d.forIn=Cp,d.forInRight=Mp,d.forOwn=Rp,d.forOwnRight=Up,d.get=ma,d.gt=Qd,d.gte=jd,d.has=Pp,d.hasIn=ya,d.head=Pu,d.identity=pt,d.includes=wd,d.indexOf=pf,d.inRange=eg,d.invoke=Np,d.isArguments=ss,d.isArray=ce,d.isArrayBuffer=ep,d.isArrayLike=ft,d.isArrayLikeObject=Le,d.isBoolean=tp,d.isBuffer=Nn,d.isDate=np,d.isElement=sp,d.isEmpty=ip,d.isEqual=rp,d.isEqualWith=ap,d.isError=pa,d.isFinite=op,d.isFunction=yn,d.isInteger=Xu,d.isLength=Ji,d.isMap=Yu,d.isMatch=up,d.isMatchWith=lp,d.isNaN=cp,d.isNative=hp,d.isNil=fp,d.isNull=_p,d.isNumber=Zu,d.isObject=Ue,d.isObjectLike=Pe,d.isPlainObject=js,d.isRegExp=ga,d.isSafeInteger=dp,d.isSet=Ju,d.isString=Qi,d.isSymbol=xt,d.isTypedArray=As,d.isUndefined=pp,d.isWeakMap=gp,d.isWeakSet=mp,d.join=wf,d.kebabCase=ag,d.last=Ot,d.lastIndexOf=bf,d.lowerCase=og,d.lowerFirst=ug,d.lt=yp,d.lte=vp,d.max=nm,d.maxBy=sm,d.mean=im,d.meanBy=rm,d.min=am,d.minBy=om,d.stubArray=Ta,d.stubFalse=Aa,d.stubObject=Hg,d.stubString=Vg,d.stubTrue=Xg,d.multiply=um,d.nth=xf,d.noConflict=Ng,d.noop=ka,d.now=Xi,d.pad=lg,d.padEnd=cg,d.padStart=hg,d.parseInt=_g,d.random=tg,d.reduce=Ad,d.reduceRight=Ed,d.repeat=fg,d.replace=dg,d.result=$p,d.round=lm,d.runInContext=T,d.sample=Id,d.size=Rd,d.snakeCase=pg,d.some=Ud,d.sortedIndex=Cf,d.sortedIndexBy=Mf,d.sortedIndexOf=Rf,d.sortedLastIndex=Uf,d.sortedLastIndexBy=Bf,d.sortedLastIndexOf=Ff,d.startCase=mg,d.startsWith=yg,d.subtract=cm,d.sum=hm,d.sumBy=_m,d.template=vg,d.times=Yg,d.toFinite=vn,d.toInteger=_e,d.toLength=ju,d.toLower=wg,d.toNumber=Nt,d.toSafeInteger=wp,d.toString=ke,d.toUpper=bg,d.trim=xg,d.trimEnd=kg,d.trimStart=Tg,d.truncate=Ag,d.unescape=Eg,d.uniqueId=Jg,d.upperCase=Sg,d.upperFirst=va,d.each=zu,d.eachRight=Gu,d.first=Pu,xa(d,function(){var e={};return tn(d,function(t,r){Te.call(d.prototype,r)||(e[r]=t)}),e}(),{chain:!1}),d.VERSION=a,Ut(["bind","bindKey","curry","curryRight","partial","partialRight"],function(e){d[e].placeholder=d}),Ut(["drop","take"],function(e,t){we.prototype[e]=function(r){r=r===n?1:Ke(_e(r),0);var u=this.__filtered__&&!t?new we(this):this.clone();return u.__filtered__?u.__takeCount__=tt(r,u.__takeCount__):u.__views__.push({size:tt(r,Fe),type:e+(u.__dir__<0?"Right":"")}),u},we.prototype[e+"Right"]=function(r){return this.reverse()[e](r).reverse()}}),Ut(["filter","map","takeWhile"],function(e,t){var r=t+1,u=r==ee||r==Ge;we.prototype[e]=function(_){var p=this.clone();return p.__iteratees__.push({iteratee:ne(_,3),type:r}),p.__filtered__=p.__filtered__||u,p}}),Ut(["head","last"],function(e,t){var r="take"+(t?"Right":"");we.prototype[e]=function(){return this[r](1).value()[0]}}),Ut(["initial","tail"],function(e,t){var r="drop"+(t?"":"Right");we.prototype[e]=function(){return this.__filtered__?new we(this):this[r](1)}}),we.prototype.compact=function(){return this.filter(pt)},we.prototype.find=function(e){return this.filter(e).head()},we.prototype.findLast=function(e){return this.reverse().find(e)},we.prototype.invokeMap=ge(function(e,t){return typeof e=="function"?new we(this):this.map(function(r){return Vs(r,e,t)})}),we.prototype.reject=function(e){return this.filter(Zi(ne(e)))},we.prototype.slice=function(e,t){e=_e(e);var r=this;return r.__filtered__&&(e>0||t<0)?new we(r):(e<0?r=r.takeRight(-e):e&&(r=r.drop(e)),t!==n&&(t=_e(t),r=t<0?r.dropRight(-t):r.take(t-e)),r)},we.prototype.takeRightWhile=function(e){return this.reverse().takeWhile(e).reverse()},we.prototype.toArray=function(){return this.take(Fe)},tn(we.prototype,function(e,t){var r=/^(?:filter|find|map|reject)|While$/.test(t),u=/^(?:head|last)$/.test(t),_=d[u?"take"+(t=="last"?"Right":""):t],p=u||/^find/.test(t);_&&(d.prototype[t]=function(){var v=this.__wrapped__,x=u?[1]:arguments,A=v instanceof we,N=x[0],z=A||ce(v),D=function(ve){var be=_.apply(d,Rn([ve],x));return u&&V?be[0]:be};z&&r&&typeof N=="function"&&N.length!=1&&(A=z=!1);var V=this.__chain__,j=!!this.__actions__.length,se=p&&!V,de=A&&!j;if(!p&&z){v=de?v:new we(this);var ie=e.apply(v,x);return ie.__actions__.push({func:Hi,args:[D],thisArg:n}),new Ft(ie,V)}return se&&de?e.apply(this,x):(ie=this.thru(D),se?u?ie.value()[0]:ie.value():ie)})}),Ut(["pop","push","shift","sort","splice","unshift"],function(e){var t=yi[e],r=/^(?:push|sort|unshift)$/.test(e)?"tap":"thru",u=/^(?:pop|shift)$/.test(e);d.prototype[e]=function(){var _=arguments;if(u&&!this.__chain__){var p=this.value();return t.apply(ce(p)?p:[],_)}return this[r](function(v){return t.apply(ce(v)?v:[],_)})}}),tn(we.prototype,function(e,t){var r=d[t];if(r){var u=r.name+"";Te.call(ws,u)||(ws[u]=[]),ws[u].push({name:t,func:r})}}),ws[zi(n,fe).name]=[{name:"wrapper",func:n}],we.prototype.clone=Ah,we.prototype.reverse=Eh,we.prototype.value=Sh,d.prototype.at=sd,d.prototype.chain=id,d.prototype.commit=rd,d.prototype.next=ad,d.prototype.plant=ud,d.prototype.reverse=ld,d.prototype.toJSON=d.prototype.valueOf=d.prototype.value=cd,d.prototype.first=d.prototype.head,Gs&&(d.prototype[Gs]=od),d},ms=ih();Yn?((Yn.exports=ms)._=ms,br._=ms):Xe._=ms}).call(ei)})(or,or.exports);var wm=or.exports;const st=vm(wm);function er(s,i,n){return s<<24|i<<16|n}function Ea(s){return s>>24&16777215}function ti(s){return s>>16&255}const Yt=Object.freeze({Unknown:0,Image:1,Buffer:2}),dl=Object.freeze({handle:0,config:null}),tr=Object.freeze({reference_count:0,physical_id:0,first_user:0,last_user:0,producers:[],consumers:[],b_is_persistent:!0,b_is_bindless:!1,max_frame_lifetime:2}),bm=Object.freeze({current_pass:0,context:null,global_bind_group:null,pass_bind_group:null,pass_bind_groups:Array(pe.Num).fill(null),pass_pipeline_state:0,resource_deletion_queue:null,pass_bindless_resources:[],pass_attachments:[],g_buffer_data:null}),xm=Object.freeze({pipeline_shaders:null,push_constant_data:null,rasterizer_state:null,attachment_blend:null,primitive_topology_type:null,viewport:null,depth_write_enabled:null,depth_stencil_compare_op:null}),pl=Object.freeze({name:"",width:0,height:0,depth:1,mip_levels:1,format:"",usage:0,sample_count:1,b_is_bindless:!1,flags:lt.None}),gl=Object.freeze({size:0,usage:0,b_is_bindless:!1,flags:El.None}),km=Object.freeze({shader_setup:st.cloneDeep(xm),inputs:[],outputs:[],input_views:[],output_views:[],pass_inputs:[],bindless_inputs:[],b_skip_auto_descriptor_setup:!1,b_split_input_image_mips:!1,b_force_keep_pass:!1}),Tm=Object.freeze({handle:0,pass_config:null,parameters:null,executor:null,shaders:{},physical_id:0,pipeline_state_id:0,reference_count:0}),Am=Object.freeze({image_resources:[],buffer_resources:[],render_passes:[],all_resource_handles:[],resource_metadata:new Map,all_bindless_resource_handles:[],resource_deletion_queue:new gm,b_global_bind_group_bound:!1}),Em=Object.freeze({global_bind_group:null,bind_groups:new Map,pipeline_states:new Map});class La{constructor(){this.pass_cache=st.cloneDeep(Em),this.registry=st.cloneDeep(Am),this.non_culled_passes=[],this.queued_global_bind_group_writes=[],this.image_resource_allocator=new ni(256,st.cloneDeep(dl)),this.buffer_resource_allocator=new ni(256,st.cloneDeep(dl)),this.render_pass_allocator=new ni(128,st.cloneDeep(Tm))}destroy(i){this.reset(i),this.registry.resource_deletion_queue.flush()}begin(i){this.reset(i)}create_image(i){const n=this.image_resource_allocator.allocate();n.config={...st.cloneDeep(pl),...i};const a=this.registry.image_resources.length;return this.registry.image_resources.push(n),n.handle=er(a,Yt.Image,1),this.registry.all_resource_handles.push(n.handle),this.registry.resource_metadata.set(n.handle,st.cloneDeep(tr)),this.registry.resource_metadata.get(n.handle).b_is_bindless=i.b_is_bindless,this.registry.resource_metadata.get(n.handle).b_is_persistent=(n.config.flags&lt.Transient)===0,n.handle}register_image(i){const n=ae.from(i),a=$.get().fetch(W.IMAGE,n),l=this.image_resource_allocator.allocate();l.config={...st.cloneDeep(pl),...a.config};const c=this.registry.image_resources.length;return this.registry.image_resources.push(l),l.handle=er(c,Yt.Image,1),this.registry.all_resource_handles.push(l.handle),this.registry.resource_metadata.set(l.handle,st.cloneDeep(tr)),this.registry.resource_metadata.get(l.handle).physical_id=n,this.registry.resource_metadata.get(l.handle).b_is_persistent=!0,this.registry.resource_metadata.get(l.handle).b_is_bindless=l.config.b_is_bindless,l.handle}create_buffer(i){const n=this.buffer_resource_allocator.allocate();n.config={...st.cloneDeep(gl),...i};const a=this.registry.buffer_resources.length;return this.registry.buffer_resources.push(n),n.handle=er(a,Yt.Buffer,1),this.registry.all_resource_handles.push(n.handle),this.registry.resource_metadata.set(n.handle,st.cloneDeep(tr)),this.registry.resource_metadata.get(n.handle).b_is_bindless=i.b_is_bindless,this.registry.resource_metadata.get(n.handle).b_is_persistent=(n.config.flags&El.Transient)===0,n.handle}register_buffer(i){const n=ae.from(i),a=$.get().fetch(W.BUFFER,n),l=this.buffer_resource_allocator.allocate();l.config={...st.cloneDeep(gl),...a.config};const c=this.registry.buffer_resources.length;return this.registry.buffer_resources.push(l),l.handle=er(c,Yt.Buffer,1),this.registry.all_resource_handles.push(l.handle),this.registry.resource_metadata.set(l.handle,st.cloneDeep(tr)),this.registry.resource_metadata.get(l.handle).physical_id=n,this.registry.resource_metadata.get(l.handle).b_is_persistent=!0,this.registry.resource_metadata.get(l.handle).b_is_bindless=l.config.b_is_bindless,l.handle}add_pass(i,n,a,l){const c=this.render_pass_allocator.allocate();c.pass_config={name:i,flags:n,attachments:[]},c.parameters={...st.cloneDeep(km),...a},c.executor=l;const f=this.registry.render_passes.length;return this.registry.render_passes.push(c),this.non_culled_passes.push(f),c.handle=f,a?(this._update_reference_counts(c),this._update_resource_param_producers_and_consumers(c),this._update_present_pass_status(c)):c.reference_count+=1,f}get_physical_pass(i){return $.get().fetch(W.PASS,i)}get_physical_image(i){return $.get().fetch(W.IMAGE,this.registry.resource_metadata.get(i).physical_id)}get_physical_buffer(i){return $.get().fetch(W.BUFFER,this.registry.resource_metadata.get(i).physical_id)}queue_global_bind_group_write(i,n=!1){n?this.queued_global_bind_group_writes=i:this.queued_global_bind_group_writes=[...this.queued_global_bind_group_writes,...i]}_update_reference_counts(i){i.reference_count+=i.parameters.outputs.length;for(const n of i.parameters.inputs)if(this.registry.resource_metadata.has(n)){const a=this.registry.resource_metadata.get(n);a.reference_count+=1}}_update_resource_param_producers_and_consumers(i){for(const n of i.parameters.inputs)this.registry.resource_metadata.has(n)&&this.registry.resource_metadata.get(n).consumers.push(i.handle);for(const n of i.parameters.outputs)this.registry.resource_metadata.has(n)&&this.registry.resource_metadata.get(n).producers.push(i.handle)}_update_present_pass_status(i){i.pass_config.b_is_present_pass=(i.pass_config.flags&Ee.Present)!==Ee.None,i.parameters.b_force_keep_pass=i.parameters.b_force_keep_pass||i.pass_config.b_is_present_pass}_compile(){this._cull_graph_passes(),this._compute_resource_first_and_last_users()}_cull_graph_passes(){const i=new Set,n=[],a=l=>{for(const c of l){const f=this.registry.render_passes[c];if(!f.parameters.b_force_keep_pass&&(--f.reference_count,f.reference_count<=0)){f.reference_count=0,i.add(c);for(const g of f.parameters.inputs)if(this.registry.resource_metadata.has(g)){const b=this.registry.resource_metadata.get(g);b.reference_count-=1,b.reference_count===0&&n.push(g)}}}};for(const l of this.registry.all_resource_handles)this.registry.resource_metadata.has(l)&&this.registry.resource_metadata.get(l).reference_count===0&&n.push(l);for(;n.length>0;){const l=n.pop();this.registry.resource_metadata.has(l)&&a(this.registry.resource_metadata.get(l).producers)}for(let l=this.non_culled_passes.length-1;l>=0;--l){const c=this.non_culled_passes[l];i.has(c)&&this.non_culled_passes.splice(l,1)}}_compute_resource_first_and_last_users(){for(const i of this.registry.all_resource_handles)if(this.registry.resource_metadata.has(i)){const n=this.registry.resource_metadata.get(i);if(n.reference_count===0)continue;n.first_user=Number.MAX_SAFE_INTEGER,n.last_user=Number.MIN_SAFE_INTEGER;for(const a of n.producers)a<n.first_user&&(n.first_user=a),a>n.last_user&&(n.last_user=a);for(const a of n.consumers)a<n.first_user&&(n.first_user=a),a>n.last_user&&(n.last_user=a)}}submit(i){if(this._compile(),this.non_culled_passes.length===0)return;const n=fl.create_encoder(i,"render_graph_encoder"),a=st.cloneDeep(bm);a.context=i,a.resource_deletion_queue=this.registry.resource_deletion_queue;for(const l of this.non_culled_passes)this._execute_pass(this.registry.render_passes[l],a,n);fl.submit(i,n)}reset(i){this._free_physical_resources(i),this.non_culled_passes.length=0,this.registry.all_resource_handles.length=0,this.registry.buffer_resources.length=0,this.registry.image_resources.length=0,this.registry.render_passes.length=0,this.registry.resource_metadata.clear(),this.image_resource_allocator.reset(),this.buffer_resource_allocator.reset(),this.render_pass_allocator.reset()}_execute_pass(i,n,a){if(!i)throw new Error("Cannot execute null pass");if(n.pass_attachments.length=0,this._setup_physical_pass_and_resources(i,n,a),(i.pass_config.flags&Ee.GraphLocal)!==Ee.None)i.executor(this,n,a);else{const l=$.get().fetch(W.PASS,i.physical_id);if(!l)throw new Error("Physical pass is null");const c=$.get().fetch(W.PIPELINE_STATE,i.pipeline_state_id);n.current_pass=i.physical_id,l.begin(a,c),this._bind_pass_bind_groups(i,n),i.executor(this,n,a),l.end(),this._update_transient_resources(i)}}_setup_physical_pass_and_resources(i,n,a){const l=(i.pass_config.flags&Ee.Compute)!==Ee.None,c=(i.pass_config.flags&Ee.GraphLocal)!==Ee.None,f=(g,b,C)=>{this.registry.resource_metadata.has(g)&&(this._setup_physical_resource(n.context,g,!l,C),!l&&!c&&this._tie_resource_to_pass_config_attachments(g,i,b,C,n),C&&this._setup_pass_input_resource_bindless_type(g,i,b))};i.parameters.inputs.forEach((g,b)=>f(g,b,!0)),i.parameters.outputs.forEach((g,b)=>f(g,b,!1)),c||(i.physical_id=ae.from(i.pass_config.name),Pa.create(i.pass_config),this._setup_pass_shaders(i,n),this._setup_pass_bind_groups(i,n),this._setup_pass_pipeline_state(i,n))}_setup_physical_resource(i,n,a,l){const c=ti(n),f=Ea(n);if(c===Yt.Buffer){const g=this.registry.buffer_resources[f],b=this.registry.resource_metadata.get(n);b.physical_id===0&&(b.physical_id=ae.from(g.config.name),qt.create(i,g.config),b.b_is_persistent||(this.registry.resource_deletion_queue.remove_execution(b.physical_id),this.registry.resource_deletion_queue.push_execution(()=>{$.get().remove(W.BUFFER,b.physical_id)},b.physical_id,b.max_frame_lifetime)))}else if(c===Yt.Image){const g=this.registry.image_resources[f],b=this.registry.resource_metadata.get(n),C=(g.config.flags&lt.LocalLoad)!==lt.None,S=a&&(!l||C);b.physical_id===0&&(b.b_is_persistent|=S,b.physical_id=ae.from(g.config.name),Fs.create(i,g.config),b.b_is_persistent||(this.registry.resource_deletion_queue.remove_execution(b.physical_id),this.registry.resource_deletion_queue.push_execution(()=>{$.get().remove(W.IMAGE,b.physical_id)},b.physical_id,b.max_frame_lifetime)))}}_tie_resource_to_pass_config_attachments(i,n,a,l,c){const f=ti(i),g=Ea(i);if(f===Yt.Image){const b=this.registry.image_resources[g],C=$.get().fetch(W.IMAGE,this.registry.resource_metadata.get(i).physical_id),S=(b.config.flags&lt.LocalLoad)!==lt.None;if(!l||S){const M=n.parameters.output_views.length>a?n.parameters.output_views[a]:0;C.config.type.includes("depth")?n.pass_config.depth_stencil_attachment={image:this.registry.resource_metadata.get(i).physical_id,view_index:M}:n.pass_config.attachments.push({image:this.registry.resource_metadata.get(i).physical_id,view_index:M})}c.pass_attachments.push(C)}}_setup_pass_input_resource_bindless_type(i,n){const a=ti(i),l=Ea(i);a===Yt.Image?this.registry.image_resources[l].config.is_bindless?n.parameters.bindless_inputs.push(i):n.parameters.pass_inputs.push(i):a===Yt.Buffer&&(this.registry.buffer_resources[l].config.b_is_bindless?n.parameters.bindless_inputs.push(i):n.parameters.pass_inputs.push(i))}_setup_pass_shaders(i,n){if(this.pass_cache.pipeline_states.get(i.pass_config.name))return;const a=i.parameters.shader_setup;if(!a.pipeline_shaders)return;(i.pass_config.flags&Ee.Compute)!==Ee.None&&a.pipeline_shaders.compute?i.shaders.compute=Jt.create(n.context,a.pipeline_shaders.compute.path):(a.pipeline_shaders.vertex&&(i.shaders.vertex=Jt.create(n.context,a.pipeline_shaders.vertex.path)),a.pipeline_shaders.fragment&&(i.shaders.fragment=Jt.create(n.context,a.pipeline_shaders.fragment.path)))}async _setup_pass_bind_groups(i,n){const a=(i.pass_config.flags&Ee.Compute)!==Ee.None,l=this.pass_cache.bind_groups.get(i.pass_config.name)||{bind_groups:Array(n.context.max_bind_groups()).fill(null)};if(this.pass_cache.bind_groups.set(i.pass_config.name,l),this._setup_global_bind_group(i,n),l.bind_groups[pe.Pass])return;let c=[],f=[];if(a)f=i.shaders.compute.reflection.getBindGroups();else{const b=i.shaders.fragment.reflection.getBindGroups();for(let C=0;C<pe.Num;C++)b[C]&&f.push(b[C])}pe.Pass<f.length&&(c=f[pe.Pass].map(C=>{let S={binding:C.binding,visibility:a?GPUShaderStage.COMPUTE:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX};const M=Jt.resource_type_from_reflection_type(C.resourceType);if(!i.parameters.pass_inputs[C.binding])throw new Error(`Pass ${i.pass_config.name} input for shader binding ${C.binding} is null or undefined. Please ensure all required pass inputs are provided.`);const F=i.parameters.pass_inputs[C.binding],U=this.registry.resource_metadata.get(F),K=ti(F);let q=null;switch(K===Yt.Image?q=$.get().fetch(W.IMAGE,U.physical_id):q=$.get().fetch(W.BUFFER,U.physical_id),M){case We.Uniform:S.buffer={type:"uniform"};break;case We.Storage:S.buffer={type:"read-only-storage"};break;case We.Texture:S.texture={viewDimension:q.config.dimension,sampleType:q.config.type==="depth"?"depth":"float"};break;case We.StorageTexture:S.storageTexture={viewDimension:q.config.dimension,sampleType:"float",format:q.config.format||"rgba8unorm"};break;case We.Sampler:S.sampler={};break}return{binding:C.binding,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,...S}}));let g=[];if(i.parameters.pass_inputs.forEach((b,C)=>{const S=this.registry.resource_metadata.get(b);if(S.b_is_persistent)if(ti(b)===Yt.Image){const F=$.get().fetch(W.IMAGE,S.physical_id);g.push({binding:C,resource:F.get_view(i.parameters.input_views[C])||F.view})}else{const F=$.get().fetch(W.BUFFER,S.physical_id);g.push({binding:C,resource:{buffer:F.buffer,offset:0,size:F.size}})}}),g.length>0){const b=qn.create_with_layout(n.context,`${i.pass_config.name}_bindgroup_${pe.Pass}`,c,pe.Pass,g);l.bind_groups[pe.Pass]=b}}_setup_pass_pipeline_state(i,n){var c;if(this.pass_cache.pipeline_states.get(i.pass_config.name)){i.pipeline_state_id=this.pass_cache.pipeline_states.get(i.pass_config.name),n.pass_pipeline_state=i.pipeline_state_id;return}const a=this.pass_cache.bind_groups.get(i.pass_config.name),l=i.parameters.shader_setup;if(l.pipeline_shaders){if((i.pass_config.flags&Ee.Compute)!==Ee.None){const g={label:i.pass_config.name,bind_layouts:a.bind_groups.filter(b=>b!==null).map(b=>b.layout),compute:{module:i.shaders.compute.module,entryPoint:l.pipeline_shaders.compute.entry_point||"cs"}};i.pipeline_state_id=ae.from(i.pass_config.name),Bs.create_compute(n.context,i.pass_config.name,g)}else{const g=i.pass_config.attachments.filter(S=>!$.get().fetch(W.IMAGE,S.image).config.type.includes("depth")).map(S=>{const F={format:$.get().fetch(W.IMAGE,S.image).config.format||"bgra8unorm"};return l.attachment_blend&&(F.blend=l.attachment_blend),F});let b=null;if(i.pass_config.depth_stencil_attachment){const S=$.get().fetch(W.IMAGE,i.pass_config.depth_stencil_attachment.image);b={depthWriteEnabled:l.b_depth_write_enabled??!0,depthCompare:l.depth_stencil_compare_op||"less",format:S.config.format||"depth24plus"}}const C={label:i.pass_config.name,bind_layouts:a.bind_groups.filter(S=>S!==null).map(S=>S.layout),vertex:{module:i.shaders.vertex.module,entryPoint:l.pipeline_shaders.vertex.entry_point||"vs",buffers:[]},fragment:{module:i.shaders.fragment.module,entryPoint:l.pipeline_shaders.fragment.entry_point||"fs",targets:g},primitive:{topology:l.primitive_topology_type||"triangle-list",cullMode:((c=l.rasterizer_state)==null?void 0:c.cull_mode)||"back"}};b&&(C.depthStencil=b),i.pipeline_state_id=ae.from(i.pass_config.name),Bs.create_render(n.context,i.pass_config.name,C)}this.pass_cache.pipeline_states.set(i.pass_config.name,i.pipeline_state_id),n.pass_pipeline_state=i.pipeline_state_id}}_setup_global_bind_group(i,n){const a=this.pass_cache.bind_groups.get(i.pass_config.name);if(a.bind_groups[pe.Global]=this.pass_cache.global_bind_group,a.bind_groups[pe.Global]&&!this.queued_global_bind_group_writes.length)return;let l=[],c=[];if(this.queued_global_bind_group_writes.forEach((f,g)=>{f.buffer?(l.push({binding:g,resource:{buffer:f.buffer.buffer,offset:f.offset||0,size:f.size}}),c.push({binding:g,visibility:f.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX|GPUShaderStage.COMPUTE,buffer:{type:f.buffer.config.usage&GPUBufferUsage.STORAGE?"read-only-storage":"uniform"}})):f.sampler?(l.push({binding:g,resource:f.sampler}),c.push({binding:g,visibility:f.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX|GPUShaderStage.COMPUTE,sampler:{}})):f.texture_view&&(l.push({binding:g,resource:f.texture_view}),c.push({binding:g,visibility:f.visibility||GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX|GPUShaderStage.COMPUTE,texture:{}}))}),this.queued_global_bind_group_writes=[],l.length>0){const f=qn.create_with_layout(n.context,`global_bindgroup_${pe.Global}`,c,pe.Global,l,!0);this.pass_cache.global_bind_group=f,a.bind_groups[pe.Global]=this.pass_cache.global_bind_group}}_bind_pass_bind_groups(i,n){const a=$.get().fetch(W.PASS,i.physical_id),l=this.pass_cache.bind_groups.get(i.pass_config.name);l.bind_groups.length>0&&(this.pass_cache.global_bind_group.bind(a),this.registry.b_global_set_bound=!0,l.bind_groups.length&&l.bind_groups[pe.Pass]&&l.bind_groups[pe.Pass].bind(a),n.pass_bind_groups[pe.Global]=l.bind_groups[pe.Global],n.pass_bind_groups[pe.Pass]=l.bind_groups[pe.Pass])}_update_transient_resources(i){i.parameters.inputs.forEach(n=>{const a=this.registry.resource_metadata.get(n);a.physical_id!==0&&a.last_user===i.handle&&a.b_is_persistent}),i.parameters.outputs.forEach(n=>{const a=this.registry.resource_metadata.get(n);a.physical_id!==0&&a.last_user===i.handle&&a.b_is_persistent})}_free_physical_resources(i){this.registry.resource_deletion_queue.update()}static create(){return new La}}var Gn=1e-6,Je=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var s=0,i=arguments.length;i--;)s+=arguments[i]*arguments[i];return Math.sqrt(s)});function Sm(){var s=new Je(9);return Je!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[5]=0,s[6]=0,s[7]=0),s[0]=1,s[4]=1,s[8]=1,s}function Gt(){var s=new Je(16);return Je!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s}function ml(s){var i=new Je(16);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i[4]=s[4],i[5]=s[5],i[6]=s[6],i[7]=s[7],i[8]=s[8],i[9]=s[9],i[10]=s[10],i[11]=s[11],i[12]=s[12],i[13]=s[13],i[14]=s[14],i[15]=s[15],i}function Im(s,i){return s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=i[3],s[4]=i[4],s[5]=i[5],s[6]=i[6],s[7]=i[7],s[8]=i[8],s[9]=i[9],s[10]=i[10],s[11]=i[11],s[12]=i[12],s[13]=i[13],s[14]=i[14],s[15]=i[15],s}function Sl(s,i,n,a,l,c,f,g,b,C,S,M,F,U,K,q){var G=new Je(16);return G[0]=s,G[1]=i,G[2]=n,G[3]=a,G[4]=l,G[5]=c,G[6]=f,G[7]=g,G[8]=b,G[9]=C,G[10]=S,G[11]=M,G[12]=F,G[13]=U,G[14]=K,G[15]=q,G}function Cm(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Il(s,i){var n=i[0],a=i[1],l=i[2],c=i[3],f=i[4],g=i[5],b=i[6],C=i[7],S=i[8],M=i[9],F=i[10],U=i[11],K=i[12],q=i[13],G=i[14],fe=i[15],oe=n*g-a*f,re=n*b-l*f,ue=n*C-c*f,Q=a*b-l*g,X=a*C-c*g,he=l*C-c*b,ye=S*q-M*K,me=S*G-F*K,rt=S*fe-U*K,$e=M*G-F*q,St=M*fe-U*q,ze=F*fe-U*G,ee=oe*ze-re*St+ue*$e+Q*rt-X*me+he*ye;return ee?(ee=1/ee,s[0]=(g*ze-b*St+C*$e)*ee,s[1]=(l*St-a*ze-c*$e)*ee,s[2]=(q*he-G*X+fe*Q)*ee,s[3]=(F*X-M*he-U*Q)*ee,s[4]=(b*rt-f*ze-C*me)*ee,s[5]=(n*ze-l*rt+c*me)*ee,s[6]=(G*ue-K*he-fe*re)*ee,s[7]=(S*he-F*ue+U*re)*ee,s[8]=(f*St-g*rt+C*ye)*ee,s[9]=(a*rt-n*St-c*ye)*ee,s[10]=(K*X-q*ue+fe*oe)*ee,s[11]=(M*ue-S*X-U*oe)*ee,s[12]=(g*me-f*$e-b*ye)*ee,s[13]=(n*$e-a*me+l*ye)*ee,s[14]=(q*re-K*Q-G*oe)*ee,s[15]=(S*Q-M*re+F*oe)*ee,s):null}function Mm(s,i,n){var a=i[0],l=i[1],c=i[2],f=i[3],g=i[4],b=i[5],C=i[6],S=i[7],M=i[8],F=i[9],U=i[10],K=i[11],q=i[12],G=i[13],fe=i[14],oe=i[15],re=n[0],ue=n[1],Q=n[2],X=n[3];return s[0]=re*a+ue*g+Q*M+X*q,s[1]=re*l+ue*b+Q*F+X*G,s[2]=re*c+ue*C+Q*U+X*fe,s[3]=re*f+ue*S+Q*K+X*oe,re=n[4],ue=n[5],Q=n[6],X=n[7],s[4]=re*a+ue*g+Q*M+X*q,s[5]=re*l+ue*b+Q*F+X*G,s[6]=re*c+ue*C+Q*U+X*fe,s[7]=re*f+ue*S+Q*K+X*oe,re=n[8],ue=n[9],Q=n[10],X=n[11],s[8]=re*a+ue*g+Q*M+X*q,s[9]=re*l+ue*b+Q*F+X*G,s[10]=re*c+ue*C+Q*U+X*fe,s[11]=re*f+ue*S+Q*K+X*oe,re=n[12],ue=n[13],Q=n[14],X=n[15],s[12]=re*a+ue*g+Q*M+X*q,s[13]=re*l+ue*b+Q*F+X*G,s[14]=re*c+ue*C+Q*U+X*fe,s[15]=re*f+ue*S+Q*K+X*oe,s}function Rm(s,i,n){var a=n[0],l=n[1],c=n[2];return s[0]=i[0]*a,s[1]=i[1]*a,s[2]=i[2]*a,s[3]=i[3]*a,s[4]=i[4]*l,s[5]=i[5]*l,s[6]=i[6]*l,s[7]=i[7]*l,s[8]=i[8]*c,s[9]=i[9]*c,s[10]=i[10]*c,s[11]=i[11]*c,s[12]=i[12],s[13]=i[13],s[14]=i[14],s[15]=i[15],s}function Um(s,i,n){var a=i[0],l=i[1],c=i[2],f=i[3],g=a+a,b=l+l,C=c+c,S=a*g,M=a*b,F=a*C,U=l*b,K=l*C,q=c*C,G=f*g,fe=f*b,oe=f*C;return s[0]=1-(U+q),s[1]=M+oe,s[2]=F-fe,s[3]=0,s[4]=M-oe,s[5]=1-(S+q),s[6]=K+G,s[7]=0,s[8]=F+fe,s[9]=K-G,s[10]=1-(S+U),s[11]=0,s[12]=n[0],s[13]=n[1],s[14]=n[2],s[15]=1,s}function Bm(s,i){return s[0]=i[12],s[1]=i[13],s[2]=i[14],s}function Cl(s,i){var n=i[0],a=i[1],l=i[2],c=i[4],f=i[5],g=i[6],b=i[8],C=i[9],S=i[10];return s[0]=Math.hypot(n,a,l),s[1]=Math.hypot(c,f,g),s[2]=Math.hypot(b,C,S),s}function Fm(s,i){var n=new Je(3);Cl(n,i);var a=1/n[0],l=1/n[1],c=1/n[2],f=i[0]*a,g=i[1]*l,b=i[2]*c,C=i[4]*a,S=i[5]*l,M=i[6]*c,F=i[8]*a,U=i[9]*l,K=i[10]*c,q=f+S+K,G=0;return q>0?(G=Math.sqrt(q+1)*2,s[3]=.25*G,s[0]=(M-U)/G,s[1]=(F-b)/G,s[2]=(g-C)/G):f>S&&f>K?(G=Math.sqrt(1+f-S-K)*2,s[3]=(M-U)/G,s[0]=.25*G,s[1]=(g+C)/G,s[2]=(F+b)/G):S>K?(G=Math.sqrt(1+S-f-K)*2,s[3]=(F-b)/G,s[0]=(g+C)/G,s[1]=.25*G,s[2]=(M+U)/G):(G=Math.sqrt(1+K-f-S)*2,s[3]=(g-C)/G,s[0]=(F+b)/G,s[1]=(M+U)/G,s[2]=.25*G),s}function Pm(s,i,n,a){var l=i[0],c=i[1],f=i[2],g=i[3],b=l+l,C=c+c,S=f+f,M=l*b,F=l*C,U=l*S,K=c*C,q=c*S,G=f*S,fe=g*b,oe=g*C,re=g*S,ue=a[0],Q=a[1],X=a[2];return s[0]=(1-(K+G))*ue,s[1]=(F+re)*ue,s[2]=(U-oe)*ue,s[3]=0,s[4]=(F-re)*Q,s[5]=(1-(M+G))*Q,s[6]=(q+fe)*Q,s[7]=0,s[8]=(U+oe)*X,s[9]=(q-fe)*X,s[10]=(1-(M+K))*X,s[11]=0,s[12]=n[0],s[13]=n[1],s[14]=n[2],s[15]=1,s}function Lm(s,i,n,a,l){var c=1/Math.tan(i/2),f;return s[0]=c/n,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,l!=null&&l!==1/0?(f=1/(a-l),s[10]=(l+a)*f,s[14]=2*l*a*f):(s[10]=-1,s[14]=-2*a),s}var Om=Lm;function Nm(s,i,n,a){var l,c,f,g,b,C,S,M,F,U,K=i[0],q=i[1],G=i[2],fe=a[0],oe=a[1],re=a[2],ue=n[0],Q=n[1],X=n[2];return Math.abs(K-ue)<Gn&&Math.abs(q-Q)<Gn&&Math.abs(G-X)<Gn?Cm(s):(S=K-ue,M=q-Q,F=G-X,U=1/Math.hypot(S,M,F),S*=U,M*=U,F*=U,l=oe*F-re*M,c=re*S-fe*F,f=fe*M-oe*S,U=Math.hypot(l,c,f),U?(U=1/U,l*=U,c*=U,f*=U):(l=0,c=0,f=0),g=M*f-F*c,b=F*l-S*f,C=S*c-M*l,U=Math.hypot(g,b,C),U?(U=1/U,g*=U,b*=U,C*=U):(g=0,b=0,C=0),s[0]=l,s[1]=g,s[2]=S,s[3]=0,s[4]=c,s[5]=b,s[6]=M,s[7]=0,s[8]=f,s[9]=C,s[10]=F,s[11]=0,s[12]=-(l*K+c*q+f*G),s[13]=-(g*K+b*q+C*G),s[14]=-(S*K+M*q+F*G),s[15]=1,s)}var Ml=Mm;function Et(){var s=new Je(3);return Je!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function Ca(s){var i=new Je(3);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i}function zm(s){var i=s[0],n=s[1],a=s[2];return Math.hypot(i,n,a)}function jt(s,i,n){var a=new Je(3);return a[0]=s,a[1]=i,a[2]=n,a}function yl(s,i){return s[0]=i[0],s[1]=i[1],s[2]=i[2],s}function Sa(s,i,n,a){return s[0]=i,s[1]=n,s[2]=a,s}function rs(s,i,n){return s[0]=i[0]+n[0],s[1]=i[1]+n[1],s[2]=i[2]+n[2],s}function Gm(s,i,n){return s[0]=i[0]-n[0],s[1]=i[1]-n[1],s[2]=i[2]-n[2],s}function si(s,i,n){return s[0]=Math.min(i[0],n[0]),s[1]=Math.min(i[1],n[1]),s[2]=Math.min(i[2],n[2]),s}function ii(s,i,n){return s[0]=Math.max(i[0],n[0]),s[1]=Math.max(i[1],n[1]),s[2]=Math.max(i[2],n[2]),s}function Ss(s,i,n){return s[0]=i[0]*n,s[1]=i[1]*n,s[2]=i[2]*n,s}function Dm(s,i,n,a){return s[0]=i[0]+n[0]*a,s[1]=i[1]+n[1]*a,s[2]=i[2]+n[2]*a,s}function Rl(s,i){var n=i[0],a=i[1],l=i[2],c=n*n+a*a+l*l;return c>0&&(c=1/Math.sqrt(c)),s[0]=i[0]*c,s[1]=i[1]*c,s[2]=i[2]*c,s}function qm(s,i){return s[0]*i[0]+s[1]*i[1]+s[2]*i[2]}function ir(s,i,n){var a=i[0],l=i[1],c=i[2],f=n[0],g=n[1],b=n[2];return s[0]=l*b-c*g,s[1]=c*f-a*b,s[2]=a*g-l*f,s}function Km(s,i,n){var a=n[0],l=n[1],c=n[2],f=n[3],g=i[0],b=i[1],C=i[2],S=l*C-c*b,M=c*g-a*C,F=a*b-l*g,U=l*F-c*M,K=c*S-a*F,q=a*M-l*S,G=f*2;return S*=G,M*=G,F*=G,U*=2,K*=2,q*=2,s[0]=g+S+U,s[1]=b+M+K,s[2]=C+F+q,s}var Wm=Gm,$m=zm;(function(){var s=Et();return function(i,n,a,l,c,f){var g,b;for(n||(n=3),a||(a=0),l?b=Math.min(l*n+a,i.length):b=i.length,g=a;g<b;g+=n)s[0]=i[g],s[1]=i[g+1],s[2]=i[g+2],c(s,s,f),i[g]=s[0],i[g+1]=s[1],i[g+2]=s[2];return i}})();function it(){var s=new Je(4);return Je!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Oa(s){var i=new Je(4);return i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],i}function an(s,i,n,a){var l=new Je(4);return l[0]=s,l[1]=i,l[2]=n,l[3]=a,l}function Is(s,i,n){return s[0]=i[0]+n[0],s[1]=i[1]+n[1],s[2]=i[2]+n[2],s[3]=i[3]+n[3],s}function Cs(s,i,n){return s[0]=i[0]*n,s[1]=i[1]*n,s[2]=i[2]*n,s[3]=i[3]*n,s}function Hm(s,i,n,a){return s[0]=i[0]+n[0]*a,s[1]=i[1]+n[1]*a,s[2]=i[2]+n[2]*a,s[3]=i[3]+n[3]*a,s}function Ul(s,i){var n=i[0],a=i[1],l=i[2],c=i[3],f=n*n+a*a+l*l+c*c;return f>0&&(f=1/Math.sqrt(f)),s[0]=n*f,s[1]=a*f,s[2]=l*f,s[3]=c*f,s}function Vm(s,i,n,a){var l=i[0],c=i[1],f=i[2],g=i[3];return s[0]=l+a*(n[0]-l),s[1]=c+a*(n[1]-c),s[2]=f+a*(n[2]-f),s[3]=g+a*(n[3]-g),s}function Xm(s,i,n){var a=i[0],l=i[1],c=i[2],f=n[0],g=n[1],b=n[2],C=n[3],S=C*a+g*c-b*l,M=C*l+b*a-f*c,F=C*c+f*l-g*a,U=-f*a-g*l-b*c;return s[0]=S*C+U*-f+M*-b-F*-g,s[1]=M*C+U*-g+F*-f-S*-b,s[2]=F*C+U*-b+S*-g-M*-f,s[3]=i[3],s}function Bl(s,i){var n=s[0],a=s[1],l=s[2],c=s[3],f=i[0],g=i[1],b=i[2],C=i[3];return Math.abs(n-f)<=Gn*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=Gn*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(l-b)<=Gn*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(c-C)<=Gn*Math.max(1,Math.abs(c),Math.abs(C))}(function(){var s=it();return function(i,n,a,l,c,f){var g,b;for(n||(n=4),a||(a=0),l?b=Math.min(l*n+a,i.length):b=i.length,g=a;g<b;g+=n)s[0]=i[g],s[1]=i[g+1],s[2]=i[g+2],s[3]=i[g+3],c(s,s,f),i[g]=s[0],i[g+1]=s[1],i[g+2]=s[2],i[g+3]=s[3];return i}})();function Kn(){var s=new Je(4);return Je!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s[3]=1,s}function Ma(s,i,n){n=n*.5;var a=Math.sin(n);return s[0]=a*i[0],s[1]=a*i[1],s[2]=a*i[2],s[3]=Math.cos(n),s}function vl(s,i,n){var a=i[0],l=i[1],c=i[2],f=i[3],g=n[0],b=n[1],C=n[2],S=n[3];return s[0]=a*S+f*g+l*C-c*b,s[1]=l*S+f*b+c*g-a*C,s[2]=c*S+f*C+a*b-l*g,s[3]=f*S-a*g-l*b-c*C,s}function rr(s,i,n,a){var l=i[0],c=i[1],f=i[2],g=i[3],b=n[0],C=n[1],S=n[2],M=n[3],F,U,K,q,G;return U=l*b+c*C+f*S+g*M,U<0&&(U=-U,b=-b,C=-C,S=-S,M=-M),1-U>Gn?(F=Math.acos(U),K=Math.sin(F),q=Math.sin((1-a)*F)/K,G=Math.sin(a*F)/K):(q=1-a,G=a),s[0]=q*l+G*b,s[1]=q*c+G*C,s[2]=q*f+G*S,s[3]=q*g+G*M,s}function Ym(s,i){var n=i[0]+i[4]+i[8],a;if(n>0)a=Math.sqrt(n+1),s[3]=.5*a,a=.5/a,s[0]=(i[5]-i[7])*a,s[1]=(i[6]-i[2])*a,s[2]=(i[1]-i[3])*a;else{var l=0;i[4]>i[0]&&(l=1),i[8]>i[l*3+l]&&(l=2);var c=(l+1)%3,f=(l+2)%3;a=Math.sqrt(i[l*3+l]-i[c*3+c]-i[f*3+f]+1),s[l]=.5*a,a=.5/a,s[3]=(i[c*3+f]-i[f*3+c])*a,s[c]=(i[c*3+l]+i[l*3+c])*a,s[f]=(i[f*3+l]+i[l*3+f])*a}return s}function Zm(s,i,n,a){var l=.5*Math.PI/180;i*=l,n*=l,a*=l;var c=Math.sin(i),f=Math.cos(i),g=Math.sin(n),b=Math.cos(n),C=Math.sin(a),S=Math.cos(a);return s[0]=c*b*S-f*g*C,s[1]=f*g*S+c*b*C,s[2]=f*b*C-c*g*S,s[3]=f*b*S+c*g*C,s}var Fl=Oa,Jm=an,Pl=Ul,Qm=Bl;(function(){var s=Et(),i=jt(1,0,0),n=jt(0,1,0);return function(a,l,c){var f=qm(l,c);return f<-.999999?(ir(s,i,l),$m(s)<1e-6&&ir(s,n,l),Rl(s,s),Ma(a,s,Math.PI),a):f>.999999?(a[0]=0,a[1]=0,a[2]=0,a[3]=1,a):(ir(s,l,c),a[0]=s[0],a[1]=s[1],a[2]=s[2],a[3]=1+f,Pl(a,a))}})();(function(){var s=Kn(),i=Kn();return function(n,a,l,c,f,g){return rr(s,a,f,g),rr(i,l,c,g),rr(n,s,i,2*g*(1-g)),n}})();(function(){var s=Sm();return function(i,n,a,l){return s[0]=a[0],s[3]=a[1],s[6]=a[2],s[1]=l[0],s[4]=l[1],s[7]=l[2],s[2]=-n[0],s[5]=-n[1],s[8]=-n[2],Pl(i,Ym(i,s))}})();var Re=Re||{},Ll=0,Qt=null,Ol=65,jm=Re.Scene=function(s,i){this.name=i.name!==void 0?i.name:null,this.nodes=new Array(i.nodes.length);for(var n=0,a=i.nodes.length;n<a;n++)this.nodes[n]=s.nodes[i.nodes[n]];this.extensions=i.extensions!==void 0?i.extensions:null,this.extras=i.extras!==void 0?i.extras:null,this.boundingBox=null},kn=Re.BoundingBox=function(s,i,n){s=s||jt(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=i||jt(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),n===void 0||n===!0?(this.min=Ca(s),this.max=Ca(i)):(this.min=s,this.max=i),this.transform=Gt()};kn.prototype.updateBoundingBox=function(s){si(this.min,this.min,s.min),ii(this.max,this.max,s.max)};kn.prototype.calculateTransform=function(){this.transform[0]=this.max[0]-this.min[0],this.transform[5]=this.max[1]-this.min[1],this.transform[10]=this.max[2]-this.min[2],this.transform[12]=this.min[0],this.transform[13]=this.min[1],this.transform[14]=this.min[2]};kn.getAABBFromOBB=function(){var s=Et(),i=Et(),n=Et(),a=Et(),l=Et();return function(c,f){Sa(s,f[0],f[1],f[2]),Sa(i,f[4],f[5],f[6]),Sa(n,f[8],f[9],f[10]);var g=jt(f[12],f[13],f[14]),b=Ca(g);Ss(a,s,c.min[0]),Ss(l,s,c.max[0]),si(s,a,l),rs(g,g,s),ii(s,a,l),rs(b,b,s),Ss(a,i,c.min[1]),Ss(l,i,c.max[1]),si(i,a,l),rs(g,g,i),ii(i,a,l),rs(b,b,i),Ss(a,n,c.min[2]),Ss(l,n,c.max[2]),si(n,a,l),rs(g,g,n),ii(n,a,l),rs(b,b,n);var C=new kn(g,b,!1);return C.calculateTransform(),C}}();var Nl=Re.Accessor=function(s,i){this.bufferView=i,this.componentType=s.componentType,this.byteOffset=s.byteOffset!==void 0?s.byteOffset:0,this.byteStride=i.byteStride,this.normalized=s.normalized!==void 0?s.normalized:!1,this.count=s.count,this.type=s.type,this.size=Na[this.type],this.min=s.min,this.max=s.max,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null};Nl.prototype.prepareVertexAttrib=function(s,i){i.vertexAttribPointer(s,this.size,this.componentType,this.normalized,this.byteStride,this.byteOffset),i.enableVertexAttribArray(s)};var e0=Re.BufferView=function(s,i){this.byteLength=s.byteLength,this.byteOffset=s.byteOffset!==void 0?s.byteOffset:0,this.byteStride=s.byteStride!==void 0?s.byteStride:0,this.target=s.target!==void 0?s.target:null,this.data=i.slice(this.byteOffset,this.byteOffset+this.byteLength),this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.buffer=null},t0=Re.Camera=function(s){this.name=s.name!==void 0?s.name:null,this.type=s.type,this.othographic=s.othographic===void 0?null:s.othographic,this.perspective=s.perspective===void 0?null:{yfov:s.perspective.yfov,znear:s.perspective.znear,zfar:s.perspective.zfar!==void 0?s.perspective.zfar:null,aspectRatio:s.perspective.aspectRatio!==void 0?s.perspective.aspectRatio:null},this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},Ps=Re.Node=function(s,i){if(this.name=s.name!==void 0?s.name:null,this.nodeID=i,this.camera=s.camera!==void 0?s.camera:null,this.matrix=Gt(),s.hasOwnProperty("matrix")){for(var n=0;n<16;++n)this.matrix[n]=s.matrix[n];this.translation=Et(),Bm(this.translation,this.matrix),this.rotation=Kn(),Fm(this.rotation,this.matrix),this.scale=Et(),Cl(this.scale,this.matrix)}else this.getTransformMatrixFromTRS(s.translation,s.rotation,s.scale);if(this.children=s.children||[],this.mesh=s.mesh!==void 0?Qt.glTF.meshes[s.mesh]:null,this.skin=s.skin!==void 0?s.skin:null,s.extensions!==void 0&&s.extensions.gl_avatar!==void 0&&Qt.enableGLAvatar===!0){var a=Qt.skeletonGltf.json.extensions.gl_avatar.skins[s.extensions.gl_avatar.skin.name],l=Qt.skeletonGltf.skins[a];this.skin=new u0(Qt.glTF,l,s.extensions.gl_avatar.skin.inverseBindMatrices)}this.weights=s.weights!==void 0?s.weights:null,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.aabb=null,this.bvh=new kn};Ps.prototype.traverse=function(s,i){i(this,s);for(var n=0,a=this.children.length;n<a;n++)this.children[n].traverse(this,i)};Ps.prototype.traversePostOrder=function(s,i){for(var n=0,a=this.children.length;n<a;n++)this.children[n].traversePostOrder(this,i);i(this,s)};Ps.prototype.traverseTwoExecFun=function(s,i,n){i(this,s);for(var a=0,l=this.children.length;a<l;a++)this.children[a].traverseTwoExecFun(this,i,n);n(this,s)};var wl=Gt();Ps.prototype.getTransformMatrixFromTRS=function(s,i,n){this.translation=s!==void 0?jt(s[0],s[1],s[2]):jt(0,0,0),this.rotation=i!==void 0?an(i[0],i[1],i[2],i[3]):an(0,0,0,1),this.scale=n!==void 0?jt(n[0],n[1],n[2]):jt(1,1,1),this.updateMatrixFromTRS()};Ps.prototype.updateMatrixFromTRS=function(){Um(wl,this.rotation,this.translation),Rm(this.matrix,wl,this.scale)};var n0=Re.Mesh=function(s,i){this.meshID=i,this.name=s.name!==void 0?s.name:null,this.primitives=[],this.boundingBox=null;for(var n,a,l=0,c=s.primitives.length;l<c;++l)n=s.primitives[l],a=new s0(Qt.glTF,n),this.primitives.push(a),a.boundingBox&&(this.boundingBox||(this.boundingBox=new kn),this.boundingBox.updateBoundingBox(a.boundingBox));this.boundingBox&&this.boundingBox.calculateTransform(),this.weights=s.weights!==void 0?s.weights:null,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},s0=Re.Primitive=function(s,i){this.attributes=i.attributes,this.indices=i.indices!==void 0?i.indices:null;var n;if(i.extensions!==void 0&&i.extensions.gl_avatar!==void 0&&Qt.enableGLAvatar===!0&&i.extensions.gl_avatar.attributes)for(n in i.extensions.gl_avatar.attributes)this.attributes[n]=i.extensions.gl_avatar.attributes[n];this.indices!==null?(this.indicesComponentType=s.json.accessors[this.indices].componentType,this.indicesLength=s.json.accessors[this.indices].count,this.indicesOffset=s.json.accessors[this.indices].byteOffset||0):(this.drawArraysCount=s.json.accessors[this.attributes.POSITION].count,this.drawArraysOffset=s.json.accessors[this.attributes.POSITION].byteOffset||0);for(n in this.attributes)this.attributes[n]=s.accessors[this.attributes[n]];if(this.material=i.material!==void 0?s.materials[i.material]:null,this.mode=i.mode!==void 0?i.mode:4,this.targets=i.targets,this.extensions=i.extensions!==void 0?i.extensions:null,this.extras=i.extras!==void 0?i.extras:null,this.vertexArray=null,this.vertexBuffer=null,this.indexBuffer=null,this.shader=null,this.boundingBox=null,this.attributes.POSITION!==void 0){var a=this.attributes.POSITION;a.max&&a.type==="VEC3"&&(this.boundingBox=new kn(jt(a.min[0],a.min[1],a.min[2]),jt(a.max[0],a.max[1],a.max[2]),!1),this.boundingBox.calculateTransform())}},zl=Re.Texture=function(s){this.name=s.name!==void 0?s.name:null,this.sampler=s.sampler!==void 0?Qt.glTF.samplers[s.sampler]:null,this.source=s.source!==void 0?Qt.glTF.images[s.source]:null,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.texture=null};zl.prototype.createTexture=function(s){this.texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this.texture),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,this.source),s.generateMipmap(s.TEXTURE_2D),s.bindTexture(s.TEXTURE_2D,null)};var Gl=Re.Sampler=function(s){this.name=s.name!==void 0?s.name:null,this.magFilter=s.magFilter!==void 0?s.magFilter:null,this.minFilter=s.minFilter!==void 0?s.minFilter:null,this.wrapS=s.wrapS!==void 0?s.wrapS:10497,this.wrapT=s.wrapT!==void 0?s.wrapT:10497,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null,this.sampler=null};Gl.prototype.createSampler=function(s){this.sampler=s.createSampler(),this.minFilter?s.samplerParameteri(this.sampler,s.TEXTURE_MIN_FILTER,this.minFilter):s.samplerParameteri(this.sampler,s.TEXTURE_MIN_FILTER,s.NEAREST_MIPMAP_LINEAR),this.magFilter?s.samplerParameteri(this.sampler,s.TEXTURE_MAG_FILTER,this.magFilter):s.samplerParameteri(this.sampler,s.TEXTURE_MAG_FILTER,s.LINEAR),s.samplerParameteri(this.sampler,s.TEXTURE_WRAP_S,this.wrapS),s.samplerParameteri(this.sampler,s.TEXTURE_WRAP_T,this.wrapT)};var Ra=Re.TextureInfo=function(s){this.index=s.index,this.texCoord=s.texCoord!==void 0?s.texCoord:0,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},bl=Re.PbrMetallicRoughness=function(s){this.baseColorFactor=s.baseColorFactor!==void 0?s.baseColorFactor:[1,1,1,1],this.baseColorTexture=s.baseColorTexture!==void 0?new Ra(s.baseColorTexture):null,this.metallicFactor=s.metallicFactor!==void 0?s.metallicFactor:1,this.roughnessFactor=s.roughnessFactor!==void 0?s.roughnessFactor:1,this.metallicRoughnessTexture=s.metallicRoughnessTexture!==void 0?new Ra(s.metallicRoughnessTexture):null,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},i0=Re.NormalTextureInfo=function(s){this.index=s.index,this.texCoord=s.texCoord!==void 0?s.texCoord:0,this.scale=s.scale!==void 0?s.scale:1,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},r0=Re.OcclusionTextureInfo=function(s){this.index=s.index,this.texCoord=s.texCoord!==void 0?s.texCoord:0,this.strength=s.strength!==void 0?s.strength:1,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},a0=Re.Material=function(s){this.name=s.name!==void 0?s.name:null,this.pbrMetallicRoughness=s.pbrMetallicRoughness!==void 0?new bl(s.pbrMetallicRoughness):new bl({baseColorFactor:[1,1,1,1],metallicFactor:1,metallicRoughnessTexture:1}),this.normalTexture=s.normalTexture!==void 0?new i0(s.normalTexture):null,this.occlusionTexture=s.occlusionTexture!==void 0?new r0(s.occlusionTexture):null,this.emissiveTexture=s.emissiveTexture!==void 0?new Ra(s.emissiveTexture):null,this.emissiveFactor=s.emissiveFactor!==void 0?s.emissiveFactor:[0,0,0],this.alphaMode=s.alphaMode!==void 0?s.alphaMode:"OPAQUE",this.alphaCutoff=s.alphaCutoff!==void 0?s.alphaCutoff:.5,this.doubleSided=s.doubleSided||!1,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},o0=Re.Skin=function(s,i,n){this.name=i.name!==void 0?i.name:null,this.skinID=n,this.joints=new Array(i.joints.length);var a,l;for(a=0,l=this.joints.length;a<l;a++)this.joints[a]=s.nodes[i.joints[a]];if(this.skeleton=i.skeleton!==void 0?s.nodes[i.skeleton]:null,this.inverseBindMatrices=i.inverseBindMatrices!==void 0?s.accessors[i.inverseBindMatrices]:null,this.extensions=i.extensions!==void 0?i.extensions:null,this.extras=i.extras!==void 0?i.extras:null,this.uniformBlockID=Ll++,this.inverseBindMatrices)for(this.inverseBindMatricesData=ur(this.inverseBindMatrices),this.inverseBindMatrix=[],this.jointMatrixUniformBuffer=null,this.jointMatrixUnidormBufferData=new Float32Array(Ol*16),a=0,l=this.inverseBindMatricesData.length;a<l;a+=16)this.inverseBindMatrix.push(Sl(this.inverseBindMatricesData[a],this.inverseBindMatricesData[a+1],this.inverseBindMatricesData[a+2],this.inverseBindMatricesData[a+3],this.inverseBindMatricesData[a+4],this.inverseBindMatricesData[a+5],this.inverseBindMatricesData[a+6],this.inverseBindMatricesData[a+7],this.inverseBindMatricesData[a+8],this.inverseBindMatricesData[a+9],this.inverseBindMatricesData[a+10],this.inverseBindMatricesData[a+11],this.inverseBindMatricesData[a+12],this.inverseBindMatricesData[a+13],this.inverseBindMatricesData[a+14],this.inverseBindMatricesData[a+15]))},u0=Re.SkinLink=function(s,i,n){if(this.isLink=!0,s.skins||(s.skins=[]),s.skins.push(this),this.name=i.name,this.skinID=s.skins.length-1,this.joints=i.joints,this.skeleton=i.skeleton,this.inverseBindMatrices=n!==void 0?s.accessors[n]:null,this.uniformBlockID=Ll++,this.inverseBindMatrices){this.inverseBindMatricesData=ur(this.inverseBindMatrices),this.inverseBindMatrix=[],this.jointMatrixUniformBuffer=null,this.jointMatrixUnidormBufferData=new Float32Array(Ol*16);for(var a=0,l=this.inverseBindMatricesData.length;a<l;a+=16)this.inverseBindMatrix.push(Sl(this.inverseBindMatricesData[a],this.inverseBindMatricesData[a+1],this.inverseBindMatricesData[a+2],this.inverseBindMatricesData[a+3],this.inverseBindMatricesData[a+4],this.inverseBindMatricesData[a+5],this.inverseBindMatricesData[a+6],this.inverseBindMatricesData[a+7],this.inverseBindMatricesData[a+8],this.inverseBindMatricesData[a+9],this.inverseBindMatricesData[a+10],this.inverseBindMatricesData[a+11],this.inverseBindMatricesData[a+12],this.inverseBindMatricesData[a+13],this.inverseBindMatricesData[a+14],this.inverseBindMatricesData[a+15]))}},l0=Re.Target=function(s){this.nodeID=s.node!==void 0?s.node:null,this.path=s.path,this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},c0=Re.Channel=function(s,i){this.sampler=i.samplers[s.sampler],this.target=new l0(s.target),this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},Dl=Re.AnimationSampler=function(s,i){this.input=s.accessors[i.input],this.output=s.accessors[i.output],this.inputTypedArray=ur(this.input),this.outputTypedArray=ur(this.output),this.interpolation=i.interpolation!==void 0?i.interpolation:"LINEAR",this.extensions=i.extensions!==void 0?i.extensions:null,this.extras=i.extras!==void 0?i.extras:null,this.curIdx=0,this.curValue=it(),this.endT=this.inputTypedArray[this.inputTypedArray.length-1],this.inputMax=this.endT-this.inputTypedArray[0]},xl=it(),kl=it();Dl.prototype.getValue=function(s){s>this.endT&&(s-=this.inputMax*Math.ceil((s-this.endT)/this.inputMax),this.curIdx=0);for(var i=this.inputTypedArray.length;this.curIdx<=i-2&&s>=this.inputTypedArray[this.curIdx+1];)this.curIdx++;this.curIdx>=i-1&&(s-=this.inputMax,this.curIdx=0);for(var n=Na[this.output.type],a=n===4?rr:Vm,l=this.curIdx,c=l*n,f=c+n,g=Math.max(0,s-this.inputTypedArray[l])/(this.inputTypedArray[l+1]-this.inputTypedArray[l]),b=0;b<n;b++)xl[b]=this.outputTypedArray[c+b],kl[b]=this.outputTypedArray[f+b];switch(this.interpolation){case"LINEAR":a(this.curValue,xl,kl,g);break}};var h0=Re.Animation=function(s,i){this.name=i.name!==void 0?i.name:null;var n,a;for(this.samplers=[],n=0,a=i.samplers.length;n<a;n++)this.samplers[n]=new Dl(s,i.samplers[n]);for(this.channels=[],n=0,a=i.channels.length;n<a;n++)this.channels[n]=new c0(i.channels[n],this);this.extensions=i.extensions!==void 0?i.extensions:null,this.extras=i.extras!==void 0?i.extras:null},_0=Re.glTFModel=function(s){this.json=s,this.defaultScene=s.scene!==void 0?s.scene:0,this.version=Number(s.asset.version),s.accessors&&(this.accessors=new Array(s.accessors.length)),s.bufferViews&&(this.bufferViews=new Array(s.bufferViews.length)),s.scenes&&(this.scenes=new Array(s.scenes.length)),s.nodes&&(this.nodes=new Array(s.nodes.length)),s.meshes&&(this.meshes=new Array(s.meshes.length)),s.materials&&(this.materials=new Array(s.materials.length)),s.textures&&(this.textures=new Array(s.textures.length)),s.samplers&&(this.samplers=new Array(s.samplers.length)),s.images&&(this.images=new Array(s.images.length)),s.skins&&(this.skins=new Array(s.skins.length)),s.animations&&(this.animations=new Array(s.animations.length)),s.cameras&&(this.cameras=new Array(s.cameras.length)),this.extensions=s.extensions!==void 0?s.extensions:null,this.extras=s.extras!==void 0?s.extras:null},Ls=Re.glTFLoader=function(){this._init(),this.glTF=null,this.enableGLAvatar=!1,this.linkSkeletonGltf=null};Ls.prototype._init=function(){this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers=[],this._bufferTasks={},this._shaderRequested=0,this._shaderLoaded=0,this._imageRequested=0,this._imageLoaded=0,this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null,Qt=this};Ls.prototype._checkComplete=function(){this._bufferRequested==this._bufferLoaded&&this._imageRequested==this._imageLoaded&&(this._loadDone=!0),this._loadDone&&this._pendingTasks==this._finishedPendingTasks&&(this._postprocess(),this.onload(this.glTF))};Ls.prototype.load_GL_Avatar_Skin=function(s,i,n){this.enableGLAvatar=!0,this.skeletonGltf=i,this.load(s,n)};Ls.prototype.load=function(s,i){this._init(),this.onload=i||function(a){console.log("glTF model loaded."),console.log(a)},this.baseUri=d0(s);var n=this;p0(s,function(a){var l=JSON.parse(a);n.glTF=new _0(l);var c,f=function(C){if(n._buffers[c]=C,n._bufferLoaded++,n._bufferTasks[c]){var S,M;for(S=0,M=n._bufferTasks[c].length;S<M;++S)n._bufferTasks[c][S](C)}n._checkComplete()};if(l.buffers)for(c in l.buffers)n._bufferRequested++,g0(n.baseUri+l.buffers[c].uri,f);var g=function(C,S){n._imageLoaded++,n.glTF.images[S]=C,n._checkComplete()},b;if(l.images)for(b in l.images)n._imageRequested++,m0(n.baseUri+l.images[b].uri,b,g);n._checkComplete()})};Ls.prototype._postprocess=function(){Qt=this;var s,i,n,a,l,c,f;if(this.glTF.cameras)for(s=0,i=this.glTF.cameras.length;s<i;s++)this.glTF.cameras[s]=new t0(this.glTF.json.cameras[s]);if(this.glTF.bufferViews)for(s=0,i=this.glTF.bufferViews.length;s<i;s++)this.glTF.bufferViews[s]=new e0(this.glTF.json.bufferViews[s],this._buffers[this.glTF.json.bufferViews[s].buffer]);if(this.glTF.accessors)for(s=0,i=this.glTF.accessors.length;s<i;s++)this.glTF.accessors[s]=new Nl(this.glTF.json.accessors[s],this.glTF.bufferViews[this.glTF.json.accessors[s].bufferView]);if(this.glTF.materials)for(s=0,i=this.glTF.materials.length;s<i;s++)this.glTF.materials[s]=new a0(this.glTF.json.materials[s]);if(this.glTF.samplers)for(s=0,i=this.glTF.samplers.length;s<i;s++)this.glTF.samplers[s]=new Gl(this.glTF.json.samplers[s]);if(this.glTF.textures)for(s=0,i=this.glTF.textures.length;s<i;s++)this.glTF.textures[s]=new zl(this.glTF.json.textures[s]);for(s=0,i=this.glTF.meshes.length;s<i;s++)this.glTF.meshes[s]=new n0(this.glTF.json.meshes[s],s);for(s=0,i=this.glTF.nodes.length;s<i;s++)this.glTF.nodes[s]=new Ps(this.glTF.json.nodes[s],s);for(s=0,i=this.glTF.nodes.length;s<i;s++)for(c=this.glTF.nodes[s],n=0,a=c.children.length;n<a;n++)c.children[n]=this.glTF.nodes[c.children[n]];var g=new Array(this.glTF.nodes.length);for(s=0,i=g.length;s<i;s++)g[s]=Gt();function b(M,F){var U=g[M.nodeID];F!==null?Ml(U,g[F.nodeID],M.matrix):Im(U,M.matrix)}function C(M,F){var U=g[M.nodeID],K;F!==null?K=F.bvh:K=l.boundingBox,M.mesh&&(f=M.mesh,f.boundingBox&&(M.aabb=kn.getAABBFromOBB(f.boundingBox,U),M.children.length===0&&(yl(M.bvh.min,M.aabb.min),yl(M.bvh.max,M.aabb.max)))),si(K.min,K.min,M.bvh.min),ii(K.max,K.max,M.bvh.max)}for(s=0,i=this.glTF.scenes.length;s<i;s++){for(l=this.glTF.scenes[s]=new jm(this.glTF,this.glTF.json.scenes[s]),l.boundingBox=new kn,n=0,a=l.nodes.length;n<a;n++)c=l.nodes[n],c.traverseTwoExecFun(null,b,C);l.boundingBox.calculateTransform()}for(n=0,a=this.glTF.nodes.length;n<a;n++)c=this.glTF.nodes[n],c.bvh!==null&&c.bvh.calculateTransform();if(this.glTF.animations)for(s=0,i=this.glTF.animations.length;s<i;s++)this.glTF.animations[s]=new h0(this.glTF,this.glTF.json.animations[s]);var S;if(this.glTF.json.skins)for(s=0,i=this.glTF.skins.length;s<i;s++)for(this.glTF.skins[s]=new o0(this.glTF,this.glTF.json.skins[s],s),S=this.glTF.skins[s].joints,n=0,a=S.length;n<a;n++)S[n].jointID=n;for(s=0,i=this.glTF.nodes.length;s<i;s++)c=this.glTF.nodes[s],c.skin!==null&&typeof c.skin=="number"&&(c.skin=this.glTF.skins[c.skin])};var Na={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function f0(s,i,n,a){switch(a){case 5122:return new Int16Array(s,i,n);case 5123:return new Uint16Array(s,i,n);case 5124:return new Int32Array(s,i,n);case 5125:return new Uint32Array(s,i,n);case 5126:return new Float32Array(s,i,n);default:return null}}function ur(s){return f0(s.bufferView.data,s.byteOffset,s.count*Na[s.type],s.componentType)}function d0(s){var i="",n=s.lastIndexOf("/");return n!==-1&&(i=s.substring(0,n+1)),i}function p0(s,i){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",s,!0),n.onreadystatechange=function(){n.readyState==4&&n.status=="200"&&i(n.responseText,this)},n.send(null)}function g0(s,i){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",s,!0),n.onreadystatechange=function(){if(n.readyState==4&&n.status=="200"){var a=n.response;a&&i&&i(a)}},n.send(null)}function m0(s,i,n){var a=new Image;a.crossOrigin="Anonymous",a.src=s,a.onload=function(){n(a,i)}}const lr=an(0,1,0,0),ar=an(0,0,1,0);an(1,0,0,0);class mt{constructor(){P(this,"buffer",null);P(this,"vertex_data",[]);P(this,"size",0);if(mt.instance)return mt.instance;mt.instance=this}static get(){return mt.instance||(mt.instance=new mt),mt.instance}add_vertex_data(i,n){const a=this.vertex_data.length;return this.vertex_data.push(...n),this.size=this._get_byte_size(),this.build(i),a}_get_byte_size(){return this.vertex_data.map(i=>i.position.concat(i.normal,i.color,i.uv,i.tangent,i.bitangent)).flat().length*4}build(i){this.buffer&&this.buffer.destroy(),this.buffer=qt.create(i,{name:"vertex_buffer",data:this.vertex_data.map(n=>n.position.concat(n.normal,n.color,n.uv,n.tangent,n.bitangent)),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Ne.get().refresh_global_shader_bindings()}}class yt{constructor(){P(this,"view_data",[]);P(this,"type_size_bytes",0);P(this,"raw_data",null);P(this,"size",0);if(yt.instance)return yt.instance;yt.instance=this}static get(){return yt.instance?yt.instance:new yt}add_view_data(i,n={}){this.view_data.push({position:n.position??it(),rotation:n.rotation??Kn(),fov:n.fov??75,aspect_ratio:n.aspect_ratio??1,near:n.near??.01,far:n.far??1e3,view_forward:n.view_forward??it(),view_right:n.view_right??it(),view_matrix:n.view_matrix??Gt(),projection_matrix:n.projection_matrix??Gt(),prev_view_matrix:n.prev_view_matrix??Gt(),prev_projection_matrix:n.prev_projection_matrix??Gt(),view_projection_matrix:n.view_projection_matrix??Gt(),inverse_view_projection_matrix:n.inverse_view_projection_matrix_direction_only??Gt()}),this.type_size_bytes===0&&(this.type_size_bytes=this._get_gpu_type_layout(this.view_data[0]).length*4);const a=this.view_data.map(l=>this._get_gpu_type_layout(l)).flat();return this.raw_data=new Float32Array(a.length),this.raw_data.set(a),this.size=this.type_size_bytes*this.view_data.length,this.build(i),this.view_data.length-1}get_view_data(i){return console.assert(i<this.view_data.length&&i>=0,"View data index out of bounds"),this.view_data[i]}set_view_data(i,n,a){let l=!1;a.position&&!Bl(this.view_data[n].position,a.position)&&(this.view_data[n].position=Oa(a.position),l=!0),a.rotation&&!Qm(this.view_data[n].rotation,a.rotation)&&(this.view_data[n].rotation=Fl(a.rotation),l=!0),a.fov&&this.view_data[n].fov!==a.fov&&(this.view_data[n].fov=a.fov,l=!0),a.aspect_ratio&&this.view_data[n].aspect_ratio!==a.aspect_ratio&&(this.view_data[n].aspect_ratio=a.aspect_ratio,l=!0),a.near&&this.view_data[n].near!==a.near&&(this.view_data[n].near=a.near,l=!0),a.far&&this.view_data[n].far!==a.far&&(this.view_data[n].far=a.far,l=!0),this.view_data[n].dirty=l}update_transforms(i,n){if(this.view_data[n].dirty){this.view_data[n].projection_matrix&&(this.view_data[n].prev_projection_matrix=ml(this.view_data[n].projection_matrix)),this.view_data[n].view_matrix&&(this.view_data[n].prev_view_matrix=ml(this.view_data[n].view_matrix)),Om(this.view_data[n].projection_matrix,this.view_data[n].fov,this.view_data[n].aspect_ratio,this.view_data[n].near,this.view_data[n].far);{this.view_data[n].view_forward=Xm(it(),ar,this.view_data[n].rotation),this.view_data[n].view_forward=Ul(it(),this.view_data[n].view_forward);const a=ir(Et(),this.view_data[n].view_forward,lr);this.view_data[n].view_right=an(a[0],a[1],a[2],0),this.view_data[n].view_right=Rl(Et(),this.view_data[n].view_right);const l=it();Hm(l,this.view_data[n].position,this.view_data[n].view_forward,1),Nm(this.view_data[n].view_matrix,this.view_data[n].position,l,lr)}Ml(this.view_data[n].view_projection_matrix,this.view_data[n].projection_matrix,this.view_data[n].view_matrix),Il(this.view_data[n].inverse_view_projection_matrix,this.view_data[n].view_projection_matrix),this.buffer?(n*this.type_size_bytes,this.buffer.write(i,this.view_data.map(this._get_gpu_type_layout))):this.build(i),this.view_data[n].dirty=!1}}build(i){this.buffer&&this.buffer.destroy(),this.buffer=qt.create(i,{name:"view_buffer",data:this.view_data.map(this._get_gpu_type_layout),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),Ne.get().refresh_global_shader_bindings()}_get_gpu_type_layout(i){return Array.of(...i.view_matrix,...i.prev_view_matrix,...i.projection_matrix,...i.prev_projection_matrix,...i.view_projection_matrix,...i.inverse_view_projection_matrix,...i.view_forward)}}class bn{constructor(){P(this,"skybox",null);if(bn.instance)return bn.instance;bn.instance=this}static get(){return bn.instance?bn.instance:new bn}async add_skybox(i,n,a){const l=await Fs.load(i,a,{name:n,format:"rgba8unorm",dimension:"cube",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return this.skybox=l,l}remove_skybox(){this.skybox=null}get_skybox(){return this.skybox}}class Dn{constructor(){this.name="",this.vertices=[],this.indices=[],this.vertex_buffer_offset=0,this.index_buffer=null}_build_index_buffer(i){let n="uint16";this.indices.constructor.name==="Uint32Array"&&(n="uint32"),this.index_buffer=qt.create(i,{name:`${this.name}_index_buffer`,raw_data:this.indices,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,element_type:n})}_get_tangents_and_bitangents(i,n){let a=[],l=[];for(let c=0;c<i.length;c+=9){const f=[i[c],i[c+1],i[c+2]],g=[i[c+3],i[c+4],i[c+5]],b=[i[c+6],i[c+7],i[c+8]],C=[n[c/3*2],n[c/3*2+1]],S=[n[c/3*2+2],n[c/3*2+3]],M=[n[c/3*2+4],n[c/3*2+5]],F=[g[0]-f[0],g[1]-f[1],g[2]-f[2]],U=[b[0]-f[0],b[1]-f[1],b[2]-f[2]],K=[S[0]-C[0],S[1]-C[1]],q=[M[0]-C[0],M[1]-C[1]],G=1/(K[0]*q[1]-K[1]*q[0]),fe=[(q[1]*F[0]-K[1]*U[0])*G,(q[1]*F[1]-K[1]*U[1])*G,(q[1]*F[2]-K[1]*U[2])*G],oe=[(K[0]*U[0]-q[0]*F[0])*G,(K[0]*U[1]-q[0]*F[1])*G,(K[0]*U[2]-q[0]*F[2])*G];a.push(...fe,...fe,...fe),l.push(...oe,...oe,...oe)}return{t:a,b:l}}static create(i,n,a,l){let c=$.get().fetch(W.MESH,ae.from(n));return c||(c=new Dn,c.name=n,c.vertices=a,c.indices=new Uint16Array(l),c.vertex_buffer_offset=mt.get().add_vertex_data(i,c.vertices),c._build_index_buffer(i),$.get().store(W.MESH,ae.from(n),c),c)}static quad(i){let n=$.get().fetch(W.MESH,ae.from("engine_quad"));return n||(n=new Dn,n.name="engine_quad",n.vertices=[{position:[-1,1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,-1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,0,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]}],n.indices=new Uint16Array([0,1,2,0,2,3]),n.vertex_buffer_offset=mt.get().add_vertex_data(i,n.vertices),n._build_index_buffer(i),$.get().store(W.MESH,ae.from("engine_quad"),n),n)}static cube(i){let n=$.get().fetch(W.MESH,ae.from("engine_cube"));return n||(n=new Dn,n.name="engine_cube",n.vertices=[{position:[-1,-1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[0,0,1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,1,0,0]},{position:[1,-1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,-1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[1,1,-1,1],normal:[0,0,-1,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[-1,0,0,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[1,1,1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[1,1,-1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[-1,1,-1,1],normal:[0,1,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,-1,0]},{position:[-1,-1,-1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,-1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[-1,-1,1,1],normal:[0,-1,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[1,0,0,0],bitangent:[0,0,1,0]},{position:[1,-1,1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,-1,-1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,1,-1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[1,1,1,1],normal:[1,0,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[0,0,-1,0],bitangent:[0,1,0,0]},{position:[-1,-1,-1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[0,0,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,-1,1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[1,0,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,1,1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[1,1,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]},{position:[-1,1,-1,1],normal:[-1,0,0,0],color:[1,1,1,1],uv:[0,1,0,0],tangent:[0,0,1,0],bitangent:[0,1,0,0]}],n.indices=new Uint16Array([0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20]),n.vertex_buffer_offset=mt.get().add_vertex_data(i,n.vertices),n._build_index_buffer(i),$.get().store(W.MESH,ae.from("engine_cube"),n),n)}static async from_gltf(i,n){let a=$.get().fetch(W.MESH,ae.from(n));if(a)return a;const l=(c,f)=>{for(const g of f.mesh.primitives){g.indices&&(g.indicesComponentType===5122||g.indicesComponentType===5123?a.indices=new Uint16Array(c.accessors[g.indices].bufferView.data):g.indicesComponentType===5125&&(a.indices=new Uint32Array(c.accessors[g.indices].bufferView.data)));let b=[];g.attributes.POSITION&&(b=new Float32Array(g.attributes.POSITION.bufferView.data));let C=[];g.attributes.NORMAL&&(C=new Float32Array(g.attributes.NORMAL.bufferView.data));let S=[];g.attributes.COLOR_0&&(S=new Float32Array(g.attributes.COLOR_0.bufferView.data));let M=[];if(g.attributes.TEXCOORD_0){switch(g.attributes.TEXCOORD_0.componentType){case 5126:M=new Float32Array(g.attributes.TEXCOORD_0.bufferView.data);break;case 5121:M=new Uint8Array(g.attributes.TEXCOORD_0.bufferView.data);break;case 5123:M=new Uint16Array(g.attributes.TEXCOORD_0.bufferView.data);break}g.attributes.TEXCOORD_0.normalized&&(M=M.map(q=>q/((1<<8*g.attributes.TEXCOORD_0.componentType.BYTES_PER_ELEMENT)-1)))}let F=[];g.attributes.TANGENT&&(F=new Float32Array(g.attributes.TANGENT.bufferView.data));let U=[];if(g.attributes.BITANGENT&&(U=new Float32Array(g.attributes.BITANGENT.bufferView.data)),F.length===0||U.length===0){const{t:q,b:G}=a._get_tangents_and_bitangents(b,M);F=q,U=G}let K=0;for(let q=0;q<b.length;q+=3)a.vertices.push({position:[b[q]??0,b[q+1]??0,b[q+2]??0,1],normal:[C[q]??0,C[q+1]??0,C[q+2]??0,0],color:[S[q]??0,S[q+1]??0,S[q+2]??0,S[q+3]??1],uv:[M[K]??0,M[K+1]??0,0,0],tangent:[F[q]??0,F[q+1]??0,F[q+2]??0,0],bitangent:[U[q]??0,U[q+1]??0,U[q+2]??0,0]}),K+=2}};return new Promise(c=>{new Ls().load(n,g=>{a=new Dn;for(const b of g.nodes)b.mesh&&l(g,b);a.name=n,a.vertex_buffer_offset=mt.get().add_vertex_data(i,a.vertices),a._build_index_buffer(i),$.get().store(W.MESH,ae.from(n),a),c(a)})})}}function xn(s,i){performance.mark(`${s}_start`),i(),performance.mark(`${s}_end`),performance.measure(`${s}`,`${s}_start`,`${s}_end`)}const cr=1e6;class y0{constructor(){P(this,"mesh_id",0);P(this,"material_id",0);P(this,"entity_id",0);P(this,"index_buffer_id",null);P(this,"instance_count",0);P(this,"first_index",0);P(this,"index_count",0);P(this,"base_vertex",0);P(this,"base_instance",0)}}class v0{constructor(i,n,a){this.batch_index=i,this.entity_index=n}}class w0{constructor(){P(this,"indirect_draw_buffer",null);P(this,"object_instance_buffer",null);P(this,"indirect_draw_data",new Uint32Array(cr*5));P(this,"object_instance_data",new Uint32Array(cr*2))}update_buffers(i,n,a){xn("update_indirect_buffers",()=>{if(!this.indirect_draw_buffer){for(let f=0;f<n.length;f++){const g=f*5;this.indirect_draw_data[g]=n[f].index_count,this.indirect_draw_data[g+1]=n[f].instance_count,this.indirect_draw_data[g+2]=n[f].first_index,this.indirect_draw_data[g+3]=n[f].base_vertex,this.indirect_draw_data[g+4]=n[f].base_instance}this.indirect_draw_buffer=qt.create(i,{name:"indirect_draw_buffer",raw_data:this.indirect_draw_data,usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST})}if(!this.object_instance_buffer){for(let f=0;f<a.length;f++){const g=f*3;this.object_instance_data[g]=a[f].batch_index,this.object_instance_data[g+1]=a[f].entity_index}this.object_instance_buffer=qt.create(i,{name:"object_instance_buffer",raw_data:this.object_instance_data,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})}const l=n.length*5*4;this.indirect_draw_buffer.size<l&&($.get().remove(W.BUFFER,this.indirect_draw_buffer.physical_id),this.indirect_draw_buffer=qt.create(i,{name:"indirect_draw_buffer",data:n.map(f=>[f.index_count,f.instance_count,f.first_index,f.base_vertex,f.base_instance]),usage:GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_DST}));const c=a.length*2*4;this.object_instance_buffer.size<c&&($.get().remove(W.BUFFER,this.object_instance_buffer.physical_id),this.object_instance_buffer=qt.create(i,{name:"object_instance_buffer",data:a.map(f=>[f.batch_index,f.entity_index]),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST})),xn("write_indirect_draw_buffer",()=>{for(let f=0;f<n.length;f++){const g=f*5;this.indirect_draw_data[g]=n[f].index_count,this.indirect_draw_data[g+1]=n[f].instance_count,this.indirect_draw_data[g+2]=n[f].first_index,this.indirect_draw_data[g+3]=n[f].base_vertex,this.indirect_draw_data[g+4]=n[f].base_instance}this.indirect_draw_buffer.write_raw(i,this.indirect_draw_data,0,n.length*5)}),xn("write_object_instance_buffer",()=>{for(let f=0;f<a.length;f++){const g=f*3;this.object_instance_data[g]=a[f].batch_index,this.object_instance_data[g+1]=a[f].entity_index}this.object_instance_buffer.write_raw(i,this.object_instance_data,0,a.length*2)})})}}class Tl{constructor(){P(this,"mesh_id",null);P(this,"entity",null);P(this,"material_id",null);P(this,"instance_count",1)}static init(i,n,a,l=null,c=1){i.mesh_id=n,i.entity=a,i.material_id=l,i.instance_count=c}}class Ze{constructor(){if(Ze.instance)return Ze.instance;this.tasks=[],this.batches=[],this.object_instances=[],this.material_buckets=new Set,this.current_task_offset=0,this.indirect_draw_object=new w0,this.tasks_allocator=new ni(cr,new Tl),this.object_instance_allocator=new ni(cr,new v0),Ze.instance=this}static get(){return Ze.instance||(Ze.instance=new Ze),Ze.instance}reserve(i){this.tasks.length=i}reset(){this.tasks.length=0,this.current_task_offset=0,this.tasks_allocator.reset()}new_task(i,n,a=null,l=1,c=!1){const f=this.tasks_allocator.allocate();return Tl.init(f,i,n,a,l),this.current_task_offset>=this.tasks.length?this.tasks.push(f):this.tasks[this.current_task_offset++]=f,c&&this.sort_and_batch(),f}sort_and_batch(i){xn("sort_and_batch",()=>{this.tasks.sort((n,a)=>n.mesh_id-a.mesh_id-(n.material_id-a.material_id)),this.batches=[],this.object_instances=[],this.object_instance_allocator.reset(),this.tasks.forEach((n,a)=>{const l=this.batches[this.batches.length-1];if(l&&l.mesh_id===n.mesh_id&&l.material_id===n.material_id)l.instance_count+=1;else{const c=$.get().fetch(W.MESH,n.mesh_id),f=new y0;f.mesh_id=n.mesh_id,f.material_id=n.material_id,f.index_buffer_id=ae.from(c.index_buffer.config.name),f.instance_count=n.instance_count,f.first_index=0,f.index_count=c.indices.length,f.base_vertex=c.vertex_buffer_offset,f.base_instance=a,f.entity_id=n.entity,this.batches.push(f)}}),this.batches.sort((n,a)=>n.material_id-a.material_id),this.material_buckets.clear(),this.batches.forEach((n,a)=>{this.material_buckets.add(n.material_id);for(let l=0;l<n.instance_count;l++){const c=this.object_instance_allocator.allocate();c.batch_index=a,c.entity_index=n.entity_id+l,this.object_instances.push(c)}}),this.indirect_draw_object.update_buffers(i,this.batches,this.object_instances)})}remove(i){this.tasks=this.tasks.filter(n=>n.entity!==i),this.current_task_offset=this.tasks.length,this.tasks.length==0&&(this.batches=[],this.object_instances=[],this.material_buckets.clear())}get_object_instance_buffer(){return this.indirect_draw_object.object_instance_buffer}get_indirect_draw_buffer(){return this.indirect_draw_object.indirect_draw_buffer}get_material_buckets(){return this.material_buckets}submit_draws(i,n,a=!1){let l=null;this.tasks.forEach(c=>{const f=$.get().fetch(W.MESH,c.mesh_id),g=$.get().fetch(W.MATERIAL,c.material_id);g&&g!==l&&(g.bind(i,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[pe.Global]&&n.pass_bind_groups[pe.Global].bind(i),n.pass_bind_groups[pe.Pass]&&n.pass_bind_groups[pe.Pass].bind(i),l=g),i.pass.draw(f.vertices.length,c.instance_count,f.vertex_buffer_offset)}),a&&this.reset()}submit_indexed_draws(i,n,a=!1){let l=null;this.tasks.forEach(c=>{const f=$.get().fetch(W.MESH,c.mesh_id),g=$.get().fetch(W.MATERIAL,c.material_id);g&&g!==l&&(g.bind(i,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[pe.Global]&&n.pass_bind_groups[pe.Global].bind(i),n.pass_bind_groups[pe.Pass]&&n.pass_bind_groups[pe.Pass].bind(i),l=g),i.pass.setIndexBuffer(f.index_buffer.buffer,f.index_buffer.config.element_type),i.pass.drawIndexed(f.indices.length,c.instance_count,0,f.vertex_buffer_offset)}),a&&this.reset()}submit_indexed_indirect_draws(i,n,a=!1,l=!0){let c=null;for(let f=0;f<this.batches.length;++f){const g=this.batches[f],b=$.get().fetch(W.BUFFER,g.index_buffer_id),C=$.get().fetch(W.MATERIAL,g.material_id);!l&&C&&C!==c&&(C.bind(i,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[pe.Global]&&n.pass_bind_groups[pe.Global].bind(i),n.pass_bind_groups[pe.Pass]&&n.pass_bind_groups[pe.Pass].bind(i),c=C),i.pass.setIndexBuffer(b.buffer,b.config.element_type),i.pass.drawIndexedIndirect(this.indirect_draw_object.indirect_draw_buffer.buffer,f*20)}a&&this.reset()}submit_material_indexed_indirect_draws(i,n,a,l=!1){const c=$.get().fetch(W.MATERIAL,a);c&&(c.bind(i,n.pass_bind_groups,n.pass_attachments),n.pass_bind_groups[pe.Global]&&n.pass_bind_groups[pe.Global].bind(i),n.pass_bind_groups[pe.Pass]&&n.pass_bind_groups[pe.Pass].bind(i));const f=this.batches.filter(g=>g.material_id===a);for(let g=0;g<f.length;++g){const b=f[g],C=$.get().fetch(W.BUFFER,b.index_buffer_id);i.pass.setIndexBuffer(C.buffer,C.config.element_type),i.pass.drawIndexedIndirect(this.indirect_draw_object.indirect_draw_buffer.buffer,g*20)}l&&this.reset()}draw_quad(i,n){const a=Dn.quad(i);n.pass.setIndexBuffer(a.index_buffer.buffer,a.index_buffer.config.element_type),n.pass.drawIndexed(a.indices.length,1,0,a.vertex_buffer_offset)}draw_cube(i,n){const a=Dn.cube(i);n.pass.setIndexBuffer(a.index_buffer.buffer,a.index_buffer.config.element_type),n.pass.drawIndexed(a.indices.length,1,0,a.vertex_buffer_offset)}}class Us{static initialize(){}static resize(i){this.size=i}static to_gpu_data(){}static add_entity(i,n){this.entity_set.add(i),this.entity_set.size>=this.size&&this.resize(this.entity_set.size*2),n&&this.update_entity_data(i,n)}static remove_entity(i){this.entity_set.delete(i),i===this.size-1&&this.resize(Math.max(...this.entity_set)*2)}static update_entity_data(i,n){const a=(l,c,f)=>{for(const[g,b]of Object.entries(c)){if(l[g]===void 0)throw new Error(`Invalid property ${g} for fragment ${this.constructor.name}`);typeof b=="object"&&b!==null&&!Array.isArray(b)&&!ArrayBuffer.isView(b)?a(l[g],b,f):l[g][f]=b}};a(this.data,n,i)}static get_entity_data(i){const n=(a,l)=>{const c={};for(const[f,g]of Object.entries(a))typeof g=="object"&&g!==null&&!ArrayBuffer.isView(g)?c[f]=n(g,l):ArrayBuffer.isView(g)?c[f]=g[l]:c[f]=g;return c};if(!this.entity_set.has(i))throw new Error(`Entity ${i} does not exist in fragment ${this.constructor.name}`);return n(this.data,i)}}P(Us,"data",null),P(Us,"size",0),P(Us,"entity_set",new Set);class hr extends Us{static initialize(){this.data={position:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},rotation:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},scale:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},prev_world_transform:new Float32Array(16),world_transform:new Float32Array(16),inverse_world_transform:new Float32Array(16),dirty:new Uint8Array(1),gpu_buffer:null,gpu_data_dirty:!0}}static resize(i){this.data||this.initialize(),super.resize(i);const n=(a,l,c=Float32Array,f=1)=>{if(a[l].length<this.size*f){const g=a[l];a[l]=new c(this.size*f),a[l].set(g)}};["position","rotation","scale"].forEach(a=>{["x","y","z"].forEach(l=>{n(this.data[a],l)})}),n(this.data,"prev_world_transform",Float32Array,16),n(this.data,"world_transform",Float32Array,16),n(this.data,"inverse_world_transform",Float32Array,16),n(this.data,"dirty",Uint8Array)}static update_entity_data(i,n){this.data||this.initialize(),super.update_entity_data(i,n),this.data.dirty[i]=1,this.data.gpu_data_dirty=!0}static to_gpu_data(i){if(this.data||this.initialize(),!this.data.gpu_data_dirty)return{gpu_buffer:this.data.gpu_buffer};const n=new Float32Array(Math.max(this.size*32,32));for(let a=0;a<this.size;a++){const l=a*16,c=a*32;for(let f=0;f<16;f++)n[c+f]=this.data.world_transform[l+f];for(let f=0;f<16;f++)n[c+16+f]=this.data.inverse_world_transform[l+f]}return this.data.gpu_buffer&&this.data.gpu_buffer.config.size<n.byteLength&&(this.data.gpu_buffer.destroy(i),this.data.gpu_buffer=null),this.data.gpu_buffer?this.data.gpu_buffer.write(i,n):this.data.gpu_buffer=qt.create(i,{name:"transform_fragment_buffer",usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,raw_data:n}),this.data.gpu_data_dirty=!1,{gpu_buffer:this.data.gpu_buffer}}}const b0={DIRECTIONAL:0,POINT:1,SPOT:2,AREA:3};class ql extends Us{static initialize(){this.data={position:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},direction:{x:new Float32Array(1),y:new Float32Array(1),z:new Float32Array(1)},color:{r:new Float32Array(1),g:new Float32Array(1),b:new Float32Array(1)},type:new Uint8Array(1),intensity:new Float32Array(1),radius:new Float32Array(1),attenuation:new Float32Array(1),outer_angle:new Float32Array(1),dirty:new Uint8Array(1),active:new Uint8Array(1),gpu_buffer:null,gpu_data_dirty:!0}}static resize(i){this.data||this.initialize(),super.resize(i);const n=(a,l,c=Float32Array,f=1)=>{if(a[l].length<this.size*f){const g=a[l];a[l]=new c(this.size*f),a[l].set(g)}};["position","direction"].forEach(a=>{["x","y","z"].forEach(l=>{n(this.data[a],l)})}),["color"].forEach(a=>{["r","g","b"].forEach(l=>{n(this.data[a],l)})}),n(this.data,"type",Uint8Array),n(this.data,"intensity",Float32Array),n(this.data,"radius",Float32Array),n(this.data,"attenuation",Float32Array),n(this.data,"outer_angle",Float32Array),n(this.data,"dirty",Uint8Array),n(this.data,"active",Uint8Array)}static update_entity_data(i,n){this.data||this.initialize(),super.update_entity_data(i,n),this.data.dirty[i]=1,this.data.active[i]=1,this.data.gpu_data_dirty=!0}static to_gpu_data(i){if(this.data||this.initialize(),!this.data.gpu_data_dirty)return{gpu_buffer:this.data.gpu_buffer};let n=0;for(let c=0;c<this.size;c++)this.data.active[c]&&n++;const a=new Float32Array(Math.max(n*16,16));let l=0;for(let c=0;c<this.size;c++)this.data.active[c]&&(a[l]=this.data.position.x[c],a[l+1]=this.data.position.y[c],a[l+2]=this.data.position.z[c],a[l+3]=0,a[l+4]=this.data.direction.x[c],a[l+5]=this.data.direction.y[c],a[l+6]=this.data.direction.z[c],a[l+7]=0,a[l+8]=this.data.color.r[c],a[l+9]=this.data.color.g[c],a[l+10]=this.data.color.b[c],a[l+11]=this.data.type[c],a[l+12]=this.data.intensity[c],a[l+13]=this.data.radius[c],a[l+14]=this.data.attenuation[c],a[l+15]=this.data.outer_angle[c],l+=16);return this.data.gpu_buffer&&this.data.gpu_buffer.config.size<a.byteLength&&(this.data.gpu_buffer.destroy(i),this.data.gpu_buffer=null),this.data.gpu_buffer?this.data.gpu_buffer.write(i,a):this.data.gpu_buffer=qt.create(i,{name:"light_fragment_buffer",usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,raw_data:a}),this.data.gpu_data_dirty=!1,{gpu_buffer:this.data.gpu_buffer}}}function nr(s,i){let n=i;for(const[a,l]of s)n=(n<<5)-n+Ua(a),n=(n<<5)-n+Ua(l),n|=0;return n}function Ua(s){return typeof s=="number"?s:typeof s=="string"?s.split("").reduce((i,n)=>(i<<5)-i+n.charCodeAt(0),0):typeof s=="object"&&s.config&&s.config.name?s.config.name.split("").reduce((i,n)=>(i<<5)-i+n.charCodeAt(0),0):0}const dr=class dr{constructor(i,n,a,l={},c=null){this.context=i,this.name=n,this.shader=a,this.pipeline_state_config=l,this.resources=[],this.parent=c}add_resource(i){this.resources.push(i)}get reflection(){return this.shader.reflection}static create(i,n,a,l={},c=null){if(this.templates.has(n))return this.templates.get(n);let f=null,g=null;if(c){if(f=this.get_template(c),!f)throw new Error(`Parent template '${c}' not found`);g=f.shader}a&&(g=Jt.create(i,a));const b=new dr(i,n,g,l,f);f&&(b.resources=[...f.resources]);const C=b.reflection?b.reflection.getBindGroups():[];if(pe.Material<C.length){const S=C[pe.Material];for(let M=0;M<S.length;M++){const F=S[M],U=Jt.resource_type_from_reflection_type(F.resourceType);b.add_resource({type:U,name:F.name,binding:M})}}return this.templates.set(n,b),b}create_pipeline_state(i,n,a=[]){var S;let l=[...n];const c=this.reflection.getBindGroups();if(pe.Material<c.length){const M=c[pe.Material];l.push(qn.create_layout(i,this.name,M.map(F=>{let U={};switch(Jt.resource_type_from_reflection_type(F.resourceType)){case We.Uniform:U={buffer:{type:"uniform"}};break;case We.Storage:U={buffer:{type:"read-only-storage"}};break;case We.Texture:U={texture:{viewDimension:Fs.dimension_from_type_name(F.type.name),sampleType:F.type.name.includes("depth")?"depth":"float"}};break;case We.StorageTexture:U={storageTexture:{viewDimension:Fs.dimension_from_type_name(F.type.name),sampleType:"float",format:Jt.get_optimal_texture_format(F.type.name)}};break;case We.Sampler:U={sampler:{}};break}return{binding:F.binding,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.VERTEX,...U}}),!0))}const f=a.filter(M=>M.config.type!=="depth").map(M=>({name:M.config.name,format:M.config.format}));this.reflection.entry.fragment[0].outputs.forEach((M,F)=>{if(f[F])return;const U={format:Jt.get_optimal_texture_format(M.type.name)};this.pipeline_state_config.targets&&F<this.pipeline_state_config.targets.length&&(this.pipeline_state_config.targets[F].format&&(U.format=this.pipeline_state_config.targets[F].format),this.pipeline_state_config.targets[F].blend&&(U.blend=this.pipeline_state_config.targets[F].blend)),f.push(U)});let b={label:this.name,bind_layouts:l.filter(M=>M!==null),vertex:{module:this.shader.module,entryPoint:this.pipeline_state_config.vertex&&this.pipeline_state_config.vertex.entry_point||"vs",buffers:[]},fragment:{module:this.shader.module,entryPoint:this.pipeline_state_config.fragment&&this.pipeline_state_config.fragment.entry_point||"fs",targets:f},primitive:{topology:this.pipeline_state_config.primitive_topology_type||"triangle-list",cullMode:((S=this.pipeline_state_config.rasterizer_state)==null?void 0:S.cull_mode)||"back"}};const C=a.find(M=>M.config.type==="depth");return this.pipeline_state_config.depth_stencil_target?b.depthStencil={format:this.pipeline_state_config.depth_stencil_target.format??"depth32float",depthWriteEnabled:this.pipeline_state_config.depth_stencil_target.depth_write_enabled??!0,depthCompare:this.pipeline_state_config.depth_stencil_target.depth_compare??"less"}:C&&(b.depthStencil={format:C.config.format,depthWriteEnabled:!0,depthCompare:"less"}),Bs.create_render(i,this.name,b)}static get_template(i){return this.templates.get(i)}get_all_resources(){return this.parent?[...this.parent.get_all_resources(),...this.resources]:this.resources}};P(dr,"templates",new Map);let _r=dr;const as=class as{constructor(i){this.template=i,this.pipeline_state=null,this.bind_group=null,this.uniform_data=new Map,this.storage_data=new Map,this.texture_data=new Map,this.sampler_data=new Map,this.state_hash=0,this.needs_bind_group_update=!1,this._update_state_hash()}_update_state_hash(){xn("Material._update_state_hash",()=>{as.materials.delete(this.state_hash),$.get().remove(W.MATERIAL,this.state_hash);let i=Ua(this.template.name);i=nr(this.uniform_data,i),i=nr(this.storage_data,i),i=nr(this.texture_data,i),i=nr(this.sampler_data,i),this.state_hash=i,$.get().store(W.MATERIAL,this.state_hash,this),as.materials.set(this.state_hash,this)})}_refresh_bind_group(){const i=this.template.get_all_resources().map(n=>{switch(n.type){case We.Uniform:return{binding:n.binding,resource:{buffer:this.uniform_data.get(n.name).buffer}};case We.Storage:return{binding:n.binding,resource:{buffer:this.storage_data.get(n.name).buffer}};case We.Texture:return{binding:n.binding,resource:this.texture_data.get(n.name).view};case We.Sampler:return{binding:n.binding,resource:this.sampler_data.get(n.name)}}});this.bind_group=qn.create(this.template.context,this.template.name,this.pipeline_state,pe.Material,i,!0)}update_pipeline_state(i,n=[]){this.pipeline_state=this.template.create_pipeline_state(this.template.context,i.filter(a=>a!==null).map(a=>a.layout),n)}set_uniform_data(i,n){this.uniform_data.set(i,n),this._update_state_hash(),this.needs_bind_group_update=!0}set_storage_data(i,n){this.storage_data.set(i,n),this._update_state_hash(),this.needs_bind_group_update=!0}set_texture_data(i,n){this.texture_data.set(i,n),this._update_state_hash(),this.needs_bind_group_update=!0}set_sampler_data(i,n){this.sampler_data.set(i,n),this._update_state_hash(),this.needs_bind_group_update=!0}bind(i,n=[],a=[]){!this.pipeline_state&&n.length>0&&a.length>0&&(this.update_pipeline_state(n,a),n.forEach(l=>{l&&l.bind(i)})),this.needs_bind_group_update&&(this._refresh_bind_group(),this.needs_bind_group_update=!1),this.pipeline_state&&i.set_pipeline(this.pipeline_state),this.bind_group&&this.bind_group.bind(i)}get_state_hash(){return this.state_hash}static create(i){const n=_r.get_template(i);if(!n)throw new Error(`Material template '${i}' not found`);return new as(n)}static get(i){return as.materials.get(i)}};P(as,"materials",new Map);let fr=as;function x0(s){return s*(Math.PI/180)}function zn(s,i,n){return Math.min(Math.max(s,i),n)}function Al(s){return s=Math.floor(s),--s,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,++s>>>0}class k0{constructor(){P(this,"initialized",!1)}setup(i,n){}draw(i,n){xn("DeferredShadingStrategy.draw",()=>{this.initialized||(this.setup(i,n),this.initialized=!0);const a=hr.to_gpu_data(i),l=n.register_buffer(a.gpu_buffer.config.name),c=ql.to_gpu_data(i),f=n.register_buffer(c.gpu_buffer.config.name),g=Ze.get().get_object_instance_buffer(),b=n.register_buffer(g.config.name);let C=null,S=null,M=null,F=null,U=null,K=null,q=null,G=null,fe=null;const oe=i.get_canvas_resolution();{const Q={pipeline_shaders:{vertex:{path:"skybox.wgsl"},fragment:{path:"skybox.wgsl"}},rasterizer_state:{cull_mode:"none"},depth_write_enabled:!1},X=bn.get().get_skybox(),he=n.register_image(X.config.name);C=n.create_image({name:"skybox_output",format:"bgra8unorm",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),n.add_pass("skybox_pass",Ee.Graphics,{inputs:[he],outputs:[C],shader_setup:Q},(ye,me,rt)=>{const $e=ye.get_physical_pass(me.current_pass);Ze.get().draw_cube(me.context,$e)})}{const Q={pipeline_shaders:{vertex:{path:"entity_prepass.wgsl"},fragment:{path:"entity_prepass.wgsl"}}};q=n.create_image({name:"main_entity_id",format:"r32uint",width:oe.width,height:oe.height,depth:1,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),M=n.create_image({name:"main_depth",format:"depth32float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient,load_op:"load"}),n.add_pass("entity_prepass",Ee.Graphics,{inputs:[l,b],outputs:[q,M],shader_setup:Q},(X,he,ye)=>{const me=X.get_physical_pass(he.current_pass);Ze.get().submit_indexed_indirect_draws(me,he,!1)})}{S=n.create_image({name:"main_albedo",format:"rgba16float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),F=n.create_image({name:"main_smra",format:"rgba16float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),U=n.create_image({name:"main_normal",format:"rgba16float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),K=n.create_image({name:"main_position",format:"rgba16float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient});const Q=Ze.get().get_material_buckets();for(const X of Q){const he=fr.get(X);n.add_pass(`g_buffer_${he.template.name}_${X}`,Ee.Graphics,{inputs:[l,b],outputs:[S,F,K,U,M]},(ye,me,rt)=>{const $e=ye.get_physical_pass(me.current_pass);me.g_buffer_data||(me.g_buffer_data={albedo:ye.get_physical_image(S),smra:ye.get_physical_image(F),position:ye.get_physical_image(K),normal:ye.get_physical_image(U),entity_id:ye.get_physical_image(q),depth:ye.get_physical_image(M)},me.g_buffer_data.albedo.config.load_op="load",me.g_buffer_data.smra.config.load_op="load",me.g_buffer_data.position.config.load_op="load",me.g_buffer_data.normal.config.load_op="load"),Ze.get().submit_material_indexed_indirect_draws($e,me,X,!1)})}}n.add_pass("reset_g_buffer_targets",Ee.GraphLocal,{},(Q,X,he)=>{X.g_buffer_data.albedo.config.load_op="clear",X.g_buffer_data.smra.config.load_op="clear",X.g_buffer_data.position.config.load_op="clear",X.g_buffer_data.normal.config.load_op="clear",X.g_buffer_data.depth.config.load_op="clear"});{const Q={pipeline_shaders:{vertex:{path:"deferred_lighting.wgsl"},fragment:{path:"deferred_lighting.wgsl"}}};G=n.create_image({name:"post_lighting",format:"rgba16float",width:oe.width,height:oe.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,flags:lt.Transient}),n.add_pass("lighting_pass",Ee.Graphics,{inputs:[C,S,F,U,K,M,f],outputs:[G],shader_setup:Q},(X,he,ye)=>{const me=X.get_physical_pass(he.current_pass);Ze.get().draw_quad(he.context,me)})}const re=6;{const Q=i.get_canvas_resolution(),X=Al(Q.width),he=Al(Q.height);let ye=[],me=[];for(let ee=0;ee<re;ee++)ye.push(n.create_image({name:`bloom_blur_${ee}`,format:"rgba16float",width:X>>ee,height:he>>ee,usage:GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING})),me.push(n.create_buffer({name:`bloom_blur_params_${ee}`,data:[0,0,0,0,0,0],usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}));const rt={pipeline_shaders:{compute:{path:"effects/bloom_downsample.wgsl"}}};for(let ee=0;ee<re;ee++){const Ve=ee===0?0:ee-1,Ge=ee;n.add_pass(`bloom_downsample_pass_${ee}`,Ee.Compute,{inputs:[ee===0?G:ye[Ve],ye[Ge],me[Ge]],outputs:[ye[Ge]],shader_setup:rt},(De,Be,Qe)=>{const It=De.get_physical_pass(Be.current_pass),Fe=De.get_physical_buffer(me[Ge]),on=zn(X>>Ve,1,X),en=zn(he>>Ve,1,he),Kt=zn(X>>Ge,1,X),je=zn(he>>Ge,1,he);Fe.write(Be.context,[on,en,Kt,je,0,ee]),It.dispatch((Kt+15)/16,(je+15)/16,1)})}const $e={pipeline_shaders:{compute:{path:"effects/bloom_upsample.wgsl"}}};for(let ee=re-1;ee>0;--ee){const Ve=ee,Ge=ee-1;n.add_pass(`bloom_upsample_pass_${ee}`,Ee.Compute,{inputs:[ye[Ve],ye[Ge],me[Ge]],outputs:[ye[Ge]],shader_setup:$e},(De,Be,Qe)=>{const It=De.get_physical_pass(Be.current_pass),Fe=De.get_physical_buffer(me[Ge]),on=zn(X>>Ve,1,X),en=zn(he>>Ve,1,he),Kt=zn(X>>Ge,1,X),je=zn(he>>Ge,1,he);Fe.write(Be.context,[on,en,Kt,je,.005,ee]),It.dispatch((Kt+15)/16,(je+15)/16,1)})}const St={pipeline_shaders:{vertex:{path:"fullscreen.wgsl"},fragment:{path:"effects/bloom_resolve.wgsl"}}};let ze=n.create_buffer({name:"bloom_resolve_params",data:[0,0,0,0],usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});fe=n.create_image({name:"post_bloom_color",format:"rgba16float",width:Q.width,height:Q.height,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),n.add_pass("bloom_resolve_pass",Ee.Graphics,{inputs:[G,ye[0],ze],outputs:[fe],shader_setup:St},(ee,Ve,Ge)=>{const De=ee.get_physical_pass(Ve.current_pass);ee.get_physical_buffer(ze).write(Ve.context,[1.5,.3,.001,0]),Ze.get().draw_quad(Ve.context,De)})}const ue=fe;{const Q=Fs.create_from_texture(i.context.getCurrentTexture(),"swapchain"),X=n.register_image(Q.config.name),he={pipeline_shaders:{vertex:{path:"fullscreen.wgsl"},fragment:{path:"fullscreen.wgsl"}}};n.add_pass("fullscreen_present_pass",Ee.Graphics|Ee.Present,{inputs:[ue],outputs:[X],shader_setup:he},(ye,me,rt)=>{const $e=ye.get_physical_pass(me.current_pass);Ze.get().draw_quad(me.context,$e)})}n.submit(i)})}}class Ne{constructor(){P(this,"graphics_context",null);P(this,"render_strategy",null);P(this,"simple_shader",null);P(this,"simple_vertex_buffer",null);P(this,"render_graph",null);if(Ne.instance)return Ne.instance;Ne.instance=this}static get(){return Ne.instance?Ne.instance:new Ne}async setup(i){this.graphics_context=await Fa.create(i,{pointer_lock:!0}),this.render_graph=La.create(),this.render_strategy=new k0,this.refresh_global_shader_bindings(),this.setup_builtin_material_template()}render(){performance.mark("frame_render"),this.graphics_context.advance_frame(),this.render_graph.begin(this.graphics_context),this.render_strategy.draw(this.graphics_context,this.render_graph)}refresh_global_shader_bindings(){this.render_graph.queue_global_bind_group_write([{buffer:mt.get().buffer,offset:0,size:mt.get().size},{buffer:yt.get().buffer,offset:0,size:yt.get().size},{sampler:Fs.get_default_sampler(this.graphics_context)}],!0)}setup_builtin_material_template(){_r.create(Ne.get().graphics_context,"StandardMaterial","standard_material.wgsl")}}class Zt{constructor(){P(this,"simulation_layers",[]);P(this,"current_time",0);P(this,"delta_time",0);P(this,"previous_time",0);if(Zt.instance)return Zt.instance;Zt.instance=this}static get(){return Zt.instance||(Zt.instance=new Zt),Zt.instance}async register_simulation_layer(i){this.simulation_layers.push(i),await i.init()}unregister_simulation_layer(i){i.cleanup(),this.simulation_layers.splice(this.simulation_layers.indexOf(i),1)}update(){performance.mark("simulation_core_update"),this.current_time=performance.now(),this.delta_time=Math.min((this.current_time-this.previous_time)/1e3,.1),this.previous_time=this.current_time;for(const i of this.simulation_layers)i.pre_update();for(const i of this.simulation_layers)i.update(this.delta_time);for(const i of this.simulation_layers)i.post_update()}}class T0{constructor(i=[]){P(this,"input_states",[]);P(this,"action_mappings",[]);P(this,"state_mappings",[]);P(this,"range_mappings",[]);P(this,"raw_to_state_mappings",{});P(this,"action_to_state_mappings",{});P(this,"dirty_states",new Set);this.set_states(i)}num_states(){return this.input_states.length}set_states(i){this.input_states=i,this.action_mappings=new Array(this.input_states.length).fill(!1),this.state_mappings=new Array(this.input_states.length).fill(!1),this.range_mappings=new Array(this.input_states.length).fill(0),this.raw_to_state_mappings={},this.action_to_state_mappings={},this.dirty_states=new Set;for(let n=0;n<this.input_states.length;++n){const a=this.input_states[n];this.raw_to_state_mappings[a.raw_input]=n,this.action_to_state_mappings[a.mapped_name]=n}}set_state(i,n){console.assert(i<this.state_mappings.length&&i>=0,"Invalid input state index"),this.state_mappings[i]=n,n&&this.dirty_states.add(i)}set_action(i,n){console.assert(i<this.action_mappings.length&&i>=0,"Invalid input state index");const a=!this.action_mappings[i]&&n;this.action_mappings[i]=n,a&&this.dirty_states.add(i)}set_range(i,n){console.assert(i<this.range_mappings.length&&i>=0,"Invalid input state index"),n!==0&&(this.range_mappings[i]=n,this.input_states[i].range_value=n,this.dirty_states.add(i))}visit_dirty_states(i){if(typeof i=="function"){for(const n of this.dirty_states){console.assert(n<this.input_states.length&&n>=0,"Invalid dirty state index");const a=this.input_states[n];i(a)}this.dirty_states.clear()}}}const J={K_Return:0,K_Escape:1,K_Backspace:2,K_Tab:3,K_Space:4,K_Exclaim:5,K_Quotedbl:6,K_Hash:7,K_Percent:8,K_Dollar:9,K_Ampersand:10,K_Quote:11,K_Leftparen:12,K_Rightparen:13,K_Asterisk:14,K_Plus:15,K_Comma:16,K_Minus:17,K_Period:18,K_Slash:19,K_Colon:20,K_Semicolon:21,K_Less:22,K_Equals:23,K_Greater:24,K_Question:25,K_At:26,K_Leftbracket:27,K_Backslash:28,K_Rightbracket:29,K_Caret:30,K_Underscore:31,K_Backquote:32,K_0:33,K_1:34,K_2:35,K_3:36,K_4:37,K_5:38,K_6:39,K_7:40,K_8:41,K_9:42,K_a:43,K_b:44,K_c:45,K_d:46,K_e:47,K_f:48,K_g:49,K_h:50,K_i:51,K_j:52,K_k:53,K_l:54,K_m:55,K_n:56,K_o:57,K_p:58,K_q:59,K_r:60,K_s:61,K_t:62,K_u:63,K_v:64,K_w:65,K_x:66,K_y:67,K_z:68,B_mouse_left:69,B_mouse_right:70,B_mouse_middle:71,NumKeys:72},Wn={M_x:0,M_y:1,NumRanges:2},rn={Action:0,State:1,Range:2};class Ia{constructor(i,n,a,l){this.mapped_name=i,this.raw_input=n,this.raw_range=a,this.input_type=l,this.range_value=0}}const Rs=class Rs{constructor(){P(this,"key_map",new Map);P(this,"ranges_array",new Array(Wn.NumRanges).fill(0));P(this,"mouse_x",0);P(this,"mouse_y",0);this.handle_key_down=this.handle_key_down.bind(this),this.handle_key_up=this.handle_key_up.bind(this),this.handle_mouse_down=this.handle_mouse_down.bind(this),this.handle_mouse_up=this.handle_mouse_up.bind(this),this.handle_mouse_move=this.handle_mouse_move.bind(this)}init(){window.addEventListener("keydown",this.handle_key_down),window.addEventListener("keyup",this.handle_key_up),window.addEventListener("mousedown",this.handle_mouse_down),window.addEventListener("mouseup",this.handle_mouse_up),window.addEventListener("mousemove",this.handle_mouse_move)}shutdown(){window.removeEventListener("keydown",this.handle_key_down),window.removeEventListener("keyup",this.handle_key_up),window.removeEventListener("mousedown",this.handle_mouse_down),window.removeEventListener("mouseup",this.handle_mouse_up),window.removeEventListener("mousemove",this.handle_mouse_move)}handle_key_down(i){const n=this.browser_key_to_input_key(i.code);n!==void 0&&this.key_map.set(n,!0)}handle_key_up(i){const n=this.browser_key_to_input_key(i.code);n!==void 0&&this.key_map.set(n,!1)}handle_mouse_down(i){const n=this.browser_button_to_input_key(i.button);n!==void 0&&this.key_map.set(n,!0)}handle_mouse_up(i){const n=this.browser_button_to_input_key(i.button);n!==void 0&&this.key_map.set(n,!1)}handle_mouse_move(i){this.mouse_x=i.movementX,this.mouse_y=i.movementY}update(i,n,a){this.ranges_array[Wn.M_x]=this.mouse_x/a.width,this.ranges_array[Wn.M_y]=this.mouse_y/a.height,this.mouse_x*=Math.exp(-.5*.5),this.mouse_y*=Math.exp(-.5*.5);for(let l=0;l<i.input_states.length;++l){const c=i.input_states[l];switch(c.input_type){case rn.State:case rn.Action:{const f=this.key_map.get(c.raw_input)||!1;c.input_type===rn.State?i.set_state(l,f):i.set_action(l,f);break}case rn.Range:{const f=this.ranges_array[c.raw_range];i.set_range(l,f);break}}}}browser_key_to_input_key(i){return Rs.key_mapping[i]}browser_button_to_input_key(i){return Rs.button_mapping[i]}};P(Rs,"key_mapping",{Enter:J.K_Return,Escape:J.K_Escape,Backspace:J.K_Backspace,Tab:J.K_Tab,Space:J.K_Space,Pause:J.K_Pause,Quote:J.K_Quote,Comma:J.K_Comma,Minus:J.K_Minus,Period:J.K_Period,Slash:J.K_Slash,Digit0:J.K_0,Digit1:J.K_1,Digit2:J.K_2,Digit3:J.K_3,Digit4:J.K_4,Digit5:J.K_5,Digit6:J.K_6,Digit7:J.K_7,Digit8:J.K_8,Digit9:J.K_9,Semicolon:J.K_Semicolon,Equal:J.K_Equals,BracketLeft:J.K_LeftBracket,Backslash:J.K_Backslash,BracketRight:J.K_RightBracket,Backquote:J.K_Backquote,KeyA:J.K_a,KeyB:J.K_b,KeyC:J.K_c,KeyD:J.K_d,KeyE:J.K_e,KeyF:J.K_f,KeyG:J.K_g,KeyH:J.K_h,KeyI:J.K_i,KeyJ:J.K_j,KeyK:J.K_k,KeyL:J.K_l,KeyM:J.K_m,KeyN:J.K_n,KeyO:J.K_o,KeyP:J.K_p,KeyQ:J.K_q,KeyR:J.K_r,KeyS:J.K_s,KeyT:J.K_t,KeyU:J.K_u,KeyV:J.K_v,KeyW:J.K_w,KeyX:J.K_x,KeyY:J.K_y,KeyZ:J.K_z}),P(Rs,"button_mapping",{0:J.B_mouse_left,1:J.B_mouse_middle,2:J.B_mouse_right});let Ba=Rs;class A0{constructor(i,n){this.entity_manager=i,this.fragment_requirements=n,this.matching_entities=new Uint32Array,this.update_matching_entities()}update_matching_entities(){const i=this.entity_manager.get_entity_count(),n=new Uint32Array(i);let a=0;const l=new Set;for(let c=0;c<i;c++)!l.has(c)&&this.fragment_requirements.every(f=>{var g;return(g=this.entity_manager.entity_fragments.get(c))==null?void 0:g.has(f)})&&(n[a]=c,a++,l.add(c));this.matching_entities=n.slice(0,a)}get_entity_count(){return this.matching_entities.length}}class Dt{constructor(){P(this,"next_entity_id",0);P(this,"entity_fragments",new Map);P(this,"fragment_types",new Set);P(this,"queries",new Set);P(this,"deleted_entities",new Set);if(Dt.instance)return Dt.instance;Dt.instance=this}static get(){return Dt.instance?Dt.instance:new Dt}create_entity(i=!0){let n;if(this.deleted_entities.size>0)n=this.deleted_entities.values().next().value,this.deleted_entities.delete(n);else if(n=this.next_entity_id++,i)for(const a of this.fragment_types)a.resize(n);return this.entity_fragments.set(n,new Set),i&&this.update_queries(),n}delete_entity(i,n=!0){if(this.entity_fragments.has(i)){for(const a of this.entity_fragments.get(i))a.remove_entity(i);this.entity_fragments.delete(i),this.deleted_entities.add(i),n&&this.update_queries()}}add_fragment(i,n,a,l=!0){this.fragment_types.has(n)||(n.initialize(),this.fragment_types.add(n)),n.add_entity(i,a),this.entity_fragments.get(i).add(n),l&&this.update_queries()}remove_fragment(i,n,a=!0){!this.entity_fragments.has(i)||!this.entity_fragments.get(i).has(n)||(n.remove_entity(i),this.entity_fragments.get(i).delete(n),a&&this.update_queries())}update_fragment(i,n,a){if(!this.entity_fragments.has(i)||!this.entity_fragments.get(i).has(n))throw new Error(`Entity ${i} does not have fragment ${n.constructor.name}`);n.update_entity_data(i,a)}get_fragment(i,n){return!this.entity_fragments.has(i)||!this.entity_fragments.get(i).has(n)?null:n.get_entity_data(i)}get_fragment_array(i){return i.data}get_entity_count(){return this.next_entity_id-this.deleted_entities.size}create_query({fragment_requirements:i}){const n=new A0(this,i);return this.queries.add(n),n}update_queries(){for(const i of this.queries)i.update_matching_entities()}}class E0{constructor(){P(this,"current_view",null);P(this,"entity_manager",Dt.get())}}class ai{constructor(){P(this,"layers",[]);P(this,"context",new E0);this.name="SimulationLayer"}init(i){}pre_update(i){for(const n of this.layers)n.pre_update(this.context)}update(i,n){for(const a of this.layers)a.update(i,this.context)}post_update(i){for(const n of this.layers)n.post_update(this.context)}add_layer(i){let n=this.get_layer(i);if(n)return n;const a=new i;return a.init(this.context),this.layers.push(a),a}remove_layer(i){const n=this.get_layer(i);n&&this.layers.splice(this.layers.indexOf(n),1)}get_layer(i){return this.layers.find(n=>n.constructor.name===i.constructor.name)}}const gt=class gt extends ai{constructor(){if(gt.instance)return gt.instance;super();P(this,"contexts",[]);P(this,"current_dirty_states",[]);P(this,"b_initialized",!1);P(this,"processor",null);gt.instance=this}static get(){return gt.instance?gt.instance:new gt}static default_context(){if(!gt.default_context_instance&&(gt.default_context_instance=new T0,gt.default_context_instance.num_states()===0)){const n=[];for(let a=0;a<J.NumKeys;++a)n.push(new Ia("",a,Wn.NumRanges,rn.State)),n.push(new Ia("",a,Wn.NumRanges,rn.Action));for(let a=0;a<Wn.NumRanges;++a)n.push(new Ia("",J.NumKeys,a,rn.Range));gt.default_context_instance.set_states(n)}return gt.default_context_instance}init(){this.b_initialized||(this.b_initialized=!0,this.processor=new Ba,this.processor.init())}update(n){if(super.update(n),performance.mark("input provider update"),this.contexts.length>0){const a=this.contexts[this.contexts.length-1];this.processor.update(a,n,Ne.get().graphics_context.canvas),this.current_dirty_states=[],a.visit_dirty_states(l=>{this.current_dirty_states.push(l)})}}push_context(n){this.contexts.push(n)}pop_context(){return this.contexts.length>0?this.contexts.pop():null}get_state(n){return this.current_dirty_states.some(a=>(typeof n=="number"?a.raw_input===n:a.mapped_name===n)&&a.input_type===rn.State)}get_action(n){return this.current_dirty_states.some(a=>(typeof n=="number"?a.raw_input===n:a.mapped_name===n)&&a.input_type===rn.Action)}get_range(n){const a=this.current_dirty_states.find(l=>(typeof n=="number"?l.raw_range===n:l.mapped_name===n)&&l.input_type===rn.Range);return a?a.range_value:0}};P(gt,"default_context_instance",null);let zt=gt;class S0 extends ai{constructor(){super(),this.move_speed=10,this.rotation_speed=1,this.orbit_distance=10}init(i){super.init(i);const n=an(0,0,-2,1),a=Jm(0,0,0,1);yt.get().set_view_data(Ne.get().graphics_context,i.current_view,{position:n,rotation:a,aspect_ratio:Ne.get().graphics_context.aspect_ratio,fov:x0(75)})}update(i,n){super.update(i,n);const a=yt.get().get_view_data(n.current_view);let l=Oa(a.position),c=Fl(a.rotation),f=!1;if(zt.get().get_state(J.K_w)){const S=Cs(it(),a.view_forward??ar,this.move_speed*i);Is(l,l,S),f=!0}if(zt.get().get_state(J.K_s)){const S=Cs(it(),a.view_forward??ar,-this.move_speed*i);Is(l,l,S),f=!0}if(zt.get().get_state(J.K_a)){const S=Cs(it(),a.view_right??WORLD_RIGHT,-this.move_speed*i);Is(l,l,S),f=!0}if(zt.get().get_state(J.K_d)){const S=Cs(it(),a.view_right??WORLD_RIGHT,this.move_speed*i);Is(l,l,S),f=!0}if(zt.get().get_state(J.K_q)){const S=Cs(it(),lr,this.move_speed*i);Is(l,l,S),f=!0}if(zt.get().get_state(J.K_e)){const S=Cs(it(),lr,-this.move_speed*i);Is(l,l,S),f=!0}const g=zt.get().get_range(Wn.M_x),b=zt.get().get_range(Wn.M_y);if(g||b){const M=Dm(Et(),l,a.view_forward??ar,10),F=Ma(Kn(),[1,0,0],b*this.rotation_speed),U=Ma(Kn(),[0,1,0],g*this.rotation_speed),K=vl(Kn(),U,F);vl(c,K,c);const q=Wm(Et(),l,M);Km(q,q,K),rs(l,M,q),f=!0}const C=Ne.get().graphics_context;f&&yt.get().set_view_data(C,n.current_view,{position:l,rotation:c}),yt.get().update_transforms(C,n.current_view)}}class ri extends Us{static initialize(){this.data={mesh:new BigInt64Array(1),material_slots:new BigInt64Array(this.material_slot_stride),instance_count:new BigInt64Array(1),dirty:new Uint8Array(1)}}static update_entity_data(i,n){if(this.data||this.initialize(),super.update_entity_data(i,n),!Array.isArray(n.material_slots))throw new Error(`Material slots must be an array for entity ${i} in fragment ${this.constructor.name}`);if(n.material_slots.length>this.material_slot_stride)throw new Error(`Material slots must be less than ${this.material_slot_stride} for entity ${i} in fragment ${this.constructor.name}`);for(let a=0;a<n.material_slots.length;a++)this.data.material_slots[i*this.material_slot_stride+a]=BigInt(n.material_slots[a]);this.data.dirty[i]=1}static resize(i){super.resize(i);const n=(a,l,c,f,g=!1)=>{if(a[l].length<this.size*c){const b=a[l];a[l]=new f(this.size*c),g?a[l].fill(0):a[l].set(b)}};["mesh","instance_count"].forEach(a=>{n(this.data,a,1,BigInt64Array)}),n(this.data,"material_slots",this.material_slot_stride,BigInt64Array),n(this.data,"dirty",1,Uint8Array,!0)}}P(ri,"material_slot_stride",64);class I0 extends ai{constructor(){super();P(this,"entity_query",null)}init(n){this.entity_query=Dt.get().create_query({fragment_requirements:[ri]})}update(n,a){xn("static_mesh_processor_update",()=>{const l=Dt.get().get_fragment_array(ri),c=$.get(),f=Ze.get();let g=null,b=null,C=null,S=0,M=!1;for(let F=0;F<this.entity_query.matching_entities.length;++F){const U=this.entity_query.matching_entities[F];if(!l.dirty[U])continue;M=!0;const K=Number(l.mesh[U]),q=Number(l.material_slots[U*ri.material_slot_stride]),G=Number(l.instance_count[U])||1;C||(C=U),K==g&&q==b?S+=G:(K!==g&&c.fetch(W.MESH,K),f.new_task(K,U,q,S),S=0,C=U),g=K,b=q,l.dirty[U]=0}S>0&&f.new_task(g,C,b,S),M&&f.sort_and_batch(Ne.get().graphics_context)})}}class C0 extends ai{constructor(){super();P(this,"entity_query",null)}init(n){this.entity_query=Dt.get().create_query({fragment_requirements:[hr]})}update(n,a){xn("transform_processor_update",()=>{const l=Dt.get().get_fragment_array(hr);for(let c=0;c<this.entity_query.matching_entities.length;++c){const f=this.entity_query.matching_entities[c];if(!l.dirty[f])continue;l.prev_world_transform.set(l.world_transform.subarray(f*16,f*16+16),f*16);const g=Pm(Gt(),Zm(Kn(),l.rotation.x[f],l.rotation.y[f],l.rotation.z[f]),an(l.position.x[f],l.position.y[f],l.position.z[f],1),an(l.scale.x[f],l.scale.y[f],l.scale.z[f],0));l.world_transform.set(g,f*16),l.inverse_world_transform.set(Il(Gt(),g),f*16),l.dirty[f]=0}})}}class M0 extends ai{constructor(n){super();P(this,"name","");P(this,"sphere_mesh",null);this.name=n}async init(n){super.init(this.context),this.context.current_view=yt.get().add_view_data(Ne.get().graphics_context),this.setup_default_subsystems()}update(n,a){super.update(n,this.context),performance.mark("scene_update")}setup_default_subsystems(){this.add_layer(S0),this.add_layer(I0),this.add_layer(C0)}create_entity(n=!0){return this.context.entity_manager.create_entity(n)}delete_entity(n,a=!0){this.context.entity_manager.delete_entity(n,a)}add_fragment(n,a,l,c=!0){this.context.entity_manager.add_fragment(n,a,l,c)}remove_fragment(n,a,l=!0){this.context.entity_manager.remove_fragment(n,a,l)}update_fragment(n,a,l,c=!0){this.context.entity_manager.update_fragment(n,a,l,c)}get_fragment(n,a){return this.context.entity_manager.get_fragment(n,a)}refresh_entity_queries(){this.context.entity_manager.update_queries()}}const Kl={is_running:!1};async function R0(){Kl.is_running=!0;const s=zt.get();await Zt.get().register_simulation_layer(s),s.push_context(zt.default_context());const i=document.getElementById("gpu-canvas");await Ne.get().setup(i);{const n=new M0("StartScene");await Zt.get().register_simulation_layer(n),await bn.get().add_skybox(Ne.get().graphics_context,"default_scene_skybox",["engine/textures/spacebox/px.png","engine/textures/spacebox/nx.png","engine/textures/spacebox/ny.png","engine/textures/spacebox/py.png","engine/textures/spacebox/pz.png","engine/textures/spacebox/nz.png"]);const a=n.create_entity();n.add_fragment(a,ql,{type:b0.DIRECTIONAL,color:{r:1,g:1,b:1},intensity:5,position:{x:50,y:100,z:50}});const l=await Dn.from_gltf(Ne.get().graphics_context,"engine/models/cube/cube.gltf"),f=fr.create("StandardMaterial").get_state_hash(),g=100,b=100,C=2;for(let S=0;S<g;S++)for(let M=0;M<g;M++)for(let F=0;F<b;F++){const U=n.create_entity(!1);n.add_fragment(U,ri,{mesh:BigInt(ae.from(l.name)),material_slots:[f],instance_count:BigInt(1)},!1),n.add_fragment(U,hr,{position:{x:(S-Math.floor(g/2))*C,y:(F-Math.floor(b/2))*C,z:(M-Math.floor(g/2))*C},rotation:{x:-90,y:90,z:0},scale:{x:.5,y:.5,z:.5}},!1)}n.refresh_entity_queries()}}function U0(){function s(){Kl.is_running&&(xn("frame_loop",()=>{Zt.get().update(),Ne.get().render()}),requestAnimationFrame(s))}requestAnimationFrame(s)}(async()=>(await R0(),U0()))();
